---
name: release

on:
  push:
    tags:
      - "v20*"

jobs:
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh release create '${{ github.ref_name }}' \
            --title 'PUDL ${{ github.ref_name }}' \
            --notes "PUDL is an application that must be installed from the repository using pixi.

          **Installation:**
          \`\`\`bash
          git clone https://github.com/catalyst-cooperative/pudl.git
          cd pudl
          git checkout ${{ github.ref_name }}
          pixi install
          \`\`\`

          **Data Outputs:**
          Data outputs generated by this release will be published separately to Zenodo.

          **Changes:**
          See [Release Notes](https://catalystcoop-pudl.readthedocs.io/en/latest/release_notes.html) for details." \
              --repo '${{ github.repository }}'

  notify-slack:
    runs-on: ubuntu-latest
    needs:
      - create-github-release
    steps:
      - name: Inform the Codemonkeys
        uses: 8398a7/action-slack@v3
        continue-on-error: true
        with:
          status: custom
          fields: workflow,job,commit,repo,ref,author,took
          custom_payload: |
            {
              username: 'action-slack',
              icon_emoji: ':octocat:',
              attachments: [{
                color: '${{ needs.create-github-release.result }}' === 'success' ? 'good' : '${{ needs.create-github-release.result }}' === 'failure' ? 'danger' : 'warning',
                text: `${process.env.AS_REPO}@${process.env.AS_REF}\n ${process.env.AS_WORKFLOW} (${process.env.AS_COMMIT})\n by ${process.env.AS_AUTHOR}\n Status: ${{ needs.create-github-release.result }}`,
              }]
            }
        env:
          GITHUB_TOKEN: ${{ github.token }} # required
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
          MATRIX_CONTEXT: ${{ toJson(matrix) }} # required
