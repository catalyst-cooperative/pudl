pudl.workspace.datastore
========================

.. py:module:: pudl.workspace.datastore

.. autoapi-nested-parse::

   Datastore manages file retrieval for PUDL datasets.



Attributes
----------

.. autoapisummary::

   pudl.workspace.datastore.logger
   pudl.workspace.datastore.ZenodoDoi


Exceptions
----------

.. autoapisummary::

   pudl.workspace.datastore.ChecksumMismatchError


Classes
-------

.. autoapisummary::

   pudl.workspace.datastore.DatapackageDescriptor
   pudl.workspace.datastore.ZenodoDoiSettings
   pudl.workspace.datastore.ZenodoFetcher
   pudl.workspace.datastore.Datastore


Functions
---------

.. autoapisummary::

   pudl.workspace.datastore.print_partitions
   pudl.workspace.datastore.validate_cache
   pudl.workspace.datastore.fetch_resources
   pudl.workspace.datastore._parse_key_values
   pudl.workspace.datastore.pudl_datastore


Module Contents
---------------

.. py:data:: logger

.. py:data:: ZenodoDoi

.. py:exception:: ChecksumMismatchError

   Bases: :py:obj:`ValueError`


   Resource checksum (md5) does not match.


.. py:class:: DatapackageDescriptor(datapackage_json: dict, dataset: str, doi: ZenodoDoi)

   A simple wrapper providing access to datapackage.json contents.


   .. py:attribute:: datapackage_json


   .. py:attribute:: dataset


   .. py:attribute:: doi


   .. py:method:: _get_resource_metadata(name: str) -> dict


   .. py:method:: get_resource_path(name: str) -> str

      Returns zenodo url that holds contents of given named resource.



   .. py:method:: get_download_size() -> int

      Returns the total download size of all the resources in MB.



   .. py:method:: validate_checksum(name: str, content: str) -> bool

      Returns True if content matches checksum for given named resource.



   .. py:method:: _matches(res: dict, **filters: Any)


   .. py:method:: _match_from_partition(parts: dict[str, str], k: str, v: str | list[str, str])


   .. py:method:: get_resources(name: str = None, **filters: Any) -> collections.abc.Iterator[pudl.workspace.resource_cache.PudlResourceKey]

      Returns series of PudlResourceKey identifiers for matching resources.

      :param name: if specified, find resource(s) with this name.
      :param filters: if specified, find resource(s) matching these key=value
                      constraints. The constraints are matched against the 'parts' field of
                      the resource entry in the datapackage.json.
      :type filters: dict



   .. py:method:: get_partitions(name: str = None) -> dict[str, set[str]]

      Return mapping of known partition keys to their allowed known values.



   .. py:method:: get_partition_filters(**filters: Any) -> collections.abc.Iterator[dict[str, str]]

      Returns list of all known partition mappings.

      This can be used to iterate over all resources as the mappings can be directly
      used as filters and should map to unique resource.

      :param filters: additional constraints for selecting relevant partitions.



   .. py:method:: _validate_datapackage(datapackage_json: dict)

      Checks the correctness of datapackage.json metadata.

      Throws ValueError if invalid.



   .. py:method:: get_json_string() -> str

      Exports the underlying json as normalized (sorted, indented) json string.



.. py:class:: ZenodoDoiSettings(**data: Any)

   Bases: :py:obj:`pydantic_settings.BaseSettings`


   Digital Object Identifiers pointing to currently used Zenodo archives.


   .. py:attribute:: censusdp1tract
      :type:  ZenodoDoi


   .. py:attribute:: censuspep
      :type:  ZenodoDoi


   .. py:attribute:: eia176
      :type:  ZenodoDoi


   .. py:attribute:: eia191
      :type:  ZenodoDoi


   .. py:attribute:: eia757a
      :type:  ZenodoDoi


   .. py:attribute:: eia860
      :type:  ZenodoDoi


   .. py:attribute:: eia860m
      :type:  ZenodoDoi


   .. py:attribute:: eia861
      :type:  ZenodoDoi


   .. py:attribute:: eia923
      :type:  ZenodoDoi


   .. py:attribute:: eia930
      :type:  ZenodoDoi


   .. py:attribute:: eiaaeo
      :type:  ZenodoDoi


   .. py:attribute:: eiaapi
      :type:  ZenodoDoi


   .. py:attribute:: epacamd_eia
      :type:  ZenodoDoi


   .. py:attribute:: epacems
      :type:  ZenodoDoi


   .. py:attribute:: ferc1
      :type:  ZenodoDoi


   .. py:attribute:: ferc2
      :type:  ZenodoDoi


   .. py:attribute:: ferc6
      :type:  ZenodoDoi


   .. py:attribute:: ferc60
      :type:  ZenodoDoi


   .. py:attribute:: ferc714
      :type:  ZenodoDoi


   .. py:attribute:: ferceqr
      :type:  ZenodoDoi


   .. py:attribute:: ferccid
      :type:  ZenodoDoi


   .. py:attribute:: gridpathratoolkit
      :type:  ZenodoDoi


   .. py:attribute:: nrelatb
      :type:  ZenodoDoi


   .. py:attribute:: phmsagas
      :type:  ZenodoDoi


   .. py:attribute:: rus7
      :type:  ZenodoDoi


   .. py:attribute:: rus12
      :type:  ZenodoDoi


   .. py:attribute:: sec10k
      :type:  ZenodoDoi


   .. py:attribute:: vcerare
      :type:  ZenodoDoi


   .. py:attribute:: model_config

      Configuration for the model, should be a dictionary conforming to [`ConfigDict`][pydantic.config.ConfigDict].


   .. py:method:: from_yaml(path: str | pathlib.Path) -> ZenodoDoiSettings
      :classmethod:


      Create a ZenodoDoiSettings instance from a YAML file path.

      :param path: Path to a YAML file.

      :returns: A ZenodoDoiSettings object with DOIs loaded from the YAML file.



.. py:class:: ZenodoFetcher(zenodo_dois: ZenodoDoiSettings | None = None, timeout: float = 100.0)

   API for fetching datapackage descriptors and resource contents from zenodo.


   .. py:attribute:: _descriptor_cache
      :type:  dict[str, DatapackageDescriptor]


   .. py:attribute:: zenodo_dois
      :type:  ZenodoDoiSettings


   .. py:attribute:: timeout
      :type:  float


   .. py:attribute:: http


   .. py:method:: get_doi(dataset: str) -> ZenodoDoi

      Returns DOI for given dataset.



   .. py:method:: get_known_datasets() -> list[str]

      Returns list of supported datasets.



   .. py:method:: _get_url(doi: ZenodoDoi) -> pydantic.HttpUrl

      Construct a Zenodo depsition URL based on its Zenodo DOI.



   .. py:method:: _fetch_from_url(url: pydantic.HttpUrl) -> requests.Response


   .. py:method:: get_descriptor(dataset: str) -> DatapackageDescriptor

      Returns class:`DatapackageDescriptor` for given dataset.



   .. py:method:: get_resource(res: pudl.workspace.resource_cache.PudlResourceKey) -> bytes

      Given resource key, retrieve contents of the file from zenodo.



.. py:class:: Datastore(local_cache_path: str | pathlib.Path | upath.UPath | None = None, cloud_cache_path: str | upath.UPath | None = 's3://pudl.catalyst.coop/zenodo', timeout: float = 15.0)

   Handle connections and downloading of Zenodo Source archives.


   .. py:attribute:: _cache


   .. py:attribute:: _datapackage_descriptors
      :type:  dict[str, DatapackageDescriptor]


   .. py:attribute:: temporary_extraction_dir


   .. py:attribute:: _zenodo_fetcher


   .. py:method:: get_known_datasets() -> list[str]

      Returns list of supported datasets.



   .. py:method:: get_datapackage_descriptor(dataset: str) -> DatapackageDescriptor

      Fetch datapackage descriptor for dataset either from cache or Zenodo.



   .. py:method:: get_resources(dataset: str, cached_only: bool = False, skip_optimally_cached: bool = False, **filters: Any) -> collections.abc.Iterator[tuple[pudl.workspace.resource_cache.PudlResourceKey, bytes]]

      Return content of the matching resources.

      :param dataset: name of the dataset to query.
      :param cached_only: if True, only retrieve resources that are present in the cache.
      :param skip_optimally_cached: if True, only retrieve resources that are not optimally
                                    cached. This triggers attempt to optimally cache these resources.
      :param filters: only return resources that match the key-value mapping in their
      :type filters: key=val
      :param metadata["parts"].:

      :Yields: (PudlResourceKey, io.BytesIO) holding content for each matching resource



   .. py:method:: remove_from_cache(res: pudl.workspace.resource_cache.PudlResourceKey) -> None

      Remove given resource from the associated cache.



   .. py:method:: get_unique_resource(dataset: str, **filters: Any) -> bytes

      Returns content of a resource assuming there is exactly one that matches.



   .. py:method:: get_zipfile_resource(dataset: str, **filters: Any) -> zipfile.ZipFile

      Retrieves unique resource and opens it as a ZipFile.



   .. py:method:: get_zipfile_resources(dataset: str, **filters: Any) -> collections.abc.Iterator[tuple[pudl.workspace.resource_cache.PudlResourceKey, zipfile.ZipFile]]

      Iterates over resources that match filters and opens each as ZipFile.



   .. py:method:: get_zipfile_file_names(zip_file: zipfile.ZipFile)

      Given a zipfile, return a list of the file names in it.



.. py:function:: print_partitions(dstore: Datastore, datasets: list[str]) -> None

   Prints known partition keys and its values for each of the datasets.


.. py:function:: validate_cache(dstore: Datastore, datasets: list[str], partition: dict[str, str]) -> None

   Validate elements in the datastore cache.

   Delete invalid entries from cache.


.. py:function:: fetch_resources(dstore: Datastore, datasets: list[str], partition: dict[str, int | str], cloud_cache_path: str, bypass_local_cache: bool) -> None

   Retrieve all matching resources and store them in the cache.


.. py:function:: _parse_key_values(ctx: click.core.Context, param: click.Option, values: str) -> dict[str, str]

   Parse key-value pairs into a Python dictionary.

   Transforms a command line argument of the form: k1=v1,k2=v2,k3=v3...
   into: {k1:v1, k2:v2, k3:v3, ...}


.. py:function:: pudl_datastore(dataset: list[str], validate: bool, list_partitions: bool, partition: dict[str, int | str], cloud_cache_path: str, bypass_local_cache: bool, logfile: pathlib.Path, loglevel: str)

   Manage the raw data inputs to the PUDL data processing pipeline.

   Download all the raw FERC Form 2 data:

   pudl_datastore --dataset ferc2

   Download the raw FERC Form 2 data only for 2021

   pudl_datastore --dataset ferc2 --partition year=2021

   Re-download the raw FERC Form 2 data for 2021 even if you already have it:

   pudl_datastore --dataset ferc2 --partition year=2021 --bypass-local-cache

   Validate all California EPA CEMS data in the local datastore:

   pudl_datastore --dataset epacems --validate --partition state=ca

   List the available partitions in the EIA-860 and EIA-923 datasets:

   pudl_datastore --dataset eia860 --dataset eia923 --list-partitions


