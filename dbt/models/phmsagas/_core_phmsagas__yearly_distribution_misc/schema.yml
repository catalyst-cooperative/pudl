version: 2
sources:
  - name: pudl
    tables:
      - name: _core_phmsagas__yearly_distribution_misc
        data_tests:
          - expect_columns_not_all_null:
              arguments:
                row_conditions:
                  all_known_leaks_scheduled_for_repair_main: EXTRACT(year FROM report_date) <= 1983
                  services_efv_in_system: EXTRACT(year FROM report_date) BETWEEN 2010 AND 2022
                  services_efv_installed: EXTRACT(year FROM report_date) BETWEEN 2010 AND 2022
                  services_shutoff_valve_in_system: EXTRACT(year FROM report_date) BETWEEN 2017 AND 2022
                  services_shutoff_valve_installed: EXTRACT(year FROM report_date) BETWEEN 2017 AND 2022
          - dbt_expectations.expect_compound_columns_to_be_unique:
              arguments:
                column_list:
                  - report_id
                  - operator_id_phmsa
                  - operating_state
          - check_row_counts_per_partition:
              arguments:
                table_name: _core_phmsagas__yearly_distribution_misc
                partition_expr: "EXTRACT(YEAR FROM report_date)"
        columns:
          - name: report_date
          - name: report_id
          - name: operator_id_phmsa
          - name: operating_state
          - name: all_known_leaks_scheduled_for_repair
          - name: all_known_leaks_scheduled_for_repair_main
          - name: hazardous_leaks_mechanical_joint_failure
          - name: federal_land_leaks_repaired_or_scheduled
          - name: average_service_length_feet
          - name: unaccounted_for_gas_fraction
            data_tests:
              - expect_quantile_constraints:
                  description: "Accept negative values in at most 17% of rows"
                  arguments:
                    constraints:
                      - quantile: 0.17
                        min_value: 0
          - name: services_shutoff_valve_installed
          - name: services_efv_installed
          - name: services_shutoff_valve_in_system
          - name: services_efv_in_system
          - name: excavation_tickets
