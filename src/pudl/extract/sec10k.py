"""Load pre-processed SEC 10-K assets from Google Cloud Storage.

These "raw" tables are generated by the SEC 10-K data extraction pipeline which can be
found in this repository: https://github.com/catalyst-cooperative/mozilla-sec-eia

However, the GCS bucket containing the data is not public, so these assets cannot be
loaded by a normal user. To address this issue we need to pull them into the same
Zenodo archiving system we use for all of our other inputs. See:
https://github.com/catalyst-cooperative/pudl/issues/4065
"""

from io import BytesIO

import dagster as dg
import pandas as pd

from pudl.settings import Sec10kSettings


def raw_sec10k_asset_factory(table_name: str):
    """Provide an asset factory to extract raw SEC10k data from parquet files."""

    @dg.asset(
        name=table_name,
        required_resource_keys={"datastore", "dataset_settings"},
    )
    def _extract_sec10k_table(context):
        ds = context.resources.datastore
        sec10k_settings = context.resources.dataset_settings.sec10k
        df = pd.read_parquet(
            BytesIO(ds.get_unique_resource("sec10k", table=table_name)),
        )

        if "report_year" in df.columns:
            df = df[df["report_year"].isin(sec10k_settings.years)]
        elif "year_quarter" in df.columns:
            df = df[df["year_quarter"].str[:4].isin(map(str, sec10k_settings.years))]
        else:
            raise RuntimeError(
                f"Expected table {table_name} to have a `report_year` or `year_quarter` column."
            )

        return df

    return _extract_sec10k_table


assets = [
    raw_sec10k_asset_factory(table_name) for table_name in Sec10kSettings().tables
]
