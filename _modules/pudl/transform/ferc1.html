<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXWBBTVMWK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EXWBBTVMWK');
    </script>
    <link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">
        <link rel="prefetch" href="../../../_static/catalyst_logo-200x200.png" as="image">

    <!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>pudl.transform.ferc1 - PUDL 2026.2.1.dev10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=b1990d62" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     <b>Take our ~10 minute <a href="https://forms.gle/E9ou5fgMcR7YVRCRA">2026 Energy Data Ecosystem Survey!</b> 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">PUDL 2026.2.1.dev10 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/catalyst_logo-200x200.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PUDL 2026.2.1.dev10 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">About PUDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_access.html">Data Access</a></li>
<li class="toctree-l1"><a class="reference external" href="https://data.catalyst.coop">PUDL Data Viewer</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../data_sources/index.html">Data Sources</a><input aria-label="Toggle navigation of Data Sources" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/censusdp1tract.html">Census DP1 – Profile of General Demographic Characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/censuspep.html">Population Estimates Program's (PEP) Federal Information Processing Series (FIPS) Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eiaapi.html">EIA Bulk API Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia176.html">EIA Form 176 – Annual Report of Natural and Supplemental Gas Supply and Disposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia860.html">EIA Form 860 – Annual Electric Generator Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia861.html">EIA Form 861 – Annual Electric Power Industry Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia923.html">EIA Form 923 – Power Plant Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia930.html">EIA Form 930 – Hourly and Daily Balancing Authority Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eiaaeo.html">EIA Annual Energy Outlook (AEO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/epacamd_eia.html">EPA CAMD to EIA Power Sector Data Crosswalk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/epacems.html">EPA Hourly Continuous Emission Monitoring System (CEMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferc1.html">FERC Form 1 – Annual Report of Major Electric Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferc714.html">FERC Form 714 – Annual Electric Balancing Authority Area and Planning Area Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferceqr.html">FERC Form 920 – Electric Quarterly Report (EQR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/gridpathratoolkit.html">GridPath Resource Adequacy Toolkit Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/nrelatb.html">NREL Annual Technology Baseline (ATB) for Electricity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/phmsagas.html">Pipelines and Hazardous Materials Safety Administration (PHMSA) Annual Natural Gas Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/rus12.html">USDA RUS Form 12 – Financial and Operating Report: Electric Power Supply</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/rus7.html">USDA RUS Form 7 – Financial and Operating Report: Electric Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/sec10k.html">U.S. Securities and Exchange Commission (SEC) Form 10-K</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/vcerare.html">Vibrant Clean Energy Resource Adequacy Renewable Energy (RARE) Power Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/other_data.html">Other Data in PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/future_data.html">High Priority Target Datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../data_dictionaries/index.html">Data Dictionaries</a><input aria-label="Toggle navigation of Data Dictionaries" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/pudl_db.html">PUDL Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/ferc1_db.html">Raw FERC Form 1 Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/codes_and_labels.html">PUDL Code Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/usage_warnings.html">PUDL Usage Warnings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../methodology/index.html">Methodology</a><input aria-label="Toggle navigation of Methodology" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../methodology/timeseries_imputation.html">Timeseries Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../methodology/sec10k_modeling.html">SEC 10-K Ownership Data Extraction Modeling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../dev/index.html">Development</a><input aria-label="Toggle navigation of Development" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dev_setup.html">Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/run_the_etl.html">Running the ETL Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dev_dagster.html">Developing with Dagster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/project_management.html">Project Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/testing.html">Testing PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_validation_quickstart.html">Data validation quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_validation_reference.html">Data validation reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/metadata.html">Metadata editing guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/build_docs.html">Building the Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/datastore.html">Working with the Datastore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/clone_ferc1.html">Converting raw FERC data to SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/existing_data_updates.html">Existing Data Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/run_a_release.html">Run a Versioned Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/pudl_id_mapping.html">PUDL ID Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/naming_conventions.html">Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_guidelines.html">Data and ETL Design Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/nightly_data_builds.html">Nightly Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/ferceqr_data_builds.html">FERC EQR Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/infrastructure_as_code.html">Infrastructure as Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/managing_external_contributions.html">Managing External Contributions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../LICENSE.html">Licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../autoapi/pudl/index.html">pudl</a><input aria-label="Toggle navigation of pudl" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/__main__/index.html">pudl.__main__</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/_version/index.html">pudl._version</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/index.html">pudl.analysis</a><input aria-label="Toggle navigation of pudl.analysis" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html">pudl.analysis.allocate_gen_fuel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/fuel_by_plant/index.html">pudl.analysis.fuel_by_plant</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/mcoe/index.html">pudl.analysis.mcoe</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/index.html">pudl.analysis.ml_tools</a><input aria-label="Toggle navigation of pudl.analysis.ml_tools" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/experiment_tracking/index.html">pudl.analysis.ml_tools.experiment_tracking</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/models/index.html">pudl.analysis.ml_tools.models</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/plant_parts_eia/index.html">pudl.analysis.plant_parts_eia</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/index.html">pudl.analysis.record_linkage</a><input aria-label="Toggle navigation of pudl.analysis.record_linkage" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/classify_plants_ferc1/index.html">pudl.analysis.record_linkage.classify_plants_ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_inputs/index.html">pudl.analysis.record_linkage.eia_ferc1_inputs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_model_config/index.html">pudl.analysis.record_linkage.eia_ferc1_model_config</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_record_linkage/index.html">pudl.analysis.record_linkage.eia_ferc1_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_train/index.html">pudl.analysis.record_linkage.eia_ferc1_train</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/embed_dataframe/index.html">pudl.analysis.record_linkage.embed_dataframe</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/link_cross_year/index.html">pudl.analysis.record_linkage.link_cross_year</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/name_cleaner/index.html">pudl.analysis.record_linkage.name_cleaner</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/service_territory/index.html">pudl.analysis.service_territory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/spatial/index.html">pudl.analysis.spatial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/state_demand/index.html">pudl.analysis.state_demand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html">pudl.analysis.timeseries_cleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/timeseries_evaluation/index.html">pudl.analysis.timeseries_evaluation</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/convert/index.html">pudl.convert</a><input aria-label="Toggle navigation of pudl.convert" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/convert/censusdp1tract_to_sqlite/index.html">pudl.convert.censusdp1tract_to_sqlite</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/convert/metadata_to_rst/index.html">pudl.convert.metadata_to_rst</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/dbt_wrapper/index.html">pudl.dbt_wrapper</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/etl/index.html">pudl.etl</a><input aria-label="Toggle navigation of pudl.etl" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/asset_checks/index.html">pudl.etl.asset_checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/check_foreign_keys/index.html">pudl.etl.check_foreign_keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/cli/index.html">pudl.etl.cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/eia_bulk_elec_assets/index.html">pudl.etl.eia_bulk_elec_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/ferceqr_deployment/index.html">pudl.etl.ferceqr_deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/glue_assets/index.html">pudl.etl.glue_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/static_assets/index.html">pudl.etl.static_assets</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/extract/index.html">pudl.extract</a><input aria-label="Toggle navigation of pudl.extract" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/censuspep/index.html">pudl.extract.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/csv/index.html">pudl.extract.csv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/dbf/index.html">pudl.extract.dbf</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia176/index.html">pudl.extract.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia191/index.html">pudl.extract.eia191</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia757a/index.html">pudl.extract.eia757a</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia860/index.html">pudl.extract.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia860m/index.html">pudl.extract.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia861/index.html">pudl.extract.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia923/index.html">pudl.extract.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia930/index.html">pudl.extract.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eiaaeo/index.html">pudl.extract.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eiaapi/index.html">pudl.extract.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/epacems/index.html">pudl.extract.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/excel/index.html">pudl.extract.excel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/extractor/index.html">pudl.extract.extractor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc/index.html">pudl.extract.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc1/index.html">pudl.extract.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc2/index.html">pudl.extract.ferc2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc6/index.html">pudl.extract.ferc6</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc60/index.html">pudl.extract.ferc60</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc714/index.html">pudl.extract.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferccid/index.html">pudl.extract.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferceqr/index.html">pudl.extract.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/gridpathratoolkit/index.html">pudl.extract.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/nrelatb/index.html">pudl.extract.nrelatb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/parquet/index.html">pudl.extract.parquet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/phmsagas/index.html">pudl.extract.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/rus12/index.html">pudl.extract.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/rus7/index.html">pudl.extract.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/sec10k/index.html">pudl.extract.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/vcerare/index.html">pudl.extract.vcerare</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/xbrl/index.html">pudl.extract.xbrl</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/ferc_to_sqlite/index.html">pudl.ferc_to_sqlite</a><input aria-label="Toggle navigation of pudl.ferc_to_sqlite" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/ferc_to_sqlite/cli/index.html">pudl.ferc_to_sqlite.cli</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/glue/index.html">pudl.glue</a><input aria-label="Toggle navigation of pudl.glue" class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/glue/ferc1_eia/index.html">pudl.glue.ferc1_eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/glue/ferc714/index.html">pudl.glue.ferc714</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/helpers/index.html">pudl.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/io_managers/index.html">pudl.io_managers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/logging_helpers/index.html">pudl.logging_helpers</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/metadata/index.html">pudl.metadata</a><input aria-label="Toggle navigation of pudl.metadata" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/classes/index.html">pudl.metadata.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/codes/index.html">pudl.metadata.codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/constants/index.html">pudl.metadata.constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/descriptions/index.html">pudl.metadata.descriptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/dfs/index.html">pudl.metadata.dfs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/enums/index.html">pudl.metadata.enums</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/fields/index.html">pudl.metadata.fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/helpers/index.html">pudl.metadata.helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/labels/index.html">pudl.metadata.labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/resource_helpers/index.html">pudl.metadata.resource_helpers</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/index.html">pudl.metadata.resources</a><input aria-label="Toggle navigation of pudl.metadata.resources" class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/allocate_gen_fuel/index.html">pudl.metadata.resources.allocate_gen_fuel</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/censusdp1tract/index.html">pudl.metadata.resources.censusdp1tract</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia/index.html">pudl.metadata.resources.eia</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia176/index.html">pudl.metadata.resources.eia176</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia860/index.html">pudl.metadata.resources.eia860</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia860m/index.html">pudl.metadata.resources.eia860m</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia861/index.html">pudl.metadata.resources.eia861</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia923/index.html">pudl.metadata.resources.eia923</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia930/index.html">pudl.metadata.resources.eia930</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eiaaeo/index.html">pudl.metadata.resources.eiaaeo</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eiaapi/index.html">pudl.metadata.resources.eiaapi</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/epacems/index.html">pudl.metadata.resources.epacems</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc1/index.html">pudl.metadata.resources.ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc1_eia_record_linkage/index.html">pudl.metadata.resources.ferc1_eia_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc714/index.html">pudl.metadata.resources.ferc714</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferccid/index.html">pudl.metadata.resources.ferccid</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferceqr/index.html">pudl.metadata.resources.ferceqr</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/glue/index.html">pudl.metadata.resources.glue</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/gridpathratoolkit/index.html">pudl.metadata.resources.gridpathratoolkit</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/nrelatb/index.html">pudl.metadata.resources.nrelatb</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/phmsagas/index.html">pudl.metadata.resources.phmsagas</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/pudl/index.html">pudl.metadata.resources.pudl</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/rus12/index.html">pudl.metadata.resources.rus12</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/rus7/index.html">pudl.metadata.resources.rus7</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/sec10k/index.html">pudl.metadata.resources.sec10k</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/vcerare/index.html">pudl.metadata.resources.vcerare</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/sources/index.html">pudl.metadata.sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/warnings/index.html">pudl.metadata.warnings</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/output/index.html">pudl.output</a><input aria-label="Toggle navigation of pudl.output" class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/censusdp1tract/index.html">pudl.output.censusdp1tract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia/index.html">pudl.output.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia860/index.html">pudl.output.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia923/index.html">pudl.output.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia930/index.html">pudl.output.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eiaapi/index.html">pudl.output.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/ferc1/index.html">pudl.output.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/ferc714/index.html">pudl.output.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/sec10k/index.html">pudl.output.sec10k</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/output/sql/index.html">pudl.output.sql</a><input aria-label="Toggle navigation of pudl.output.sql" class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/output/sql/helpers/index.html">pudl.output.sql.helpers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/index.html">pudl.package_data</a><input aria-label="Toggle navigation of pudl.package_data" class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/censuspep/index.html">pudl.package_data.censuspep</a><input aria-label="Toggle navigation of pudl.package_data.censuspep" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/censuspep/column_maps/index.html">pudl.package_data.censuspep.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia176/index.html">pudl.package_data.eia176</a><input aria-label="Toggle navigation of pudl.package_data.eia176" class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia176/column_maps/index.html">pudl.package_data.eia176.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia191/index.html">pudl.package_data.eia191</a><input aria-label="Toggle navigation of pudl.package_data.eia191" class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia191/column_maps/index.html">pudl.package_data.eia191.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia757a/index.html">pudl.package_data.eia757a</a><input aria-label="Toggle navigation of pudl.package_data.eia757a" class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia757a/column_maps/index.html">pudl.package_data.eia757a.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860/index.html">pudl.package_data.eia860</a><input aria-label="Toggle navigation of pudl.package_data.eia860" class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860/column_maps/index.html">pudl.package_data.eia860.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860m/index.html">pudl.package_data.eia860m</a><input aria-label="Toggle navigation of pudl.package_data.eia860m" class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860m/column_maps/index.html">pudl.package_data.eia860m.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia861/index.html">pudl.package_data.eia861</a><input aria-label="Toggle navigation of pudl.package_data.eia861" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia861/column_maps/index.html">pudl.package_data.eia861.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia923/index.html">pudl.package_data.eia923</a><input aria-label="Toggle navigation of pudl.package_data.eia923" class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia923/column_maps/index.html">pudl.package_data.eia923.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia930/index.html">pudl.package_data.eia930</a><input aria-label="Toggle navigation of pudl.package_data.eia930" class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia930/column_maps/index.html">pudl.package_data.eia930.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/epacems/index.html">pudl.package_data.epacems</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/ferc1/index.html">pudl.package_data.ferc1</a><input aria-label="Toggle navigation of pudl.package_data.ferc1" class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/ferc1/row_maps/index.html">pudl.package_data.ferc1.row_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/glue/index.html">pudl.package_data.glue</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/phmsagas/index.html">pudl.package_data.phmsagas</a><input aria-label="Toggle navigation of pudl.package_data.phmsagas" class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/phmsagas/column_maps/index.html">pudl.package_data.phmsagas.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus12/index.html">pudl.package_data.rus12</a><input aria-label="Toggle navigation of pudl.package_data.rus12" class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus12/column_maps/index.html">pudl.package_data.rus12.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus7/index.html">pudl.package_data.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/settings/index.html">pudl.package_data.settings</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/test/index.html">pudl.package_data.test</a><input aria-label="Toggle navigation of pudl.package_data.test" class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/test/column_maps/index.html">pudl.package_data.test.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/vcerare/index.html">pudl.package_data.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/resources/index.html">pudl.resources</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/scripts/index.html">pudl.scripts</a><input aria-label="Toggle navigation of pudl.scripts" class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/auto_match_utilities/index.html">pudl.scripts.auto_match_utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/dbt_helper/index.html">pudl.scripts.dbt_helper</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/generate_pudl_duckdb/index.html">pudl.scripts.generate_pudl_duckdb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/pudl_null_cols/index.html">pudl.scripts.pudl_null_cols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/resource_description/index.html">pudl.scripts.resource_description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/zenodo_data_release/index.html">pudl.scripts.zenodo_data_release</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/settings/index.html">pudl.settings</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/transform/index.html">pudl.transform</a><input aria-label="Toggle navigation of pudl.transform" class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/censuspep/index.html">pudl.transform.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/classes/index.html">pudl.transform.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia/index.html">pudl.transform.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia176/index.html">pudl.transform.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia860/index.html">pudl.transform.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia860m/index.html">pudl.transform.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia861/index.html">pudl.transform.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia923/index.html">pudl.transform.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia930/index.html">pudl.transform.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eiaaeo/index.html">pudl.transform.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eiaapi/index.html">pudl.transform.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/epacems/index.html">pudl.transform.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc/index.html">pudl.transform.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc1/index.html">pudl.transform.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc714/index.html">pudl.transform.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferccid/index.html">pudl.transform.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferceqr/index.html">pudl.transform.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/gridpathratoolkit/index.html">pudl.transform.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/nrelatb/index.html">pudl.transform.nrelatb</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/transform/params/index.html">pudl.transform.params</a><input aria-label="Toggle navigation of pudl.transform.params" class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/transform/params/ferc1/index.html">pudl.transform.params.ferc1</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/phmsagas/index.html">pudl.transform.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus/index.html">pudl.transform.rus</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus12/index.html">pudl.transform.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus7/index.html">pudl.transform.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/sec10k/index.html">pudl.transform.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/vcerare/index.html">pudl.transform.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/validate/index.html">pudl.validate</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/workspace/index.html">pudl.workspace</a><input aria-label="Toggle navigation of pudl.workspace" class="toctree-checkbox" id="toctree-checkbox-36" name="toctree-checkbox-36" role="switch" type="checkbox"/><label for="toctree-checkbox-36"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/datastore/index.html">pudl.workspace.datastore</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/resource_cache/index.html">pudl.workspace.resource_cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/setup/index.html">pudl.workspace.setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../bibliography.html">Bibliography</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pudl.transform.ferc1</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Classes &amp; functions to process FERC Form 1 data before loading into the PUDL DB.</span>

<span class="sd">Note that many of the classes/objects here inherit from/are instances of classes defined</span>
<span class="sd">in :mod:`pudl.transform.classes`. Their design and relationships to each other are</span>
<span class="sd">documented in that module.</span>

<span class="sd">See :mod:`pudl.transform.params.ferc1` for the values that parameterize many of these</span>
<span class="sd">transformations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.resources</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Self</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dagster</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssetIn</span><span class="p">,</span> <span class="n">AssetsDefinition</span><span class="p">,</span> <span class="n">asset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.core.groupby</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFrameGroupBy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pudl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.extract.ferc1</span><span class="w"> </span><span class="kn">import</span> <span class="n">TABLE_NAME_MAP_FERC1</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">assert_cols_areclose</span><span class="p">,</span> <span class="n">convert_cols_dtypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">PUDL_PACKAGE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_pudl_dtypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.settings</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ferc1Settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.transform.classes</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AbstractTableTransformer</span><span class="p">,</span>
    <span class="n">InvalidRows</span><span class="p">,</span>
    <span class="n">RenameColumns</span><span class="p">,</span>
    <span class="n">TableTransformParams</span><span class="p">,</span>
    <span class="n">TransformParams</span><span class="p">,</span>
    <span class="n">cache_df</span><span class="p">,</span>
    <span class="n">enforce_snake_case</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.transform.ferc</span><span class="w"> </span><span class="kn">import</span> <span class="n">filter_for_freshest_data_xbrl</span><span class="p">,</span> <span class="n">get_primary_key_raw_xbrl</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">logging_helpers</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>



<span class="nd">@asset</span>
<div class="viewcode-block" id="_core_ferc1_xbrl__metadata_json">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._core_ferc1_xbrl__metadata_json">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_core_ferc1_xbrl__metadata_json</span><span class="p">(</span>
    <span class="n">raw_ferc1_xbrl__metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate cleaned json xbrl metadata.</span>

<span class="sd">    For now, this only runs :func:`add_source_tables_to_xbrl_metadata`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">add_source_tables_to_xbrl_metadata</span><span class="p">(</span><span class="n">raw_ferc1_xbrl__metadata_json</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_source_tables_to_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.add_source_tables_to_xbrl_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_source_tables_to_xbrl_metadata</span><span class="p">(</span>
    <span class="n">raw_ferc1_xbrl__metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a ``source_tables`` field into metadata calculation components.</span>

<span class="sd">    When a particular component of a calculation does not originate from the table in</span>
<span class="sd">    which the calculated field is being reported, label the source table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_fields_in_table</span><span class="p">(</span><span class="n">table_meta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile a list of all of the fields reported in a table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">meta_list</span> <span class="ow">in</span> <span class="n">table_meta</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">meta_list</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_tables_to_fields</span><span class="p">(</span><span class="n">xbrl_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span> <span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile a dictionary of table names (keys) to list of fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">table_name</span><span class="p">:</span> <span class="n">all_fields_in_table</span><span class="p">(</span><span class="n">table_meta</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_meta</span> <span class="ow">in</span> <span class="n">xbrl_meta</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">label_source_tables</span><span class="p">(</span><span class="n">calc_component</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">tables_to_fields</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ``source_tables`` element to the calculation component.&quot;&quot;&quot;</span>
        <span class="n">calc_component</span><span class="p">[</span><span class="s2">&quot;source_tables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">other_table_name</span>
            <span class="k">for</span> <span class="n">other_table_name</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">tables_to_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">calc_component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">fields</span>
        <span class="p">]</span>
        <span class="c1"># weirdly there are a number of nuclear xbrl_factoid calc components that seem</span>
        <span class="c1"># to have no source_tables.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_component</span><span class="p">[</span><span class="s2">&quot;source_tables&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found no source table for </span><span class="si">{</span><span class="n">calc_component</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calc_component</span>

    <span class="n">tables_to_fields</span> <span class="o">=</span> <span class="n">extract_tables_to_fields</span><span class="p">(</span><span class="n">raw_ferc1_xbrl__metadata_json</span><span class="p">)</span>
    <span class="c1"># for each table loop through all of the calculations within each field</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">table_meta</span> <span class="ow">in</span> <span class="n">raw_ferc1_xbrl__metadata_json</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">list_of_facts</span> <span class="ow">in</span> <span class="n">table_meta</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">xbrl_fact</span> <span class="ow">in</span> <span class="n">list_of_facts</span><span class="p">:</span>
                <span class="c1"># all facts have ``calculations``, but they are empty lists when null</span>
                <span class="k">for</span> <span class="n">calc_component</span> <span class="ow">in</span> <span class="n">xbrl_fact</span><span class="p">[</span><span class="s2">&quot;calculations&quot;</span><span class="p">]:</span>
                    <span class="c1"># does the calc component show up in the table? if not, add a label</span>
                    <span class="k">if</span> <span class="n">calc_component</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables_to_fields</span><span class="p">[</span><span class="n">table_name</span><span class="p">]:</span>
                        <span class="n">calc_component</span> <span class="o">=</span> <span class="n">label_source_tables</span><span class="p">(</span>
                            <span class="n">calc_component</span><span class="p">,</span> <span class="n">tables_to_fields</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">calc_component</span><span class="p">[</span><span class="s2">&quot;source_tables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">raw_ferc1_xbrl__metadata_json</span></div>



<span class="c1">################################################################################</span>
<span class="c1"># FERC 1 Transform Parameter Models</span>
<span class="c1">################################################################################</span>
<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<div class="viewcode-block" id="SourceFerc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SourceFerc1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SourceFerc1</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration of allowed FERC 1 raw data sources.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SourceFerc1.XBRL">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SourceFerc1.XBRL">[docs]</a>
    <span class="n">XBRL</span> <span class="o">=</span> <span class="s2">&quot;xbrl&quot;</span></div>

<div class="viewcode-block" id="SourceFerc1.DBF">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SourceFerc1.DBF">[docs]</a>
    <span class="n">DBF</span> <span class="o">=</span> <span class="s2">&quot;dbf&quot;</span></div>
</div>



<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<div class="viewcode-block" id="TableIdFerc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TableIdFerc1</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration of the allowed FERC 1 table IDs.</span>

<span class="sd">    Hard coding this doesn&#39;t seem ideal. Somehow it should be either defined in the</span>
<span class="sd">    context of the Package, the Ferc1Settings, an etl_group, or DataSource. All of the</span>
<span class="sd">    table transformers associated with a given data source should have a table_id that&#39;s</span>
<span class="sd">    from that data source&#39;s subset of the database. Where should this really happen?</span>
<span class="sd">    Alternatively, the allowable values could be derived *from* the structure of the</span>
<span class="sd">    Package. But this works for now.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TableIdFerc1.STEAM_PLANTS_FUEL">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.STEAM_PLANTS_FUEL">[docs]</a>
    <span class="n">STEAM_PLANTS_FUEL</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_steam_plants_fuel_sched402&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.STEAM_PLANTS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.STEAM_PLANTS">[docs]</a>
    <span class="n">STEAM_PLANTS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_steam_plants_sched402&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.HYDROELECTRIC_PLANTS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.HYDROELECTRIC_PLANTS">[docs]</a>
    <span class="n">HYDROELECTRIC_PLANTS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_hydroelectric_plants_sched406&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.SMALL_PLANTS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.SMALL_PLANTS">[docs]</a>
    <span class="n">SMALL_PLANTS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_small_plants_sched410&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.PUMPED_STORAGE_PLANTS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.PUMPED_STORAGE_PLANTS">[docs]</a>
    <span class="n">PUMPED_STORAGE_PLANTS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_pumped_storage_plants_sched408&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.PLANT_IN_SERVICE">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.PLANT_IN_SERVICE">[docs]</a>
    <span class="n">PLANT_IN_SERVICE</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_plant_in_service_sched204&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.PURCHASED_POWER_AND_EXCHANGES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.PURCHASED_POWER_AND_EXCHANGES">[docs]</a>
    <span class="n">PURCHASED_POWER_AND_EXCHANGES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;core_ferc1__yearly_purchased_power_and_exchanges_sched326&quot;</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="TableIdFerc1.TRANSMISSION_LINES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.TRANSMISSION_LINES">[docs]</a>
    <span class="n">TRANSMISSION_LINES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_transmission_lines_sched422&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.ENERGY_SOURCES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.ENERGY_SOURCES">[docs]</a>
    <span class="n">ENERGY_SOURCES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_energy_sources_sched401&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.ENERGY_DISPOSITIONS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.ENERGY_DISPOSITIONS">[docs]</a>
    <span class="n">ENERGY_DISPOSITIONS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_energy_dispositions_sched401&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.UTILITY_PLANT_SUMMARY">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.UTILITY_PLANT_SUMMARY">[docs]</a>
    <span class="n">UTILITY_PLANT_SUMMARY</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_utility_plant_summary_sched200&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.OPERATING_EXPENSES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.OPERATING_EXPENSES">[docs]</a>
    <span class="n">OPERATING_EXPENSES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_operating_expenses_sched320&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.BALANCE_SHEET_LIABILITIES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.BALANCE_SHEET_LIABILITIES">[docs]</a>
    <span class="n">BALANCE_SHEET_LIABILITIES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_balance_sheet_liabilities_sched110&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.DEPRECIATION_SUMMARY">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.DEPRECIATION_SUMMARY">[docs]</a>
    <span class="n">DEPRECIATION_SUMMARY</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_depreciation_summary_sched336&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.BALANCE_SHEET_ASSETS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.BALANCE_SHEET_ASSETS">[docs]</a>
    <span class="n">BALANCE_SHEET_ASSETS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_balance_sheet_assets_sched110&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.RETAINED_EARNINGS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.RETAINED_EARNINGS">[docs]</a>
    <span class="n">RETAINED_EARNINGS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_retained_earnings_sched118&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.INCOME_STATEMENTS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.INCOME_STATEMENTS">[docs]</a>
    <span class="n">INCOME_STATEMENTS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_income_statements_sched114&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.DEPRECIATION_CHANGES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.DEPRECIATION_CHANGES">[docs]</a>
    <span class="n">DEPRECIATION_CHANGES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_depreciation_changes_sched219&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.OPERATING_REVENUES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.OPERATING_REVENUES">[docs]</a>
    <span class="n">OPERATING_REVENUES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_operating_revenues_sched300&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.DEPRECIATION_BY_FUNCTION">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.DEPRECIATION_BY_FUNCTION">[docs]</a>
    <span class="n">DEPRECIATION_BY_FUNCTION</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_depreciation_by_function_sched219&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.CASH_FLOWS">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.CASH_FLOWS">[docs]</a>
    <span class="n">CASH_FLOWS</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_cash_flows_sched120&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.SALES_BY_RATE_SCHEDULES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.SALES_BY_RATE_SCHEDULES">[docs]</a>
    <span class="n">SALES_BY_RATE_SCHEDULES</span> <span class="o">=</span> <span class="s2">&quot;core_ferc1__yearly_sales_by_rate_schedules_sched304&quot;</span></div>

<div class="viewcode-block" id="TableIdFerc1.OTHER_REGULATORY_LIABILITIES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TableIdFerc1.OTHER_REGULATORY_LIABILITIES">[docs]</a>
    <span class="n">OTHER_REGULATORY_LIABILITIES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;core_ferc1__yearly_other_regulatory_liabilities_sched278&quot;</span>
    <span class="p">)</span></div>
</div>



<span class="c1">################################################################################</span>
<span class="c1"># FERC 1 specific Column, MultiColumn, and Table Transform Functions</span>
<span class="c1">################################################################################</span>


<div class="viewcode-block" id="RenameColumnsFerc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RenameColumnsFerc1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RenameColumnsFerc1</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dictionaries for renaming either XBRL or DBF derived FERC 1 columns.</span>

<span class="sd">    This is FERC 1 specific, because we need to store both DBF and XBRL rename</span>
<span class="sd">    dictionaries separately. Note that this parameter model does not have its own unique</span>
<span class="sd">    transform function. Like the generic :class:`pudl.transform.classes.RenameColumns`</span>
<span class="sd">    it depends on the build in :meth:`pd.rename` method, which is called with the values</span>
<span class="sd">    DBF or XBRL parameters depending on the context.</span>

<span class="sd">    Potential parameters validations that could be implemented</span>

<span class="sd">    * Validate that all keys appear in the original dbf/xbrl sources.</span>
<span class="sd">      This has to be true, but right now we don&#39;t have stored metadata enumerating all</span>
<span class="sd">      of the columns that exist in the raw data, so we don&#39;t have anything to check</span>
<span class="sd">      against. Implement once when we have schemas defined for after the extract step.</span>

<span class="sd">    * Validate all values appear in PUDL tables, and all expected PUDL names are mapped.</span>
<span class="sd">      Actually we can&#39;t require that the rename values appear in the PUDL tables,</span>
<span class="sd">      because there will be cases in which the original column gets dropped or modified,</span>
<span class="sd">      e.g. in the case of unit conversions with a column rename.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RenameColumnsFerc1.dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RenameColumnsFerc1.dbf">[docs]</a>
    <span class="n">dbf</span><span class="p">:</span> <span class="n">RenameColumns</span> <span class="o">=</span> <span class="n">RenameColumns</span><span class="p">()</span></div>

<div class="viewcode-block" id="RenameColumnsFerc1.xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RenameColumnsFerc1.xbrl">[docs]</a>
    <span class="n">xbrl</span><span class="p">:</span> <span class="n">RenameColumns</span> <span class="o">=</span> <span class="n">RenameColumns</span><span class="p">()</span></div>

<div class="viewcode-block" id="RenameColumnsFerc1.duration_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RenameColumnsFerc1.duration_xbrl">[docs]</a>
    <span class="n">duration_xbrl</span><span class="p">:</span> <span class="n">RenameColumns</span> <span class="o">=</span> <span class="n">RenameColumns</span><span class="p">()</span></div>

<div class="viewcode-block" id="RenameColumnsFerc1.instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RenameColumnsFerc1.instant_xbrl">[docs]</a>
    <span class="n">instant_xbrl</span><span class="p">:</span> <span class="n">RenameColumns</span> <span class="o">=</span> <span class="n">RenameColumns</span><span class="p">()</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="RenameColumnsFerc1.rename_dicts_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RenameColumnsFerc1.rename_dicts_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_dicts_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile all of the XBRL rename dictionaries into an ordered list.&quot;&quot;&quot;</span>
        <span class="c1"># add the xbrl last bc it happens after the inst/dur renames</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">duration_xbrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instant_xbrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbrl</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="WideToTidy">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WideToTidy</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for converting a wide table to a tidy table with value types.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WideToTidy.idx_cols">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidy.idx_cols">[docs]</a>
    <span class="n">idx_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of column names to treat as the table index.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WideToTidy.stacked_column_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidy.stacked_column_name">[docs]</a>
    <span class="n">stacked_column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of column that will contain the stacked categories.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WideToTidy.value_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidy.value_types">[docs]</a>
    <span class="n">value_types</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of names of value types that will end up being the column names.</span>

<span class="sd">    Some of the FERC tables have multiple data types spread across many different</span>
<span class="sd">    categories.  In the input dataframe given to :func:`wide_to_tidy`, the value types</span>
<span class="sd">    must be the suffixes of the column names. If the table does not natively have the</span>
<span class="sd">    pattern of &quot;{to-be stacked category}_{value_type}&quot;, rename the columns using a</span>
<span class="sd">    ``rename_columns.duration_xbrl``, ``rename_columns.instant_xbrl`` or</span>
<span class="sd">    ``rename_columns.dbf`` parameter which will be employed in</span>
<span class="sd">    :meth:`process_duration_xbrl`, :meth:`process_instant_xbrl` or :meth:`process_dbf`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WideToTidy.expected_drop_cols">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidy.expected_drop_cols">[docs]</a>
    <span class="n">expected_drop_cols</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;The number of columns that are expected to be dropped.</span>

<span class="sd">    :func:`wide_to_tidy_xbrl` will generate a regex pattern assuming the ``value_types``</span>
<span class="sd">    are the column name&#39;s suffixes. If a column does not conform to that pattern, it</span>
<span class="sd">    will be filtered out. This is helpful for us to not include a bunch of columns from</span>
<span class="sd">    the input dataframe incorrectly included in the stacking process. We could enumerate</span>
<span class="sd">    every column that we want to drop, but this could be tedious and potentially error</span>
<span class="sd">    prone. But this does mean that if a column is incorrectly named - or barely missing</span>
<span class="sd">    the pattern, it will be dropped. This parameter enables us to lock the number of</span>
<span class="sd">    expected columns. If the dropped columns are a different number, an error will be</span>
<span class="sd">    raised.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="WideToTidySourceFerc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidySourceFerc1">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WideToTidySourceFerc1</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for converting either or both XBRL and DBF table from wide to tidy.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="WideToTidySourceFerc1.xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidySourceFerc1.xbrl">[docs]</a>
    <span class="n">xbrl</span><span class="p">:</span> <span class="n">WideToTidy</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">WideToTidy</span><span class="p">]</span> <span class="o">=</span> <span class="n">WideToTidy</span><span class="p">()</span></div>

<div class="viewcode-block" id="WideToTidySourceFerc1.dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidySourceFerc1.dbf">[docs]</a>
    <span class="n">dbf</span><span class="p">:</span> <span class="n">WideToTidy</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">WideToTidy</span><span class="p">]</span> <span class="o">=</span> <span class="n">WideToTidy</span><span class="p">()</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="WideToTidySourceFerc1.value_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.WideToTidySourceFerc1.value_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">value_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile a list of all of the ``value_types`` from ``wide_to_tidy``.&quot;&quot;&quot;</span>
        <span class="c1"># each wtt source could be either a list of WideToTidy or a WideToTidy.</span>
        <span class="c1"># so we need to drill in to either grab the value_types</span>
        <span class="n">value_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wide_to_tidy</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xbrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbf</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wide_to_tidy</span><span class="p">,</span> <span class="n">WideToTidy</span><span class="p">):</span>
                <span class="n">value_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wide_to_tidy</span><span class="o">.</span><span class="n">value_types</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wide_to_tidy</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rly_wide_to_tidy</span> <span class="ow">in</span> <span class="n">wide_to_tidy</span><span class="p">:</span>
                    <span class="n">value_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rly_wide_to_tidy</span><span class="o">.</span><span class="n">value_types</span><span class="p">)</span>
        <span class="c1"># remove None&#39;s &amp; flatten/dedupe</span>
        <span class="n">value_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value_types</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">flattened_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">flattened_values</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">flattened_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flattened_values</span></div>
</div>



<div class="viewcode-block" id="wide_to_tidy">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.wide_to_tidy">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">wide_to_tidy</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">WideToTidy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reshape wide tables with FERC account columns to tidy format.</span>

<span class="sd">    The XBRL table coming into this method could contain all the data from both the</span>
<span class="sd">    instant and duration tables in a wide format -- with one column for every</span>
<span class="sd">    combination of value type (e.g. additions, ending_balance) and value category, which</span>
<span class="sd">    means ~500 columns for some tables.</span>

<span class="sd">    We tidy this into a long table with one column for each of the value types in</span>
<span class="sd">    ``params.value_types`` and a new column named ``xbrl_factoid`` that contains</span>
<span class="sd">    categories that were previously the XBRL column name stems.</span>

<span class="sd">    This allows aggregations of multiple ``xbrl_factoid`` categories in a columnar</span>
<span class="sd">    fashion such as aggregation across groups of rows to total up various hierarchical</span>
<span class="sd">    accounting categories (hydraulic turbines -&gt; hydraulic production plant -&gt; all</span>
<span class="sd">    production plant -&gt; all electric utility plant) though the categorical columns</span>
<span class="sd">    required for that aggregation are added later.</span>

<span class="sd">    For table that have a internal relationship between the values in the</span>
<span class="sd">    ``params.value_types``, such as the :ref:`core_ferc1__yearly_plant_in_service_sched204` table, this also</span>
<span class="sd">    enables aggregation across columns to calculate the ending balance based on the</span>
<span class="sd">    starting balance and all of the reported changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">value_types</span><span class="p">)</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(^.*)_(&quot;</span> <span class="o">+</span> <span class="n">suffixes</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$)&quot;</span>
    <span class="c1"># filter out any columns that don&#39;t match the pattern</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">idx_cols</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">pat</span><span class="p">)</span>
    <span class="c1"># check if there are unexpected columns being dropped</span>
    <span class="n">dropped_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dropping: </span><span class="si">{</span><span class="n">dropped_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">expected_drop_cols</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropped_cols</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unexpected number of columns dropped: (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dropped_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">) instead of &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">expected_drop_cols</span><span class="si">}</span><span class="s2">). Columns dropped: </span><span class="si">{</span><span class="n">dropped_cols</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">new_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\2&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_out</span><span class="o">.</span><span class="n">columns</span><span class="p">],</span>
        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">stacked_column_name</span><span class="p">,</span> <span class="s2">&quot;value_type&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_cols</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df_out</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">stacked_column_name</span><span class="p">,</span> <span class="n">future_stack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">params</span><span class="o">.</span><span class="n">value_types</span><span class="p">]</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="c1"># remove the name of the columns which was the name of the renaming layer of the</span>
    <span class="c1"># multi-index</span>
    <span class="n">df_out</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">df_out</span></div>



<div class="viewcode-block" id="MergeXbrlMetadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MergeXbrlMetadata">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MergeXbrlMetadata</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for merging in XBRL metadata.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MergeXbrlMetadata.rename_columns">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MergeXbrlMetadata.rename_columns">[docs]</a>
    <span class="n">rename_columns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dictionary to rename columns in the normalized metadata before merging.</span>

<span class="sd">    This dictionary will be passed as :func:`pd.DataFrame.rename` ``columns`` parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MergeXbrlMetadata.on">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MergeXbrlMetadata.on">[docs]</a>
    <span class="n">on</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Column name to merge on in :func:`merge_xbrl_metadata`.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="merge_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.merge_xbrl_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_xbrl_metadata</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">xbrl_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">MergeXbrlMetadata</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge metadata based on params.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">xbrl_metadata</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">),</span>
        <span class="n">on</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">on</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="DropDuplicateRowsDbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DropDuplicateRowsDbf">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DropDuplicateRowsDbf</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameter for dropping duplicate DBF rows.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DropDuplicateRowsDbf.table_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DropDuplicateRowsDbf.table_name">[docs]</a>
    <span class="n">table_name</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of table used to grab primary keys of PUDL table to check for duplicates.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DropDuplicateRowsDbf.data_columns">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DropDuplicateRowsDbf.data_columns">[docs]</a>
    <span class="n">data_columns</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of data column names to ensure primary key duplicates have the same data.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="drop_duplicate_rows_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.drop_duplicate_rows_dbf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">drop_duplicate_rows_dbf</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">DropDuplicateRowsDbf</span><span class="p">,</span>
    <span class="n">return_dupes_w_unique_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop duplicate DBF rows if duplicates have identical data or one row has nulls.</span>

<span class="sd">    There are several instances of the DBF data reporting the same value on multiple</span>
<span class="sd">    rows. This function checks to see if all of the duplicate values that have the same</span>
<span class="sd">    primary keys have reported the same data or have records with null data in any of</span>
<span class="sd">    the data columns while the other record has complete data. If the duplicates have no</span>
<span class="sd">    unique data, the duplicates are dropped with ``keep=&quot;first&quot;``. If any duplicates do</span>
<span class="sd">    not contain the same data or half null data, an assertion will be raised.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DBF table containing PUDL primary key columns</span>
<span class="sd">        params: an instance of :class:`DropDuplicateRowsDbf`</span>
<span class="sd">        return_dupes_w_unique_data: Boolean flag used for debugging only which returns</span>
<span class="sd">            the duplicates which contain actually unique data instead of raising</span>
<span class="sd">            assertion. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pks</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">from_id</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">table_name</span><span class="o">.</span><span class="n">value</span>
    <span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">primary_key</span>
    <span class="c1"># add a column that indicates whether or not any of the data columns contain null data</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;null_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

    <span class="c1"># checks to make sure the drop is targeted as expected</span>
    <span class="c1"># of the PK dupes, drop all instances when the data *is also the same*</span>
    <span class="n">dupes_w_possible_unique_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
        <span class="n">pks</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">data_columns</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">dupes_w_possible_unique_data</span> <span class="o">=</span> <span class="n">dupes_w_possible_unique_data</span><span class="p">[</span>
        <span class="n">dupes_w_possible_unique_data</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># if there are pk+data dupes, is there one record with some null data</span>
    <span class="c1"># an other with completely non-null data??</span>
    <span class="c1"># OR are there any records that have some null data and some actually unique</span>
    <span class="c1"># data</span>
    <span class="n">nunique_data_columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_nunique&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">data_columns</span><span class="p">]</span>
    <span class="n">dupes_w_possible_unique_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">:,</span> <span class="n">nunique_data_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;null_data_nunique&quot;</span><span class="p">]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">dupes_w_possible_unique_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pks</span><span class="p">)[</span><span class="n">params</span><span class="o">.</span><span class="n">data_columns</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;null_data&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;nunique&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_nunique&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">dupes_w_unique_data</span> <span class="o">=</span> <span class="n">dupes_w_possible_unique_data</span><span class="p">[</span>
        <span class="p">(</span><span class="n">dupes_w_possible_unique_data</span><span class="o">.</span><span class="n">null_data_nunique</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span>
            <span class="n">dupes_w_possible_unique_data</span><span class="p">[</span>
                <span class="n">dupes_w_possible_unique_data</span><span class="p">[</span><span class="n">nunique_data_columns</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">pks</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dupes_w_unique_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_dupes_w_unique_data</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Returning duplicate records for debugging.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dupes_w_unique_data</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Duplicates have unique data and should not be dropped. Unique data: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dupes_w_unique_data</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="si">{</span><span class="n">dupes_w_unique_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">pks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">len_og</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;null_data&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;null_data&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Dropped </span><span class="si">{</span><span class="n">len_og</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate records: </span><span class="si">{</span><span class="p">(</span><span class="n">len_og</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">len_og</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="s2">&quot; of total rows.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="AlignRowNumbersDbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AlignRowNumbersDbf">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AlignRowNumbersDbf</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for aligning DBF row numbers with metadata from manual maps.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AlignRowNumbersDbf.dbf_table_names">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AlignRowNumbersDbf.dbf_table_names">[docs]</a>
    <span class="n">dbf_table_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;DBF table to use to grab the row map in :func:`align_row_numbers_dbf`.</span>

<span class="sd">    Default is ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="align_row_numbers_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.align_row_numbers_dbf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">align_row_numbers_dbf</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">AlignRowNumbersDbf</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rename the xbrl_factoid column after :meth:`align_row_numbers_dbf`.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dbf_table_names</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Aligning row numbers from DBF row to XBRL map for </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">dbf_table_names</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">row_map</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">read_dbf_to_xbrl_map</span><span class="p">(</span><span class="n">dbf_table_names</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dbf_table_names</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fill_dbf_to_xbrl_map</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;row_literal&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">row_map</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Filled DBF-XBRL map contains NA values, which should never happen:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row_map</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">row_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;row_number&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Found null row labels after aligning DBF/XBRL rows.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># eliminate the header rows since they (should!) contain no data in either the</span>
        <span class="c1"># DBF or XBRL records:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">!=</span> <span class="s2">&quot;HEADER_ROW&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="SelectDbfRowsByCategory">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SelectDbfRowsByCategory">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SelectDbfRowsByCategory</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for :func:`select_dbf_rows_by_category`.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SelectDbfRowsByCategory.column_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SelectDbfRowsByCategory.column_name">[docs]</a>
    <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;The column name containing categories to select by.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SelectDbfRowsByCategory.select_by_xbrl_categories">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SelectDbfRowsByCategory.select_by_xbrl_categories">[docs]</a>
    <span class="n">select_by_xbrl_categories</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Boolean flag to indicate whether or not to use the categories in the XBRL table.</span>

<span class="sd">    If True, :func:`select_dbf_rows_by_category` will find the list of categories that</span>
<span class="sd">    exist in the passed in ``processed_xbrl`` to select by.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SelectDbfRowsByCategory.additional_categories">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SelectDbfRowsByCategory.additional_categories">[docs]</a>
    <span class="n">additional_categories</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of additional categories to select by.</span>

<span class="sd">    If ``select_by_xbrl_categories`` is ``True``, these categories will be added to the</span>
<span class="sd">    XBRL categories and both will be used to select rows from the DBF data. If</span>
<span class="sd">    ``select_by_xbrl_categories`` is ``False``, only the &quot;additional&quot; categories will be</span>
<span class="sd">    the used to select rows from the DBF data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SelectDbfRowsByCategory.len_expected_categories_to_drop">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SelectDbfRowsByCategory.len_expected_categories_to_drop">[docs]</a>
    <span class="n">len_expected_categories_to_drop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of categories that are expected to be dropped from the DBF data.</span>

<span class="sd">    This is here to ensure no unexpected manipulations to the categories have occurred. A</span>
<span class="sd">    warning will be flagged if this number is different than the number of categories</span>
<span class="sd">    that are being dropped.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="select_dbf_rows_by_category">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.select_dbf_rows_by_category">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_dbf_rows_by_category</span><span class="p">(</span>
    <span class="n">processed_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">processed_xbrl</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">SelectDbfRowsByCategory</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select DBF rows with values listed or found in XBRL in a categorical-like column.</span>

<span class="sd">    The XBRL data often breaks out sub-sections of DBF tables into their own table.</span>
<span class="sd">    These breakout tables are often messy, unstructured portions of a particular</span>
<span class="sd">    schedule or page on the FERC1 PDF. We often want to preserve some of the ways the</span>
<span class="sd">    XBRL data is segmented so we need to be able to select only portions of the DBF</span>
<span class="sd">    table to be concatenated with the XBRL data.</span>

<span class="sd">    In mapping DBF data to XBRL data for the tables that rely on their ``row_number``</span>
<span class="sd">    we map each row to its corresponding ``xbrl_factoid``. The standard use of this</span>
<span class="sd">    transformer is to use the ``column_name`` that corresponds to the ``xbrl_factoid``</span>
<span class="sd">    that was merged into the DBF data via :func:`align_row_numbers_dbf` and was</span>
<span class="sd">    converted into a column in the XBRL data via :func:`wide_to_tidy`.</span>

<span class="sd">    Note: Often, the unstructured portion of the DBF table that (possibly) sums up into</span>
<span class="sd">    a single value in structured data has the same ``xbrl_factoid`` name in the XBRL</span>
<span class="sd">    tables. By convention, we are employing a pattern in the ``dbf_to_xbrl.csv`` map</span>
<span class="sd">    that involves adding an ``_unstructed`` suffix to the rows that correspond to the</span>
<span class="sd">    unstructured portion of the table. This enables a simple selection of the structured</span>
<span class="sd">    part of the table. When processing the unstructured table, you can either rename the</span>
<span class="sd">    XBRL data&#39;s factoid name to include an ``_unstructed`` suffix or you can specify</span>
<span class="sd">    the categories with ``_unstructed`` suffixes using the ``additional_categories``</span>
<span class="sd">    parameter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compile the list of categories from the possible options.</span>
    <span class="n">categories_to_select</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">select_by_xbrl_categories</span><span class="p">:</span>
        <span class="n">categories_to_select</span> <span class="o">=</span> <span class="n">categories_to_select</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">processed_xbrl</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">additional_categories</span><span class="p">:</span>
        <span class="n">categories_to_select</span> <span class="o">=</span> <span class="n">categories_to_select</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">additional_categories</span>

    <span class="c1"># check if we are getting the same number of expected categories to drop</span>
    <span class="n">categories_to_drop</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">cat</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">processed_dbf</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories_to_select</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categories_to_drop</span><span class="p">)</span> <span class="o">!=</span> <span class="n">params</span><span class="o">.</span><span class="n">len_expected_categories_to_drop</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">categories_to_drop</span><span class="p">)</span><span class="si">}</span><span class="s2"> DBF categories that contain the &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;following values in </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">column_name</span><span class="si">}</span><span class="s2"> but expected &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">len_expected_categories_to_drop</span><span class="si">}</span><span class="s2">:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categories_to_drop</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="c1"># now select only the rows which contain the categories we want to include in the</span>
    <span class="c1"># column that we care about. Copy bc this is a slice of the og dataframe.</span>
    <span class="n">category_mask</span> <span class="o">=</span> <span class="n">processed_dbf</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">categories_to_select</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">processed_dbf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">category_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>



<div class="viewcode-block" id="UnstackBalancesToReportYearInstantXbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UnstackBalancesToReportYearInstantXbrl">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UnstackBalancesToReportYearInstantXbrl</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for :func:`unstack_balances_to_report_year_instant_xbrl`.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="UnstackBalancesToReportYearInstantXbrl.unstack_balances_to_report_year">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UnstackBalancesToReportYearInstantXbrl.unstack_balances_to_report_year">[docs]</a>
    <span class="n">unstack_balances_to_report_year</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;If True unstack balances to a single year (the report year).&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="unstack_balances_to_report_year_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.unstack_balances_to_report_year_instant_xbrl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unstack_balances_to_report_year_instant_xbrl</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">UnstackBalancesToReportYearInstantXbrl</span><span class="p">,</span>
    <span class="n">primary_key_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turn start year end year rows into columns for each value type.</span>

<span class="sd">    Called in :meth:`Ferc1AbstractTableTransformer.process_instant_xbrl`.</span>

<span class="sd">    Some instant tables report year-end data, with their datestamps in different years,</span>
<span class="sd">    but we want year-start and year-end data within a single report_year (which is</span>
<span class="sd">    equivalent) stored in two separate columns for compatibility with the DBF data.</span>

<span class="sd">    This function unstacks that table and adds the suffixes ``_starting_balance`` and</span>
<span class="sd">    ``_ending_balance`` to each of the columns. These can then be used as</span>
<span class="sd">    ``value_types`` in :func:`wide_to_tidy` to normalize the table.</span>

<span class="sd">    There are two checks in place:</span>

<span class="sd">    First, it will make sure that there are not duplicate entries for a single year +</span>
<span class="sd">    other primary key fields. Ex: a row for 2020-12-31 and 2020-06-30 for entity_id X</span>
<span class="sd">    means that the data isn&#39;t annually unique. We could just drop these mid-year</span>
<span class="sd">    values, but we might want to keep them or at least check that there is no funny</span>
<span class="sd">    business with the data.</span>

<span class="sd">    We also check that there are no mid-year dates at all. If an entity reports a value</span>
<span class="sd">    from the middle of the year, we can&#39;t identify it as a start/end of year value.</span>

<span class="sd">    Params:</span>
<span class="sd">        primary_key_cols: The columns that should be used to check for duplicated data,</span>
<span class="sd">            and also for unstacking the balance -- these are set to be the index before</span>
<span class="sd">            unstack is called. These are typically set by the wrapping method and</span>
<span class="sd">            generated automatically based on other class transformation parameters via</span>
<span class="sd">            :meth:`Ferc1AbstractTableTransformer.source_table_primary_key`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">unstack_balances_to_report_year</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># report year always corresponds to the year of &quot;date&quot;</span>
    <span class="n">unique_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">primary_key_cols</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s2">&quot;report_year&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">unique_cols</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Looks like there are multiple entries per year--not sure which to use &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;for the start/end balance. </span><span class="si">{</span><span class="n">params</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">primary_key_cols</span><span class="si">=}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">is_year_end</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Looks like there are some values in here that aren&#39;t from the end of &quot;</span>
            <span class="s2">&quot;the year. We can&#39;t use those to calculate start and end balances.&quot;</span>
        <span class="p">)</span>

    <span class="n">ending_balances</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">balance_type</span><span class="o">=</span><span class="s2">&quot;ending_balance&quot;</span><span class="p">)</span>
    <span class="n">starting_balances</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">report_year</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">balance_type</span><span class="o">=</span><span class="s2">&quot;starting_balance&quot;</span>
    <span class="p">)</span>
    <span class="n">all_balances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">starting_balances</span><span class="p">,</span> <span class="n">ending_balances</span><span class="p">])</span>
    <span class="c1"># for the first year, we expect no starting balances; for the last year, we expect no ending balances.</span>
    <span class="n">first_last_year_stripped</span> <span class="o">=</span> <span class="n">all_balances</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">isin</span><span class="p">({</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">max</span><span class="p">()})</span>
    <span class="p">]</span>
    <span class="n">unstacked_by_year</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">first_last_year_stripped</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">primary_key_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;balance_type&quot;</span><span class="p">,</span> <span class="s2">&quot;sched_table_name&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="s2">&quot;balance_type&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># munge multi-index into flat index, separated by _</span>
    <span class="n">unstacked_by_year</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">unstacked_by_year</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_flat_index</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">unstacked_by_year</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>



<div class="viewcode-block" id="CombineAxisColumnsXbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CombineAxisColumnsXbrl">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CombineAxisColumnsXbrl</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for :func:`combine_axis_columns_xbrl`.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CombineAxisColumnsXbrl.axis_columns_to_combine">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CombineAxisColumnsXbrl.axis_columns_to_combine">[docs]</a>
    <span class="n">axis_columns_to_combine</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;List of axis columns to combine.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CombineAxisColumnsXbrl.new_axis_column_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CombineAxisColumnsXbrl.new_axis_column_name">[docs]</a>
    <span class="n">new_axis_column_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;The name of the combined axis column -- must end with the suffix ``_axis``!.&quot;&quot;&quot;</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;new_axis_column_name&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="CombineAxisColumnsXbrl.doesnt_end_with_axis">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CombineAxisColumnsXbrl.doesnt_end_with_axis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">doesnt_end_with_axis</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure that new axis column ends in _axis.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_axis&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The new axis column name must end with the suffix &#39;_axis&#39;!&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span></div>
</div>



<div class="viewcode-block" id="combine_axis_columns_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.combine_axis_columns_xbrl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">combine_axis_columns_xbrl</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">CombineAxisColumnsXbrl</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine axis columns from squished XBRL tables into one column with no NAs.</span>

<span class="sd">    Called in :meth:`Ferc1AbstractTableTransformer.process_xbrl`.</span>

<span class="sd">    There are instances (ex: sales_by_rate_schedule_ferc1) where the DBF table is equal</span>
<span class="sd">    to several concatenated XBRL tables. These XBRL tables are extracted together with</span>
<span class="sd">    the function :func:`extract_xbrl_concat`. Once combined, we need to deal with their</span>
<span class="sd">    axis columns.</span>

<span class="sd">    We use the axis columns (the primary key for the raw XBRL tables) in the creation</span>
<span class="sd">    of ``record_id``s for each of the rows. If each of the concatenated XBRL tables has</span>
<span class="sd">    the same axis column name then there&#39;s no need to fret. However, if the columns have</span>
<span class="sd">    slightly different names (ex: ``residential_sales_axis`` vs.</span>
<span class="sd">    ``industrial_sales_axis``), we&#39;ll need to combine them. We combine them to get rid</span>
<span class="sd">    of NA values which aren&#39;t allowed in primary keys. Otherwise it would look like</span>
<span class="sd">    this:</span>

<span class="sd">        +-------------------------+-------------------------+</span>
<span class="sd">        | residential_sales_axis  | industrial_sales_axis   |</span>
<span class="sd">        +=========================+=========================+</span>
<span class="sd">        | value1                  | NA                      |</span>
<span class="sd">        +-------------------------+-------------------------+</span>
<span class="sd">        | value2                  | NA                      |</span>
<span class="sd">        +-------------------------+-------------------------+</span>
<span class="sd">        | NA                      | valueA                  |</span>
<span class="sd">        +-------------------------+-------------------------+</span>
<span class="sd">        | NA                      | valueB                  |</span>
<span class="sd">        +-------------------------+-------------------------+</span>

<span class="sd">    vs. this:</span>

<span class="sd">        +-------------------------+</span>
<span class="sd">        | sales_axis              |</span>
<span class="sd">        +=========================+</span>
<span class="sd">        | value1                  |</span>
<span class="sd">        +-------------------------+</span>
<span class="sd">        | value2                  |</span>
<span class="sd">        +-------------------------+</span>
<span class="sd">        | valueA                  |</span>
<span class="sd">        +-------------------------+</span>
<span class="sd">        | valueB                  |</span>
<span class="sd">        +-------------------------+</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, make sure that the new_axis_column_name param as the word axis in it</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">new_axis_column_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_axis&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Your new_axis_column_name must end with the suffix _axis so that it gets &quot;</span>
            <span class="s2">&quot;included in the record_id.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Now, make sure there are no overlapping axis columns</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">axis_columns_to_combine</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;You&#39;re trying to combine axis columns, but there&#39;s more than one axis &quot;</span>
            <span class="s2">&quot;column value per row.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Now combine all of the columns into one and remove the old axis columns</span>
    <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">new_axis_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">axis_columns_to_combine</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">new_axis_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">new_axis_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">axis_columns_to_combine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="AssignQuarterlyDataToYearlyDbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AssignQuarterlyDataToYearlyDbf">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AssignQuarterlyDataToYearlyDbf</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for transferring quarterly reported data to annual columns.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AssignQuarterlyDataToYearlyDbf.quarterly_to_yearly_column_map">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AssignQuarterlyDataToYearlyDbf.quarterly_to_yearly_column_map">[docs]</a>
    <span class="n">quarterly_to_yearly_column_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="AssignQuarterlyDataToYearlyDbf.quarterly_filed_years">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AssignQuarterlyDataToYearlyDbf.quarterly_filed_years">[docs]</a>
    <span class="n">quarterly_filed_years</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="assign_quarterly_data_to_yearly_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.assign_quarterly_data_to_yearly_dbf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assign_quarterly_data_to_yearly_dbf</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">AssignQuarterlyDataToYearlyDbf</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transfer 4th quarter reported data to the annual columns.</span>

<span class="sd">    For some reason in the dbf data for this table reported all of the</span>
<span class="sd">    balance data as quarterly data between specific years. We already choose</span>
<span class="sd">    the end of the year in :meth:`select_annual_rows_dbf`. This ensures that</span>
<span class="sd">    by this point, any quarterly data remaining in the input dataframe pertains</span>
<span class="sd">    to the 4th quarter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bad_years_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">quarterly_filed_years</span><span class="p">)</span>
    <span class="c1"># ensure this filling in treatment is necessary!</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_years_mask</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">quarterly_to_yearly_column_map</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
        <span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;We expected that all balance data in years </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">quarterly_filed_years</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;to be all null. Found non-null records, so the annual columns may no &quot;</span>
            <span class="s2">&quot;longer need to be filled in with quarterly data.&quot;</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">quarterly_col</span><span class="p">,</span> <span class="n">yearly_col</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">quarterly_to_yearly_column_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_years_mask</span><span class="p">,</span> <span class="n">yearly_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_years_mask</span><span class="p">,</span> <span class="n">quarterly_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="AddColumnWithUniformValue">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AddColumnWithUniformValue">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AddColumnWithUniformValue</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for adding a column to a table with a single value.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AddColumnWithUniformValue.column_value">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AddColumnWithUniformValue.column_value">[docs]</a>
    <span class="n">column_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AddColumnWithUniformValue.is_dimension">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AddColumnWithUniformValue.is_dimension">[docs]</a>
    <span class="n">is_dimension</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="AddColumnsWithUniformValues">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AddColumnsWithUniformValues">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AddColumnsWithUniformValues</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for adding columns to a table with a single value.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="AddColumnsWithUniformValues.columns_to_add">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AddColumnsWithUniformValues.columns_to_add">[docs]</a>
    <span class="n">columns_to_add</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AddColumnWithUniformValue</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="s2">&quot;Dictionary of column names (keys) with :class:`AddColumnWithUniformValue` (values)&quot;</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="AddColumnsWithUniformValues.assign_cols">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AddColumnsWithUniformValues.assign_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary of column_name (key) to uniform value (value) to use with pd.assign.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">col</span><span class="p">:</span> <span class="n">col_info</span><span class="o">.</span><span class="n">column_value</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col_info</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns_to_add</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="add_columns_with_uniform_values">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.add_columns_with_uniform_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_columns_with_uniform_values</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">AddColumnsWithUniformValues</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a column to a table with a single value.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="o">.</span><span class="n">assign_cols</span><span class="p">)</span></div>



<div class="viewcode-block" id="IsCloseTolerance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IsCloseTolerance">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IsCloseTolerance</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Info for testing a particular check.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IsCloseTolerance.isclose_rtol">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IsCloseTolerance.isclose_rtol">[docs]</a>
    <span class="n">isclose_rtol</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e-5</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Relative tolerance to use in :func:`np.isclose` for determining equality.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IsCloseTolerance.isclose_atol">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IsCloseTolerance.isclose_atol">[docs]</a>
    <span class="n">isclose_atol</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1e-8</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Absolute tolerance to use in :func:`np.isclose` for determining equality.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="CalculationIsCloseTolerance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CalculationIsCloseTolerance">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CalculationIsCloseTolerance</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calc params organized by check type.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CalculationIsCloseTolerance.error_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CalculationIsCloseTolerance.error_frequency">[docs]</a>
    <span class="n">error_frequency</span><span class="p">:</span> <span class="n">IsCloseTolerance</span> <span class="o">=</span> <span class="n">IsCloseTolerance</span><span class="p">()</span></div>

<div class="viewcode-block" id="CalculationIsCloseTolerance.relative_error_magnitude">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CalculationIsCloseTolerance.relative_error_magnitude">[docs]</a>
    <span class="n">relative_error_magnitude</span><span class="p">:</span> <span class="n">IsCloseTolerance</span> <span class="o">=</span> <span class="n">IsCloseTolerance</span><span class="p">(</span><span class="n">isclose_atol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculationIsCloseTolerance.null_calculated_value_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CalculationIsCloseTolerance.null_calculated_value_frequency">[docs]</a>
    <span class="n">null_calculated_value_frequency</span><span class="p">:</span> <span class="n">IsCloseTolerance</span> <span class="o">=</span> <span class="n">IsCloseTolerance</span><span class="p">()</span></div>

<div class="viewcode-block" id="CalculationIsCloseTolerance.absolute_error_magnitude">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CalculationIsCloseTolerance.absolute_error_magnitude">[docs]</a>
    <span class="n">absolute_error_magnitude</span><span class="p">:</span> <span class="n">IsCloseTolerance</span> <span class="o">=</span> <span class="n">IsCloseTolerance</span><span class="p">()</span></div>

<div class="viewcode-block" id="CalculationIsCloseTolerance.null_reported_value_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CalculationIsCloseTolerance.null_reported_value_frequency">[docs]</a>
    <span class="n">null_reported_value_frequency</span><span class="p">:</span> <span class="n">IsCloseTolerance</span> <span class="o">=</span> <span class="n">IsCloseTolerance</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="MetricTolerances">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MetricTolerances">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MetricTolerances</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tolerances for all data checks to be preformed within a grouped df.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MetricTolerances.error_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MetricTolerances.error_frequency">[docs]</a>
    <span class="n">error_frequency</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.01</span></div>

<div class="viewcode-block" id="MetricTolerances.relative_error_magnitude">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MetricTolerances.relative_error_magnitude">[docs]</a>
    <span class="n">relative_error_magnitude</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.2</span></div>

<div class="viewcode-block" id="MetricTolerances.null_calculated_value_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MetricTolerances.null_calculated_value_frequency">[docs]</a>
    <span class="n">null_calculated_value_frequency</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.7</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fraction of records with non-null reported values and null calculated values.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="MetricTolerances.absolute_error_magnitude">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MetricTolerances.absolute_error_magnitude">[docs]</a>
    <span class="n">absolute_error_magnitude</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span></div>

<div class="viewcode-block" id="MetricTolerances.null_reported_value_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.MetricTolerances.null_reported_value_frequency">[docs]</a>
    <span class="n">null_reported_value_frequency</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Field</span><span class="p">(</span><span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.0</span></div>
</div>

    <span class="c1"># ooof this one is just bad</span>


<div class="viewcode-block" id="GroupMetricTolerances">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricTolerances">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GroupMetricTolerances</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data quality expectations related to FERC 1 calculations.</span>

<span class="sd">    We are doing a lot of comparisons between calculated and reported values to identify</span>
<span class="sd">    reporting errors in the data, errors in FERC&#39;s metadata, and bugs in our own code.</span>
<span class="sd">    This class provides a structure for encoding our expectations about the level of</span>
<span class="sd">    acceptable (or at least expected) errors, and allows us to pass them around.</span>

<span class="sd">    In the future we might also want to specify much more granular expectations,</span>
<span class="sd">    pertaining to individual tables, years, utilities, or facts to ensure that we don&#39;t</span>
<span class="sd">    have low overall error rates, but a problem with the way the data or metadata is</span>
<span class="sd">    reported in a particular year.  We could also define per-filing and per-table error</span>
<span class="sd">    tolerances to help us identify individual utilities that have e.g. used an outdated</span>
<span class="sd">    version of Form 1 when filing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GroupMetricTolerances.ungrouped">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricTolerances.ungrouped">[docs]</a>
    <span class="n">ungrouped</span><span class="p">:</span> <span class="n">MetricTolerances</span> <span class="o">=</span> <span class="n">MetricTolerances</span><span class="p">(</span>
        <span class="n">error_frequency</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
        <span class="n">relative_error_magnitude</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>
        <span class="n">null_calculated_value_frequency</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
        <span class="n">null_reported_value_frequency</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="GroupMetricTolerances.xbrl_factoid">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricTolerances.xbrl_factoid">[docs]</a>
    <span class="n">xbrl_factoid</span><span class="p">:</span> <span class="n">MetricTolerances</span> <span class="o">=</span> <span class="n">MetricTolerances</span><span class="p">(</span>
        <span class="n">error_frequency</span><span class="o">=</span><span class="mf">0.018</span><span class="p">,</span>
        <span class="n">null_calculated_value_frequency</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="GroupMetricTolerances.utility_id_ferc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricTolerances.utility_id_ferc1">[docs]</a>
    <span class="n">utility_id_ferc1</span><span class="p">:</span> <span class="n">MetricTolerances</span> <span class="o">=</span> <span class="n">MetricTolerances</span><span class="p">(</span>
        <span class="n">error_frequency</span><span class="o">=</span><span class="mf">0.038</span><span class="p">,</span>
        <span class="n">null_calculated_value_frequency</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="GroupMetricTolerances.report_year">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricTolerances.report_year">[docs]</a>
    <span class="n">report_year</span><span class="p">:</span> <span class="n">MetricTolerances</span> <span class="o">=</span> <span class="n">MetricTolerances</span><span class="p">(</span>
        <span class="n">error_frequency</span><span class="o">=</span><span class="mf">0.006</span><span class="p">,</span>
        <span class="n">null_calculated_value_frequency</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="GroupMetricTolerances.table_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricTolerances.table_name">[docs]</a>
    <span class="n">table_name</span><span class="p">:</span> <span class="n">MetricTolerances</span> <span class="o">=</span> <span class="n">MetricTolerances</span><span class="p">(</span>
        <span class="n">error_frequency</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
        <span class="n">relative_error_magnitude</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">null_calculated_value_frequency</span><span class="o">=</span><span class="mf">0.50</span><span class="p">,</span>
        <span class="n">null_reported_value_frequency</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span>
    <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GroupMetricChecks">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricChecks">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GroupMetricChecks</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Input for checking calculations organized by group and test.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GroupMetricChecks.groups_to_check">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricChecks.groups_to_check">[docs]</a>
    <span class="n">groups_to_check</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span>
        <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;ungrouped&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span>
        <span class="p">]</span>
    <span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;ungrouped&quot;</span><span class="p">,</span>
        <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
        <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
    <span class="p">]</span></div>

<div class="viewcode-block" id="GroupMetricChecks.metrics_to_check">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricChecks.metrics_to_check">[docs]</a>
    <span class="n">metrics_to_check</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;error_frequency&quot;</span><span class="p">,</span>
        <span class="s2">&quot;relative_error_magnitude&quot;</span><span class="p">,</span>
        <span class="s2">&quot;null_calculated_value_frequency&quot;</span><span class="p">,</span>
        <span class="s2">&quot;null_reported_value_frequency&quot;</span><span class="p">,</span>
    <span class="p">]</span></div>

<div class="viewcode-block" id="GroupMetricChecks.group_metric_tolerances">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricChecks.group_metric_tolerances">[docs]</a>
    <span class="n">group_metric_tolerances</span><span class="p">:</span> <span class="n">GroupMetricTolerances</span> <span class="o">=</span> <span class="n">GroupMetricTolerances</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroupMetricChecks.is_close_tolerance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricChecks.is_close_tolerance">[docs]</a>
    <span class="n">is_close_tolerance</span><span class="p">:</span> <span class="n">CalculationIsCloseTolerance</span> <span class="o">=</span> <span class="n">CalculationIsCloseTolerance</span><span class="p">()</span></div>


    <span class="c1"># TODO: The mechanics of this validation are a pain, given the bajillion combos</span>
    <span class="c1"># of tolerances we have in the matrix of checks. It works, but actually specifying</span>
    <span class="c1"># all of the relative values is not currently ergonomic, so it is disabled for the</span>
    <span class="c1"># moment.</span>
    <span class="c1"># @model_validator(mode=&quot;after&quot;)</span>
<div class="viewcode-block" id="GroupMetricChecks.grouped_tol_ge_ungrouped_tol">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.GroupMetricChecks.grouped_tol_ge_ungrouped_tol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grouped_tol_ge_ungrouped_tol</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grouped tolerance should always be greater than or equal to ungrouped.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups_to_check</span><span class="p">:</span>
            <span class="n">metric_tolerances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_metric_tolerances</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">tolerance</span> <span class="ow">in</span> <span class="n">metric_tolerances</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ungrouped_tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_metric_tolerances</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()[</span>
                    <span class="s2">&quot;ungrouped&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tolerance</span> <span class="o">&lt;</span> <span class="n">ungrouped_tolerance</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="n">group</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">tolerance</span><span class="si">=}</span><span class="s2"> for </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> should be &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;greater than </span><span class="si">{</span><span class="n">ungrouped_tolerance</span><span class="si">=}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>
</div>



<div class="viewcode-block" id="ReconcileTableCalculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ReconcileTableCalculations">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReconcileTableCalculations</span><span class="p">(</span><span class="n">TransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parameters for reconciling xbrl-metadata based calculations within a table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReconcileTableCalculations.column_to_check">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ReconcileTableCalculations.column_to_check">[docs]</a>
    <span class="n">column_to_check</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of data column to check.</span>

<span class="sd">    This will typically be ``dollar_value`` or ``ending_balance`` column for the income</span>
<span class="sd">    statement and the balance sheet tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ReconcileTableCalculations.group_metric_checks">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ReconcileTableCalculations.group_metric_checks">[docs]</a>
    <span class="n">group_metric_checks</span><span class="p">:</span> <span class="n">GroupMetricChecks</span> <span class="o">=</span> <span class="n">GroupMetricChecks</span><span class="p">()</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fraction of calculated values which we allow not to match reported values.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReconcileTableCalculations.subdimension_column">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ReconcileTableCalculations.subdimension_column">[docs]</a>
    <span class="n">subdimension_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sub-dimension column name (e.g. utility type) to compare calculations against in</span>
<span class="sd">    :func:`reconcile_table_calculations`.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReconcileTableCalculations.subdimension_calculation_tolerance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ReconcileTableCalculations.subdimension_calculation_tolerance">[docs]</a>
    <span class="n">subdimension_calculation_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fraction of calculated subdimensions allowed not to match reported values.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReconcileTableCalculations.subdimension_merge_validation">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ReconcileTableCalculations.subdimension_merge_validation">[docs]</a>
    <span class="n">subdimension_merge_validation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span> <span class="s2">&quot;many_to_many&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;one_to_many&quot;</span>
    <span class="p">)</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;For the subdimension calculations, how to merge validate when merging the data</span>
<span class="sd">(left) onto the calculation components (right).&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="reconcile_table_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.reconcile_table_calculations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reconcile_table_calculations</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">calculation_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">xbrl_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">xbrl_factoid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">ReconcileTableCalculations</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure intra-table calculated values match reported values within a tolerance.</span>

<span class="sd">    In addition to checking whether all reported &quot;calculated&quot; values match the output</span>
<span class="sd">    of our repaired calculations, this function adds a correction record to the</span>
<span class="sd">    dataframe that is included in the calculations so that after the fact the</span>
<span class="sd">    calculations match exactly. This is only done when the fraction of records that</span>
<span class="sd">    don&#39;t match within the tolerances of :func:`numpy.isclose` is below a set</span>
<span class="sd">    threshold.</span>

<span class="sd">    Note that only calculations which are off by a significant amount result in the</span>
<span class="sd">    creation of a correction record. Many calculations are off from the reported values</span>
<span class="sd">    by exactly one dollar, presumably due to rounding errors. These records typically</span>
<span class="sd">    do not fail the :func:`numpy.isclose()` test and so are not corrected.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: processed table containing data values to check.</span>
<span class="sd">        calculation_components: processed calculation component metadata.</span>
<span class="sd">        xbrl_metadata: A dataframe of fact-level metadata, required for inferring the</span>
<span class="sd">            sub-dimension total calculations.</span>
<span class="sd">        xbrl_factoid_name: The name of the column which contains XBRL factoid values in</span>
<span class="sd">            the processed table.</span>
<span class="sd">        table_name: name of the PUDL table whose data and metadata is being processed.</span>
<span class="sd">            This is necessary so we can ensure the metadata has the same structure as</span>
<span class="sd">            the calculation components, which at a minimum need both ``table_name`` and</span>
<span class="sd">            ``xbrl_factoid`` to identify them.</span>
<span class="sd">        params: :class:`ReconcileTableCalculations` parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dataframe that includes new ``*_correction`` records with values that ensure</span>
<span class="sd">        the calculations all match to within the required tolerance. It will also</span>
<span class="sd">        contain columns created by the calculation checking process like ``abs_diff``</span>
<span class="sd">        and ``rel_diff``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If we don&#39;t have this value, we aren&#39;t doing any calculation checking:</span>
    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">column_to_check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="c1"># Use the calculation components which reference ONLY values within the table</span>
    <span class="n">intra_table_calcs</span> <span class="o">=</span> <span class="n">calculation_components</span><span class="p">[</span>
        <span class="n">calculation_components</span><span class="o">.</span><span class="n">is_within_table_calc</span>
    <span class="p">]</span>
    <span class="c1"># To interact with the calculation components, we need uniformly named columns</span>
    <span class="c1"># for xbrl_factoid, and table_name</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">xbrl_factoid_name</span><span class="p">:</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span>
    <span class="p">)</span>
    <span class="n">dim_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">dim</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">other_dimensions</span><span class="p">(</span><span class="n">table_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">]</span>
    <span class="n">calc_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dim_cols</span>

    <span class="k">if</span> <span class="n">dim_cols</span><span class="p">:</span>
        <span class="n">table_dims</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">calc_idx</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="n">intra_table_calcs</span> <span class="o">=</span> <span class="n">_add_intra_table_calculation_dimensions</span><span class="p">(</span>
            <span class="n">intra_table_calcs</span><span class="o">=</span><span class="n">intra_table_calcs</span><span class="p">,</span>
            <span class="n">table_dims</span><span class="o">=</span><span class="n">table_dims</span><span class="p">,</span>
            <span class="n">dim_cols</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Check the subdimension totals. add subdimension_corrections!</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">subdimension_column</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Checking total-to-subdimension calculations in </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">subdimension_column</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">calc_comps_w_totals</span> <span class="o">=</span> <span class="n">_calculation_components_subdimension_calculations</span><span class="p">(</span>
                <span class="n">intra_table_calcs</span><span class="o">=</span><span class="n">intra_table_calcs</span><span class="p">,</span>
                <span class="n">table_dims</span><span class="o">=</span><span class="n">table_dims</span><span class="p">,</span>
                <span class="n">xbrl_metadata</span><span class="o">=</span><span class="n">xbrl_metadata</span><span class="p">,</span>
                <span class="n">dim_cols</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">reconcile_one_type_of_table_calculations</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">calculation_components</span><span class="o">=</span><span class="n">calc_comps_w_totals</span><span class="p">[</span>
                    <span class="n">calc_comps_w_totals</span><span class="o">.</span><span class="n">is_total_to_subdimensions_calc</span>
                <span class="p">],</span>
                <span class="n">calc_idx</span><span class="o">=</span><span class="n">calc_idx</span><span class="p">,</span>
                <span class="n">value_col</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">column_to_check</span><span class="p">,</span>
                <span class="n">group_metric_checks</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">group_metric_checks</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                <span class="n">is_subdimension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">calc_to_data_merge_validation</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">subdimension_merge_validation</span><span class="p">,</span>
            <span class="p">)[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">reconcile_one_type_of_table_calculations</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
        <span class="n">calculation_components</span><span class="o">=</span><span class="n">intra_table_calcs</span><span class="p">,</span>
        <span class="n">calc_idx</span><span class="o">=</span><span class="n">calc_idx</span><span class="p">,</span>
        <span class="n">value_col</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">column_to_check</span><span class="p">,</span>
        <span class="n">group_metric_checks</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">group_metric_checks</span><span class="p">,</span>
        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
        <span class="n">is_subdimension</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Rename back to the original xbrl_factoid column name before returning:</span>
    <span class="k">return</span> <span class="n">calculated_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">xbrl_factoid_name</span><span class="p">})</span></div>



<div class="viewcode-block" id="reconcile_one_type_of_table_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.reconcile_one_type_of_table_calculations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">reconcile_one_type_of_table_calculations</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">calculation_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">calc_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">value_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">group_metric_checks</span><span class="p">:</span> <span class="n">GroupMetricChecks</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_subdimension</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">calc_to_data_merge_validation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span> <span class="s2">&quot;many_to_many&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate vales, run metric checks and add corrections.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: exploded FERC data to apply the calculations to. Primary key should be</span>
<span class="sd">            ``report_year``, ``utility_id_ferc1``, ``table_name``, ``xbrl_factoid``, and</span>
<span class="sd">            whatever additional dimensions are relevant to the data.</span>
<span class="sd">        calculation_components: Table defining the calculations, with each row defining</span>
<span class="sd">            a single component, including its weight. Groups of rows identified by</span>
<span class="sd">            ``table_name_parent`` and ``xbrl_factoid_parent`` indicate the values being</span>
<span class="sd">            calculated.</span>
<span class="sd">        calc_idx: primary key columns that uniquely identify a calculation component</span>
<span class="sd">            (not including the ``_parent`` columns).</span>
<span class="sd">        value_col: label of the column in ``data`` that contains the values to apply the</span>
<span class="sd">            calculations to (typically ``dollar_value`` or ``ending_balance``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calculation_components</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="n">calculated_df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">calculate_values_from_components</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">calculation_components</span><span class="o">=</span><span class="n">calculation_components</span><span class="p">,</span>
            <span class="n">calc_idx</span><span class="o">=</span><span class="n">calc_idx</span><span class="p">,</span>
            <span class="n">value_col</span><span class="o">=</span><span class="n">value_col</span><span class="p">,</span>
            <span class="n">calc_to_data_merge_validation</span><span class="o">=</span><span class="n">calc_to_data_merge_validation</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">check_calculation_metrics</span><span class="p">,</span>
            <span class="n">group_metric_checks</span><span class="o">=</span><span class="n">group_metric_checks</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">add_corrections</span><span class="p">,</span>
            <span class="n">value_col</span><span class="o">=</span><span class="n">value_col</span><span class="p">,</span>
            <span class="n">is_close_tolerance</span><span class="o">=</span><span class="n">IsCloseTolerance</span><span class="p">(),</span>
            <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
            <span class="n">is_subdimension</span><span class="o">=</span><span class="n">is_subdimension</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">calculated_df</span></div>



<div class="viewcode-block" id="_calculation_components_subdimension_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._calculation_components_subdimension_calculations">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_calculation_components_subdimension_calculations</span><span class="p">(</span>
    <span class="n">intra_table_calcs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">table_dims</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">xbrl_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dim_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add total to subdimension calculations into calculation components.&quot;&quot;&quot;</span>
    <span class="n">meta_w_dims</span> <span class="o">=</span> <span class="n">xbrl_metadata</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dim_cols</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">}</span>
    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">make_xbrl_factoid_dimensions_explicit</span><span class="p">,</span>
        <span class="n">table_dimensions_ferc1</span><span class="o">=</span><span class="n">table_dims</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">calc_comps_w_totals</span> <span class="o">=</span> <span class="n">infer_intra_factoid_totals</span><span class="p">(</span>
        <span class="n">intra_table_calcs</span><span class="p">,</span>
        <span class="n">meta_w_dims</span><span class="o">=</span><span class="n">meta_w_dims</span><span class="p">,</span>
        <span class="n">table_dimensions</span><span class="o">=</span><span class="n">table_dims</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">calc_comps_w_totals</span></div>



<div class="viewcode-block" id="_add_intra_table_calculation_dimensions">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._add_intra_table_calculation_dimensions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_add_intra_table_calculation_dimensions</span><span class="p">(</span>
    <span class="n">intra_table_calcs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">table_dims</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dim_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add all observed subdimensions into the calculation components.&quot;&quot;&quot;</span>
    <span class="c1">######## Add all observed subdimensions into the calculation components!!!</span>
    <span class="c1"># First determine what dimensions matter in this table:</span>
    <span class="c1"># - usually params.subdimension_column has THE ONE dimension in the table...</span>
    <span class="c1"># - BUT some tables have more than one dimension so we grab from all of the</span>
    <span class="c1">#   the dims in the transformers.</span>

    <span class="c1"># need to add in the correction dimensions. they don&#39;t show up in the data at</span>
    <span class="c1"># this point so we don&#39;t have the dimensions yet. NOTE: this could have been</span>
    <span class="c1"># done by adding the dims into table_dims..... maybe would have been more</span>
    <span class="c1"># straightforward</span>
    <span class="n">correction_mask</span> <span class="o">=</span> <span class="n">intra_table_calcs</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_correction&quot;</span><span class="p">)</span>
    <span class="n">intra_table_calcs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">intra_table_calcs</span><span class="p">[</span><span class="o">~</span><span class="n">correction_mask</span><span class="p">],</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">intra_table_calcs</span><span class="p">[</span><span class="n">correction_mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">),</span>
                <span class="n">table_dims</span><span class="p">[[</span><span class="s2">&quot;table_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dim_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">intra_table_calcs</span> <span class="o">=</span> <span class="n">make_xbrl_factoid_dimensions_explicit</span><span class="p">(</span>
        <span class="n">intra_table_calcs</span><span class="p">,</span>
        <span class="n">table_dimensions_ferc1</span><span class="o">=</span><span class="n">table_dims</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">assign_parent_dimensions</span><span class="p">,</span>
        <span class="n">table_dimensions</span><span class="o">=</span><span class="n">table_dims</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="o">=</span><span class="n">dim_cols</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># this is for the income statement table specifically, but is general:</span>
    <span class="c1"># remove all the bits where we have a child dim but not a parent dim</span>
    <span class="c1"># sometimes there are child dimensions that have utility_type == &quot;other2&quot; etc</span>
    <span class="c1"># where the parent dimension has nothing</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dim_cols</span><span class="p">:</span>
        <span class="n">intra_table_calcs</span> <span class="o">=</span> <span class="n">intra_table_calcs</span><span class="p">[</span>
            <span class="o">~</span><span class="p">(</span>
                <span class="n">intra_table_calcs</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
                <span class="o">&amp;</span> <span class="n">intra_table_calcs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">intra_table_calcs</span></div>



<div class="viewcode-block" id="calculate_values_from_components">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.calculate_values_from_components">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_values_from_components</span><span class="p">(</span>
    <span class="n">calculation_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">calc_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">value_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">calc_to_data_merge_validation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span> <span class="s2">&quot;many_to_many&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;one_to_many&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply calculations derived from XBRL metadata to reported XBRL data.</span>

<span class="sd">    Args:</span>
<span class="sd">        calculation_components: Table defining the calculations, with each row defining</span>
<span class="sd">            a single component, including its weight. Groups of rows identified by</span>
<span class="sd">            ``table_name_parent`` and ``xbrl_factoid_parent`` indicate the values being</span>
<span class="sd">            calculated.</span>
<span class="sd">        data: exploded FERC data to apply the calculations to. Primary key should be</span>
<span class="sd">            ``report_year``, ``utility_id_ferc1``, ``table_name``, ``xbrl_factoid``, and</span>
<span class="sd">            whatever additional dimensions are relevant to the data.</span>
<span class="sd">        calc_idx: primary key columns that uniquely identify a calculation component</span>
<span class="sd">            (not including the ``_parent`` columns).</span>
<span class="sd">        value_col: label of the column in ``data`` that contains the values to apply the</span>
<span class="sd">            calculations to (typically ``dollar_value`` or ``ending_balance``).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Merge the reported data and the calculation component metadata to enable</span>
    <span class="c1"># validation of calculated values. Here the data table exploded is supplying the</span>
    <span class="c1"># values associated with individual calculation components, and the table_name</span>
    <span class="c1"># and xbrl_factoid to which we aggregate are coming from the calculation</span>
    <span class="c1"># components table. After merging we use the weights to adjust the reported</span>
    <span class="c1"># values so they can be summed directly. This gives us aggregated calculated</span>
    <span class="c1"># values that can later be compared to the higher level reported values.</span>

    <span class="c1"># infer the pks of the data by adding in the util/year</span>
    <span class="n">data_idx</span> <span class="o">=</span> <span class="n">calc_idx</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">]</span>
    <span class="c1"># we are going to merge the data onto the calc components with the _parent</span>
    <span class="c1"># column names, so the groupby after the merge needs a set of by cols with the</span>
    <span class="c1"># _parent suffix</span>
    <span class="n">gby_parent</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">calc_idx</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">calc_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">calculation_components</span><span class="p">,</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="n">calc_to_data_merge_validation</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="n">calc_idx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># apply the weight from the calc to convey the sign before summing.</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">calculated_value</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">gby_parent</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;calculated_value&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">is_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">MergeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># Make debugging easier.</span>
        <span class="k">raise</span> <span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">MergeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Merge failed, duplicated merge keys in left dataset with merge key of </span><span class="si">{</span><span class="n">calc_idx</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">calculation_components</span><span class="p">[</span><span class="n">calculation_components</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">calc_idx</span><span class="p">,</span><span class="w"> </span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">calc_idx</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="c1"># remove the _parent suffix so we can merge these calculated values back onto</span>
    <span class="c1"># the data using the original pks</span>
    <span class="n">calc_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">calc_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;_parent&quot;</span><span class="p">)</span>
    <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">calc_df</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">data_idx</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
        <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">calculated_df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">calculated_df</span><span class="o">.</span><span class="n">_merge</span> <span class="o">==</span> <span class="s2">&quot;right_only&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">calculated_df</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="p">]</span><span class="o">.</span><span class="n">empty</span>

    <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">])</span>
    <span class="c1"># Force value_col to be a float to prevent any hijinks with calculating differences.</span>
    <span class="c1"># Data types were very messy here, including pandas Float64 for the</span>
    <span class="c1"># calculated_value columns which did not work with the np.isclose(). Not sure</span>
    <span class="c1"># why these are cropping up.</span>
    <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">(</span><span class="n">convert_floating</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
        <span class="p">{</span><span class="n">value_col</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># For all of these below, only assign values when the record is a calculated record</span>
    <span class="c1"># Also, make sure we are filling nulls so we capture the differences when there are</span>
    <span class="c1"># null values in the calculated or reported values.</span>
    <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;is_calc&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">BooleanDtype</span><span class="p">()})</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">is_calc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">is_calc</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">diff</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">is_calc</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">calculated_value</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">abs_diff</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">is_calc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">),</span>
        <span class="n">rel_diff</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">is_calc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">abs_diff</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="n">value_col</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Uniformity here helps keep the error checking functions simpler:</span>
    <span class="n">calculated_df</span><span class="p">[</span><span class="s2">&quot;reported_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">calculated_df</span></div>



<div class="viewcode-block" id="check_calculation_metrics_by_group">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.check_calculation_metrics_by_group">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_calculation_metrics_by_group</span><span class="p">(</span>
    <span class="n">calculated_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">group_metric_checks</span><span class="p">:</span> <span class="n">GroupMetricChecks</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tabulate the results of the calculation checks by group.</span>

<span class="sd">    Convert all of the groups&#39; checks into a big df. This will have two indexes: first</span>
<span class="sd">    for the group name (group) and one for the groups values. the columns will include</span>
<span class="sd">    three for each test: the test metric that is the same name as the test (ex:</span>
<span class="sd">    error_frequency), the tolerance for that group/test and a boolean indicating</span>
<span class="sd">    whether or not that metric failed to meet the tolerance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results_dfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># for each groupby grouping: calculate metrics for each test</span>
    <span class="c1"># then check if each test is within acceptable tolerance levels</span>
    <span class="k">for</span> <span class="n">group_name</span> <span class="ow">in</span> <span class="n">group_metric_checks</span><span class="o">.</span><span class="n">groups_to_check</span><span class="p">:</span>
        <span class="n">group_metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">metric_name</span><span class="p">,</span>
            <span class="n">metric_tolerance</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">group_metric_checks</span><span class="o">.</span><span class="n">group_metric_tolerances</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()[</span>
            <span class="n">group_name</span>
        <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">group_metric_checks</span><span class="o">.</span><span class="n">metrics_to_check</span><span class="p">:</span>
                <span class="c1"># this feels icky. the param name for the metrics are all snake_case while</span>
                <span class="c1"># the metric classes are all TitleCase. So we convert to TitleCase</span>
                <span class="n">title_case_test</span> <span class="o">=</span> <span class="n">metric_name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">group_metric_checker</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">title_case_test</span><span class="p">](</span>
                    <span class="n">by</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span>
                    <span class="n">is_close_tolerance</span><span class="o">=</span><span class="n">group_metric_checks</span><span class="o">.</span><span class="n">is_close_tolerance</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()[</span>
                        <span class="n">metric_name</span>
                    <span class="p">],</span>
                    <span class="n">metric_tolerance</span><span class="o">=</span><span class="n">metric_tolerance</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">group_metric</span> <span class="o">=</span> <span class="n">group_metric_checker</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
                    <span class="n">calculated_df</span><span class="o">=</span><span class="n">calculated_df</span>
                <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">group_name</span><span class="p">:</span> <span class="s2">&quot;group_value&quot;</span><span class="p">})</span>
                <span class="c1"># we want to set the index values as the same for all groups, but both the</span>
                <span class="c1"># ungrouped and table_name group require a special exception because we need</span>
                <span class="c1"># to add table_name into the columns</span>
                <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">&quot;ungrouped&quot;</span><span class="p">:</span>
                    <span class="n">group_metric</span> <span class="o">=</span> <span class="n">group_metric</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;ungrouped&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group_name</span> <span class="o">==</span> <span class="s2">&quot;table_name&quot;</span><span class="p">:</span>
                    <span class="c1"># we end up having two columns w/ table_name values in order to keep all the</span>
                    <span class="c1"># outputs having the same indexes.</span>
                    <span class="n">group_metric</span> <span class="o">=</span> <span class="n">group_metric</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                        <span class="n">table_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;group_value&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># make a uniform multi-index w/ group name and group values</span>
                <span class="n">group_metrics</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_metric</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;group_value&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="n">results_dfs</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">group_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results_dfs</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="check_calculation_metrics">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.check_calculation_metrics">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_calculation_metrics</span><span class="p">(</span>
    <span class="n">calculated_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">group_metric_checks</span><span class="p">:</span> <span class="n">GroupMetricChecks</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the calculation metrics and determine if calculations are within tolerance.&quot;&quot;&quot;</span>
    <span class="c1"># DO ERROR CHECKS</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">check_calculation_metrics_by_group</span><span class="p">(</span><span class="n">calculated_df</span><span class="p">,</span> <span class="n">group_metric_checks</span><span class="p">)</span>
    <span class="c1"># get the records w/ errors in any! of their checks</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;is_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># it miiight be good to isolate just the error columns..</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found errors while running tests on the calculations:</span><span class="se">\n</span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">calculated_df</span></div>



<span class="c1">########################################################################################</span>
<span class="c1"># Calculation Error Checking Functions</span>
<span class="c1"># - These functions all take a dataframe and return a float.</span>
<span class="c1"># - They are intended to be used in GroupBy.apply() (or on a whole dataframe).</span>
<span class="c1"># - They require a uniform `reported_value` column so that they can all have the same</span>
<span class="c1">#   call signature, which allows us to iterate over all of them in a matrix.</span>
<span class="c1">########################################################################################</span>


<div class="viewcode-block" id="ErrorMetric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ErrorMetric</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for checking a particular metric within a group.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorMetric.by">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.by">[docs]</a>
    <span class="n">by</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;ungrouped&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span>
    <span class="p">]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Name of group to check the metric based on.</span>

<span class="sd">    With the exception of the ungrouped case, all groups depend on table_name as well as</span>
<span class="sd">    the other column specified via by.</span>

<span class="sd">    If by==&quot;table_name&quot; then that is the only column used in the groupby().</span>

<span class="sd">    If by==&quot;ungrouped&quot; then all records are included in the &quot;group&quot; (via a dummy column</span>
<span class="sd">    named ungrouped that contains only the value ungrouped). This allows us to use the</span>
<span class="sd">    same infrastructure for applying the metrics to grouped and ungrouped data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorMetric.is_close_tolerance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.is_close_tolerance">[docs]</a>
    <span class="n">is_close_tolerance</span><span class="p">:</span> <span class="n">IsCloseTolerance</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inputs for the metric to determine :meth:`is_not_close`. Instance of :class:`IsCloseTolerance`.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorMetric.metric_tolerance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.metric_tolerance">[docs]</a>
    <span class="n">metric_tolerance</span><span class="p">:</span> <span class="nb">float</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tolerance for checking the metric within the ``by`` group.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorMetric.required_cols">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.required_cols">[docs]</a>
    <span class="n">required_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;table_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
        <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;calculated_value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;abs_diff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rel_diff&quot;</span><span class="p">,</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="ErrorMetric.has_required_cols">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.has_required_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_required_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that the input dataframe has all required columns.&quot;&quot;&quot;</span>
        <span class="n">missing_required_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_required_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The table is missing the following required columns: </span><span class="si">{</span><span class="n">missing_required_cols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="ErrorMetric.metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">gb</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Metric function that will be applied to each group of values being checked.&quot;&quot;&quot;</span>
        <span class="o">...</span></div>


<div class="viewcode-block" id="ErrorMetric.is_not_close">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.is_not_close">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_not_close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flag records where reported and calculated values differ significantly.</span>

<span class="sd">        We only want to check this metric when there is a non-null ``abs_diff`` because</span>
<span class="sd">        we want to avoid the instances in which there are either null reported or</span>
<span class="sd">        calculated values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;calculated_value&quot;</span><span class="p">],</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;reported_value&quot;</span><span class="p">],</span>
                <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_close_tolerance</span><span class="o">.</span><span class="n">isclose_rtol</span><span class="p">,</span>
                <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_close_tolerance</span><span class="o">.</span><span class="n">isclose_atol</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;abs_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ErrorMetric.groupby_cols">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.groupby_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">groupby_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The list of columns to group by.</span>

<span class="sd">        We want to default to adding the table_name into all groupby&#39;s, but two of our</span>
<span class="sd">        ``by`` options need special treatment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gb_by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ungrouped&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">]:</span>
            <span class="n">gb_by</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">gb_by</span></div>


<div class="viewcode-block" id="ErrorMetric.apply_metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.apply_metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate the metric values within each group through an apply method.</span>

<span class="sd">        This method adds a column ``is_not_close`` into the df before the groupby</span>
<span class="sd">        because that column is used in many of the :meth:`metric`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return a df instead of a series</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_not_close&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_not_close</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">groupby_cols</span><span class="p">())</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ErrorMetric._snake_case_metric_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric._snake_case_metric_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_snake_case_metric_name</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the TitleCase class name to a snake_case string.&quot;&quot;&quot;</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;(?!^)([A-Z]+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;_\1&quot;</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>


<div class="viewcode-block" id="ErrorMetric.check">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorMetric.check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">calculated_df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a df w/ the metric, tolerance and is_error columns.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_required_cols</span><span class="p">(</span><span class="n">calculated_df</span><span class="p">)</span>
        <span class="c1"># ungrouped is special because the rest of the stock group names are column</span>
        <span class="c1"># names.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">by</span> <span class="o">==</span> <span class="s2">&quot;ungrouped&quot;</span><span class="p">:</span>
            <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">ungrouped</span><span class="o">=</span><span class="s2">&quot;ungrouped&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">metric_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snake_case_metric_name</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_metric</span><span class="p">(</span><span class="n">calculated_df</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">metric_name</span><span class="p">])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span>  <span class="c1"># totolerance_ is just for reporting so you can know of off you are</span>
                    <span class="sa">f</span><span class="s2">&quot;tolerance_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_tolerance</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;is_error_</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric_tolerance</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">by</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="ErrorFrequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorFrequency">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ErrorFrequency</span><span class="p">(</span><span class="n">ErrorMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check error frequency in XBRL calculations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ErrorFrequency.metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ErrorFrequency.metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">gb</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the frequency with which records are tagged as errors.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">gb</span><span class="p">[</span><span class="n">gb</span><span class="o">.</span><span class="n">is_not_close</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">gb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="c1"># Will only occur if all reported values are NaN when calculated values</span>
            <span class="c1"># exist, or vice versa.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Calculated values have no corresponding reported values in this table.&quot;</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="RelativeErrorMagnitude">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RelativeErrorMagnitude">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RelativeErrorMagnitude</span><span class="p">(</span><span class="n">ErrorMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check relative magnitude of errors in XBRL calculations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RelativeErrorMagnitude.metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RelativeErrorMagnitude.metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">gb</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the mangnitude of the errors relative to total reported value.&quot;&quot;&quot;</span>
        <span class="n">gb_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">gb</span><span class="p">[</span><span class="s2">&quot;reported_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">denom</span><span class="p">):</span>
            <span class="n">gb_value</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">abs_diff</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span>
        <span class="k">return</span> <span class="n">gb_value</span></div>
</div>



<div class="viewcode-block" id="AbsoluteErrorMagnitude">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AbsoluteErrorMagnitude">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AbsoluteErrorMagnitude</span><span class="p">(</span><span class="n">ErrorMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check absolute magnitude of errors in XBRL calculations.</span>

<span class="sd">    These numbers may vary wildly from table to table so no default values for the</span>
<span class="sd">    expected errors are provided here...</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbsoluteErrorMagnitude.metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.AbsoluteErrorMagnitude.metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">gb</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the absolute mangnitude of XBRL calculation errors.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gb</span><span class="o">.</span><span class="n">abs_diff</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="NullCalculatedValueFrequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.NullCalculatedValueFrequency">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NullCalculatedValueFrequency</span><span class="p">(</span><span class="n">ErrorMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the frequency of null calculated values.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NullCalculatedValueFrequency.apply_metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.NullCalculatedValueFrequency.apply_metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Only apply metric to rows that contain calculated values.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">row_type_xbrl</span> <span class="o">==</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupby_cols</span><span class="p">())</span>
            <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">include_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NullCalculatedValueFrequency.metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.NullCalculatedValueFrequency.metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">gb</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fraction of non-null reported values that have null corresponding calculated values.&quot;&quot;&quot;</span>
        <span class="n">non_null_reported</span> <span class="o">=</span> <span class="n">gb</span><span class="p">[</span><span class="s2">&quot;reported_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="n">null_calculated</span> <span class="o">=</span> <span class="n">gb</span><span class="p">[</span><span class="s2">&quot;calculated_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">non_null_reported</span> <span class="o">&amp;</span> <span class="n">null_calculated</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">non_null_reported</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>
</div>



<div class="viewcode-block" id="NullReportedValueFrequency">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.NullReportedValueFrequency">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NullReportedValueFrequency</span><span class="p">(</span><span class="n">ErrorMetric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the frequency of null reported values.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NullReportedValueFrequency.metric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.NullReportedValueFrequency.metric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">gb</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Frequency with which the reported values are Null.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gb</span><span class="p">[</span><span class="s2">&quot;reported_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">gb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="add_corrections">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.add_corrections">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_corrections</span><span class="p">(</span>
    <span class="n">calculated_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">value_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_close_tolerance</span><span class="p">:</span> <span class="n">IsCloseTolerance</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_subdimension</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add corrections to discrepancies between reported &amp; calculated values.</span>

<span class="sd">    To isolate the sources of error, and ensure that all totals add up as expected in</span>
<span class="sd">    later phases of the transformation, we add correction records to the dataframe</span>
<span class="sd">    which compensate for any difference between the calculated and reported values. The</span>
<span class="sd">    ``_correction`` factoids that are added here have already been added to the</span>
<span class="sd">    calculation components during the metadata processing.</span>

<span class="sd">    Args:</span>
<span class="sd">        calculated_df: DataFrame containing the data to correct. Must already have</span>
<span class="sd">            ``abs_diff`` column that was added by :func:`check_calculation_metrics`</span>
<span class="sd">        value_col: Label of the column whose values are being calculated.</span>
<span class="sd">        calculation_tolerance: Data structure containing various calculation tolerances.</span>
<span class="sd">        table_name: Name of the table whose data we are working with. For logging.</span>
<span class="sd">        is_subdimension: Indicator of whether or not the correction to add is a total to</span>
<span class="sd">            subdimension calculated value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">corrections</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="p">[</span>
        <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">calculated_df</span><span class="p">[</span><span class="s2">&quot;calculated_value&quot;</span><span class="p">],</span>
            <span class="n">calculated_df</span><span class="p">[</span><span class="n">value_col</span><span class="p">],</span>
            <span class="n">rtol</span><span class="o">=</span><span class="n">is_close_tolerance</span><span class="o">.</span><span class="n">isclose_rtol</span><span class="p">,</span>
            <span class="n">atol</span><span class="o">=</span><span class="n">is_close_tolerance</span><span class="o">.</span><span class="n">isclose_atol</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">&amp;</span> <span class="n">calculated_df</span><span class="p">[</span><span class="s2">&quot;abs_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># fill in the nulls with zeros so we get a correction for records</span>
    <span class="n">corrections</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">corrections</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">corrections</span><span class="p">[</span>
        <span class="s2">&quot;calculated_value&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">correction_label</span> <span class="o">=</span> <span class="s2">&quot;subdimension_correction&quot;</span> <span class="k">if</span> <span class="n">is_subdimension</span> <span class="k">else</span> <span class="s2">&quot;correction&quot;</span>
    <span class="n">corrections</span> <span class="o">=</span> <span class="n">corrections</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">xbrl_factoid_corrected</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">],</span>
        <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">correction_label</span><span class="p">,</span>
        <span class="n">row_type_xbrl</span><span class="o">=</span><span class="n">correction_label</span><span class="p">,</span>
        <span class="n">is_within_table_calc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">record_id</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">num_notnull_calcs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">calculated_df</span><span class="p">[</span><span class="s2">&quot;abs_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="n">num_corrections</span> <span class="o">=</span> <span class="n">corrections</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_records</span> <span class="o">=</span> <span class="n">calculated_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">corrected_fraction</span> <span class="o">=</span> <span class="n">num_corrections</span> <span class="o">/</span> <span class="n">num_notnull_calcs</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="n">corrected_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: Correcting </span><span class="si">{</span><span class="n">corrected_fraction</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> of all non-null reported &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;values (</span><span class="si">{</span><span class="n">num_corrections</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_notnull_calcs</span><span class="si">}</span><span class="s2">) out of a total of &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_records</span><span class="si">}</span><span class="s2"> original records.&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">calculated_df</span><span class="p">,</span> <span class="n">corrections</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">calculated_df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)],</span>
        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="Ferc1TableTransformParams">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Ferc1TableTransformParams</span><span class="p">(</span><span class="n">TableTransformParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A model defining what TransformParams are allowed for FERC Form 1.</span>

<span class="sd">    This adds additional parameter models beyond the ones inherited from the</span>
<span class="sd">    :class:`pudl.transform.classes.AbstractTableTransformer` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Ferc1TableTransformParams.rename_columns_ferc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.rename_columns_ferc1">[docs]</a>
    <span class="n">rename_columns_ferc1</span><span class="p">:</span> <span class="n">RenameColumnsFerc1</span> <span class="o">=</span> <span class="n">RenameColumnsFerc1</span><span class="p">(</span>
        <span class="n">dbf</span><span class="o">=</span><span class="n">RenameColumns</span><span class="p">(),</span>
        <span class="n">xbrl</span><span class="o">=</span><span class="n">RenameColumns</span><span class="p">(),</span>
        <span class="n">instant_xbrl</span><span class="o">=</span><span class="n">RenameColumns</span><span class="p">(),</span>
        <span class="n">duration_xbrl</span><span class="o">=</span><span class="n">RenameColumns</span><span class="p">(),</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.wide_to_tidy">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.wide_to_tidy">[docs]</a>
    <span class="n">wide_to_tidy</span><span class="p">:</span> <span class="n">WideToTidySourceFerc1</span> <span class="o">=</span> <span class="n">WideToTidySourceFerc1</span><span class="p">(</span>
        <span class="n">dbf</span><span class="o">=</span><span class="n">WideToTidy</span><span class="p">(),</span> <span class="n">xbrl</span><span class="o">=</span><span class="n">WideToTidy</span><span class="p">()</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.merge_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.merge_xbrl_metadata">[docs]</a>
    <span class="n">merge_xbrl_metadata</span><span class="p">:</span> <span class="n">MergeXbrlMetadata</span> <span class="o">=</span> <span class="n">MergeXbrlMetadata</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.align_row_numbers_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.align_row_numbers_dbf">[docs]</a>
    <span class="n">align_row_numbers_dbf</span><span class="p">:</span> <span class="n">AlignRowNumbersDbf</span> <span class="o">=</span> <span class="n">AlignRowNumbersDbf</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.drop_duplicate_rows_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.drop_duplicate_rows_dbf">[docs]</a>
    <span class="n">drop_duplicate_rows_dbf</span><span class="p">:</span> <span class="n">DropDuplicateRowsDbf</span> <span class="o">=</span> <span class="n">DropDuplicateRowsDbf</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.assign_quarterly_data_to_yearly_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.assign_quarterly_data_to_yearly_dbf">[docs]</a>
    <span class="n">assign_quarterly_data_to_yearly_dbf</span><span class="p">:</span> <span class="n">AssignQuarterlyDataToYearlyDbf</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">AssignQuarterlyDataToYearlyDbf</span><span class="p">()</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.select_dbf_rows_by_category">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.select_dbf_rows_by_category">[docs]</a>
    <span class="n">select_dbf_rows_by_category</span><span class="p">:</span> <span class="n">SelectDbfRowsByCategory</span> <span class="o">=</span> <span class="n">SelectDbfRowsByCategory</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.unstack_balances_to_report_year_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.unstack_balances_to_report_year_instant_xbrl">[docs]</a>
    <span class="n">unstack_balances_to_report_year_instant_xbrl</span><span class="p">:</span> <span class="n">UnstackBalancesToReportYearInstantXbrl</span> <span class="o">=</span> <span class="n">UnstackBalancesToReportYearInstantXbrl</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.combine_axis_columns_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.combine_axis_columns_xbrl">[docs]</a>
    <span class="n">combine_axis_columns_xbrl</span><span class="p">:</span> <span class="n">CombineAxisColumnsXbrl</span> <span class="o">=</span> <span class="n">CombineAxisColumnsXbrl</span><span class="p">()</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.reconcile_table_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.reconcile_table_calculations">[docs]</a>
    <span class="n">reconcile_table_calculations</span><span class="p">:</span> <span class="n">ReconcileTableCalculations</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ReconcileTableCalculations</span><span class="p">()</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="Ferc1TableTransformParams.add_columns_with_uniform_values">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.add_columns_with_uniform_values">[docs]</a>
    <span class="n">add_columns_with_uniform_values</span><span class="p">:</span> <span class="n">AddColumnsWithUniformValues</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">AddColumnsWithUniformValues</span><span class="p">()</span>
    <span class="p">)</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Ferc1TableTransformParams.xbrl_factoid_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.xbrl_factoid_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">xbrl_factoid_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Access the column name of the ``xbrl_factoid``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_xbrl_metadata</span><span class="o">.</span><span class="n">on</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Ferc1TableTransformParams.rename_dicts_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.rename_dicts_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_dicts_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile all of the XBRL rename dictionaries into an ordered list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns_ferc1</span><span class="o">.</span><span class="n">rename_dicts_xbrl</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Ferc1TableTransformParams.wide_to_tidy_value_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.wide_to_tidy_value_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wide_to_tidy_value_types</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile a list of all of the ``value_types`` from ``wide_to_tidy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wide_to_tidy</span><span class="o">.</span><span class="n">value_types</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Ferc1TableTransformParams.aligned_dbf_table_names">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.aligned_dbf_table_names">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aligned_dbf_table_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The list of DBF tables aligned by row number in this transform.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_row_numbers_dbf</span><span class="o">.</span><span class="n">dbf_table_names</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="Ferc1TableTransformParams.dimension_columns">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1TableTransformParams.dimension_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dimension_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of column names of dimensions.&quot;&quot;&quot;</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dim</span>
            <span class="k">for</span> <span class="p">(</span>
                <span class="n">dim</span><span class="p">,</span>
                <span class="n">col_info</span><span class="p">,</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_columns_with_uniform_values</span><span class="o">.</span><span class="n">columns_to_add</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">col_info</span><span class="o">.</span><span class="n">is_dimension</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">subdimension_column</span><span class="p">:</span>
            <span class="n">dims</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">subdimension_column</span><span class="p">})</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="select_current_year_annual_records_duration_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.select_current_year_annual_records_duration_xbrl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_current_year_annual_records_duration_xbrl</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select for annual records within their report_year.</span>

<span class="sd">    Select only records that have a start_date at beginning of the report_year and</span>
<span class="sd">    have an end_date at the end of the report_year.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">len_og</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;start_date&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime64[s]&quot;</span><span class="p">,</span> <span class="s2">&quot;end_date&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime64[s]&quot;</span><span class="p">})</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">start_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">end_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">end_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">end_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">len_out</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: After selection of dates based on the report year,&quot;</span>
        <span class="sa">f</span><span class="s2">&quot; we have </span><span class="si">{</span><span class="n">len_out</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">len_og</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of the original table.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<span class="c1">################################################################################</span>
<span class="c1"># FERC 1 transform helper functions. Probably to be integrated into a class</span>
<span class="c1"># below as methods or moved to a different module once it&#39;s clear where they belong.</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="get_ferc1_dbf_rows_to_map">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.get_ferc1_dbf_rows_to_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_ferc1_dbf_rows_to_map</span><span class="p">(</span><span class="n">ferc1_engine</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">Engine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify DBF rows that need to be mapped to XBRL columns.</span>

<span class="sd">    Select all records in the ``f1_row_lit_tbl`` where the row literal associated with a</span>
<span class="sd">    given combination of table and row number is different from the preceding year.</span>
<span class="sd">    This is the smallest set of records which we can use to reproduce the whole table by</span>
<span class="sd">    expanding the time series to include all years, and forward filling the row</span>
<span class="sd">    literals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;row_number&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">]</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;row_literal&quot;</span><span class="p">]</span>
    <span class="n">row_lit</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span>
        <span class="s2">&quot;f1_row_lit_tbl&quot;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">ferc1_engine</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">idx_cols</span> <span class="o">+</span> <span class="n">data_cols</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">)</span>
    <span class="n">row_lit</span><span class="p">[</span><span class="s2">&quot;shifted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_lit</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;row_number&quot;</span><span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">row_literal</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
    <span class="n">row_lit</span><span class="p">[</span><span class="s2">&quot;changed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_lit</span><span class="o">.</span><span class="n">row_literal</span> <span class="o">!=</span> <span class="n">row_lit</span><span class="o">.</span><span class="n">shifted</span>
    <span class="k">return</span> <span class="n">row_lit</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_lit</span><span class="o">.</span><span class="n">changed</span><span class="p">,</span> <span class="n">idx_cols</span> <span class="o">+</span> <span class="n">data_cols</span><span class="p">]</span></div>



<div class="viewcode-block" id="update_dbf_to_xbrl_map">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.update_dbf_to_xbrl_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_dbf_to_xbrl_map</span><span class="p">(</span><span class="n">ferc1_engine</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">Engine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Regenerate the FERC 1 DBF+XBRL glue while retaining existing mappings.</span>

<span class="sd">    Reads all rows that need to be mapped out of the ``f1_row_lit_tbl`` and appends</span>
<span class="sd">    columns containing any previously mapped values, returning the resulting dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;row_number&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">]</span>
    <span class="n">all_rows</span> <span class="o">=</span> <span class="n">get_ferc1_dbf_rows_to_map</span><span class="p">(</span><span class="n">ferc1_engine</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">)</span>
    <span class="n">mapped_rows</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;pudl.package_data.ferc1&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;dbf_to_xbrl.csv&quot;</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;row_literal&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_rows</span><span class="p">,</span> <span class="n">mapped_rows</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;row_number&quot;</span><span class="p">])</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="read_dbf_to_xbrl_map">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.read_dbf_to_xbrl_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_dbf_to_xbrl_map</span><span class="p">(</span><span class="n">dbf_table_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the manually compiled DBF row to XBRL column mapping for a given table.</span>

<span class="sd">    Args:</span>
<span class="sd">        dbf_table_name: The original name of the table in the FERC Form 1 DBF database</span>
<span class="sd">            whose mapping to the XBRL data you want to extract. for example</span>
<span class="sd">            ``f1_plant_in_srvce``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with columns ``[sched_table_name, report_year, row_number, row_type, xbrl_factoid]``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">row_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;pudl.package_data.ferc1&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;dbf_to_xbrl.csv&quot;</span><span class="p">,</span>
        <span class="n">usecols</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_literal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="c1"># Select only the rows that pertain to dbf_table_name</span>
    <span class="n">row_map</span> <span class="o">=</span> <span class="n">row_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_map</span><span class="o">.</span><span class="n">sched_table_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dbf_table_names</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">row_map</span></div>



<div class="viewcode-block" id="fill_dbf_to_xbrl_map">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.fill_dbf_to_xbrl_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fill_dbf_to_xbrl_map</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dbf_years</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Forward-fill missing years in the minimal, manually compiled DBF to XBRL mapping.</span>

<span class="sd">    The relationship between a DBF row and XBRL column/fact/entity/whatever is mostly</span>
<span class="sd">    consistent from year to year. To minimize the amount of manual mapping work we have</span>
<span class="sd">    to do, we only map the years in which the relationship changes. In the end we do</span>
<span class="sd">    need a complete correspondence for all years though, and this function uses the</span>
<span class="sd">    minimal information we&#39;ve compiled to fill in all the gaps, producing a complete</span>
<span class="sd">    mapping across all requested years.</span>

<span class="sd">    One complication is that we need to explicitly indicate which DBF rows have headers</span>
<span class="sd">    in them (which don&#39;t exist in XBRL), to differentiate them from null values in the</span>
<span class="sd">    exhaustive index we create below. We set a ``HEADER_ROW`` sentinel value so we can</span>
<span class="sd">    distinguish between two different reasons that we might find NULL values in the</span>
<span class="sd">    ``xbrl_factoid`` field:</span>

<span class="sd">    1. It&#39;s NULL because it&#39;s between two valid mapped values (the NULL was created</span>
<span class="sd">       in our filling of the time series) and should thus be filled in, or</span>

<span class="sd">    2. It&#39;s NULL because it was a header row in the DBF data, which means it should</span>
<span class="sd">       NOT be filled in. Without the ``HEADER_ROW`` value, when a row number from year X</span>
<span class="sd">       becomes associated with a non-header row in year X+1 the ffill will keep right on</span>
<span class="sd">       filling, associating all of the new header rows with the value of</span>
<span class="sd">       ``xbrl_factoid`` that was associated with the old row number.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A dataframe containing a DBF row to XBRL mapping for a single FERC 1 DBF</span>
<span class="sd">            table.</span>
<span class="sd">        dbf_years: The list of years that should have their DBF row to XBRL mapping</span>
<span class="sd">            filled in. This defaults to all available years of DBF data for FERC 1. In</span>
<span class="sd">            general this parameter should only be set to a non-default value for testing</span>
<span class="sd">            purposes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A complete mapping of DBF row number to XBRL columns for all years of data</span>
<span class="sd">        within a single FERC 1 DBF table. Has columns of</span>
<span class="sd">        ``[report_year, row_number, xbrl_factoid]``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dbf_years</span><span class="p">:</span>
        <span class="n">dbf_years</span> <span class="o">=</span> <span class="n">Ferc1Settings</span><span class="p">()</span><span class="o">.</span><span class="n">dbf_years</span>
    <span class="c1"># If the first year that we&#39;re trying to produce isn&#39;t mapped, we won&#39;t be able to</span>
    <span class="c1"># forward fill.</span>
    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">dbf_years</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid combination of years and DBF-XBRL mapping. The first year cannot</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;be filled and **must** be mapped.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;First year: </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">dbf_years</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Mapped years: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">row_type</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">),</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found non-null XBRL column value mapped to a DBF header row.&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">row_type</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;HEADER_ROW&quot;</span>

    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Found NA XBRL values in the DBF-XBRL mapping, which shouldn&#39;t happen. </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;xbrl_factoid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;row_type&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

    <span class="c1"># Create an index containing all combinations of report_year and row_number</span>
    <span class="n">idx_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;row_number&quot;</span><span class="p">,</span> <span class="s2">&quot;sched_table_name&quot;</span><span class="p">]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
        <span class="p">[</span><span class="n">dbf_years</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">row_number</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">sched_table_name</span><span class="o">.</span><span class="n">unique</span><span class="p">()],</span>
        <span class="n">names</span><span class="o">=</span><span class="n">idx_cols</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Concatenate the row map with the empty index, so we have blank spaces to fill:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">),</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_cols</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Forward fill missing XBRL column names, until a new definition for the row</span>
    <span class="c1"># number is encountered:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;row_literal&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;row_number&quot;</span><span class="p">,</span> <span class="s2">&quot;sched_table_name&quot;</span><span class="p">]</span>
    <span class="p">)[[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;row_literal&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>
    <span class="c1"># Drop NA values produced in the broadcasting merge onto the exhaustive index.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">)</span>
    <span class="c1"># There should be no NA values left at this point:</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Filled DBF-XBRL map contains NA values, which should never happen:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="get_data_cols_raw_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.get_data_cols_raw_xbrl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data_cols_raw_xbrl</span><span class="p">(</span>
    <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of all XBRL data columns appearing in a given XBRL table.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of all the data columns found in the original XBRL DB that correspond to</span>
<span class="sd">        the given PUDL table. Includes columns from both the instant and duration tables</span>
<span class="sd">        but excludes structural columns that appear in all XBRL tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excluded_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;entity_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;filing_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;index&quot;</span><span class="p">,</span>
        <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
        <span class="s2">&quot;start_date&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">raw_xbrl_instant</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">raw_xbrl_duration</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">excluded_cols</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="read_xbrl_calculation_fixes">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.read_xbrl_calculation_fixes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_xbrl_calculation_fixes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read in the table of calculation fixes.&quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;pudl.package_data.ferc1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
        <span class="s2">&quot;xbrl_calculation_component_fixes.csv&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">as_file</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">calc_fixes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">calc_fixes</span></div>



<span class="c1">################################################################################</span>
<span class="c1"># FERC 1 specific TableTransformer classes</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Ferc1AbstractTableTransformer</span><span class="p">(</span><span class="n">AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An abstract class defining methods common to many FERC Form 1 tables.</span>

<span class="sd">    This subclass remains abstract because it does not define transform_main(), which</span>
<span class="sd">    is always going to be table-specific.</span>

<span class="sd">    * Methods that only apply to XBRL data should end with _xbrl</span>
<span class="sd">    * Methods that only apply to DBF data should end with _dbf</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Ferc1AbstractTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span></div>

<div class="viewcode-block" id="Ferc1AbstractTableTransformer.parameter_model">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.parameter_model">[docs]</a>
    <span class="n">parameter_model</span> <span class="o">=</span> <span class="n">Ferc1TableTransformParams</span></div>

<div class="viewcode-block" id="Ferc1AbstractTableTransformer.params">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.params">[docs]</a>
    <span class="n">params</span><span class="p">:</span> <span class="n">parameter_model</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;True if each record in the transformed table corresponds to one input record.</span>

<span class="sd">    For tables that have been transformed from wide-to-tidy format, or undergone other</span>
<span class="sd">    kinds of reshaping, there is not a simple one-to-one relationship between input and</span>
<span class="sd">    output records, and so we should not expect record IDs to be unique. In those cases</span>
<span class="sd">    they serve only a forensic purpose, telling us where to find the original source of</span>
<span class="sd">    the transformed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.xbrl_metadata">[docs]</a>
    <span class="n">xbrl_metadata</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataframe combining XBRL metadata for both instant and duration table columns.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.xbrl_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.xbrl_calculations">[docs]</a>
    <span class="n">xbrl_calculations</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataframe of calculation components.</span>

<span class="sd">    If ``None``, the calculations have not been instantiated. If the table has been</span>
<span class="sd">    instantiated but is an empty table, then there are no calculations for that table.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">TableTransformParams</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_dfs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">clear_cached_dfs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Augment inherited initializer to store XBRL metadata in the class.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">cache_dfs</span><span class="o">=</span><span class="n">cache_dfs</span><span class="p">,</span>
            <span class="n">clear_cached_dfs</span><span class="o">=</span><span class="n">clear_cached_dfs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">xbrl_metadata_json</span><span class="p">:</span>
            <span class="n">xbrl_metadata_converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
                <span class="n">xbrl_metadata_json</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_calculations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_xbrl_metadata_calculations</span><span class="p">(</span>
                <span class="n">xbrl_metadata_converted</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_xbrl_metadata</span><span class="p">(</span>
                <span class="n">xbrl_metadata_converted</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_calculations</span>
            <span class="p">)</span>

    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.transform_start">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.transform_start">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_start</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process the raw data until the XBRL and DBF inputs have been unified.&quot;&quot;&quot;</span>
        <span class="n">processed_dbf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span>
        <span class="n">processed_xbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_xbrl</span><span class="p">(</span><span class="n">raw_xbrl_instant</span><span class="p">,</span> <span class="n">raw_xbrl_duration</span><span class="p">)</span>
        <span class="n">processed_dbf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_dbf_rows_by_category</span><span class="p">(</span><span class="n">processed_dbf</span><span class="p">,</span> <span class="n">processed_xbrl</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Concatenating DBF + XBRL dataframes.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">processed_dbf</span><span class="p">,</span> <span class="n">processed_xbrl</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generic FERC1 main table transformer.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A single transformed table concatenating multiple years of cleaned data</span>
<span class="sd">            derived from the raw DBF and/or XBRL inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spot_fix_values</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strip_non_numeric_values</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nullify_outliers</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">replace_with_na</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_invalid_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">PUDL_PACKAGE</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_xbrl_metadata</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_columns_with_uniform_values</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.transform_end">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.transform_end">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standardized final cleanup after the transformations are done.</span>

<span class="sd">        Checks calculations. Enforces dataframe schema. Checks for empty dataframes and</span>
<span class="sd">        null columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enforce_schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Final dataframe is empty!!!&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> is entirely NULL!&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.select_dbf_rows_by_category">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.select_dbf_rows_by_category">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_dbf_rows_by_category</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">processed_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">processed_xbrl</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">SelectDbfRowsByCategory</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper method for :func:`select_dbf_rows_by_category`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">select_dbf_rows_by_category</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">column_name</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Selecting DBF rows with desired values in </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">column_name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="n">processed_dbf</span> <span class="o">=</span> <span class="n">select_dbf_rows_by_category</span><span class="p">(</span>
                <span class="n">processed_dbf</span><span class="o">=</span><span class="n">processed_dbf</span><span class="p">,</span>
                <span class="n">processed_xbrl</span><span class="o">=</span><span class="n">processed_xbrl</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_dbf</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize the XBRL JSON metadata, turning it into a dataframe.</span>

<span class="sd">        This process concatenates and deduplicates the metadata which is associated with</span>
<span class="sd">        the instant and duration tables, since the metadata is only combined with the</span>
<span class="sd">        data after the instant and duration (and DBF) tables have been merged. This</span>
<span class="sd">        happens in :meth:`Ferc1AbstractTableTransformer.merge_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Processing XBRL metadata.&quot;</span><span class="p">)</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">]),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;references.form_location&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;references.account&quot;</span><span class="p">:</span> <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">calculations</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">calculations</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">(),</span>
                    <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">(),</span>
                    <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">(),</span>
                    <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">xbrl_factoid_original</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">,</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_xbrl_factoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deduplicate_xbrl_factoid_xbrl_metadata</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;process_xbrl_metadata&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.process_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.process_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_converted</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">xbrl_calculations</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process XBRL metadata after the calculations have been cleaned.</span>

<span class="sd">        Add ``row_type_xbrl`` and ``is_within_table_calc`` columns and create</span>
<span class="sd">        ``xbrl_factoid`` records for the calculation corrections.</span>

<span class="sd">        Args:</span>
<span class="sd">            xbrl_metadata_converted: Dataframe of relatively unprocessed metadata.</span>
<span class="sd">                Result of :meth:`convert_xbrl_metadata_json_to_df`.</span>
<span class="sd">            xbrl_calculations: Dataframe of calculation components. Result of</span>
<span class="sd">                :meth:`process_xbrl_metadata_calculations`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># drop the calcs bc we never want to use them again. the xbrl_calculations are</span>
        <span class="c1"># now the main source of truth for the calcs. set index so we can easily</span>
        <span class="c1"># graph some calc info onto the metadata using an index of xbrl_factoid_parent.</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="n">xbrl_metadata_converted</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;calculations&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Flag metadata record types</span>
        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>  <span class="c1"># if there is nothing in the calc cols for a parent fact - its reported</span>
                <span class="n">xbrl_calculations</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">])[</span>
                    <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                <span class="o">==</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="s2">&quot;reported_value&quot;</span>
        <span class="p">)</span>
        <span class="c1"># this bool column is created and used within the calculations. but its a</span>
        <span class="c1"># helpful thing in the metadata table as well.</span>
        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">xbrl_calculations</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">])[</span><span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">BooleanDtype</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_columns_with_uniform_values</span><span class="o">.</span><span class="n">columns_to_add</span><span class="p">:</span>
            <span class="n">tbl_meta</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_columns_with_uniform_values</span><span class="o">.</span><span class="n">assign_cols</span>
            <span class="p">)</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_metadata_corrections</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_xbrl_factoid_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tbl_meta</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;De-duplicate the xbrl_metadata based on ``xbrl_factoid``.</span>

<span class="sd">        Default is to do nothing besides check for duplicate values because almost all</span>
<span class="sd">        tables have no deduping. Deduplication needs to be applied before the</span>
<span class="sd">        :meth:`apply_xbrl_calculation_fixes` inside of :meth:`process_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">merge_xbrl_metadata</span><span class="o">.</span><span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Metadata for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> has duplicative xbrl_factoid records.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.raw_xbrl_factoid_to_pudl_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.raw_xbrl_factoid_to_pudl_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_xbrl_factoid_to_pudl_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col_name_xbrl</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename a column name from original XBRL name to the transformed PUDL name.</span>

<span class="sd">        There are several transform params that either explicitly or implicitly rename</span>
<span class="sd">        columns:</span>
<span class="sd">        * :class:`RenameColumnsFerc1`</span>
<span class="sd">        * :class:`WideToTidySourceFerc1`</span>
<span class="sd">        * :class:`UnstackBalancesToReportYearInstantXbrl`</span>
<span class="sd">        * :class:`ConvertUnits`</span>

<span class="sd">        This method attempts to use the table params to translate a column name.</span>

<span class="sd">        Note: Instead of doing this for each individual column name, we could compile a</span>
<span class="sd">        rename dict for the whole table with a similar processand then apply it for each</span>
<span class="sd">        group of columns instead of running through this full process every time. If</span>
<span class="sd">        this took longer than...  ~5 ms on a single table w/ lots of calcs this would</span>
<span class="sd">        probably be worth it for simplicity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_name_new</span> <span class="o">=</span> <span class="n">col_name_xbrl</span>
        <span class="k">for</span> <span class="n">rename_stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rename_dicts_xbrl</span><span class="p">:</span>
            <span class="n">col_name_new</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rename_stage</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col_name_new</span><span class="p">,</span> <span class="n">col_name_new</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">value_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">wide_to_tidy_value_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name_new</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">value_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">col_name_new</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">value_type</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">col_name_new</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">unstack_balances_to_report_year_instant_xbrl</span><span class="p">:</span>  <span class="c1"># noqa: SIM102</span>
            <span class="c1"># TODO: do something...? add starting_balance &amp; ending_balance suffixes?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">merge_xbrl_metadata</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;We haven&#39;t implemented a xbrl_factoid rename for the parameter &quot;</span>
                    <span class="s2">&quot;unstack_balances_to_report_year_instant_xbrl. Since you are trying&quot;</span>
                    <span class="s2">&quot;to merge the metadata on this table that has this treatment, a &quot;</span>
                    <span class="s2">&quot;xbrl_factoid rename will be required.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">convert_units</span><span class="p">:</span>  <span class="c1"># noqa: SIM102</span>
            <span class="c1"># TODO: use from_unit -&gt; to_unit map. but none of the $$ tables have this rn.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">merge_xbrl_metadata</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;We haven&#39;t implemented a xbrl_factoid rename for the parameter &quot;</span>
                    <span class="s2">&quot;convert_units. Since you are trying to merge the metadata on this &quot;</span>
                    <span class="s2">&quot;table that has this treatment, a xbrl_factoid rename will be &quot;</span>
                    <span class="s2">&quot;required.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">col_name_new</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.rename_xbrl_factoid">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.rename_xbrl_factoid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_xbrl_factoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename a series of raw to PUDL factoid names via :meth:`raw_xbrl_factoid_to_pudl_name`.&quot;&quot;&quot;</span>
        <span class="n">xbrl_factoid_name_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">xbrl_factoid_name_og</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_xbrl_factoid_to_pudl_name</span><span class="p">(</span>
                <span class="n">xbrl_factoid_name_og</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">xbrl_factoid_name_og</span> <span class="ow">in</span> <span class="n">col</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">col</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">xbrl_factoid_name_map</span><span class="p">)</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.rename_xbrl_factoid_other_tables">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.rename_xbrl_factoid_other_tables">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_xbrl_factoid_other_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_comps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename the factoids from calculation components from other tables.</span>

<span class="sd">        Note: It is probably possible to build an apply style function that takes a</span>
<span class="sd">        series of factoid names and a series of table names and returns a table-specific</span>
<span class="sd">        rename_xbrl_factoid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calc_tables</span> <span class="o">=</span> <span class="n">calc_comps</span><span class="o">.</span><span class="n">table_name</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">os_tables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tbl</span>
            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">calc_tables</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tbl</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">os_tables</span><span class="p">:</span>
            <span class="n">trns</span> <span class="o">=</span> <span class="n">FERC1_TFR_CLASSES</span><span class="p">[</span><span class="n">tbl</span><span class="p">]()</span>
            <span class="n">calc_comps</span> <span class="o">=</span> <span class="n">calc_comps</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">tbl</span><span class="o">=</span><span class="n">tbl</span><span class="p">,</span> <span class="n">trns</span><span class="o">=</span><span class="n">trns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">table_name</span> <span class="o">==</span> <span class="n">tbl</span><span class="p">,</span>
                    <span class="n">trns</span><span class="o">.</span><span class="n">rename_xbrl_factoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">),</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">calc_comps</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.add_metadata_corrections">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.add_metadata_corrections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_metadata_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_meta</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create metadata records for the calculation correction factoids.</span>

<span class="sd">        Args:</span>
<span class="sd">            tbl_meta: processed metadata table which contains columns ``row_type_xbrl``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">correction_meta</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">row_type_xbrl</span> <span class="o">==</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">is_within_table_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">row_type_xbrl</span><span class="o">=</span><span class="s2">&quot;correction&quot;</span><span class="p">,</span>
            <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">+</span> <span class="s2">&quot;_correction&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">subdimension_column</span><span class="p">:</span>
            <span class="c1"># add the _subdimension_correction records as well.</span>
            <span class="c1"># how to determine whether a</span>
            <span class="n">subdimension_correction_meta</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span>
                <span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">row_type_xbrl</span> <span class="o">==</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">is_within_table_calc</span>
            <span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">row_type_xbrl</span><span class="o">=</span><span class="s2">&quot;correction&quot;</span><span class="p">,</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">+</span> <span class="s2">&quot;_subdimension_correction&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subdimension_correction_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">tbl_meta</span><span class="p">,</span>
                    <span class="n">correction_meta</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span>
                    <span class="n">subdimension_correction_meta</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
                    <span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.add_calculation_corrections">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.add_calculation_corrections">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_calculation_corrections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">calc_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add correction components and parent-only factoids to calculation metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            tbl_meta: Partially transformed table metadata in dataframe form.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An updated version of the table metadata containing calculation definitions</span>
<span class="sd">            that include a correction component.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If we haven&#39;t provided calculation check parameters, then we can&#39;t identify</span>
        <span class="c1"># a appropriate correction factor.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">column_to_check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calc_components</span>

        <span class="c1"># split the calcs from non-calcs/make corrections/append</span>
        <span class="n">calcs</span> <span class="o">=</span> <span class="n">calc_components</span><span class="p">[</span><span class="n">calc_components</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
        <span class="n">correction_components</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">calcs</span><span class="p">[[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">table_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">table_name_parent</span><span class="p">,</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid_parent</span> <span class="o">+</span> <span class="s2">&quot;_correction&quot;</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">subdimension_column</span><span class="p">:</span>
            <span class="n">subdimension_correction_components</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">calcs</span><span class="p">[</span><span class="n">calcs</span><span class="o">.</span><span class="n">is_within_table_calc</span><span class="p">][</span>
                    <span class="p">[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">table_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">table_name_parent</span><span class="p">,</span>
                    <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid_parent</span> <span class="o">+</span> <span class="s2">&quot;_subdimension_correction&quot;</span>
                    <span class="p">),</span>
                    <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subdimension_correction_components</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">calc_components</span><span class="p">,</span> <span class="n">correction_components</span><span class="p">,</span> <span class="n">subdimension_correction_components</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.get_xbrl_calculation_fixes">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.get_xbrl_calculation_fixes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_xbrl_calculation_fixes</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grab the XBRL calculations fixes for this table.&quot;&quot;&quot;</span>
        <span class="n">calc_fixes</span> <span class="o">=</span> <span class="n">read_xbrl_calculation_fixes</span><span class="p">()</span>
        <span class="c1"># grab the fixes from this table only!</span>
        <span class="n">calc_fixes</span> <span class="o">=</span> <span class="n">calc_fixes</span><span class="p">[</span><span class="n">calc_fixes</span><span class="o">.</span><span class="n">table_name_parent</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">calc_fixes</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.apply_xbrl_calculation_fixes">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.apply_xbrl_calculation_fixes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_xbrl_calculation_fixes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">calc_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">calc_fixes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use the fixes we&#39;ve compiled to update calculations in the XBRL metadata.</span>

<span class="sd">        Instructions for updating the calculation component fixes file:</span>

<span class="sd">        * To add a calculation component that is missing from the raw metadata,</span>
<span class="sd">          add a new line in the ``xbrl_calculation_component_fixes.csv`` with a</span>
<span class="sd">          the parent and child portion of the calculation and a weight.</span>
<span class="sd">        * To remove a calculation component that exists incorrectly in the raw</span>
<span class="sd">          metadata, add a line in the ``xbrl_calculation_component_fixes.csv``</span>
<span class="sd">          with the parent and child portion of the calculation without a weight.</span>
<span class="sd">        * To edit the weight of a calculation component that exists in the raw</span>
<span class="sd">          metadata, add a line in the ``xbrl_calculation_component_fixes.csv``</span>
<span class="sd">          with the parent and child portion of the calculation with the corrected</span>
<span class="sd">          weight.</span>

<span class="sd">        Some common errors occurs when ingesting new metadata which flags the</span>
<span class="sd">        AssertionError in this method. If you&#39;re trying to remove a calculation component</span>
<span class="sd">        manually and it doesn&#39;t actually exist as a calculation component in the metadata,</span>
<span class="sd">        an AssertionError will be raised. Similarly, if you&#39;re trying to add a</span>
<span class="sd">        calculation component manually that already exists, an AssertionError will be</span>
<span class="sd">        raised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">calc_comp_idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;table_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">dupes</span> <span class="o">:=</span> <span class="n">calc_fixes</span><span class="p">[</span><span class="n">calc_fixes</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">calc_comp_idx</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;Duplicates found in the calculation fixes where none were expected.&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dupes</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">calc_fixes</span> <span class="o">=</span> <span class="n">calc_fixes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">calc_comp_idx</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">calc_components</span> <span class="o">=</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">calc_comp_idx</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="c1"># find the fixes that need to be replaced. We id them</span>
        <span class="c1"># by finding the fixes that share indexes with the calc components</span>
        <span class="c1"># Note: we can&#39;t just dropna after adding the replacements instead</span>
        <span class="c1"># of while finding the replacements because we have included all</span>
        <span class="c1"># factoids in the calculation component table as parent factoids</span>
        <span class="c1"># even if there are no/null calculation components.</span>
        <span class="n">replace_me</span> <span class="o">=</span> <span class="n">calc_fixes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">calc_fixes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">calc_components</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="n">calc_components</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">replace_me</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">replace_me</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span> <span class="o">=</span> <span class="n">replace_me</span>

        <span class="c1"># find the lines that only show up in the fixes that need to be added</span>
        <span class="n">add_me</span> <span class="o">=</span> <span class="n">calc_fixes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">calc_fixes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">calc_components</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">calc_components</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">calc_components</span><span class="p">,</span> <span class="n">add_me</span><span class="p">])</span>
        <span class="c1"># sometimes we add fresh calculations to parent facts that originally didn&#39;t</span>
        <span class="c1"># have any calculation components. So if we are adding those parent facts</span>
        <span class="c1"># with child facts/calc components, we need to remove the non-calc records</span>
        <span class="c1"># so make fake little parent facts with null children from all the add_mes</span>
        <span class="n">null_calc_versions_of_add_mes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">add_me</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">xbrl_factoid</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">calc_comp_idx</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">remove_the_non_cals_from_add_mes</span> <span class="o">=</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
            <span class="n">null_calc_versions_of_add_mes</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">calc_components</span> <span class="o">=</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">remove_the_non_cals_from_add_mes</span><span class="p">]</span>

        <span class="c1"># find the &quot;null&quot; fixes which correspond to records which need to be deleted.</span>
        <span class="n">delete_me</span> <span class="o">=</span> <span class="n">calc_fixes</span><span class="p">[</span><span class="n">calc_fixes</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">calc_components</span> <span class="o">=</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">calc_components</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">delete_me</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">len_fixes_applied</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">replace_me</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_me</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">delete_me</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;We&#39;ve applied </span><span class="si">{</span><span class="n">len_fixes_applied</span><span class="si">}</span><span class="s2"> calculation fixes including &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">replace_me</span><span class="p">)</span><span class="si">}</span><span class="s2"> replacements, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">add_me</span><span class="p">)</span><span class="si">}</span><span class="s2"> additions and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">delete_me</span><span class="p">)</span><span class="si">}</span><span class="s2"> deletions.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">calc_fixes</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len_fixes_applied</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;We&#39;ve applied </span><span class="si">{</span><span class="n">len_fixes_applied</span><span class="si">}</span><span class="s2"> calculation fixes while we started &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">calc_fixes</span><span class="p">)</span><span class="si">}</span><span class="s2">. Length of applied and original fixes should &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;be the same.</span><span class="se">\n</span><span class="si">{</span><span class="n">replace_me</span><span class="si">=}</span><span class="se">\n</span><span class="si">{</span><span class="n">add_me</span><span class="si">=}</span><span class="se">\n</span><span class="si">{</span><span class="n">delete_me</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.process_xbrl_metadata_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.process_xbrl_metadata_calculations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl_metadata_calculations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">xbrl_metadata_converted</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert xbrl metadata calculations into a table of calculation components.</span>

<span class="sd">        This method extracts the calculations from the ``xbrl_metadata_converted``</span>
<span class="sd">        that are stored as json embedded within the ``calculations``column and convert</span>
<span class="sd">        those into calculation component records. The resulting table includes columns</span>
<span class="sd">        pertaining to both the calculation components and the parent factoid that the</span>
<span class="sd">        components pertain to. The parental columns had suffixes of ``_parent``.</span>

<span class="sd">        This method also adds fixes to the calculations via</span>
<span class="sd">        :meth:`apply_xbrl_calculation_fixes`, adds corrections records via</span>
<span class="sd">        :meth:`add_calculation_corrections` and adds the column</span>
<span class="sd">        ``is_within_table_calc``.</span>

<span class="sd">        Args:</span>
<span class="sd">            xbrl_metadata_converted: Dataframe of relatively unprocessed metadata.</span>
<span class="sd">                Result of :meth:`convert_xbrl_metadata_json_to_df`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">xbrl_metadata_converted</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">calculations</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">calculations</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">)</span>
        <span class="c1"># reset the index post calc explosion so we can merge on index later</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;calculations&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">calculations</span><span class="o">.</span><span class="n">isnull</span><span class="p">()):</span>
            <span class="n">calc_comps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;source_tables&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">calc_comps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">calculations</span><span class="p">)</span>

        <span class="n">calc_comps</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">calc_comps</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;source_tables&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;source_tables&quot;</span><span class="p">:</span> <span class="s2">&quot;table_name&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;calculations&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">table_name_parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">table_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rename_xbrl_factoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">),</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_xbrl_factoid_other_tables</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_xbrl_calculation_fixes</span><span class="p">,</span>
                <span class="n">calc_fixes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_xbrl_calculation_fixes</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># this is really a xbrl_factoid-level flag, but we need it while using this</span>
        <span class="c1"># calc components.</span>
        <span class="n">calc_comps</span><span class="p">[</span><span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># make a temp bool col to check if all the components are intra table</span>
            <span class="c1"># should the non-calc guys get a null or a true here? rn its true bc fillna</span>
            <span class="n">calc_comps</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">intra_table_calc_comp_flag</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">table_name</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">])[</span>
                <span class="s2">&quot;intra_table_calc_comp_flag&quot;</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">BooleanDtype</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="c1"># check for uniqueness only when we are reconciling the calculations</span>
        <span class="c1"># bc that implies we have cleaned the calcs and are intending to use them.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">column_to_check</span><span class="p">:</span>
            <span class="n">calc_comp_idx</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span>
                <span class="s2">&quot;table_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">dupes</span> <span class="o">:=</span> <span class="n">calc_comps</span><span class="p">[</span><span class="n">calc_comps</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">calc_comp_idx</span><span class="p">)]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;Duplicates found in the calculation components where none were .&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;expected </span><span class="si">{</span><span class="n">dupes</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">calc_comps</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_calculation_corrections</span><span class="p">)</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.add_columns_with_uniform_values">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.add_columns_with_uniform_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_columns_with_uniform_values</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">AddColumnsWithUniformValues</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a column with a uniform value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">add_columns_with_uniform_values</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">columns_to_add</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Adding uniform value columns. </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">assign_cols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">add_columns_with_uniform_values</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;merge_xbrl_metadata&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.merge_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.merge_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">MergeXbrlMetadata</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine XBRL-derived metadata with the data it pertains to.</span>

<span class="sd">        While the metadata we&#39;re using to annotate the data comes from the more recent</span>
<span class="sd">        XBRL data, it applies generally to all the historical DBF data as well! This</span>
<span class="sd">        method reads the normalized metadata out of an attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">merge_xbrl_metadata</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_metadata</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;Metadata has not yet been generated. Must run process_xbrl_metadata&quot;</span>
                    <span class="s2">&quot;and assign xbrl_metadata before merging metadata.&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Merging metadata&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">merge_xbrl_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_metadata</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.align_row_numbers_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.align_row_numbers_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_row_numbers_dbf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">AlignRowNumbersDbf</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Align historical FERC1 DBF row numbers with XBRL account IDs.</span>

<span class="sd">        Additional Parameterization TBD with additional experience. See:</span>
<span class="sd">        https://github.com/catalyst-cooperative/pudl/issues/2012</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">align_row_numbers_dbf</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">dbf_table_names</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">align_row_numbers_dbf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.drop_duplicate_rows_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.drop_duplicate_rows_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_duplicate_rows_dbf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">DropDuplicateRowsDbf</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop the DBF rows where the PKs and data columns are duplicated.</span>

<span class="sd">        Wrapper function for :func:`drop_duplicate_rows_dbf`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">drop_duplicate_rows_dbf</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">table_name</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Dropping rows where primary key and data &quot;</span>
                <span class="s2">&quot;columns are duplicated.&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">drop_duplicate_rows_dbf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DBF-specific transformations that take place before concatenation.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Processing DBF data pre-concatenation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">raw_dbf</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_annual_rows_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_footnote_columns_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">align_row_numbers_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_record_id</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">DBF</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_unused_original_columns_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_utility_id_ferc1</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">DBF</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wide_to_tidy</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">DBF</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_duplicate_rows_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_quarterly_data_to_yearly_dbf</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.process_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.process_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;XBRL-specific transformations that take place before concatenation.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Processing XBRL data pre-concatenation.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_instant_and_duration_tables_xbrl</span><span class="p">(</span>
                <span class="n">raw_xbrl_instant</span><span class="p">,</span> <span class="n">raw_xbrl_duration</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wide_to_tidy</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combine_axis_columns_xbrl</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_record_id</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_utility_id_ferc1</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.rename_columns">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.rename_columns">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rename_columns</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">rename_stage</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;dbf&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_instant&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_duration&quot;</span><span class="p">]</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">RenameColumns</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Grab the params based on the rename stage and run default rename_columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Table to be renamed.</span>
<span class="sd">            rename_stage: Name of stage in the transform process. Used to get specific</span>
<span class="sd">                stage&#39;s parameters if None have been passed.</span>
<span class="sd">            params: Rename column parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rename_columns_ferc1</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">rename_stage</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.select_annual_rows_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.select_annual_rows_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select_annual_rows_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select only annually reported DBF Rows.</span>

<span class="sd">        There are some DBF tables that include a mix of reporting frequencies. For now,</span>
<span class="sd">        the default for PUDL tables is to have only the annual records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;report_prd&quot;</span> <span class="ow">in</span> <span class="n">df</span> <span class="ow">and</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">report_prd</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">12</span><span class="p">]:</span>
            <span class="n">len_og</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">report_prd</span> <span class="o">==</span> <span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: After selection of only annual records,&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; we have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">len_og</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of the original table.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.assign_quarterly_data_to_yearly_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.assign_quarterly_data_to_yearly_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_quarterly_data_to_yearly_dbf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">AssignQuarterlyDataToYearlyDbf</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transfer quarterly filed data to annual columns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">assign_quarterly_data_to_yearly_dbf</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">quarterly_to_yearly_column_map</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Converting quarterly filed data to annual.&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">assign_quarterly_data_to_yearly_dbf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.unstack_balances_to_report_year_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.unstack_balances_to_report_year_instant_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unstack_balances_to_report_year_instant_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">UnstackBalancesToReportYearInstantXbrl</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Turn start year end year rows into columns for each value type.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Unstacking balances to the report years.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">unstack_balances_to_report_year_instant_xbrl</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">unstack_balances_to_report_year</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">unstack_balances_to_report_year_instant_xbrl</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">primary_key_cols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_table_primary_key</span><span class="p">(</span>
                    <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.wide_to_tidy">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.wide_to_tidy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">wide_to_tidy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">source_ferc1</span><span class="p">:</span> <span class="n">SourceFerc1</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">WideToTidy</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reshape wide tables with FERC account columns to tidy format.</span>

<span class="sd">        The XBRL table coming into this method contains all the data from both the</span>
<span class="sd">        instant and duration tables in a wide format -- with one column for every</span>
<span class="sd">        combination of value type (e.g. additions, ending_balance) and accounting</span>
<span class="sd">        category, which means ~500 columns.</span>

<span class="sd">        We tidy this into a long table with one column for each of the value types (6 in</span>
<span class="sd">        all), and a new column that contains the accounting categories. This allows</span>
<span class="sd">        aggregation across columns to calculate the ending balance based on the starting</span>
<span class="sd">        balance and all of the reported changes, and aggregation across groups of rows</span>
<span class="sd">        to total up various hierarchical accounting categories (hydraulic turbines -&gt;</span>
<span class="sd">        hydraulic production plant -&gt; all  production plant -&gt; all electric utility</span>
<span class="sd">        plant) though the categorical columns required for that aggregation are added</span>
<span class="sd">        later.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">wide_to_tidy</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">multiple_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">WideToTidy</span><span class="p">)</span> <span class="k">else</span> <span class="n">params</span>
        <span class="k">for</span> <span class="n">single_params</span> <span class="ow">in</span> <span class="n">multiple_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">single_params</span><span class="o">.</span><span class="n">idx_cols</span> <span class="ow">or</span> <span class="n">single_params</span><span class="o">.</span><span class="n">value_types</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: applying wide_to_tidy for </span><span class="si">{</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">wide_to_tidy</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">single_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.combine_axis_columns_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.combine_axis_columns_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">combine_axis_columns_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">CombineAxisColumnsXbrl</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine axis columns from squished XBRL tables into one column with no NA.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">combine_axis_columns_xbrl</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">axis_columns_to_combine</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Combining axis columns: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">axis_columns_to_combine</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">new_axis_column_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">combine_axis_columns_xbrl</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.merge_instant_and_duration_tables_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.merge_instant_and_duration_tables_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_instant_and_duration_tables_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge XBRL instant and duration tables, reshaping instant as needed.</span>

<span class="sd">        FERC1 XBRL instant period signifies that it is true as of the reported date,</span>
<span class="sd">        while a duration fact pertains to the specified time period. The ``date`` column</span>
<span class="sd">        for an instant fact corresponds to the ``end_date`` column of a duration fact.</span>

<span class="sd">        When merging the instant and duration tables, we need to preserve row order.</span>
<span class="sd">        For the small generators table, row order is how we label and extract</span>
<span class="sd">        information from header and note rows. Outer merging messes up the order, so we</span>
<span class="sd">        need to use a one-sided merge. So far, it seems like the duration df contains</span>
<span class="sd">        all the index values in the instant df. To be sure, there&#39;s a check that makes</span>
<span class="sd">        sure there are no unique instant df index values. If that passes, we merge the</span>
<span class="sd">        instant table into the duration table, and the row order is preserved.</span>

<span class="sd">        Note: This should always be applied before :meth:``rename_columns``</span>

<span class="sd">        Args:</span>
<span class="sd">            raw_xbrl_instant: table representing XBRL instant facts.</span>
<span class="sd">            raw_xbrl_duration: table representing XBRL duration facts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A unified table combining the XBRL duration and instant facts, if both types</span>
<span class="sd">            of facts were present. If either input dataframe is empty, the other</span>
<span class="sd">            dataframe is returned unchanged, except that several unused columns are</span>
<span class="sd">            dropped. If both input dataframes are empty, an empty dataframe is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filing_name&quot;</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">]</span>
        <span class="c1"># Ignore errors in case not all drop_cols are present.</span>
        <span class="c1"># Do any table-specific preprocessing of the instant and duration tables</span>
        <span class="n">instant</span> <span class="o">=</span> <span class="n">raw_xbrl_instant</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_instant_xbrl</span>
        <span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">raw_xbrl_duration</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_duration_xbrl</span>
        <span class="p">)</span>

        <span class="n">instant_axes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">raw_xbrl_instant</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_axis&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">duration_axes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">raw_xbrl_duration</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_axis&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">instant_axes</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="nb">bool</span><span class="p">(</span><span class="n">duration_axes</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">instant_axes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">duration_axes</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Instant and Duration XBRL Axes do not match.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    instant: </span><span class="si">{</span><span class="n">instant_axes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;    duration: </span><span class="si">{</span><span class="n">duration_axes</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">instant</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: No XBRL instant table found.&quot;</span><span class="p">)</span>
            <span class="n">out_df</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="k">elif</span> <span class="n">duration</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: No XBRL duration table found.&quot;</span><span class="p">)</span>
            <span class="n">out_df</span> <span class="o">=</span> <span class="n">instant</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Both XBRL instant &amp; duration tables found.&quot;</span>
            <span class="p">)</span>
            <span class="n">instant_merge_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;entity_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">instant_axes</span>
            <span class="n">duration_merge_keys</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;entity_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sched_table_name&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">+</span> <span class="n">duration_axes</span>
            <span class="c1"># See if there are any values in the instant table that don&#39;t show up in the</span>
            <span class="c1"># duration table.</span>
            <span class="n">unique_instant_rows</span> <span class="o">=</span> <span class="n">instant</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
                <span class="n">instant_merge_keys</span>
            <span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">duration_merge_keys</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_instant_rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Combining XBRL instant &amp; duration tables &quot;</span>
                    <span class="s2">&quot;using RIGHT-MERGE.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Merge instant into duration.</span>
                <span class="n">out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">instant</span><span class="p">,</span>
                    <span class="n">duration</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="n">left_on</span><span class="o">=</span><span class="n">instant_merge_keys</span><span class="p">,</span>
                    <span class="n">right_on</span><span class="o">=</span><span class="n">duration_merge_keys</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: Check whether our assumptions about these tables hold before</span>
                <span class="c1"># concatenating them. May need to be table specific. E.g.</span>
                <span class="c1"># * What fraction of their index values overlap? (it should be high!)</span>
                <span class="c1"># * Do the instant/duration columns conform to expected naming conventions?</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Combining XBRL instant &amp; duration tables &quot;</span>
                    <span class="s2">&quot;using CONCATENATION.&quot;</span>
                <span class="p">)</span>
                <span class="n">out_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">instant</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">instant_merge_keys</span><span class="p">),</span>
                        <span class="n">duration</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">duration_merge_keys</span><span class="p">),</span>
                    <span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">Ferc1Settings</span><span class="p">()</span><span class="o">.</span><span class="n">xbrl_years</span><span class="p">)]</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_instant_xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.process_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.process_instant_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_instant_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-processing required to make instant and duration tables compatible.</span>

<span class="sd">        Column renaming is sometimes required because a few columns in the instant and</span>
<span class="sd">        duration tables do not have corresponding names that follow the naming</span>
<span class="sd">        conventions of ~95% of all the columns, which we rely on programmatically when</span>
<span class="sd">        reshaping and concatenating these tables together.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;instant_xbrl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unstack_balances_to_report_year_instant_xbrl</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_duration_xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.process_duration_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.process_duration_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_duration_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-processing required to make instant and duration tables compatible.</span>

<span class="sd">        Column renaming is sometimes required because a few columns in the instant and</span>
<span class="sd">        duration tables do not have corresponding names that follow the naming</span>
<span class="sd">        conventions of ~95% of all the columns, which we rely on programmatically when</span>
<span class="sd">        reshaping and concatenating these tables together.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;duration_xbrl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="n">select_current_year_annual_records_duration_xbrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.drop_footnote_columns_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.drop_footnote_columns_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_footnote_columns_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop DBF footnote reference columns, which all end with _f.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Dropping DBF footnote columns.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*_f$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.source_table_primary_key">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.source_table_primary_key">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">source_table_primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="p">:</span> <span class="n">SourceFerc1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look up the pre-renaming source table primary key columns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_ferc1</span> <span class="o">==</span> <span class="n">SourceFerc1</span><span class="o">.</span><span class="n">DBF</span><span class="p">:</span>
            <span class="n">pk_cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;report_prd&quot;</span><span class="p">,</span>
                <span class="s2">&quot;respondent_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;spplmnt_num&quot;</span><span class="p">,</span>
                <span class="s2">&quot;row_number&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">source_ferc1</span> <span class="o">==</span> <span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span>  <span class="c1"># nosec: B101</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rename_columns_ferc1</span><span class="o">.</span><span class="n">xbrl</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">pk_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_id&quot;</span><span class="p">]</span>
            <span class="c1"># Sort to avoid dependence on the ordering of rename_columns.</span>
            <span class="c1"># Doing the sorting here because we have a particular ordering</span>
            <span class="c1"># hard coded for the DBF primary keys.</span>
            <span class="n">pk_cols</span> <span class="o">+=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_axis&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pk_cols</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.renamed_table_primary_key">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.renamed_table_primary_key">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">renamed_table_primary_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="p">:</span> <span class="n">SourceFerc1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Look up the post-renaming primary key columns.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_ferc1</span> <span class="o">==</span> <span class="n">SourceFerc1</span><span class="o">.</span><span class="n">DBF</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rename_columns_ferc1</span><span class="o">.</span><span class="n">dbf</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">source_ferc1</span> <span class="o">==</span> <span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span>  <span class="c1"># nosec: B101</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">rename_columns_ferc1</span><span class="o">.</span><span class="n">xbrl</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">pk_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_table_primary_key</span><span class="p">(</span><span class="n">source_ferc1</span><span class="o">=</span><span class="n">source_ferc1</span><span class="p">)</span>
        <span class="c1"># Translate to the renamed columns</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pk_cols</span><span class="p">]</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="Ferc1AbstractTableTransformer.drop_unused_original_columns_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.drop_unused_original_columns_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_unused_original_columns_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove residual DBF specific columns.&quot;&quot;&quot;</span>
        <span class="n">unused_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;report_prd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spplmnt_num&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_seq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_prvlg&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Dropping unused DBF structural columns: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unused_cols</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">missing_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unused_cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Trying to drop missing original DBF columns:&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">unused_cols</span><span class="p">)</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.assign_record_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.assign_record_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_record_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="p">:</span> <span class="n">SourceFerc1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a column identifying the original source record for each row.</span>

<span class="sd">        It is often useful to be able to tell exactly which record in the FERC Form 1</span>
<span class="sd">        database a given record within the PUDL database came from.</span>

<span class="sd">        Within each FERC Form 1 DBF table, each record is supposed to be uniquely</span>
<span class="sd">        identified by the combination of: report_year, report_prd, utility_id_ferc1_dbf,</span>
<span class="sd">        spplmnt_num, row_number.</span>

<span class="sd">        The FERC Form 1 XBRL tables do not have these supplement and row number</span>
<span class="sd">        columns, so we construct an id based on:</span>
<span class="sd">        report_year, utility_id_ferc1_xbrl, and the primary key columns of the XBRL table</span>

<span class="sd">        Args:</span>
<span class="sd">            df: table to assign ``record_id`` to</span>
<span class="sd">            source_ferc1: data source of raw ferc1 database.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any of the primary key columns are missing from the DataFrame</span>
<span class="sd">                being processed.</span>
<span class="sd">            ValueError: If there are any null values in the primary key columns.</span>
<span class="sd">            ValueError: If the resulting ``record_id`` column is non-unique.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Assigning </span><span class="si">{</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> source record IDs.&quot;</span>
        <span class="p">)</span>
        <span class="n">pk_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_table_primary_key</span><span class="p">(</span><span class="n">source_ferc1</span><span class="p">)</span>
        <span class="n">missing_pk_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_pk_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">): Missing primary key &quot;</span>
                <span class="s2">&quot;columns in dataframe while assigning source record_id: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missing_pk_cols</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">pk_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">): Found null primary key &quot;</span>
                <span class="s2">&quot;values.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">pk_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">record_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sched_table_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="n">pk_cols</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;_&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">sched_table_name</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Null sched_table_name&#39;s were found where none &quot;</span>
                <span class="s2">&quot;were expected.&quot;</span>
            <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">record_id</span> <span class="o">=</span> <span class="n">enforce_snake_case</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">record_id</span><span class="p">)</span>

        <span class="n">dupe_ids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">record_id</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">record_id</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dupe_ids</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_unique_record_ids</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dupe_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate record_ids: </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dupe_ids</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.assign_utility_id_ferc1">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.assign_utility_id_ferc1">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_utility_id_ferc1</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="p">:</span> <span class="n">SourceFerc1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign the PUDL-assigned utility_id_ferc1 based on the native utility ID.</span>

<span class="sd">        We need to replace the natively reported utility ID from each of the two FERC1</span>
<span class="sd">        sources with a PUDL-assigned utility. The mapping between the native ID&#39;s and</span>
<span class="sd">        these PUDL-assigned ID&#39;s can be accessed in the database tables</span>
<span class="sd">        ``utilities_dbf_ferc1`` and ``utilities_xbrl_ferc1``.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: the input table with the native utility ID column.</span>
<span class="sd">            source_ferc1: the</span>

<span class="sd">        Returns:</span>
<span class="sd">            an augemented version of the input ``df`` with a new column that replaces</span>
<span class="sd">            the natively reported utility ID with the PUDL-assigned utility ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Assigning </span><span class="si">{</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> source utility IDs.&quot;</span>
        <span class="p">)</span>
        <span class="n">utility_map_ferc1</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">glue</span><span class="o">.</span><span class="n">ferc1_eia</span><span class="o">.</span><span class="n">get_utility_map_ferc1</span><span class="p">()</span>
        <span class="c1"># use the source utility ID column to get a unique map and for merging</span>
        <span class="n">util_id_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;utility_id_ferc1_</span><span class="si">{</span><span class="n">source_ferc1</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">util_map_series</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">utility_map_ferc1</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">util_id_col</span><span class="p">])</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">util_id_col</span><span class="p">)</span>
            <span class="o">.</span><span class="n">utility_id_ferc1</span>
        <span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">util_id_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">util_map_series</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Ferc1AbstractTableTransformer.reconcile_table_calculations">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.Ferc1AbstractTableTransformer.reconcile_table_calculations">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reconcile_table_calculations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">ReconcileTableCalculations</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check how well a table&#39;s calculated values match reported values.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">column_to_check</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_calculations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="s2">&quot;No calculations table has been built. Must run process_xbrl_metadata_calculations&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Checking the XBRL metadata-based calculations.&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">reconcile_table_calculations</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                <span class="n">calculation_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xbrl_calculations</span><span class="p">,</span>
                <span class="n">xbrl_factoid_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xbrl_factoid_name</span><span class="p">,</span>
                <span class="n">xbrl_metadata</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xbrl_metadata</span><span class="p">,</span>
                <span class="n">table_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="SteamPlantsFuelTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SteamPlantsFuelTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A table transformer specific to the :ref:`core_ferc1__yearly_steam_plants_fuel_sched402` table.</span>

<span class="sd">    The :ref:`core_ferc1__yearly_steam_plants_fuel_sched402` table reports data about fuel consumed by large thermal power</span>
<span class="sd">    plants in the :ref:`core_ferc1__yearly_steam_plants_sched402` table. Each record in the steam table is</span>
<span class="sd">    typically associated with several records in the fuel table, with each fuel record</span>
<span class="sd">    reporting data for a particular type of fuel consumed by that plant over the course</span>
<span class="sd">    of a year. The fuel table presents several challenges.</span>

<span class="sd">    The type of fuel, which is part of the primary key for the table, is a freeform</span>
<span class="sd">    string with hundreds of different nonstandard values. These strings are categorized</span>
<span class="sd">    manually and converted to ``fuel_type_code_pudl``. Some values cannot be categorized</span>
<span class="sd">    and are set to ``other``. In other string categorizations we set the unidentifiable</span>
<span class="sd">    values to NA, but in this table the fuel type is part of the primary key and primary</span>
<span class="sd">    keys cannot contain NA values.</span>

<span class="sd">    This simplified categorization occasionally results in records with duplicate</span>
<span class="sd">    primary keys. In those cases the records are aggregated into a single record if they</span>
<span class="sd">    have the same apparent physical units. If the fuel units are different, only the</span>
<span class="sd">    first record is retained.</span>

<span class="sd">    Several columns have unspecified, inconsistent, fuel-type specific units of measure</span>
<span class="sd">    associated with them. In order for records to be comparable and aggregatable, we</span>
<span class="sd">    have to infer and standardize these units.</span>

<span class="sd">    In the raw FERC Form 1 data there is a ``fuel_units`` column which describes the</span>
<span class="sd">    units of fuel delivered or consumed. Most commonly this is short tons for solid</span>
<span class="sd">    fuels (coal), thousands of cubic feet (Mcf) for gaseous fuels, and barrels (bbl) for</span>
<span class="sd">    liquid fuels.  However, the ``fuel_units`` column is also a freeform string with</span>
<span class="sd">    hundreds of nonstandard values which we have to manually categorize, and many of the</span>
<span class="sd">    values do not map directly to the most commonly used units for fuel quantities. E.g.</span>
<span class="sd">    some solid fuel quantities are reported in pounds, or thousands of pounds, not tons;</span>
<span class="sd">    some liquid fuels are reported in gallons or thousands of gallons, not barrels; and</span>
<span class="sd">    some gaseous fuels are reported in cubic feet not thousands of cubic feet.</span>

<span class="sd">    Two additional columns report fuel price per unit of heat content and fuel heat</span>
<span class="sd">    content per physical unit of fuel. The units of those columns are not explicitly</span>
<span class="sd">    reported, vary by fuel, and are inconsistent within individual fuel types.</span>

<span class="sd">    We adopt standardized units and attempt to convert all reported values in the fuel</span>
<span class="sd">    table into those units. For physical fuel units we adopt those that are used by the</span>
<span class="sd">    EIA: short tons (tons) for solid fuels, barrels (bbl) for liquid fuels, and</span>
<span class="sd">    thousands of cubic feet (mcf) for gaseous fuels. For heat content per (physical)</span>
<span class="sd">    unit of fuel, we use millions of British thermal units (mmbtu). All fuel prices are</span>
<span class="sd">    converted to US dollars, while many are reported in cents.</span>

<span class="sd">    Because the reported fuel price and heat content units are implicit, we have to</span>
<span class="sd">    infer them based on observed values. This is only possible because these quantities</span>
<span class="sd">    are ratios with well defined ranges of valid values. The common units that we</span>
<span class="sd">    observe and attempt to standardize include:</span>

<span class="sd">    * coal: primarily BTU/pound, but also MMBTU/ton and MMBTU/pound.</span>
<span class="sd">    * oil: primarily BTU/gallon.</span>
<span class="sd">    * gas: reported in a mix of MMBTU/cubic foot, and MMBTU/thousand cubic feet.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">STEAM_PLANTS_FUEL</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Table specific transforms for core_ferc1__yearly_steam_plants_fuel_sched402.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A single transformed table concatenating multiple years of cleaned data</span>
<span class="sd">            derived from the raw DBF and/or XBRL inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spot_fix_values</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_invalid_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">correct_units</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start with inherited method and do some fuel-specific processing.</span>

<span class="sd">        We have to do most of the transformation before the DBF and XBRL data have been</span>
<span class="sd">        concatenated because the fuel type column is part of the primary key and it is</span>
<span class="sd">        extensively modified in the cleaning process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span>
            <span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize_physical_fuel_units</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.process_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.process_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Special pre-concat treatment of the :ref:`core_ferc1__yearly_steam_plants_fuel_sched402` table.</span>

<span class="sd">        We have to do most of the transformation before the DBF and XBRL data have been</span>
<span class="sd">        concatenated because the fuel type column is part of the primary key and it is</span>
<span class="sd">        extensively modified in the cleaning process. For the XBRL data, this means we</span>
<span class="sd">        can&#39;t create a record ID until that fuel type value is clean. In addition, the</span>
<span class="sd">        categorization of fuel types results in a number of duplicate fuel records which</span>
<span class="sd">        need to be aggregated.</span>

<span class="sd">        Args:</span>
<span class="sd">            raw_xbrl_instant: Freshly extracted XBRL instant fact table.</span>
<span class="sd">            raw_xbrl_duration: Freshly extracted XBRL duration fact table.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Almost fully transformed XBRL data table, with instant and duration facts</span>
<span class="sd">            merged together.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_instant_and_duration_tables_xbrl</span><span class="p">(</span>
                <span class="n">raw_xbrl_instant</span><span class="p">,</span> <span class="n">raw_xbrl_duration</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize_physical_fuel_units</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_duplicate_fuel_types_xbrl</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_record_id</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assign_utility_id_ferc1</span><span class="p">,</span>
                <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.to_numeric">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.to_numeric">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_numeric</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert columns containing numeric strings to numeric types.&quot;&quot;&quot;</span>
        <span class="n">numeric_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;fuel_consumed_units&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_burned&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_delivered&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_mmbtu&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.standardize_physical_fuel_units">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.standardize_physical_fuel_units">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">standardize_physical_fuel_units</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert reported fuel quantities to standard units depending on fuel type.</span>

<span class="sd">        Use the categorized fuel type and reported fuel units to convert all fuel</span>
<span class="sd">        quantities to the following standard units, depending on whether the fuel is a</span>
<span class="sd">        solid, liquid, or gas. When a single fuel reports its quantity in fundamentally</span>
<span class="sd">        different units, convert based on typical values. E.g. 19.85 MMBTU per ton of</span>
<span class="sd">        coal, 1.037 Mcf per MMBTU of natural gas, 7.46 barrels per ton of oil.</span>

<span class="sd">          * solid fuels (coal and waste): short tons [ton]</span>
<span class="sd">          * liquid fuels (oil): barrels [bbl]</span>
<span class="sd">          * gaseous fuels (gas): thousands of cubic feet [mcf]</span>

<span class="sd">        Columns to which these physical units apply:</span>

<span class="sd">          * fuel_consumed_units (tons, bbl, mcf)</span>
<span class="sd">          * fuel_cost_per_unit_burned (usd/ton, usd/bbl, usd/mcf)</span>
<span class="sd">          * fuel_cost_per_unit_delivered (usd/ton, usd/bbl, usd/mcf)</span>

<span class="sd">        One remaining challenge in this standardization is that nuclear fuel is reported</span>
<span class="sd">        in both mass of Uranium and fuel heat content, and it&#39;s unclear if there&#39;s any</span>
<span class="sd">        reasonable typical conversion between these units, since available heat content</span>
<span class="sd">        depends on the degree of U235 enrichement, the type of reactor, and whether the</span>
<span class="sd">        fuel is just Uranium, or a mix of Uranium and Plutonium from decommissioned</span>
<span class="sd">        nuclear weapons. See:</span>

<span class="sd">        https://world-nuclear.org/information-library/facts-and-figures/heat-values-of-various-fuels.aspx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">FuelFix</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;FuelFix&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;fuel&quot;</span><span class="p">,</span> <span class="s2">&quot;from_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;to_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;mult&quot;</span><span class="p">])</span>
        <span class="n">fuel_fixes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># US average coal heat content is 19.85 mmbtu/short ton</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;coal&quot;</span><span class="p">,</span> <span class="s2">&quot;mmbtu&quot;</span><span class="p">,</span> <span class="s2">&quot;ton&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">19.85</span><span class="p">)),</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;coal&quot;</span><span class="p">,</span> <span class="s2">&quot;btu&quot;</span><span class="p">,</span> <span class="s2">&quot;ton&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">19.85e6</span><span class="p">)),</span>
            <span class="c1"># 2000 lbs per short ton</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;coal&quot;</span><span class="p">,</span> <span class="s2">&quot;lbs&quot;</span><span class="p">,</span> <span class="s2">&quot;ton&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2000.0</span><span class="p">)),</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;coal&quot;</span><span class="p">,</span> <span class="s2">&quot;klbs&quot;</span><span class="p">,</span> <span class="s2">&quot;ton&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)),</span>
            <span class="c1"># 42 gallons per barrel. Seriously, who makes up these units?</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;oil&quot;</span><span class="p">,</span> <span class="s2">&quot;gal&quot;</span><span class="p">,</span> <span class="s2">&quot;bbl&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">42.0</span><span class="p">)),</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;oil&quot;</span><span class="p">,</span> <span class="s2">&quot;kgal&quot;</span><span class="p">,</span> <span class="s2">&quot;bbl&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">/</span> <span class="mf">42.0</span><span class="p">)),</span>
            <span class="c1"># On average a &quot;ton of oil equivalent&quot; is 7.46 barrels</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;oil&quot;</span><span class="p">,</span> <span class="s2">&quot;ton&quot;</span><span class="p">,</span> <span class="s2">&quot;bbl&quot;</span><span class="p">,</span> <span class="mf">7.46</span><span class="p">),</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;gas&quot;</span><span class="p">,</span> <span class="s2">&quot;mmbtu&quot;</span><span class="p">,</span> <span class="s2">&quot;mcf&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">1.037</span><span class="p">)),</span>
            <span class="c1"># Nuclear plants report either heat content or mass of heavy metal</span>
            <span class="c1"># MW*days thermal to MWh thermal</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;nuclear&quot;</span><span class="p">,</span> <span class="s2">&quot;mwdth&quot;</span><span class="p">,</span> <span class="s2">&quot;mwhth&quot;</span><span class="p">,</span> <span class="mf">24.0</span><span class="p">),</span>
            <span class="c1"># Straight energy equivalence between BTU and MWh here:</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;nuclear&quot;</span><span class="p">,</span> <span class="s2">&quot;mmbtu&quot;</span><span class="p">,</span> <span class="s2">&quot;mwhth&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.412142</span><span class="p">)),</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;nuclear&quot;</span><span class="p">,</span> <span class="s2">&quot;btu&quot;</span><span class="p">,</span> <span class="s2">&quot;mwhth&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">3412142</span><span class="p">)),</span>
            <span class="c1"># Unclear if it&#39;s possible to convert heavy metal to heat reliably</span>
            <span class="n">FuelFix</span><span class="p">(</span><span class="s2">&quot;nuclear&quot;</span><span class="p">,</span> <span class="s2">&quot;grams&quot;</span><span class="p">,</span> <span class="s2">&quot;kg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">fix</span> <span class="ow">in</span> <span class="n">fuel_fixes</span><span class="p">:</span>
            <span class="n">fuel_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fuel_type_code_pudl</span> <span class="o">==</span> <span class="n">fix</span><span class="o">.</span><span class="n">fuel</span>
            <span class="n">unit_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fuel_units</span> <span class="o">==</span> <span class="n">fix</span><span class="o">.</span><span class="n">from_unit</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fuel_mask</span> <span class="o">&amp;</span> <span class="n">unit_mask</span><span class="p">),</span> <span class="s2">&quot;fuel_consumed_units&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">fix</span><span class="o">.</span><span class="n">mult</span>
            <span class="c1"># Note: The 2 corrections below DIVIDE by the multiplier because the units</span>
            <span class="c1"># are in the denominator (&quot;per_unit&quot;) rather than the numerator.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fuel_mask</span> <span class="o">&amp;</span> <span class="n">unit_mask</span><span class="p">),</span> <span class="s2">&quot;fuel_cost_per_unit_burned&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">fix</span><span class="o">.</span><span class="n">mult</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fuel_mask</span> <span class="o">&amp;</span> <span class="n">unit_mask</span><span class="p">),</span> <span class="s2">&quot;fuel_cost_per_unit_delivered&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">fix</span><span class="o">.</span><span class="n">mult</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fuel_mask</span> <span class="o">&amp;</span> <span class="n">unit_mask</span><span class="p">),</span> <span class="s2">&quot;fuel_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix</span><span class="o">.</span><span class="n">to_unit</span>

        <span class="c1"># Set all remaining non-standard units and affected columns to NA.</span>
        <span class="n">FuelAllowedUnits</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;FuelAllowedUnits&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;fuel&quot;</span><span class="p">,</span> <span class="s2">&quot;allowed_units&quot;</span><span class="p">])</span>
        <span class="n">fuel_allowed_units</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">FuelAllowedUnits</span><span class="p">(</span><span class="s2">&quot;coal&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;ton&quot;</span><span class="p">,)),</span>
            <span class="n">FuelAllowedUnits</span><span class="p">(</span><span class="s2">&quot;oil&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;bbl&quot;</span><span class="p">,)),</span>
            <span class="n">FuelAllowedUnits</span><span class="p">(</span><span class="s2">&quot;gas&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;mcf&quot;</span><span class="p">,)),</span>
            <span class="n">FuelAllowedUnits</span><span class="p">(</span><span class="s2">&quot;nuclear&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;kg&quot;</span><span class="p">,</span> <span class="s2">&quot;mwhth&quot;</span><span class="p">)),</span>
            <span class="n">FuelAllowedUnits</span><span class="p">(</span><span class="s2">&quot;waste&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;ton&quot;</span><span class="p">,)),</span>
            <span class="c1"># All unidentified fuel types (&quot;other&quot;) get units set to NA</span>
            <span class="n">FuelAllowedUnits</span><span class="p">(</span><span class="s2">&quot;other&quot;</span><span class="p">,</span> <span class="p">()),</span>
        <span class="p">]</span>
        <span class="n">physical_units_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;fuel_consumed_units&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_burned&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_delivered&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">fau</span> <span class="ow">in</span> <span class="n">fuel_allowed_units</span><span class="p">:</span>
            <span class="n">fuel_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">fuel_type_code_pudl</span> <span class="o">==</span> <span class="n">fau</span><span class="o">.</span><span class="n">fuel</span>
            <span class="n">invalid_unit_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">fuel_units</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">fau</span><span class="o">.</span><span class="n">allowed_units</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fuel_mask</span> <span class="o">&amp;</span> <span class="n">invalid_unit_mask</span><span class="p">),</span> <span class="n">physical_units_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">fuel_mask</span> <span class="o">&amp;</span> <span class="n">invalid_unit_mask</span><span class="p">),</span> <span class="s2">&quot;fuel_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>

        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.aggregate_duplicate_fuel_types_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.aggregate_duplicate_fuel_types_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_duplicate_fuel_types_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fuel_xbrl</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate the fuel records having duplicate primary keys.&quot;&quot;&quot;</span>
        <span class="n">pk_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_table_primary_key</span><span class="p">(</span><span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;sched_table_name&quot;</span>
        <span class="p">]</span>
        <span class="n">fuel_xbrl</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;fuel_units_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fuel_xbrl</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
            <span class="s2">&quot;fuel_units&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;nunique&quot;</span><span class="p">)</span>

        <span class="c1"># split</span>
        <span class="n">dupe_mask</span> <span class="o">=</span> <span class="n">fuel_xbrl</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">pk_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">multi_unit_mask</span> <span class="o">=</span> <span class="n">fuel_xbrl</span><span class="o">.</span><span class="n">fuel_units_count</span> <span class="o">!=</span> <span class="mi">1</span>

        <span class="n">fuel_pk_dupes</span> <span class="o">=</span> <span class="n">fuel_xbrl</span><span class="p">[</span><span class="n">dupe_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">multi_unit_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fuel_multi_unit</span> <span class="o">=</span> <span class="n">fuel_xbrl</span><span class="p">[</span><span class="n">dupe_mask</span> <span class="o">&amp;</span> <span class="n">multi_unit_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fuel_non_dupes</span> <span class="o">=</span> <span class="n">fuel_xbrl</span><span class="p">[</span><span class="o">~</span><span class="n">dupe_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">multi_unit_mask</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Aggregating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fuel_pk_dupes</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows with &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;duplicate primary keys out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fuel_xbrl</span><span class="p">)</span><span class="si">}</span><span class="s2"> total rows.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Dropping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fuel_multi_unit</span><span class="p">)</span><span class="si">}</span><span class="s2"> records with &quot;</span>
            <span class="s2">&quot;inconsistent fuel units preventing aggregation &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fuel_xbrl</span><span class="p">)</span><span class="si">}</span><span class="s2"> total rows.&quot;</span>
        <span class="p">)</span>
        <span class="n">agg_row_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fuel_pk_dupes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">fuel_multi_unit</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fuel_xbrl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">agg_row_fraction</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">agg_row_fraction</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> of all rows are being &quot;</span>
                <span class="s2">&quot;aggregated. Higher than the allowed value of 15%!&quot;</span>
            <span class="p">)</span>
        <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;fuel_consumed_units&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_mmbtu_per_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_delivered&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_burned&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_mmbtu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_mwh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_mmbtu_per_mwh&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># apply</span>
        <span class="n">fuel_pk_dupes</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">sum_and_weighted_average_agg</span><span class="p">(</span>
            <span class="n">df_in</span><span class="o">=</span><span class="n">fuel_pk_dupes</span><span class="p">,</span>
            <span class="n">by</span><span class="o">=</span><span class="n">pk_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">,</span> <span class="s2">&quot;end_date&quot;</span><span class="p">,</span> <span class="s2">&quot;fuel_units&quot;</span><span class="p">],</span>
            <span class="n">sum_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fuel_consumed_units&quot;</span><span class="p">],</span>
            <span class="n">wtavg_dict</span><span class="o">=</span><span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="s2">&quot;fuel_consumed_units&quot;</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data_cols</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;fuel_consumed_units&quot;</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># We can&#39;t aggregate data when fuel units are inconsistent, but we don&#39;t want</span>
        <span class="c1"># to lose the records entirely, so we&#39;ll keep the first one.</span>
        <span class="n">fuel_multi_unit</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">data_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">fuel_multi_unit</span> <span class="o">=</span> <span class="n">fuel_multi_unit</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">pk_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="c1"># combine</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fuel_non_dupes</span><span class="p">,</span> <span class="n">fuel_pk_dupes</span><span class="p">,</span> <span class="n">fuel_multi_unit</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fuel_units_count&quot;</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.drop_total_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.drop_total_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_total_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop rows that represent plant totals rather than individual fuels.</span>

<span class="sd">        This is an imperfect, heuristic process. The rows we identify as probably</span>
<span class="sd">        representing totals rather than individual fuels:</span>

<span class="sd">        * have zero or null values in all of their numerical data columns</span>
<span class="sd">        * have no identifiable fuel type</span>
<span class="sd">        * have no identifiable fuel units</span>
<span class="sd">        * DO report a value for MMBTU / MWh (heat rate)</span>

<span class="sd">        In the case of the core_ferc1__yearly_steam_plants_fuel_sched402 table, we drop any row where all the data columns</span>
<span class="sd">        are null AND there&#39;s a non-null value in the ``fuel_mmbtu_per_mwh`` column, as</span>
<span class="sd">        it typically indicates a &quot;total&quot; row for a plant. We also require a null value</span>
<span class="sd">        for the fuel_units and an &quot;other&quot; value for the fuel type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;fuel_consumed_units&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_mmbtu_per_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_delivered&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_unit_burned&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_mmbtu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_mwh&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">total_rows_idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="n">data_cols</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>  <span class="c1"># No normal numerical data</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">fuel_units</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>  <span class="c1"># no recognizable fuel units</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">fuel_type_code_pudl</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">)</span>  <span class="c1"># No recognizable fuel type</span>
            <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">fuel_mmbtu_per_mwh</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>  <span class="c1"># But it DOES report heat rate!</span>
        <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Dropping &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_rows_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;rows representing plant-level all-fuel totals.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">total_rows_idx</span><span class="p">)</span></div>


<div class="viewcode-block" id="SteamPlantsFuelTableTransformer.drop_invalid_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsFuelTableTransformer.drop_invalid_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">drop_invalid_rows</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">InvalidRows</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop invalid rows from the fuel table.</span>

<span class="sd">        This method both drops rows in which all required data columns are null (using</span>
<span class="sd">        the inherited parameterized method) and then also drops those rows we believe</span>
<span class="sd">        represent plant totals. See :meth:`SteamPlantsFuelTableTransformer.drop_total_rows`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">drop_invalid_rows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_total_rows</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SteamPlantsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SteamPlantsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for the :ref:`core_ferc1__yearly_steam_plants_sched402` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SteamPlantsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SteamPlantsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">STEAM_PLANTS</span></div>
</div>



<div class="viewcode-block" id="HydroelectricPlantsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.HydroelectricPlantsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HydroelectricPlantsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A table transformer specific to the :ref:`core_ferc1__yearly_hydroelectric_plants_sched406` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HydroelectricPlantsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.HydroelectricPlantsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">HYDROELECTRIC_PLANTS</span></div>


<div class="viewcode-block" id="HydroelectricPlantsTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.HydroelectricPlantsTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Standard transform_main, bespoke remove duplicate record &amp; remove ``.`` from project_num column.&quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_drop_duplicates</span><span class="p">)</span>
        <span class="c1"># project_num is an integer column but in 2023 some of them have .&#39;s</span>
        <span class="c1"># as prefixes</span>
        <span class="n">df</span><span class="o">.</span><span class="n">project_num</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">project_num</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="HydroelectricPlantsTableTransformer.targeted_drop_duplicates">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.HydroelectricPlantsTableTransformer.targeted_drop_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">targeted_drop_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Targeted removal of known duplicate record.</span>

<span class="sd">        There are two records in 2019 with a ``utility_id_ferc1`` of 200 and a</span>
<span class="sd">        ``plant_name_ferc1`` of &quot;marmet&quot;. The records are nearly duplicates of</span>
<span class="sd">        eachother, except one have nulls in the capex columns. Surgically remove the</span>
<span class="sd">        record with the nulls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">null_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;capex_land&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_structures&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_facilities&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_equipment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_roads&quot;</span><span class="p">,</span>
            <span class="s2">&quot;asset_retirement_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_total&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_per_mw&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">dupe_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">==</span> <span class="mi">2019</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">utility_id_ferc1</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">plant_name_ferc1</span> <span class="o">==</span> <span class="s2">&quot;marmet&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">null_masks</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">null_columns</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>

        <span class="n">possible_dupes</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dupe_mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">possible_dupes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2019</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="si">}</span><span class="s2">: Expected 2 records for found: </span><span class="si">{</span><span class="n">possible_dupes</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">dropping</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dupe_mask</span> <span class="o">&amp;</span> <span class="n">null_masks</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Dropping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dropping</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate record with null data in </span><span class="si">{</span><span class="n">null_columns</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="p">(</span><span class="n">dupe_mask</span> <span class="o">&amp;</span> <span class="n">null_masks</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="PumpedStoragePlantsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PumpedStoragePlantsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PumpedStoragePlantsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_pumped_storage_plants_sched408` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PumpedStoragePlantsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PumpedStoragePlantsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">PUMPED_STORAGE_PLANTS</span></div>
</div>



<div class="viewcode-block" id="PurchasedPowerAndExchangesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PurchasedPowerAndExchangesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PurchasedPowerAndExchangesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_purchased_power_and_exchanges_sched326`.</span>

<span class="sd">    This table has data about inter-utility power purchases into the PUDL DB. This</span>
<span class="sd">    includes how much electricity was purchased, how much it cost, and who it was</span>
<span class="sd">    purchased from. Unfortunately the field describing which other utility the power was</span>
<span class="sd">    being bought from is poorly standardized, making it difficult to correlate with</span>
<span class="sd">    other data. It will need to be categorized by hand or with some fuzzy matching</span>
<span class="sd">    eventually.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PurchasedPowerAndExchangesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PurchasedPowerAndExchangesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">PURCHASED_POWER_AND_EXCHANGES</span></div>
</div>



<div class="viewcode-block" id="PlantInServiceTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PlantInServiceTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A transformer for the :ref:`core_ferc1__yearly_plant_in_service_sched204` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PlantInServiceTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">PLANT_IN_SERVICE</span></div>

<div class="viewcode-block" id="PlantInServiceTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_xbrl_metadata&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PlantInServiceTableTransformer.process_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.process_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_converted</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">xbrl_calculations</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the metadata to reflect the transformed data.</span>

<span class="sd">        We fill in some gaps in the metadata, e.g. for FERC accounts that have been</span>
<span class="sd">        split across multiple rows, or combined without being calculated. We also need</span>
<span class="sd">        to rename the XBRL metadata categories to conform to the same naming convention</span>
<span class="sd">        that we are using in the data itself (since FERC doesn&#39;t quite follow their own</span>
<span class="sd">        naming conventions...). We use the same rename dictionary, but as an argument to</span>
<span class="sd">        :meth:`pd.Series.replace` instead of :meth:`pd.DataFrame.rename`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_xbrl_metadata</span><span class="p">(</span>
            <span class="n">xbrl_metadata_converted</span><span class="p">,</span> <span class="n">xbrl_calculations</span>
        <span class="p">)</span>

        <span class="c1"># Set pseudo-account numbers for rows that split or combine FERC accounts, but</span>
        <span class="c1"># which are not calculated values.</span>
        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;electric_plant_purchased&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_status&quot;</span><span class="p">],</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;102_purchased&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">]</span>
        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;electric_plant_sold&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_status&quot;</span><span class="p">],</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;102_sold&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">]</span>
        <span class="n">tbl_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span>
            <span class="o">==</span> <span class="s2">&quot;electric_plant_in_service_and_completed_construction_not_classified_electric&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;101_and_106&quot;</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


<div class="viewcode-block" id="PlantInServiceTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_xbrl_factoid_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tbl_meta</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;De-duplicate the XBLR metadata.</span>

<span class="sd">        We deduplicate the metadata on the basis of the ``xbrl_factoid`` name.</span>
<span class="sd">        This table in particular has multiple ``wide_to_tidy`` ``value_types`` because</span>
<span class="sd">        there are multiple dollar columns embedded (it has both the standard start/end</span>
<span class="sd">        balances as well as modifications like transfers/retirements). In the XBRL</span>
<span class="sd">        metadata, each xbrl_fact has its own set of metadata and possibly its own set of</span>
<span class="sd">        calculations. Which means that one ``xbrl_factoid`` for this table natively</span>
<span class="sd">        could have multiple calculations or other metadata.</span>

<span class="sd">        For merging, we need the metadata to have one field per ``xbrl_factoid``.</span>
<span class="sd">        Because we normally only use the start/end balance in calculations, when there</span>
<span class="sd">        are duplicate renamed ``xbrl_factoid`` s in our processed metadata, we are going</span>
<span class="sd">        to prefer the one that refers to the start/end balances. In an ideal world, we</span>
<span class="sd">        would be able to access this metadata based on both the ``xbrl_factoid`` and</span>
<span class="sd">        any column from ``value_types`` but that would require a larger change in</span>
<span class="sd">        architecture.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># remove duplication of xbrl_factoid</span>
        <span class="n">same_calcs_mask</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;calculations&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># if they key values are the same, select the records with values in ferc_account</span>
        <span class="n">same_calcs_deduped</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tbl_meta</span><span class="p">[</span><span class="n">same_calcs_mask</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;ferc_account&quot;</span><span class="p">])</span>  <span class="c1"># sort brings the nulls to the bottom</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># when the calcs are different, they are referring to the non-adjustments</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_additions&quot;</span><span class="p">,</span> <span class="s2">&quot;_retirements&quot;</span><span class="p">,</span> <span class="s2">&quot;_adjustments&quot;</span><span class="p">,</span> <span class="s2">&quot;_transfers&quot;</span><span class="p">)</span>
        <span class="n">unique_calcs_deduped</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span>
            <span class="o">~</span><span class="n">same_calcs_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid_original</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffixes</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">tbl_meta_cleaned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">same_calcs_deduped</span><span class="p">,</span> <span class="n">unique_calcs_deduped</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">tbl_meta_cleaned</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="o">~</span><span class="n">tbl_meta_cleaned</span><span class="o">.</span><span class="n">duplicated</span><span class="p">([</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tbl_meta_cleaned</span></div>


<div class="viewcode-block" id="PlantInServiceTableTransformer.apply_sign_conventions">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.apply_sign_conventions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_sign_conventions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjust rows and column sign conventsion to enable aggregation by summing.</span>

<span class="sd">        Columns have uniform sign conventions, which we have manually inferred from the</span>
<span class="sd">        original metadata. This can and probably should be done programmatically in the</span>
<span class="sd">        future. If not, we&#39;ll probably want to store the column_weights as a parameter</span>
<span class="sd">        rather than hard-coding it in here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;starting_balance&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;additions&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;retirements&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;transfers&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;adjustments&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;ending_balance&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Set row weights based on the value of the &quot;balance&quot; field</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="s2">&quot;debit&quot;</span><span class="p">,</span> <span class="s2">&quot;row_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">balance</span> <span class="o">==</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span> <span class="s2">&quot;row_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="c1"># Apply column weightings. Can this be done all at once in a vectorized way?</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_weights</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">column_weights</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">*=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_weight&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="PlantInServiceTableTransformer.targeted_drop_duplicates_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.targeted_drop_duplicates_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">targeted_drop_duplicates_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop bad duplicate records from a specific utility in 2018.</span>

<span class="sd">        This is a very specific fix, meant to get rid of a particular observed set of</span>
<span class="sd">        duplicate records: FERC Respondent ID 187 in 2018 has two sets of plant in</span>
<span class="sd">        service records, one of which contains a bunch of null data.</span>

<span class="sd">        This method is part of the DBF processing because we want to be able to</span>
<span class="sd">        hard-code a specific value of ``utility_id_ferc1_dbf`` and those IDs are no</span>
<span class="sd">        longer available later in the process. I think.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># A single utility has double reported data in 2018.</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;ferc_account_label&quot;</span><span class="p">]</span>
        <span class="n">dupe_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">pk</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">==</span> <span class="mi">2018</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">utility_id_ferc1_dbf</span> <span class="o">==</span> <span class="mi">187</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">all_dupes</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dupe_mask</span><span class="p">]</span>
        <span class="c1"># The observed pairs of duplicate records have NA values in all of the</span>
        <span class="c1"># additions, retirements, adjustments, and transfers columns. This selects</span>
        <span class="c1"># only those duplicates that have *any* non-null value in those rows.</span>
        <span class="n">good_dupes</span> <span class="o">=</span> <span class="n">all_dupes</span><span class="p">[</span>
            <span class="n">all_dupes</span><span class="p">[[</span><span class="s2">&quot;additions&quot;</span><span class="p">,</span> <span class="s2">&quot;retirements&quot;</span><span class="p">,</span> <span class="s2">&quot;adjustments&quot;</span><span class="p">,</span> <span class="s2">&quot;transfers&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
            <span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Make sure that the good and bad dupes have exactly the same indices:</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_index_equal</span><span class="p">(</span>
            <span class="n">good_dupes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">all_dupes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">deduped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">dupe_mask</span><span class="p">],</span> <span class="n">good_dupes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="n">remaining_dupes</span> <span class="o">=</span> <span class="n">deduped</span><span class="p">[</span><span class="n">deduped</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">pk</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remaining_dupes</span><span class="p">)</span><span class="si">}</span><span class="s2"> dupes remaining after &quot;</span>
            <span class="s2">&quot;targeted deduplication.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">deduped</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PlantInServiceTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop targeted duplicates in the DBF data so we can use FERC respondent ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_drop_duplicates_dbf</span><span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="PlantInServiceTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.PlantInServiceTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The main table-specific transformations, affecting contents not structure.</span>

<span class="sd">        Annotates and alters data based on information from the XBRL taxonomy metadata.</span>
<span class="sd">        Also assigns utility type, plant status &amp; function for use in table explosions.</span>
<span class="sd">        Make all electric_plant_sold balances positive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_sign_conventions</span><span class="p">)</span>
        <span class="c1"># Make all electric_plant_sold values positive</span>
        <span class="c1"># This could probably be a FERC transformer class function or in the</span>
        <span class="c1"># apply_sign_conventions function, but it doesn&#39;t seem like the best fit for</span>
        <span class="c1"># now.</span>
        <span class="n">neg_values</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ferc_account_label&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;electric_plant_sold&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">neg_values</span><span class="p">,</span> <span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;ending_balance&quot;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Converted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">neg_values</span><span class="p">])</span><span class="si">}</span><span class="s2"> negative values to positive.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Add two exceptions for plant status</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">ferc_account_label</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;electric_plant_sold&quot;</span><span class="p">,</span> <span class="s2">&quot;electric_plant_purchased&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">plant_status</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="SmallPlantsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SmallPlantsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A table transformer specific to the :ref:`core_ferc1__yearly_small_plants_sched410` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SmallPlantsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">SMALL_PLANTS</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SmallPlantsTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Table specific transforms for core_ferc1__yearly_small_plants_sched410.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A single transformed table concatenating multiple years of cleaned data</span>
<span class="sd">            derived from the raw DBF and/or XBRL inputs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spot_fix_values</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nullify_outliers</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_ferc1_license</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_row_types</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prep_header_fuel_and_plant_types</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_plant_name_fuel_types</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorize_strings</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_header_fuel_and_plant_types</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associate_notes_with_values</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot_fix_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_invalid_rows</span><span class="p">)</span>
            <span class="c1"># Now remove the row_type columns because we&#39;ve already moved totals to a</span>
            <span class="c1"># different column</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.extract_ferc1_license">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.extract_ferc1_license">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_ferc1_license</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract FERC license number from ``plant_name_ferc1``.</span>

<span class="sd">        Many FERC license numbers are embedded in the ``plant_name_ferc1`` column, but</span>
<span class="sd">        not all numbers in the ``plant_name_ferc1`` column are FERC licenses. Some are</span>
<span class="sd">        dates, dollar amounts, page numbers, or numbers of wind turbines. This function</span>
<span class="sd">        extracts valid FERC license numbers and puts them in a new column called</span>
<span class="sd">        ``license_id_ferc1``.</span>

<span class="sd">        Potential FERC license numbers are valid when:</span>

<span class="sd">        - Two or more integers were found.</span>
<span class="sd">        - The found integers were accompanied by key phrases such as:</span>
<span class="sd">          ``[&quot;license&quot;, &quot;no.&quot;, &quot;ferc&quot;, &quot;project&quot;]``.</span>
<span class="sd">        - The accompanying name does not contain phrases such as:</span>
<span class="sd">          ``[&quot;page&quot;, &quot;pg&quot;, &quot;$&quot;,  &quot;wind&quot;, &quot;units&quot;]``.</span>
<span class="sd">        - The found integers don&#39;t fall don&#39;t fall within the range of a valid year,</span>
<span class="sd">          defined as: 1900-2050.</span>
<span class="sd">        - The plant record is categorized as ``hydro`` or not categorized via the</span>
<span class="sd">          ``plant_type`` and ``fuel_type`` columns.</span>

<span class="sd">        This function also fills ``other`` fuel types with ``hydro`` for all plants with</span>
<span class="sd">        valid FERC licenses because only hydro plants have FERC licenses.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with a new column called ``license_id_ferc1``</span>
<span class="sd">            that contains FERC 1 license information extracted from</span>
<span class="sd">            ``plant_name_ferc1``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Extracting FERC license from plant name&quot;</span><span class="p">)</span>
        <span class="c1"># Extract all numbers greater than 2 digits from plant_name_ferc1 and put them</span>
        <span class="c1"># in a new column as integers.</span>
        <span class="n">out_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">license_id_ferc1</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">plant_name_ferc1</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(\d{3,})&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;Int64&quot;</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># Define what makes a good license</span>
        <span class="n">obvious_license</span> <span class="o">=</span> <span class="n">out_df</span><span class="o">.</span><span class="n">plant_name_ferc1</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;no\.|license|ferc|project&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">not_license</span> <span class="o">=</span> <span class="n">out_df</span><span class="o">.</span><span class="n">plant_name_ferc1</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;page|pg|\$|wind|solar|nuclear|nonutility|units|surrendered&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">exceptions_to_is_year</span> <span class="o">=</span> <span class="n">out_df</span><span class="o">.</span><span class="n">plant_name_ferc1</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;tomahawk|otter rapids|wausau|alexander|hooksett|north umpqua&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">is_year</span> <span class="o">=</span> <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;license_id_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">2050</span><span class="p">)</span>
        <span class="n">not_hydro</span> <span class="o">=</span> <span class="o">~</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;plant_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;hydro&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="o">|</span> <span class="o">~</span><span class="n">out_df</span><span class="p">[</span>
            <span class="s2">&quot;fuel_type&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;hydro&quot;</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">])</span>
        <span class="c1"># Replace all the non-license numbers with NA</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">not_hydro</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">obvious_license</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">not_license</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">is_year</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">obvious_license</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">exceptions_to_is_year</span><span class="p">),</span>
            <span class="s2">&quot;license_id_ferc1&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># Fill fuel type with hydro</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;license_id_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="s2">&quot;fuel_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">),</span>
            <span class="s2">&quot;fuel_type&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hydro&quot;</span>

        <span class="k">return</span> <span class="n">out_df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer._find_possible_header_or_note_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer._find_possible_header_or_note_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_possible_header_or_note_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find and label rows that might be headers or notes.</span>

<span class="sd">        Called by the coordinating function :func:`label_row_types`.</span>

<span class="sd">        This function creates a column called ``possible_header_or_note`` that is either</span>
<span class="sd">        True or False depending on whether a group of columns are all NA. Rows labeled</span>
<span class="sd">        as True will be further scrutinized in the :func:`_label_header_rows` and</span>
<span class="sd">        :func:`_label_note_rows` functions to determine whether they are actually</span>
<span class="sd">        headers or notes.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with a new column called</span>
<span class="sd">            ``possible_header_or_note`` that flags rows that might contain useful header</span>
<span class="sd">            or note information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define header qualifications</span>
        <span class="n">possible_header_or_note_if_cols_na</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;construction_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_cost_of_plant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_total&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capex_per_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;opex_total&quot;</span><span class="p">,</span>
            <span class="s2">&quot;opex_fuel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;opex_maintenance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_cost_per_mmbtu&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;peak_demand_mw&quot;,</span>
            <span class="c1"># &quot;opex_operations&quot;</span>
        <span class="p">]</span>
        <span class="c1"># Label possible header or note rows</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">possible_header_or_note_if_cols_na</span><span class="p">)</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer._find_note_clumps">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer._find_note_clumps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_find_note_clumps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataFrameGroupBy</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find groups of rows likely to be notes.</span>

<span class="sd">        Once the :func:`_find_possible_header_or_note_rows` function identifies rows</span>
<span class="sd">        that are either headers or notes, we must determine which one they are. As</span>
<span class="sd">        described in the :func:`_label_note_rows` function, notes rows are usually</span>
<span class="sd">        adjacent rows with no content.</span>

<span class="sd">        This function itentifies instances of two or more adjacent rows where</span>
<span class="sd">        ``possible_header_or_note`` = True. It takes individual utility-year groups as a</span>
<span class="sd">        parameter as opposed to the entire dataset because adjacent rows are only</span>
<span class="sd">        meaningful if they are from the same reporting entity in the same year. If we</span>
<span class="sd">        were to run this on the whole dataframe, we would see &quot;note clumps&quot; that are</span>
<span class="sd">        actually notes from the end of one utility&#39;s report and headers from the</span>
<span class="sd">        beginning of another. For this reason, we run this function from within the</span>
<span class="sd">        :func:`_label_note_rows_group` function.</span>

<span class="sd">        The output of this function is not a modified version of the original</span>
<span class="sd">        utility-year group, rather, it is a DataFrame containing information about the</span>
<span class="sd">        nature of the ``possible_header_or_note`` = True rows that is used to determine</span>
<span class="sd">        if that row is a note or not. It also returns the original utility-year-group as</span>
<span class="sd">        groupby objects separated by each time ``possible_header_or_note`` changes from</span>
<span class="sd">        True to False or vice versa.</span>

<span class="sd">        If you pass in the following df:</span>

<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | plant_name_ferc1  | possible_header_or_note |</span>
<span class="sd">        +===================+=========================+</span>
<span class="sd">        | HYDRO:            | True                    |</span>
<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | rainbow falls (b) | False                   |</span>
<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | cadyville (a)     | False                   |</span>
<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | keuka (c)         | False                   |</span>
<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | (a) project #2738 | True                    |</span>
<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | (b) project #2835 | True                    |</span>
<span class="sd">        +-------------------+-------------------------+</span>
<span class="sd">        | (c) project #2852 | True                    |</span>
<span class="sd">        +-------------------+-------------------------+</span>

<span class="sd">        You will get the following output (in addition to the groupby objects for each</span>
<span class="sd">        clump):</span>

<span class="sd">        +----------------+----------------+</span>
<span class="sd">        | header_or_note | rows_per_clump |</span>
<span class="sd">        +================+================+</span>
<span class="sd">        | True           | 1              |</span>
<span class="sd">        +----------------+----------------+</span>
<span class="sd">        | False          | 3              |</span>
<span class="sd">        +----------------+----------------+</span>
<span class="sd">        | True           | 3              |</span>
<span class="sd">        +----------------+----------------+</span>

<span class="sd">        This shows each clump of adjacent records where ``possible_header_or_note`` is</span>
<span class="sd">        True or False and how many records are in each clump.</span>

<span class="sd">        Params:</span>
<span class="sd">            group: A utility-year grouping of the concatenated FERC XBRL and DBF tables.</span>
<span class="sd">                This table must have been run through the</span>
<span class="sd">                :func:`_find_possible_header_or_note_rows` function and contain the</span>
<span class="sd">                column ``possible_header_or_note``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing groupby objects for each of the note and non-note clumps</span>
<span class="sd">            and a DataFrame indicating the number of rows in each note or non-note</span>
<span class="sd">            clump.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make groups based on consecutive sections where the group_col is alike.</span>
        <span class="n">clump_groups</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">group</span><span class="p">[</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
                <span class="o">!=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span>
            <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Identify the first (and only) group_col value for each group and count</span>
        <span class="c1"># how many rows are in each group.</span>
        <span class="n">clump_groups_df</span> <span class="o">=</span> <span class="n">clump_groups</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">header_or_note</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">),</span>
            <span class="n">rows_per_clump</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">clump_groups</span><span class="p">,</span> <span class="n">clump_groups_df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer._label_header_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer._label_header_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_label_header_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Label header rows by adding ``header`` to ``row_type`` column.</span>

<span class="sd">        Called by the coordinating function :func:`label_row_types`.</span>

<span class="sd">        Once possible header or notes rows have been identified via the</span>
<span class="sd">        :func:`_find_possible_header_or_note_rows` function, this function sorts out</span>
<span class="sd">        which ones are headers. It does this by identifying a list of strings that, when</span>
<span class="sd">        found in the ``plant_name_ferc1`` column, indicate that the row is or is not a</span>
<span class="sd">        header.</span>

<span class="sd">        Sometimes this function identifies a header that is actually a note. For this</span>
<span class="sd">        reason, it&#39;s important that the function be called before</span>
<span class="sd">        :func:`_label_note_rows` so that the bad header values get overridden by the</span>
<span class="sd">        ``note`` designation.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data that has been run through</span>
<span class="sd">            the :func:`_find_possible_header_or_note_rows` function and contains the</span>
<span class="sd">            column ``possible_header_or_note``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with likely headers rows containing the string</span>
<span class="sd">            ``header`` in the ``row_type`` column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Possible headers/note rows that contains these strings are headers</span>
        <span class="n">header_strings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;hydro&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hyrdo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;internal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gas&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diesel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;diesal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;steam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;other&quot;</span><span class="p">,</span>
            <span class="s2">&quot;combustion&quot;</span><span class="p">,</span>
            <span class="s2">&quot;combustine&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel cell&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hydraulic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;waste&quot;</span><span class="p">,</span>
            <span class="s2">&quot;landfill&quot;</span><span class="p">,</span>
            <span class="s2">&quot;photovoltaic&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nuclear&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oil&quot;</span><span class="p">,</span>
            <span class="s2">&quot;renewable&quot;</span><span class="p">,</span>
            <span class="s2">&quot;facilities&quot;</span><span class="p">,</span>
            <span class="s2">&quot;combined cycle&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Possible headers/note rows that contains these strings are not headers</span>
        <span class="n">nonheader_strings</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;#&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;\*&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solargenix&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solargennix&quot;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s2">&quot;\@&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rockton&quot;</span><span class="p">,</span>
            <span class="s2">&quot;albany steam&quot;</span><span class="p">,</span>
            <span class="s2">&quot;other general ops. supervision &amp; engineering&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Any rows that contains these strings are headers</span>
        <span class="n">header_exceptions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;hydro plants: licensed proj. no.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hydro license no.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hydro: license no.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hydro plants: licensed proj no.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;photo voltaic generating plants:&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Labeling header rows&quot;</span><span class="p">)</span>

        <span class="c1"># Label good header rows (based on whether they contain key strings)</span>
        <span class="n">possible_header</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">]</span>
        <span class="n">good_header</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">header_strings</span><span class="p">))</span>
        <span class="n">bad_header</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nonheader_strings</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">possible_header</span> <span class="o">&amp;</span> <span class="n">good_header</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">bad_header</span><span class="p">,</span> <span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
        <span class="c1"># There are some headers that don&#39;t pass the possible_header test but are</span>
        <span class="c1"># still definitely headers.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">header_exceptions</span><span class="p">),</span> <span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer._label_note_rows_group">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer._label_note_rows_group">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_label_note_rows_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">util_year_group</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrameGroupBy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Label note rows by adding ``note`` to ``row_type`` column.</span>

<span class="sd">        Called within the wrapper function :func:`_label_note_rows`</span>

<span class="sd">        This function breaks the data down by reporting unit (utility and year) and</span>
<span class="sd">        determines whether a ``possible_header_note`` = True row is a note based on two</span>
<span class="sd">        criteria:</span>

<span class="sd">        - Clumps of 2 or more adjacent rows where ``possible_header_or_note`` is True.</span>
<span class="sd">        - Instances where the last row in a utility-year group has</span>
<span class="sd">          ``possible_header_or_note`` as True.</span>

<span class="sd">        There are a couple of important exceptions that this function also</span>
<span class="sd">        addresses. Utilities often have multiple headers in a single utility-year</span>
<span class="sd">        grouping. You might see something like: ``pd.Series([header, plant1, plant2,</span>
<span class="sd">        note, header, plant3, plant4])``. In this case, a note clump is actually</span>
<span class="sd">        comprised of a note followed by a header. This function will not override the</span>
<span class="sd">        header as a note. Unfortunately, there is always the possibility that a header</span>
<span class="sd">        row is followed by a plant that had no values reported. This would look like,</span>
<span class="sd">        and therefore be categorized as a note clump. I haven&#39;t built a work around, but</span>
<span class="sd">        hopefully there aren&#39;t very many of these.</span>

<span class="sd">        Params:</span>
<span class="sd">            util_year_group: A groupby object that contains a single year and utility.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input but with likely note rows containing the string ``note`` in</span>
<span class="sd">            the ``row_type`` column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create mini groups that count pockets of true and false for each</span>
        <span class="c1"># utility and year. See _find_note_clumps docstring.</span>
        <span class="n">clump_group</span><span class="p">,</span> <span class="n">clump_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_note_clumps</span><span class="p">(</span><span class="n">util_year_group</span><span class="p">)</span>

        <span class="c1"># Used later to enable exceptions</span>
        <span class="n">max_df_val</span> <span class="o">=</span> <span class="n">util_year_group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># Create a list of the index values where there is a note clump! This also</span>
        <span class="c1"># includes instances where the last row in a group is a note.</span>
        <span class="n">note_clump_idx_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">clump_count</span><span class="p">[</span>
                <span class="p">(</span><span class="n">clump_count</span><span class="p">[</span><span class="s2">&quot;header_or_note&quot;</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">clump_count</span><span class="p">[</span><span class="s2">&quot;rows_per_clump&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="o">|</span> <span class="p">(</span><span class="n">clump_count</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;rows_per_clump&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>
        <span class="c1"># If there are any clumped/end headers:</span>
        <span class="k">if</span> <span class="n">note_clump_idx_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">note_clump_idx_list</span><span class="p">:</span>
                <span class="c1"># If the last row in a clump looks like a header, and the clump is</span>
                <span class="c1"># not the last clump in the utility_year group, then drop the last</span>
                <span class="c1"># row from the note clump index range because it&#39;s a header!</span>
                <span class="n">note_clump_idx_range</span> <span class="o">=</span> <span class="n">clump_group</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">not_last_clump</span> <span class="o">=</span> <span class="n">clump_group</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">max_df_val</span>
                <span class="n">is_good_header</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">util_year_group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">util_year_group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">clump_group</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="p">]</span>
                    <span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">not_last_clump</span> <span class="o">&amp;</span> <span class="n">is_good_header</span><span class="p">:</span>
                    <span class="n">note_clump_idx_range</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">x</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">note_clump_idx_range</span>
                        <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">note_clump_idx_range</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="p">]</span>
                <span class="c1"># Label the note clump as a note</span>
                <span class="n">util_year_group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">util_year_group</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">note_clump_idx_range</span><span class="p">),</span> <span class="s2">&quot;row_type&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;note&quot;</span>

        <span class="k">return</span> <span class="n">util_year_group</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer._label_note_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer._label_note_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_label_note_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for :func:`_label_note_rows_group`.</span>

<span class="sd">        The small plants table has lots of note rows that contain useful information.</span>
<span class="sd">        Unfortunately, the notes are in their own row rather than their own column! This</span>
<span class="sd">        means that useful information pertaining to plant rows is floating around as a</span>
<span class="sd">        junk row with no other information except the note in the ``plant_name_ferc1``</span>
<span class="sd">        field. Luckily, the data are reported just like they would be on paper. I.e.,</span>
<span class="sd">        The headers are at the top, and the notes are at the bottom. See the table in</span>
<span class="sd">        :func:`label_row_types` for more detail. This function labels note rows.</span>

<span class="sd">        Note rows are determined by row location within a given report, so we must break</span>
<span class="sd">        the data into reporting units (utility and year) and then apply note-finding</span>
<span class="sd">        methodology defined in :func:`_label_note_rows_group` to each group.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data that has been run through</span>
<span class="sd">            the :func:`_find_possible_header_or_note_rows` function and contains the</span>
<span class="sd">            column ``possible_header_or_note``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with likely note rows containing the string</span>
<span class="sd">            ``note`` in the ``row_type`` column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Labeling notes rows&quot;</span><span class="p">)</span>

        <span class="n">util_groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">util_groups</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label_note_rows_group</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer._label_total_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer._label_total_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_label_total_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Label total rows by adding ``total`` to ``row_type`` column.</span>

<span class="sd">        Called within the wrapper function :func:`_label_note_rows`</span>

<span class="sd">        For the most part, when ``plant_name_ferc1`` contains the string ``total``, the</span>
<span class="sd">        values therein are duplicates of what is already reported, i.e.: a total value.</span>
<span class="sd">        However, there are some cases where that&#39;s not true. For example, the phrase</span>
<span class="sd">        ``amounts are for the total`` appears when chunks of plants (usually but not</span>
<span class="sd">        always wind) are reported together. It&#39;s a total, but it&#39;s not double counting</span>
<span class="sd">        which is the reason for the ``total`` flag.</span>

<span class="sd">        Similar to :func:`_label_header_rows`, it&#39;s important that this be called before</span>
<span class="sd">        :func:`_label_note_rows` in :func:`label_row_types` so that not clumps can</span>
<span class="sd">        override certain non-totals that are mistakenly labeled as such.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with likely total rows containing the string</span>
<span class="sd">            ``total`` in the ``row_type`` column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Label totals in row_type in case it overwrites any headers</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Labeling total rows&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;amounts are for the total&quot;</span><span class="p">),</span>
            <span class="s2">&quot;row_type&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;total&quot;</span>

        <span class="c1"># This one gets overridden by notes: total solar operation/maintenance</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.label_row_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.label_row_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">label_row_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coordinate labeling of ``row_types`` as headers, notes, or totals.</span>

<span class="sd">        The small plants table is more like a digitized PDF than an actual data table.</span>
<span class="sd">        The rows contain all sorts of information in addition to what the columns might</span>
<span class="sd">        suggest. For instance, there are header rows, note rows, and total rows that</span>
<span class="sd">        contain useful information, but cause confusion in their current state, mixed in</span>
<span class="sd">        with the rest of the data.</span>

<span class="sd">        Here&#39;s an example of what you might find in the small plants table:</span>

<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | plant_name_ferc1  | plant_type | capacity_mw     |</span>
<span class="sd">        +===================+============+=================+</span>
<span class="sd">        | HYDRO:            | NA         | NA              |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | rainbow falls (b) | NA         | 30              |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | cadyville (a)     | NA         | 100             |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | keuka (c)         | NA         | 80              |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | total plants      | NA         | 310             |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | (a) project #2738 | NA         | NA              |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | (b) project #2835 | NA         | NA              |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>
<span class="sd">        | (c) project #2852 | NA         | NA              |</span>
<span class="sd">        +-------------------+------------+-----------------+</span>

<span class="sd">        Notice how misleading it is to have all this information in one column. The</span>
<span class="sd">        goal of this function is to coordinate labeling functions so that we can</span>
<span class="sd">        identify which rows contain specific plant information and which rows are</span>
<span class="sd">        headers, notes, or totals.</span>

<span class="sd">        Once labeled, other functions can either remove rows that might cause double</span>
<span class="sd">        counting, extract useful plant or fuel type information from headers, and</span>
<span class="sd">        extract useful context or license id information from notes.</span>

<span class="sd">        Coordinates :func:`_label_header_rows`, :func:`_label_total_rows`,</span>
<span class="sd">        :func:`_label_note_rows`.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data that has been run through</span>
<span class="sd">            the :func:`_find_possible_header_or_note_rows` function and contains the</span>
<span class="sd">            column ``possible_header_or_note``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with a column called ``row_type`` containing the</span>
<span class="sd">            strings ``header``, ``note``, ``total``, or NA to indicate what type of row</span>
<span class="sd">            it is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Add a column to show final row type</span>
        <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;row_type&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Label the row types</span>
        <span class="n">df_labeled</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_possible_header_or_note_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_header_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_total_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_note_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;possible_header_or_note&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Move total labels to a different column</span>
        <span class="n">df_labeled</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_labeled</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;is_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">df_labeled</span><span class="p">[</span><span class="s2">&quot;is_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_labeled</span><span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="s2">&quot;row_type&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;total&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df_labeled</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.prep_header_fuel_and_plant_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.prep_header_fuel_and_plant_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_header_fuel_and_plant_types</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">show_unmapped_headers</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Forward fill header rows to prep for fuel and plant type extraction.</span>

<span class="sd">        The headers we&#39;ve identified in :func:`_label_header_rows` can be used to</span>
<span class="sd">        supplement the values in the ``plant_type`` and ``fuel_type`` columns.</span>

<span class="sd">        This function groups the data by utility, year, and header; extracts the header</span>
<span class="sd">        into a new column; and forward fills the headers so that each record in the</span>
<span class="sd">        header group is associated with that header. Because the headers map to</span>
<span class="sd">        different fuel types and plant types (ex: ``solar pv`` maps to fuel type</span>
<span class="sd">        ``solar`` and plant type ``photovoltaic``), the new forward-filled header column</span>
<span class="sd">        is duplicated and called ``fuel_type_from_header`` and</span>
<span class="sd">        ``plant_type_from_header``. In :func:`map_header_fuel_and_plant_types`, these</span>
<span class="sd">        columns will be mapped to their respective fuel and plant types, used</span>
<span class="sd">        to fill in blank values in the ``plant_type`` and ``fuel_type``, and then</span>
<span class="sd">        eventually removed.</span>

<span class="sd">        Why separate the prep step from the map step?</span>

<span class="sd">        We trust the values originally reported in the ``fuel_type`` and ``plant_type``</span>
<span class="sd">        columns more than the extracted and forward filled header values, so we only</span>
<span class="sd">        want to replace ``fuel_type`` and ``plant_type`` values that are labeled as</span>
<span class="sd">        ``pd.NA`` or ``other``. The values reported to those columns are extremely messy</span>
<span class="sd">        and must be cleaned via :func:`pudl.transform.classes.categorize_strings` in</span>
<span class="sd">        order for us to know which are truly ``pd.NA`` or ``other``. Because we also</span>
<span class="sd">        use :func:`pudl.transform.classes.categorize_strings` to map the headers to fuel</span>
<span class="sd">        and plant types, it makes sense to clean all four columns at once and then</span>
<span class="sd">        combine them.</span>

<span class="sd">        Here&#39;s a look at what this function does. It starts with the following table:</span>

<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | plant_name_ferc1  | plant_type | fuel_type  | row_type |</span>
<span class="sd">        +===================+============+============+==========+</span>
<span class="sd">        | HYDRO:            | NA         | NA         | header   |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | rainbow falls (b) | NA         | NA         | NA       |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | cadyville (a)     | NA         | NA         | NA       |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | keuka (c)         | NA         | NA         | NA       |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | Wind Turbines:    | NA         | NA         | header   |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | sunny grove       | NA         | NA         | NA       |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>
<span class="sd">        | green park wind   | NA         | wind       | NA       |</span>
<span class="sd">        +-------------------+------------+------------+----------+</span>

<span class="sd">        And ends with this:</span>

<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | plant_name_ferc1  | plant   | fuel    | plant_type     | fuel_type          |</span>
<span class="sd">        |                   | _type   | _type   | _from_header   | _from_header       |</span>
<span class="sd">        +===================+=========+=========+================+====================+</span>
<span class="sd">        | HYDRO:            | NA      | NA      | HYDRO:         | HYDRO:             |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | rainbow falls (b) | NA      | NA      | HYDRO:         | HYDRO:             |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | cadyville (a)     | NA      | NA      | HYDRO:         | HYDRO:             |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | keuka (c)         | NA      | NA      | HYDRO:         | HYDRO:             |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | Wind Turbines:    | NA      | NA      | Wind Turbines: | Wind Turbines:     |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | sunny grove       | NA      | NA      | Wind Turbines: | Wind Turbines:     |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>
<span class="sd">        | green park wind   | NA      | wind    | Wind Turbines: | Wind Turbines:     |</span>
<span class="sd">        +-------------------+---------+---------+----------------+--------------------+</span>

<span class="sd">        NOTE: If a utility&#39;s ``plant_name_ferc1`` values look like this: ``[&quot;STEAM&quot;,</span>
<span class="sd">        &quot;coal_plant1&quot;, &quot;coal_plant2&quot;, &quot;wind_turbine1&quot;]``, then this algorithm will</span>
<span class="sd">        think that last wind turbine is a steam plant. Luckily, when a utility embeds</span>
<span class="sd">        headers in the data it usually includes them for all plant types: ``[&quot;STEAM&quot;,</span>
<span class="sd">        &quot;coal_plant1&quot;, &quot;coal_plant2&quot;, &quot;WIND&quot;, &quot;wind_turbine&quot;]``.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data that has been run through</span>
<span class="sd">            :func:`_label_row_type` and contains the columns ``row_type``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with new columns ``plant_type_from_header``</span>
<span class="sd">            and ``fuel_type_from_header`` that forward fill the values in the header</span>
<span class="sd">            rows by utility, year, and header group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Forward filling header fuel and plant types&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create a column of just headers</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span>

        <span class="c1"># Make groups based on utility, year, and header.</span>
        <span class="c1"># The .cumsum() creates a new series with values that go up from 1 whenever</span>
        <span class="c1"># there is a new header. So imagine row_type[&quot;header&quot;, NA, NA, &quot;header&quot;, NA].</span>
        <span class="c1"># this creates a series of [1,1,1,2,2] so that the data can be grouped by</span>
        <span class="c1"># header.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;header_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;header&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="s2">&quot;header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;header_group&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>

        <span class="c1"># Create temporary columns for plant type and fuel type</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_type_from_header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fuel_type_from_header&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;header_group&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.map_header_fuel_and_plant_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.map_header_fuel_and_plant_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_header_fuel_and_plant_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fill ``pd.NA`` and ``other`` plant and fuel types with cleaned headers.</span>

<span class="sd">        :func:`prep_header_fuel_and_plant_types` extracted and forward filled the header</span>
<span class="sd">        values; :func:`pudl.transform.params.categorize_strings` cleaned them according</span>
<span class="sd">        to both the fuel and plant type parameters. This function combines the</span>
<span class="sd">        ``fuel_type_from_header`` with ``fuel_type`` and ``plant_type_from_header`` with</span>
<span class="sd">        ``plant_type`` when the reported, cleaned values are ``pd.NA`` or ``other``.</span>

<span class="sd">        To understand more about why these steps are necessary read the docstrings for</span>
<span class="sd">        :func:`prep_header_fuel_and_plant_types`.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data that has been run through</span>
<span class="sd">            :func:`prep_header_fuel_and_plant_types` and contains the columns</span>
<span class="sd">            ``fuel_type_from_header`` and ``plant_type_from_header``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with rows with ``pd.NA`` or ``other`` in the</span>
<span class="sd">            ``fuel_type`` and ``plant_type`` columns filled in with the respective</span>
<span class="sd">            values from ``fuel_type_from_header`` and ``plant_type_from_header`` when</span>
<span class="sd">            available. ``fuel_type_from_header`` and ``plant_type_from_header`` columns</span>
<span class="sd">            removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Filling NA and &#39;other&#39; fuel and plant types with&quot;</span>
            <span class="s2">&quot; header info&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Stash the amount of NA values to check that the filling worked.</span>
        <span class="n">old_fuel_type_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fuel_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="n">old_plant_type_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="p">)</span>

        <span class="c1"># Fill NA and &quot;other&quot; fields</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]),</span> <span class="s2">&quot;plant_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">plant_type_from_header</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fuel_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">]),</span> <span class="s2">&quot;fuel_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">fuel_type_from_header</span>
        <span class="p">)</span>

        <span class="c1"># Remove _from_header fields</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_type_from_header&quot;</span><span class="p">,</span> <span class="s2">&quot;fuel_type_from_header&quot;</span><span class="p">])</span>

        <span class="c1"># Check that this worked!</span>
        <span class="n">new_fuel_type_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fuel_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="n">new_plant_type_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="s2">&quot;other&quot;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_fuel_type_count</span> <span class="o">&lt;</span> <span class="n">new_fuel_type_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No header fuel types added when there should be&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_plant_type_count</span> <span class="o">&lt;</span> <span class="n">new_plant_type_count</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No header plant types added when there should be&quot;</span><span class="p">)</span>

        <span class="n">useful_rows_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Added fuel types to </span><span class="si">{</span><span class="n">new_fuel_type_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_fuel_type_count</span><span class="si">}</span><span class="s2"> plant rows &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">new_fuel_type_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_fuel_type_count</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">useful_rows_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%). &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Added plant types to </span><span class="si">{</span><span class="n">new_plant_type_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_plant_type_count</span><span class="si">}</span><span class="s2"> plant &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;rows (</span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">new_plant_type_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_plant_type_count</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">useful_rows_len</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">%).&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.map_plant_name_fuel_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.map_plant_name_fuel_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">map_plant_name_fuel_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Supplement ``fuel_type`` with information in ``plant_name_ferc1``.</span>

<span class="sd">        Sometimes fuel type is embedded in a plant name (not just headers). In this case</span>
<span class="sd">        we can identify that what that fuel is from the name and fill in empty</span>
<span class="sd">        ``fuel_type`` values. Right now, this only works for hydro plants because the</span>
<span class="sd">        rest are complicated and have a slew of exceptions. This could probably be</span>
<span class="sd">        applied to the ``plant_type`` column in the future too.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with rows with ``other`` in the</span>
<span class="sd">            ``fuel_type`` column filled in notable fuel types extracted from the the</span>
<span class="sd">            ``plant_name_ferc1`` column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Getting fuel type (hydro) from plant name&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;hydro&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;fuel_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;other&quot;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;fuel_type&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;hydro&quot;</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.associate_notes_with_values">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.associate_notes_with_values">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">associate_notes_with_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use footnote indicators to map notes and FERC licenses to plant rows.</span>

<span class="sd">        There are many utilities that report a bunch of mostly empty note rows at the</span>
<span class="sd">        bottom of their yearly entry. These notes often pertain to specific plant rows</span>
<span class="sd">        above. Sometimes the notes and their respective plant rows are linked by a</span>
<span class="sd">        common footnote indicator such as (a) or (1) etc.</span>

<span class="sd">        This function takes this:</span>

<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | plant_name_ferc1  | row_type   | license_id_ferc1 |</span>
<span class="sd">        +===================+============+==================+</span>
<span class="sd">        | HYDRO:            | header     | NA               |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | rainbow falls (b) | NA         | NA               |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | cadyville (a)     | NA         | NA               |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | keuka (c)         | NA         | NA               |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | total plants      | total      | NA               |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | (a) project #2738 | note       | 2738             |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | (b) project #2835 | note       | 2738             |</span>
<span class="sd">        +-------------------+------------+------------------+</span>
<span class="sd">        | (c) project #2852 | note       | 2738             |</span>
<span class="sd">        +-------------------+------------+------------------+</span>

<span class="sd">        Finds the note rows with footnote indicators, maps the content from the note row</span>
<span class="sd">        into a new note column that&#39;s associated with the value row, and maps any FERC</span>
<span class="sd">        license extracted from this note column to the ``license_id_ferc1`` column in</span>
<span class="sd">        the value row.</span>

<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | plant_name_ferc1  | row_type   | notes             | license_id_ferc1 |</span>
<span class="sd">        +===================+============+===================+==================+</span>
<span class="sd">        | HYDRO:            | header     | NA                | NA               |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | rainbow falls (b) | NA         | (b) project #2835 | 2835             |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | cadyville (a)     | NA         | (a) project #2738 | 2738             |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | keuka (c)         | NA         | (c) project #2852 | 2752             |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | total plants      | total      | NA                | NA               |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | (a) project #2738 | note       | NA                | 2738             |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | (b) project #2835 | note       | NA                | 2835             |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>
<span class="sd">        | (c) project #2852 | note       | NA                | 2752             |</span>
<span class="sd">        +-------------------+------------+-------------------+------------------+</span>

<span class="sd">        (Header and note rows are removed later).</span>

<span class="sd">        NOTE: Note rows that don&#39;t have a footnote indicator or note rows with a</span>
<span class="sd">        footnote indicator that don&#39;t have a corresponding plant row with the same</span>
<span class="sd">        indicator are not captured. They will ultimately get removed and their content</span>
<span class="sd">        will not be preserved.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data that has been run through</span>
<span class="sd">            :func:`label_row_types` and contains the column ``row_type``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with a column called ``notes`` that contains</span>
<span class="sd">            notes, reported below, in the same row as the plant values they pertain to.</span>
<span class="sd">            Also, any further additions to the ``license_id_ferc1`` field as extracted</span>
<span class="sd">            from these newly associated notes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Mapping notes and ferc license from notes rows&quot;</span>
        <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">associate_notes_with_values_group</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Map footnotes within a given utility year group.</span>

<span class="sd">            Because different utilities may use the same footnotes or the same utility</span>
<span class="sd">            could reuse footnotes each year, we must do the footnote association within</span>
<span class="sd">            utility-year groups.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">regular_row</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
            <span class="n">has_note</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;note&quot;</span>

            <span class="c1"># Shorten execution time by only looking at groups with discernible</span>
            <span class="c1"># footnotes</span>
            <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">footnote</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># Make a df that combines notes and ferc license with the same footnote</span>
                <span class="n">footnote_df</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">group</span><span class="p">[</span><span class="n">has_note</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;footnote&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="s2">&quot;license_id_ferc1&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">})</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">:</span> <span class="s2">&quot;notes&quot;</span><span class="p">})</span>
                <span class="p">)</span>

                <span class="c1"># Map these new license and note values onto the original df</span>
                <span class="n">updated_ferc_license_col</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">footnote</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="n">footnote_df</span><span class="p">[</span><span class="s2">&quot;license_id_ferc1&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">notes_col</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">footnote</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">footnote_df</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">])</span>
                <span class="c1"># We update the ferc lic col because some were already there from the</span>
                <span class="c1"># plant name extraction. However, we want to override with the notes</span>
                <span class="c1"># ferc licenses because they are more likely to be accurate.</span>
                <span class="n">group</span><span class="o">.</span><span class="n">license_id_ferc1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_ferc_license_col</span><span class="p">)</span>
                <span class="n">group</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">regular_row</span><span class="p">,</span> <span class="s2">&quot;notes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">notes_col</span>

            <span class="k">return</span> <span class="n">group</span>

        <span class="n">footnote_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\(\d?[a-z]?[A-Z]?\))&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="c1"># Create new footnote column</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;footnote&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">plant_name_ferc1</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">footnote_pattern</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># Group by year and utility and run footnote association</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">])</span>
        <span class="n">sg_notes</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">associate_notes_with_values_group</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># Remove footnote column now that rows are associated</span>
        <span class="n">sg_notes</span> <span class="o">=</span> <span class="n">sg_notes</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;footnote&quot;</span><span class="p">])</span>

        <span class="n">notes_added</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">sg_notes</span><span class="p">[</span><span class="n">sg_notes</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">sg_notes</span><span class="p">[</span><span class="s2">&quot;row_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mapped </span><span class="si">{</span><span class="n">notes_added</span><span class="si">}</span><span class="s2"> notes to plant rows.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sg_notes</span></div>


<div class="viewcode-block" id="SmallPlantsTableTransformer.spot_fix_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SmallPlantsTableTransformer.spot_fix_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spot_fix_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fix one-off row errors.</span>

<span class="sd">        In 2004, utility_id_ferc1 251 reports clumps of units together. Each unit clump</span>
<span class="sd">        looks something like this: ``intrepid wind farm (107 units @ 1.5 mw each)`` and</span>
<span class="sd">        is followed by a row that looks like this: ``(amounts are for the total of all</span>
<span class="sd">        107 units)``. For the most part, these rows are useless note rows. However,</span>
<span class="sd">        there is one instance where important values are reported in this note row</span>
<span class="sd">        rather than in the actual plant row above.</span>

<span class="sd">        There are probably plenty of other spot fixes one could add here.</span>

<span class="sd">        Params:</span>
<span class="sd">            df: Pre-processed, concatenated XBRL and DBF data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The same input DataFrame but with some spot fixes corrected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Spot fixing some rows&quot;</span><span class="p">)</span>
        <span class="c1"># Define rows and columns to change</span>
        <span class="n">cols_to_change</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;row_type&quot;</span>
        <span class="p">]</span>
        <span class="n">row_with_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2004</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;(amounts are for the total of all 107 units)&quot;</span>
        <span class="p">)</span>
        <span class="n">row_missing_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2004</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;plant_name_ferc1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;intrepid wind farm (107 units @ 1.5 mw each)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Replace row missing information with data from row containing information</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_missing_info</span><span class="p">,</span> <span class="n">cols_to_change</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">row_with_info</span><span class="p">][</span>
            <span class="n">cols_to_change</span>
        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Remove row_with_info so there is no duplicate information</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">row_with_info</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="TransmissionLinesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TransmissionLinesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TransmissionLinesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A table transformer for the :ref:`core_ferc1__yearly_transmission_lines_sched422` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TransmissionLinesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TransmissionLinesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">TRANSMISSION_LINES</span></div>

<div class="viewcode-block" id="TransmissionLinesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TransmissionLinesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="TransmissionLinesTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.TransmissionLinesTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do some string-to-numeric ninja moves.&quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;num_transmission_circuits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;num_transmission_circuits&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="EnergySourcesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergySourcesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EnergySourcesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_energy_sources_sched401` table.</span>

<span class="sd">    The raw DBF and XBRL table will be split up into two tables. This transformer</span>
<span class="sd">    generates the sources of electricity for utilities, dropping the information about</span>
<span class="sd">    dispositions. For XBRL, this is a duration-only table. Right now we are merging in</span>
<span class="sd">    the metadata but not actually keeping anything from it. We are also not yet doing</span>
<span class="sd">    anything with the sign.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnergySourcesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergySourcesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">ENERGY_SOURCES</span></div>

<div class="viewcode-block" id="EnergySourcesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergySourcesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="EnergySourcesTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergySourcesTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform default xbrl metadata processing plus adding 1 new xbrl_factoid.</span>

<span class="sd">        Note: we should probably parameterize this and add it into the standard</span>
<span class="sd">        :meth:`process_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="n">facts_to_add</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">new_fact</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;megawatt_hours_purchased&quot;</span><span class="p">,</span> <span class="s2">&quot;purchased_mwh&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">new_facts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">facts_to_add</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tbl_meta</span><span class="p">,</span> <span class="n">new_facts</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="EnergyDispositionsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergyDispositionsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">EnergyDispositionsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_energy_dispositions_sched401` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="EnergyDispositionsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergyDispositionsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">ENERGY_DISPOSITIONS</span></div>

<div class="viewcode-block" id="EnergyDispositionsTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.EnergyDispositionsTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UtilityPlantSummaryTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_utility_plant_summary_sched200` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">UTILITY_PLANT_SUMMARY</span></div>

<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.process_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.process_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the end-of-previous-year instant data.&quot;&quot;&quot;</span>
        <span class="n">all_current_year</span> <span class="o">=</span> <span class="n">raw_xbrl_instant</span><span class="p">[</span>
            <span class="n">raw_xbrl_instant</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
            <span class="o">==</span> <span class="n">raw_xbrl_instant</span><span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_xbrl</span><span class="p">(</span><span class="n">all_current_year</span><span class="p">,</span> <span class="n">raw_xbrl_duration</span><span class="p">)</span></div>


<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do the default metadata processing plus add a new factoid.</span>

<span class="sd">        The new factoid corresponds to the aggregated factoid in</span>
<span class="sd">        :meth:`aggregated_xbrl_factoids`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="c1"># things that could be grabbed from a aggregated_xbrl_factoids param</span>
        <span class="n">new_factoid_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;utility_plant_in_service_classified_and_property_under_capital_leases&quot;</span>
        <span class="p">)</span>
        <span class="c1"># point this new aggregated factiod to the PIS table&#39;s equivalent when the</span>
        <span class="c1"># subdimensions line up</span>
        <span class="n">calc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;electric_plant_in_service_and_completed_construction_not_classified_electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;source_tables&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;core_ferc1__yearly_plant_in_service_sched204&quot;</span><span class="p">],</span>
                <span class="s2">&quot;utility_type&quot;</span><span class="p">:</span> <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="n">new_fact</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">new_factoid_name</span><span class="p">],</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">calc</span><span class="p">)],</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;debit&quot;</span><span class="p">],</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">],</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">new_factoid_name</span><span class="p">],</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;calculated_value&quot;</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span>

        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">tbl_meta</span><span class="p">,</span> <span class="n">new_fact</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default transforming, plus spot fixing and building aggregate xbrl_factoid.&quot;&quot;&quot;</span>
        <span class="c1"># we want to aggregate the factoids first here bc merge_xbrl_metadata is done</span>
        <span class="c1"># at the end of super().transform_main</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggregated_xbrl_factoids</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spot_fix_bad_signs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.aggregated_xbrl_factoids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.aggregated_xbrl_factoids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregated_xbrl_factoids</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate xbrl_factoids records for linking to :ref:`core_ferc1__yearly_plant_in_service_sched204`.</span>

<span class="sd">        This table has two ``xbrl_factoid`` which can be linked via calculations to one</span>
<span class="sd">        ``xbrl_factoid`` in the :ref:`core_ferc1__yearly_plant_in_service_sched204`.</span>
<span class="sd">        Doing this 2:1 linkage would be fine in theory. But the</span>
<span class="sd">        :ref:`core_ferc1__yearly_plant_in_service_sched204` is in most senses</span>
<span class="sd">        the table with the more details and of our desire to build tree-link</span>
<span class="sd">        relationships between factoids, we need to build a new factoid to link in a 1:1</span>
<span class="sd">        manner between this table and the :ref:`core_ferc1__yearly_plant_in_service_sched204`.</span>

<span class="sd">        We&#39;ll also add this factoid into the metadata via :meth:`process_xbrl_metadata`</span>
<span class="sd">        and add the linking calculation via :meth:`apply_xbrl_calculation_fixes`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># these guys could be params</span>
        <span class="n">factoids_to_agg</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;utility_plant_in_service_classified&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utility_plant_in_service_property_under_capital_leases&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">new_factoid_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;utility_plant_in_service_classified_and_property_under_capital_leases&quot;</span>
        <span class="p">)</span>
        <span class="n">cols_to_agg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span>
        <span class="c1"># grab some key info for the actual aggregation</span>
        <span class="n">xbrl_factoid_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xbrl_factoid_name</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">from_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="n">pks_wo_factoid</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pks</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">xbrl_factoid_name</span><span class="p">]</span>

        <span class="n">agg_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">xbrl_factoid_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">factoids_to_agg</span><span class="p">)</span>
        <span class="n">agg_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">agg_mask</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pks_wo_factoid</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="n">cols_to_agg</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">xbrl_factoid_name</span><span class="p">:</span> <span class="n">new_factoid_name</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="c1"># note: this results in the &quot;loss&quot; of non-pk columns like record_id - which</span>
        <span class="c1"># seems appropriate imo. still flag a warning</span>
        <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">agg_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;record_id&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Post-aggregating a new xbrl_factoid, we are missing the following columns: </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># squish em back together</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">agg_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="UtilityPlantSummaryTableTransformer.spot_fix_bad_signs">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.UtilityPlantSummaryTableTransformer.spot_fix_bad_signs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spot_fix_bad_signs</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Spot fix depreciation_utility_plant_in_service records with bad signs.&quot;&quot;&quot;</span>
        <span class="n">primary_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utility_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utility_plant_asset_type&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">spot_fix_pks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="mi">2012</span><span class="p">,</span>
                <span class="mi">156</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2012</span><span class="p">,</span>
                <span class="mi">156</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2012</span><span class="p">,</span>
                <span class="mi">156</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2012</span><span class="p">,</span>
                <span class="mi">156</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2012</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="s2">&quot;electric&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2013</span><span class="p">,</span>
                <span class="mi">170</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2013</span><span class="p">,</span>
                <span class="mi">170</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;amortization_of_other_utility_plant_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;amortization_of_plant_acquisition_adjustment&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2013</span><span class="p">,</span>
                <span class="mi">170</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2013</span><span class="p">,</span>
                <span class="mi">170</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2013</span><span class="p">,</span>
                <span class="mi">170</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;amortization_of_other_utility_plant_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="s2">&quot;electric&quot;</span><span class="p">,</span> <span class="s2">&quot;amortization_of_plant_acquisition_adjustment&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2013</span><span class="p">,</span>
                <span class="mi">170</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="s2">&quot;electric&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2007</span><span class="p">,</span>
                <span class="mi">393</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2007</span><span class="p">,</span>
                <span class="mi">393</span><span class="p">,</span>
                <span class="s2">&quot;electric&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">393</span><span class="p">,</span> <span class="s2">&quot;electric&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2007</span><span class="p">,</span>
                <span class="mi">393</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="mi">2007</span><span class="p">,</span>
                <span class="mi">393</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">393</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">spot_fix_pks</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="n">utility_type</span><span class="p">,</span> <span class="n">column_name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2006</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">2021</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">utility_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;electric&quot;</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;accumulated_provision_for_depreciation_amortization_and_depletion_of_plant_utility&quot;</span><span class="p">,</span>
                <span class="s2">&quot;amortization_of_other_utility_plant_utility_plant_in_service&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_amortization_and_depletion_utility_plant_in_service&quot;</span><span class="p">,</span>
                <span class="s2">&quot;depreciation_utility_plant_in_service&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># Par down spot fixes to account for fast tests where not all years are used</span>
        <span class="n">df_years</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">spot_fix_pks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spot_fix_pks</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">df_years</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Spotfixing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">spot_fix_pks</span><span class="p">)</span><span class="si">}</span><span class="s2"> records.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">spot_fix_pks</span><span class="p">:</span>
            <span class="c1"># Create a df of the primary key of the records you want to fix</span>
            <span class="n">df_keys</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">spot_fix_pks</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">primary_keys</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
                <span class="n">primary_keys</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">primary_keys</span><span class="p">)</span>
            <span class="c1"># Flip the signs for the values in &quot;ending balance&quot; all records in the original</span>
            <span class="c1"># df that appear in the primary key df</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_keys</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># All of these are flipping negative values to positive values,</span>
            <span class="c1"># so let&#39;s make sure that&#39;s what happens</span>
            <span class="n">flipped_values</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_keys</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">flipped_values</span><span class="p">[</span><span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;None of these spot fixes should be negative&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">apply_pudl_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;ferc1&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="BalanceSheetLiabilitiesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetLiabilitiesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BalanceSheetLiabilitiesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_balance_sheet_liabilities_sched110` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BalanceSheetLiabilitiesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetLiabilitiesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">BALANCE_SHEET_LIABILITIES</span></div>

<div class="viewcode-block" id="BalanceSheetLiabilitiesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetLiabilitiesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BalanceSheetLiabilitiesTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetLiabilitiesTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Duplicate data that appears in multiple distinct calculations.</span>

<span class="sd">        There is a one case in which exactly the same data values are referenced in</span>
<span class="sd">        multiple calculations which can&#39;t be resolved by choosing one of the</span>
<span class="sd">        referenced values as the canonical location for that data. In order to preserve</span>
<span class="sd">        all of the calculation structure, we need to duplicate those records in the</span>
<span class="sd">        data, the metadata, and the calculation specifications.  Here we duplicate the</span>
<span class="sd">        data and associated it with newly defined facts, which we will also add to</span>
<span class="sd">        the metadata and calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">facts_to_duplicate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;long_term_portion_of_derivative_instrument_liabilities&quot;</span><span class="p">,</span>
            <span class="s2">&quot;long_term_portion_of_derivative_instrument_liabilities_hedges&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">liability_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">facts_to_duplicate</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">liability_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;less_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">liability_type</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">new_data</span><span class="p">])</span></div>


<div class="viewcode-block" id="BalanceSheetLiabilitiesTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetLiabilitiesTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform default xbrl metadata processing plus adding 2 new xbrl_factoids.</span>

<span class="sd">        We add two new factoids which are defined (by PUDL) only for the DBF data, and</span>
<span class="sd">        also duplicate and redefine several factoids which are referenced in multiple</span>
<span class="sd">        calculations and need to be distinguishable from each other.</span>

<span class="sd">        Note: we should probably parameterize this and add it into the standard</span>
<span class="sd">        :meth:`process_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="n">facts_to_duplicate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;long_term_portion_of_derivative_instrument_liabilities&quot;</span><span class="p">,</span>
            <span class="s2">&quot;long_term_portion_of_derivative_instrument_liabilities_hedges&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">duplicated_facts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tbl_meta</span><span class="p">[</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">facts_to_duplicate</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;less_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">,</span>
                <span class="n">xbrl_factoid_original</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;less_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid_original</span><span class="p">,</span>
                <span class="n">balance</span><span class="o">=</span><span class="s2">&quot;credit&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">facts_to_add</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">new_fact</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;accumulated_deferred_income_taxes&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="n">new_facts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">facts_to_add</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tbl_meta</span><span class="p">,</span> <span class="n">new_facts</span><span class="p">,</span> <span class="n">duplicated_facts</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="BalanceSheetAssetsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetAssetsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BalanceSheetAssetsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_balance_sheet_assets_sched110` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BalanceSheetAssetsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetAssetsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">BALANCE_SHEET_ASSETS</span></div>

<div class="viewcode-block" id="BalanceSheetAssetsTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetAssetsTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BalanceSheetAssetsTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetAssetsTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Duplicate data that appears in multiple distinct calculations.</span>

<span class="sd">        There is a one case in which exactly the same data values are referenced in</span>
<span class="sd">        multiple calculations which can&#39;t be resolved by choosing one of the</span>
<span class="sd">        referenced values as the canonical location for that data. In order to preserve</span>
<span class="sd">        all of the calculation structure, we need to duplicate those records in the</span>
<span class="sd">        data, the metadata, and the calculation specifications.  Here we duplicate the</span>
<span class="sd">        data and associated it with newly defined facts, which we will also add to</span>
<span class="sd">        the metadata and calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">facts_to_duplicate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;noncurrent_portion_of_allowances&quot;</span><span class="p">,</span>
            <span class="s2">&quot;derivative_instrument_assets_long_term&quot;</span><span class="p">,</span>
            <span class="s2">&quot;derivative_instrument_assets_hedges_long_term&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">asset_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">facts_to_duplicate</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">asset_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;less_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">asset_type</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">new_data</span><span class="p">])</span></div>


<div class="viewcode-block" id="BalanceSheetAssetsTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.BalanceSheetAssetsTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default xbrl metadata processing plus some error correction.</span>

<span class="sd">        We add two new factoids which are defined (by PUDL) only for the DBF data, and</span>
<span class="sd">        also duplicate and redefine several factoids which are referenced in multiple</span>
<span class="sd">        calculations and need to be distinguishable from each other.</span>

<span class="sd">        Note: we should probably parameterize this and add it into the standard</span>
<span class="sd">        :meth:`process_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>

        <span class="n">facts_to_duplicate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;noncurrent_portion_of_allowances&quot;</span><span class="p">,</span>
            <span class="s2">&quot;derivative_instrument_assets_long_term&quot;</span><span class="p">,</span>
            <span class="s2">&quot;derivative_instrument_assets_hedges_long_term&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">duplicated_facts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tbl_meta</span><span class="p">[</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">facts_to_duplicate</span><span class="p">)]</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;less_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">,</span>
                <span class="n">xbrl_factoid_original</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;less_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid_original</span><span class="p">,</span>
                <span class="n">balance</span><span class="o">=</span><span class="s2">&quot;credit&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">facts_to_add</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">new_fact</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;special_funds_all&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nuclear_fuel&quot;</span><span class="p">,</span>
                <span class="s2">&quot;preliminary_natural_gas_and_other_survey_and_investigation_charges&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">new_facts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">facts_to_add</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tbl_meta</span><span class="p">,</span> <span class="n">new_facts</span><span class="p">,</span> <span class="n">duplicated_facts</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="IncomeStatementsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IncomeStatementsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">IncomeStatementsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for the :ref:`core_ferc1__yearly_income_statements_sched114` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IncomeStatementsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IncomeStatementsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">INCOME_STATEMENTS</span></div>

<div class="viewcode-block" id="IncomeStatementsTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IncomeStatementsTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="IncomeStatementsTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IncomeStatementsTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform default xbrl metadata processing plus adding a new xbrl_factoid.</span>

<span class="sd">        Note: we should probably parameterize this and add it into the standard</span>
<span class="sd">        :meth:`process_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="n">facts_to_add</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;miscellaneous_deductions&quot;</span><span class="p">],</span>
            <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;[]&quot;</span><span class="p">],</span>
            <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;debit&quot;</span><span class="p">],</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">],</span>
            <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;miscellaneous_deductions&quot;</span><span class="p">],</span>
            <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">],</span>
            <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;reported_value&quot;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">new_facts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">facts_to_add</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tbl_meta</span><span class="p">,</span> <span class="n">new_facts</span><span class="p">])</span></div>


<div class="viewcode-block" id="IncomeStatementsTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IncomeStatementsTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop incorrect row numbers from f1_incm_stmnt_2 before standard processing.</span>

<span class="sd">        In 2003, two rows were added to the ``f1_income_stmnt`` dbf table, which bumped</span>
<span class="sd">        the starting ``row_number`` of ``f1_incm_stmnt_2`` from 25 to 27. A small</span>
<span class="sd">        handful of respondents seem to have not gotten the memo about this in</span>
<span class="sd">        2003 and have information on these row numbers that shouldn&#39;t exist at all for</span>
<span class="sd">        this table.</span>

<span class="sd">        This step necessitates the ability to know which source table each record</span>
<span class="sd">        actually comes from, which required adding a column (``sched_table_name``) in</span>
<span class="sd">        the extract step before these two dbf input tables were concatenated.</span>

<span class="sd">        Right now we are just dropping these bad row numbers. Should we actually be</span>
<span class="sd">        bumping the whole respondent&#39;s row numbers - assuming they reported incorrectly</span>
<span class="sd">        for the whole table? See: https://github.com/catalyst-cooperative/pudl/issues/471</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">len_og</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span>
        <span class="n">known_bad_income2_rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">]</span>
        <span class="n">raw_dbf</span> <span class="o">=</span> <span class="n">raw_dbf</span><span class="p">[</span>
            <span class="o">~</span><span class="p">(</span>
                <span class="p">(</span><span class="n">raw_dbf</span><span class="o">.</span><span class="n">sched_table_name</span> <span class="o">==</span> <span class="s2">&quot;f1_incm_stmnt_2&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_dbf</span><span class="o">.</span><span class="n">report_year</span> <span class="o">==</span> <span class="mi">2003</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_dbf</span><span class="o">.</span><span class="n">row_number</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">known_bad_income2_rows</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Dropped </span><span class="si">{</span><span class="n">len_og</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span><span class="si">}</span><span class="s2"> records (</span><span class="si">{</span><span class="p">(</span><span class="n">len_og</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">len_og</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of&quot;</span>
            <span class="s2">&quot;total) records from 2003 from the f1_incm_stmnt_2 DBF table that have &quot;</span>
            <span class="s2">&quot;known incorrect row numbers.&quot;</span>
        <span class="p">)</span>
        <span class="n">raw_dbf</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw_dbf</span></div>


<div class="viewcode-block" id="IncomeStatementsTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.IncomeStatementsTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop duplicate records from f1_income_stmnt.</span>

<span class="sd">        Because net_utility_operating_income is reported on both page 1 and 2 of the</span>
<span class="sd">        form, it ends up introducing a bunch of duplicated records, so we need to drop</span>
<span class="sd">        one of them. Since the value is used in the calculations that are part of the</span>
<span class="sd">        second page, we&#39;ll drop it from the first page.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="o">~</span><span class="p">(</span>
                <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">record_id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;f1_income_stmnt_&quot;</span><span class="p">))</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">income_type</span> <span class="o">==</span> <span class="s2">&quot;net_utility_operating_income&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">apply_pudl_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;ferc1&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RetainedEarningsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RetainedEarningsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_retained_earnings_sched118` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="RetainedEarningsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">RETAINED_EARNINGS</span></div>

<div class="viewcode-block" id="RetainedEarningsTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.current_year_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.current_year_types">[docs]</a>
    <span class="n">current_year_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;unappropriated_undistributed_subsidiary_earnings&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unappropriated_retained_earnings&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>

<div class="viewcode-block" id="RetainedEarningsTableTransformer.previous_year_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.previous_year_types">[docs]</a>
    <span class="n">previous_year_types</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;unappropriated_undistributed_subsidiary_earnings_previous_year&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unappropriated_retained_earnings_previous_year&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the metadata to reflect the transformed data.</span>

<span class="sd">        Beyond the standard :meth:`Ferc1AbstractTableTransformer.process_xbrl_metadata`</span>
<span class="sd">        processing, add FERC account values for a few known values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span>
            <span class="o">==</span> <span class="s2">&quot;transfers_from_unappropriated_undistributed_subsidiary_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;216.1&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span>
            <span class="o">==</span> <span class="s2">&quot;appropriated_retained_earnings_including_reserve_amortization&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;215_and_215.1&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;retained_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;215_and_215.1_and_216&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;unappropriated_retained_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;216&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;equity_in_earnings_of_subsidiary_companies&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;418.1&quot;</span>

        <span class="c1"># NOTE: Needs to happen before `process_xbrl_metadata_calculations`</span>
        <span class="n">facts_to_add</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="n">new_fact</span><span class="p">,</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">new_fact</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;unappropriated_retained_earnings_previous_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unappropriated_undistributed_subsidiary_earnings_previous_year&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>

        <span class="n">new_facts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">facts_to_add</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">meta</span><span class="p">,</span> <span class="n">new_facts</span><span class="p">])</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preform generic :meth:`process_dbf`, plus deal with duplicates.</span>

<span class="sd">        Along with the standard processing in</span>
<span class="sd">        :meth:`Ferc1AbstractTableTransformer.process_dbf`, this method runs:</span>
<span class="sd">        * :meth:`targeted_drop_duplicates_dbf`</span>
<span class="sd">        * :meth:`reconcile_double_year_earnings_types_dbf`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">processed_dbf</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span>
            <span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_drop_duplicates_dbf</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconcile_double_year_earnings_types_dbf</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">processed_dbf</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="RetainedEarningsTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add ``_previous_year`` factoids after standard transform_main.</span>

<span class="sd">        Add ``_previous_year`` factoids for ``unappropriated_retained_earnings`` and</span>
<span class="sd">        ``unappropriated_undistributed_subsidiary_earnings`` after standard</span>
<span class="sd">        transform_main. This should only affect XBRL data, but we do it after merging to</span>
<span class="sd">        enable access to DBF data to fill this in as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_previous_year_factoid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.transform_end">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.transform_end">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check ``_previous_year`` factoids for consistency after the transformation is done.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_end</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_double_year_earnings_types</span><span class="p">)</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.check_double_year_earnings_types">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.check_double_year_earnings_types">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_double_year_earnings_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check previous year/current year factoids for consistency.</span>

<span class="sd">        The terminology can be very confusing - here are the expectations:</span>

<span class="sd">        1. &quot;inter year consistency&quot;: earlier year&#39;s &quot;current starting/end</span>
<span class="sd">           balance&quot; == later year&#39;s &quot;previous starting/end balance&quot;</span>
<span class="sd">        2. &quot;intra year consistency&quot;: each year&#39;s &quot;previous ending balance&quot; ==</span>
<span class="sd">           &quot;current starting balance&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_year_facts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_year_types</span><span class="p">)]</span>
        <span class="n">previous_year_facts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_year_types</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">earnings_type</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;_previous_year&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># inter year comparison requires us to match the earlier year&#39;s current facts</span>
        <span class="c1"># to the later year&#39;s previous facts, so we add 1 to the report year &amp; merge.</span>
        <span class="n">earlier_years</span> <span class="o">=</span> <span class="n">current_year_facts</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">report_year</span><span class="o">=</span><span class="n">current_year_facts</span><span class="o">.</span><span class="n">report_year</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">later_years</span> <span class="o">=</span> <span class="n">previous_year_facts</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="s2">&quot;earnings_type&quot;</span><span class="p">]</span>
        <span class="n">inter_year_facts</span> <span class="o">=</span> <span class="n">earlier_years</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">later_years</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_earlier&quot;</span><span class="p">,</span> <span class="s2">&quot;_later&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;starting_balance_earlier&quot;</span><span class="p">,</span>
                <span class="s2">&quot;starting_balance_later&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ending_balance_earlier&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ending_balance_later&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">intra_year_facts</span> <span class="o">=</span> <span class="n">previous_year_facts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">current_year_facts</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_previous&quot;</span><span class="p">,</span> <span class="s2">&quot;_current&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">assert_cols_areclose</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">inter_year_facts</span><span class="p">,</span>
            <span class="n">a_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;starting_balance_earlier&quot;</span><span class="p">],</span>
            <span class="n">b_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;starting_balance_later&quot;</span><span class="p">],</span>
            <span class="n">mismatch_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Current starting balance&#39; for year X-1 doesn&#39;t match &quot;</span>
            <span class="s2">&quot;&#39;previous starting balance&#39; for year X.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">assert_cols_areclose</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">inter_year_facts</span><span class="p">,</span>
            <span class="n">a_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ending_balance_earlier&quot;</span><span class="p">],</span>
            <span class="n">b_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ending_balance_later&quot;</span><span class="p">],</span>
            <span class="n">mismatch_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Current ending balance&#39; for year X-1 doesn&#39;t match &quot;</span>
            <span class="s2">&quot;&#39;previous ending balance&#39; for year X.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">assert_cols_areclose</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">intra_year_facts</span><span class="p">,</span>
            <span class="n">a_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ending_balance_previous&quot;</span><span class="p">],</span>
            <span class="n">b_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;starting_balance_current&quot;</span><span class="p">],</span>
            <span class="n">mismatch_threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&#39;Previous year ending balance&#39; should be the same as &quot;</span>
            <span class="s2">&quot;&#39;current year starting balance&#39; for all years!&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.targeted_drop_duplicates_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.targeted_drop_duplicates_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">targeted_drop_duplicates_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop duplicates with truly duplicate data.</span>

<span class="sd">        There are instances of utilities that reported multiple values for several</span>
<span class="sd">        earnings types for a specific year (utility_id_ferc1 68 in 1998 &amp;</span>
<span class="sd">        utility_id_ferc1 296 in 2015). We are taking the largest value reported and</span>
<span class="sd">        dropping the rest. There very well could be a better strategy here, but there</span>
<span class="sd">        are only 25 records that have this problem, so we&#39;ve going with this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="n">PUDL_PACKAGE</span><span class="o">.</span><span class="n">get_resource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">primary_key</span>
        <span class="c1"># we are not going to check all of the unstructed earnings types for dupes bc</span>
        <span class="c1"># we will drop these later</span>
        <span class="n">dupe_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_unstructured&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="n">pks</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">dupes</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dupe_mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Too many duplicates found (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span><span class="si">}</span><span class="s2">). &quot;</span>
                <span class="s2">&quot;Expected 25 or less.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># we are simply sorting to get the biggest value and dropping the rest.</span>
        <span class="n">dupes</span> <span class="o">=</span> <span class="n">dupes</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;starting_balance&quot;</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">pks</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">dupe_mask</span><span class="p">],</span> <span class="n">dupes</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.reconcile_double_year_earnings_types_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.reconcile_double_year_earnings_types_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reconcile_double_year_earnings_types_dbf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconcile current and past year data reported in 1 report_year.</span>

<span class="sd">        The DBF table includes two different earnings types that have: &quot;Beginning of</span>
<span class="sd">        Period&quot; and &quot;End of Period&quot; rows. But the table has both an amount column that</span>
<span class="sd">        corresponds to a balance and a starting balance column. For these two earnings</span>
<span class="sd">        types, this means that there is in effect two years of data in this table for</span>
<span class="sd">        each report year: a starting and ending balance for the pervious year and a</span>
<span class="sd">        starting and ending balance for the current year. The ending balance for the</span>
<span class="sd">        previous year should be the same as the starting balance for the current year.</span>

<span class="sd">        We need to keep both pieces of data in order to calculate ``ending_balances``,</span>
<span class="sd">        so we want to check these assumptions, extract as much information from these</span>
<span class="sd">        two years of data, and keep both records for each of these two earnings</span>
<span class="sd">        types for each utility.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AssertionError: There are a very small number of instances in which the</span>
<span class="sd">                ending balance from the previous year does not match the starting</span>
<span class="sd">                balance from the current year. The % of these non-matching instances</span>
<span class="sd">                should be less than 2% of the records with these date duplicative</span>
<span class="sd">                earnings types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Reconciling previous year&#39;s data.&quot;</span><span class="p">)</span>
        <span class="c1"># DBF has _current_year suffix while PUDL core version does not</span>
        <span class="n">current_year_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;unappropriated_undistributed_subsidiary_earnings_current_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unappropriated_retained_earnings_current_year&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">previous_year_types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;unappropriated_undistributed_subsidiary_earnings_previous_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unappropriated_retained_earnings_previous_year&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># assign() copies, so no need to double copy when extracting this slice</span>
        <span class="n">current_year</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">current_year_types</span><span class="p">)]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">earnings_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;_current_year&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">previous_year</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">previous_year_types</span><span class="p">)]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">earnings_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;_previous_year&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;utility_id_ferc1_dbf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;earnings_type&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">data_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;amount&quot;</span><span class="p">,</span> <span class="s2">&quot;starting_balance&quot;</span><span class="p">]</span>
        <span class="n">date_dupe_types</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">current_year</span><span class="p">,</span>
            <span class="n">previous_year</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">data_columns</span><span class="p">],</span>
            <span class="n">on</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_previous_year&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">date_dupe_types</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="c1"># check if the starting balance from the current year is actually</span>
        <span class="c1"># the amount from the previous year</span>
        <span class="n">date_mismatch</span> <span class="o">=</span> <span class="n">date_dupe_types</span><span class="p">[</span>
            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">date_dupe_types</span><span class="o">.</span><span class="n">starting_balance</span><span class="p">,</span>
                <span class="n">date_dupe_types</span><span class="o">.</span><span class="n">amount_previous_year</span><span class="p">,</span>
                <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">date_dupe_types</span><span class="o">.</span><span class="n">starting_balance</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">date_dupe_types</span><span class="o">.</span><span class="n">amount_previous_year</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">data_mismatch_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_mismatch</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_dupe_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_mismatch_ratio</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;More records than expected have data that is not the same in &quot;</span>
                <span class="s2">&quot;the starting_balance vs the amount column for the earnings_type &quot;</span>
                <span class="s2">&quot;that reports both current and previous year. </span><span class="si">% o</span><span class="s2">f mismatch records: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_mismatch_ratio</span><span class="si">:</span><span class="s2">.01%</span><span class="si">}</span><span class="s2"> (expected less than 1%)&quot;</span>
            <span class="p">)</span>

        <span class="c1"># the amount from the current year values should be the ending balance.</span>
        <span class="c1"># the amount from the previous year should fill in the starting balance</span>
        <span class="c1"># then drop all of the _previous_year columns</span>
        <span class="n">date_dupe_types</span> <span class="o">=</span> <span class="n">date_dupe_types</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">ending_balance</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
            <span class="n">starting_balance</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">starting_balance</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">amount_previous_year</span>
            <span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;amount_previous_year&quot;</span><span class="p">,</span> <span class="s2">&quot;starting_balance_previous_year&quot;</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">current_year_types</span><span class="p">)],</span> <span class="n">date_dupe_types</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Since we&#39;ve created an ending balance column, we should use the &#39;amount&#39;</span>
        <span class="c1"># value to fill it across the table and drop the amount column.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">ending_balance</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ending_balance</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;amount&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.add_previous_year_factoid">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.add_previous_year_factoid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_previous_year_factoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create ``*_previous_year`` factoids for XBRL data.</span>

<span class="sd">        XBRL doesn&#39;t include the previous year&#39;s data, but DBF does - so we try to</span>
<span class="sd">        check that year X&#39;s ``*_current_year`` factoid has the same value as year X+1&#39;s</span>
<span class="sd">        ``*_previous_year`` factoid.</span>

<span class="sd">        To do this, we need to add some ``*_previous_year`` factoids to the XBRL data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_year_facts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_year_types</span><span class="p">)]</span>
        <span class="n">previous_year_facts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">earnings_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_year_types</span><span class="p">)]</span>

        <span class="n">missing_years</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_year_facts</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">previous_year_facts</span><span class="o">.</span><span class="n">report_year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">to_copy_forward</span> <span class="o">=</span> <span class="n">current_year_facts</span><span class="p">[</span>
            <span class="p">(</span><span class="n">current_year_facts</span><span class="o">.</span><span class="n">report_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">missing_years</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;earnings_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">inferred_previous_year_facts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">to_copy_forward</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">report_year</span><span class="o">=</span><span class="n">to_copy_forward</span><span class="o">.</span><span class="n">report_year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">new_earnings_type</span><span class="o">=</span><span class="n">to_copy_forward</span><span class="o">.</span><span class="n">earnings_type</span> <span class="o">+</span> <span class="s2">&quot;_previous_year&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">current_year_facts</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;earnings_type&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;new_earnings_type&quot;</span><span class="p">:</span> <span class="s2">&quot;earnings_type&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">row_type_xbrl</span><span class="o">=</span><span class="s2">&quot;reported_value&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">inferred_previous_year_facts</span><span class="p">])</span></div>


<div class="viewcode-block" id="RetainedEarningsTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.RetainedEarningsTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_xbrl_factoid_xbrl_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_meta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deduplicate the xbrl_metadata based on the ``xbrl_factoid``.</span>

<span class="sd">        The metadata relating to dollar_value column *generally* had the same name as</span>
<span class="sd">        the renamed xbrl_factoid. we&#39;ll double check that we a) didn&#39;t remove too many</span>
<span class="sd">        factoid&#39;s by doing this AND that we have a fully deduped output below. In an</span>
<span class="sd">        ideal world, we would have multiple pieces of metadata information (like</span>
<span class="sd">        calculations and ferc account #&#39;s), for every single :meth:`wide_to_tidy` value</span>
<span class="sd">        column.</span>

<span class="sd">        Note: This is **almost** the same as the method for</span>
<span class="sd">        :ref:`core_ferc1__yearly_operating_revenues_sched300`. If we wanted to lean into this</span>
<span class="sd">        version of deduplication more generally this might be a fine way start to an</span>
<span class="sd">        abstraction, but ideally we wouldn&#39;t need to dedupe this at all and instead</span>
<span class="sd">        enable metadata for every value column from :meth:`wide_to_tidy`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dupes_masks</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">non_dupes</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span><span class="o">~</span><span class="n">dupes_masks</span><span class="p">]</span>
        <span class="n">dupes</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span><span class="n">dupes_masks</span><span class="p">]</span>

        <span class="n">deduped</span> <span class="o">=</span> <span class="n">dupes</span><span class="p">[</span><span class="n">dupes</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="n">dupes</span><span class="o">.</span><span class="n">xbrl_factoid_original</span><span class="p">]</span>
        <span class="n">tbl_meta_cleaned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">non_dupes</span><span class="p">,</span> <span class="n">deduped</span><span class="p">])</span>
        <span class="k">assert</span> <span class="o">~</span><span class="n">tbl_meta_cleaned</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">factoid</span>
            <span class="k">for</span> <span class="n">factoid</span> <span class="ow">in</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">factoid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl_meta_cleaned</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;We expected to find no missing xbrl_factoid&#39;s after deduplication &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but found </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta_cleaned</span></div>
</div>



<div class="viewcode-block" id="DepreciationSummaryTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationSummaryTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DepreciationSummaryTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_depreciation_summary_sched336` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DepreciationSummaryTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationSummaryTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">DEPRECIATION_SUMMARY</span></div>

<div class="viewcode-block" id="DepreciationSummaryTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationSummaryTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_xbrl_metadata&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DepreciationSummaryTableTransformer.process_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationSummaryTableTransformer.process_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_converted</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">xbrl_calculations</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the metadata to reflect the transformed data.</span>

<span class="sd">        Beyond the standard :meth:`Ferc1AbstractTableTransformer.process_xbrl_metadata`</span>
<span class="sd">        processing, add FERC account values for a few known values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_xbrl_metadata</span><span class="p">(</span><span class="n">xbrl_metadata_converted</span><span class="p">,</span> <span class="n">xbrl_calculations</span><span class="p">)</span>
        <span class="c1"># logger.info(meta)</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;depreciation_expense&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;403&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;depreciation_expense_asset_retirement&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;403.1&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;amortization_limited_term_electric_plant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;404&quot;</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;amortization_other_electric_plant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ferc_account&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;405&quot;</span>
        <span class="k">return</span> <span class="n">meta</span></div>
</div>



<div class="viewcode-block" id="DepreciationChangesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationChangesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DepreciationChangesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_depreciation_changes_sched219` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DepreciationChangesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationChangesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">DEPRECIATION_CHANGES</span></div>

<div class="viewcode-block" id="DepreciationChangesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationChangesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DepreciationChangesTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationChangesTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span> <span class="n">xbrl_metadata_json</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the metadata to reflect the transformed data.</span>

<span class="sd">        Warning: The calculations in this table are currently being corrected using</span>
<span class="sd">        reconcile_table_calculations(), but they still contain high rates of error.</span>
<span class="sd">        This function replaces the name of the single balance column reported in the</span>
<span class="sd">        XBRL Instant table with starting_balance / ending_balance. We pull those two</span>
<span class="sd">        values into their own separate labeled rows, each of which should get the</span>
<span class="sd">        metadata from the original column. We do this pre-processing before we</span>
<span class="sd">        call the main function in order for the calculation fixes and renaming to work</span>
<span class="sd">        as expected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_xbrl_metadata_json</span> <span class="o">=</span> <span class="n">xbrl_metadata_json</span>
        <span class="c1"># Get instant metadata</span>
        <span class="n">instant</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">new_xbrl_metadata_json</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">])</span>
        <span class="c1"># Duplicate instant metadata, and add starting/ending suffix</span>
        <span class="c1"># should just be balance beginning of year</span>
        <span class="n">instant</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">instant</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">instant</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instant</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;_starting_balance&quot;</span><span class="p">,</span> <span class="s2">&quot;_ending_balance&quot;</span><span class="p">]</span>
        <span class="c1"># Return to JSON format in order to continue processing</span>
        <span class="n">new_xbrl_metadata_json</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
            <span class="n">instant</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xbrl_metadata_json</span> <span class="o">=</span> <span class="n">new_xbrl_metadata_json</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">new_xbrl_metadata_json</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DepreciationChangesTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationChangesTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Accumulated Depreciation table specific DBF cleaning operations.</span>

<span class="sd">        The XBRL reports a utility_type which is always electric in this table, but</span>
<span class="sd">        which may be necessary for differentiating between different values when this</span>
<span class="sd">        data is combined with other tables. The DBF data doesn&#39;t report this value so</span>
<span class="sd">        we are adding it here for consistency across the two data sources.</span>

<span class="sd">        Also rename the ``ending_balance_accounts`` to ``ending_balance``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_df</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">utility_type</span><span class="o">=</span><span class="s2">&quot;electric&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;depreciation_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ending_balance_accounts&quot;</span><span class="p">,</span> <span class="s2">&quot;depreciation_type&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ending_balance&quot;</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_instant_xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DepreciationChangesTableTransformer.process_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationChangesTableTransformer.process_instant_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_instant_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-processing required to make the instant and duration tables compatible.</span>

<span class="sd">        This table has a rename that needs to take place in an unusual spot -- after the</span>
<span class="sd">        starting / ending balances have been usntacked, but before the instant &amp;</span>
<span class="sd">        duration tables are merged. This method just reversed the order in which these</span>
<span class="sd">        operations happen, compared to the inherited method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unstack_balances_to_report_year_instant_xbrl</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;instant_xbrl&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="DepreciationByFunctionTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DepreciationByFunctionTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer for :ref:`core_ferc1__yearly_depreciation_by_function_sched219` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">DEPRECIATION_BY_FUNCTION</span></div>

<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a metadata table with the one factoid we&#39;ve assigned to this table.</span>

<span class="sd">        Instead of adding facts to the metadata like a lot of the other table-specific</span>
<span class="sd">        :meth:`convert_xbrl_metadata_json_to_df`, this method creates a metadata table</span>
<span class="sd">        with one singular ``xbrl_factoid``. We assign that factoid to the table in</span>
<span class="sd">        :meth:`transform_main`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fact</span> <span class="o">=</span> <span class="s2">&quot;accumulated_depreciation&quot;</span>
        <span class="n">single_table_fact</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">fact</span><span class="p">,</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="n">fact</span><span class="p">,</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="s2">&quot;calculated_value&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">single_table_fact</span><span class="p">)</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tbl_meta</span></div>


<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.raw_xbrl_factoid_to_pudl_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.raw_xbrl_factoid_to_pudl_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">raw_xbrl_factoid_to_pudl_name</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">col_name_xbrl</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the one fact name for this table.</span>

<span class="sd">        We&#39;ve artificially assigned this table to have one ``xbrl_factoid`` during</span>
<span class="sd">        :meth:`transform_main`. Because this table only has one value for its</span>
<span class="sd">        ``xbrl_factoid`` column, all ``col_name_xbrl`` should be converted to</span>
<span class="sd">        &quot;accumulated_depreciation&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;accumulated_depreciation&quot;</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Accumulated Depreciation table specific DBF cleaning operations.</span>

<span class="sd">        The XBRL reports a utility_type which is always electric in this table, but</span>
<span class="sd">        which may be necessary for differentiating between different values when this</span>
<span class="sd">        data is combined with other tables. The DBF data doesn&#39;t report this value so we</span>
<span class="sd">        are adding it here for consistency across the two data sources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="n">raw_df</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">utility_type</span><span class="o">=</span><span class="s2">&quot;electric&quot;</span><span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_instant_xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.process_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.process_instant_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_instant_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-processing required to make the instant and duration tables compatible.</span>

<span class="sd">        This table has a rename that needs to take place in an unusual spot -- after the</span>
<span class="sd">        starting / ending balances have been usntacked, but before the instant &amp;</span>
<span class="sd">        duration tables are merged. This method reverses the order in which these</span>
<span class="sd">        operations happen compared to the inherited method. We also want to strip the</span>
<span class="sd">        ``accumulated_depreciation`` that appears on every plant functional class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unstack_balances_to_report_year_instant_xbrl</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;instant_xbrl&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add ``depreciation_type`` then run default :meth:`transform_main`.</span>

<span class="sd">        We are adding ``depreciation_type`` as the ``xbrl_factoid`` column for this</span>
<span class="sd">        table with one value (&quot;accumulated_depreciation&quot;) across the whole table. This</span>
<span class="sd">        table has multiple &quot;dimension&quot; columns such as ``utility_type`` and</span>
<span class="sd">        ``plant_function`` which differentiate what slice of a utility&#39;s assets each</span>
<span class="sd">        record pertains to. We added this new column as the ``xbrl_factoid`` of the</span>
<span class="sd">        table instead of using one of the dimensions of the table so that the table can</span>
<span class="sd">        conform to the same pattern of treatment for these dimension columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">depreciation_type</span><span class="o">=</span><span class="s2">&quot;accumulated_depreciation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span>
        <span class="p">)</span>
        <span class="c1"># convert this **one** utility&#39;s depreciation $$ from negative -&gt; +</span>
        <span class="c1"># this was found through checking the inter-table calculations in the explosion</span>
        <span class="c1"># process. The one factoid in this table is linked with</span>
        <span class="c1"># depreciation_utility_plant_in_service in the utility_plant_summary_ferc1 table.</span>
        <span class="c1"># the values in both tables are almost always positive. Not always &amp; there are</span>
        <span class="c1"># some logical reasons why depreciation can sometimes be negative. Nonetheless,</span>
        <span class="c1"># for this one utility, all of its values in utility_plant_summary_ferc1 are</span>
        <span class="c1"># positive while nearly all of the $s over here are negative. No other utility</span>
        <span class="c1"># has as many -$ which tells me this is a data entry error.</span>
        <span class="c1"># see https://github.com/catalyst-cooperative/pudl/issues/2703 for more details</span>
        <span class="n">negative_util_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">utility_id_ferc1</span> <span class="o">==</span> <span class="mi">211</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">negative_util_mask</span><span class="p">,</span> <span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">negative_util_mask</span><span class="p">,</span> <span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DepreciationByFunctionTableTransformer.transform_end">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.DepreciationByFunctionTableTransformer.transform_end">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run standard :meth:`Ferc1AbstractTableTransformer.transform_end` plus a data validation step.</span>

<span class="sd">        In :func:`infer_intra_factoid_totals`, we restrict the child calculation</span>
<span class="sd">        components to only those without &quot;total&quot; in any of the dimension columns (e.g.</span>
<span class="sd">        ``plant_status == &quot;total&quot;``).  Because of this, when there is more than one</span>
<span class="sd">        dimension with totals in a table, as in this table, records with two totals</span>
<span class="sd">        (e.g. ``plant_status == &quot;total&quot;`` and ``plant_function == &quot;total&quot;``) only get</span>
<span class="sd">        linked to children with no &quot;totals&quot; in any of their subdimensions. This is fine</span>
<span class="sd">        and good because it avoids possible double counting of mixed total and</span>
<span class="sd">        sub-dimension calculations. But it means that records with totals in one</span>
<span class="sd">        sub-dimension (e.g. ``plant_status == &quot;in_service&quot;`` and ``plant_function ==</span>
<span class="sd">        &quot;total&quot;``) aren&#39;t linked to double-total parent factoids. To ensure that there</span>
<span class="sd">        aren&#39;t many instances of data where most or all of the data is reported in these</span>
<span class="sd">        mixed-total records, we add a validation step to ward against large-scale data</span>
<span class="sd">        loss in :class:`pudl.output.ferc1.Exploder`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_end</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dimension_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plant_function&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_status&quot;</span><span class="p">]</span>
        <span class="n">correction_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">depreciation_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_correction&quot;</span><span class="p">)</span>
        <span class="n">double_total_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">dimension_cols</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="n">single_total_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">dimension_cols</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span>
        <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">double_total_mask</span>

        <span class="n">gb_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">]</span>
        <span class="n">value_col</span> <span class="o">=</span> <span class="s2">&quot;ending_balance&quot;</span>
        <span class="n">single_total_sum</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">single_total_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">correction_mask</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">gb_idx</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="n">value_col</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">value_col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s2">_single_total&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">children_sum</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">single_total_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">double_total_mask</span><span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">gb_idx</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="n">value_col</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">value_col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s2">_children&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="n">double_totals</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">double_total_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">correction_mask</span><span class="p">,</span> <span class="n">gb_idx</span> <span class="o">+</span> <span class="p">[</span><span class="n">value_col</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">value_col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value_col</span><span class="si">}</span><span class="s2">_double_total&quot;</span><span class="p">})</span>
        <span class="n">total_test</span> <span class="o">=</span> <span class="n">double_totals</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">single_total_sum</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">gb_idx</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">children_sum</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">gb_idx</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
        <span class="n">total_test</span> <span class="o">=</span> <span class="n">total_test</span><span class="p">[</span>
            <span class="n">total_test</span><span class="o">.</span><span class="n">ending_balance_double_total</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
            <span class="o">&amp;</span> <span class="n">total_test</span><span class="o">.</span><span class="n">ending_balance_single_total</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">description_of_these_records</span> <span class="o">=</span> <span class="s2">&quot;with nulls in the total/total record but non-null data in the total/sub-dimension records.&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_test</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found more records (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">total_test</span><span class="p">)</span><span class="si">}</span><span class="s2">) than expected (7) </span><span class="si">{</span><span class="n">description_of_these_records</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">total_test</span><span class="p">[</span><span class="n">total_test</span><span class="o">.</span><span class="n">ending_balance_children</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;We expected that all of the records </span><span class="si">{</span><span class="n">description_of_these_records</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;to have non-null data in the pure sub-dimension records, but some records that don&#39;t meet this condition were found.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>
</div>



<div class="viewcode-block" id="OperatingExpensesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingExpensesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OperatingExpensesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_operating_expenses_sched320` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OperatingExpensesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingExpensesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">OPERATING_EXPENSES</span></div>

<div class="viewcode-block" id="OperatingExpensesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingExpensesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="OperatingExpensesTableTransformer.targeted_drop_duplicates_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingExpensesTableTransformer.targeted_drop_duplicates_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">targeted_drop_duplicates_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop incorrect duplicate from 2002.</span>

<span class="sd">        In 2002, utility_id_ferc1_dbf 96 reported two values for</span>
<span class="sd">        administrative_and_general_operation_expense. I found the correct value by</span>
<span class="sd">        looking at the prev_yr_amt value in 2003. This removes the incorrect row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_df</span><span class="p">)</span>
        <span class="n">raw_df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="p">[</span>
            <span class="o">~</span><span class="p">((</span><span class="n">raw_df</span><span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2002</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_df</span><span class="p">[</span><span class="s2">&quot;crnt_yr_amt&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">35990321</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dropped</span> <span class="o">:=</span> <span class="n">start_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_df</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More rows dropped than expected: </span><span class="si">{</span><span class="n">dropped</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Heyyyy dropping that one row&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw_df</span></div>


<div class="viewcode-block" id="OperatingExpensesTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingExpensesTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default XBRL metadata processing and add a DBF-only xblr factoid.</span>

<span class="sd">        Note: we should probably parameterize this and add it into the standard</span>
<span class="sd">        :meth:`process_xbrl_metadata`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="n">dbf_only_facts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">:</span> <span class="n">dbf_only_fact</span><span class="p">,</span>
                <span class="s2">&quot;calculations&quot;</span><span class="p">:</span> <span class="s2">&quot;[]&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;credit&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ferc_account&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">:</span> <span class="n">dbf_only_fact</span><span class="p">,</span>
                <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;row_type_xbrl&quot;</span><span class="p">:</span> <span class="s2">&quot;reported_value&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">dbf_only_fact</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;load_dispatching_transmission_expense&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">dbf_only_facts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dbf_only_facts</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="n">tbl_meta</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tbl_meta</span><span class="p">,</span> <span class="n">dbf_only_facts</span><span class="p">])</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">utility_type</span><span class="o">=</span><span class="s2">&quot;electric&quot;</span><span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;dbf&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OperatingExpensesTableTransformer.process_dbf">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingExpensesTableTransformer.process_dbf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_dbf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process DBF but drop a bad row that is flagged by drop_duplicates.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">process_dbf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_drop_duplicates_dbf</span><span class="p">(</span><span class="n">raw_dbf</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="OperatingRevenuesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingRevenuesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OperatingRevenuesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_operating_revenues_sched300` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OperatingRevenuesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingRevenuesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">OPERATING_REVENUES</span></div>

<div class="viewcode-block" id="OperatingRevenuesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingRevenuesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="OperatingRevenuesTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingRevenuesTableTransformer.deduplicate_xbrl_factoid_xbrl_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deduplicate_xbrl_factoid_xbrl_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tbl_meta</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the metadata to reflect the transformed data.</span>

<span class="sd">        Employ the standard process for processing metadata. Then remove duplication on</span>
<span class="sd">        the basis of the ``xbrl_factoid``. This table used :meth:`wide_to_tidy` with three</span>
<span class="sd">        separate value columns. Which results in one ``xbrl_factoid`` referencing three</span>
<span class="sd">        separate data columns. This method grabs only one piece of metadata for each</span>
<span class="sd">        renamed ``xbrl_factoid``, preferring the calculated value or the factoid</span>
<span class="sd">        referencing the dollar columns.</span>

<span class="sd">        In an ideal world, we would have multiple pieces of metadata information (like</span>
<span class="sd">        calculations and ferc account #&#39;s), for every single :meth:`wide_to_tidy` value</span>
<span class="sd">        column. We would probably want to employ that across the board - adding suffixes</span>
<span class="sd">        or something like that to stack the metadata in a similar fashion that we stack</span>
<span class="sd">        the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dupes_masks</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">non_dupes</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span><span class="o">~</span><span class="n">dupes_masks</span><span class="p">]</span>
        <span class="n">dupes</span> <span class="o">=</span> <span class="n">tbl_meta</span><span class="p">[</span><span class="n">dupes_masks</span><span class="p">]</span>
        <span class="c1"># the metadata relating to dollar_value column *generally* had the same name as</span>
        <span class="c1"># the renamed xbrl_factoid. the outliers here are these two that have calcs for</span>
        <span class="c1"># the factoid we want to keep (we could also id them w/ their og factoid names</span>
        <span class="c1"># if that would be more straightforward)</span>
        <span class="n">deduped</span> <span class="o">=</span> <span class="n">dupes</span><span class="p">[</span>
            <span class="p">(</span><span class="n">dupes</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="n">dupes</span><span class="o">.</span><span class="n">xbrl_factoid_original</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span>
                <span class="n">dupes</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;small_or_commercial&quot;</span><span class="p">,</span> <span class="s2">&quot;large_or_industrial&quot;</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">dupes</span><span class="o">.</span><span class="n">calculations</span> <span class="o">!=</span> <span class="s2">&quot;[]&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="n">tbl_meta_cleaned</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">non_dupes</span><span class="p">,</span> <span class="n">deduped</span><span class="p">])</span>
        <span class="k">assert</span> <span class="o">~</span><span class="n">tbl_meta_cleaned</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="c1"># double check that we&#39;re getting only the guys we want</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">factoid</span>
            <span class="k">for</span> <span class="n">factoid</span> <span class="ow">in</span> <span class="n">tbl_meta</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">factoid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tbl_meta_cleaned</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="s2">&quot;We expected to find no missing xbrl_factoid&#39;s after deduplication &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;but found </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">tbl_meta_cleaned</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OperatingRevenuesTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingRevenuesTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add duplicate removal after standard transform_main &amp; assign utility type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_drop_duplicates</span><span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="OperatingRevenuesTableTransformer.targeted_drop_duplicates">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OperatingRevenuesTableTransformer.targeted_drop_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">targeted_drop_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop one duplicate records from 2011, utility_id_ferc1 295.&quot;&quot;&quot;</span>
        <span class="n">dupe_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">utility_id_ferc1</span> <span class="o">==</span> <span class="mi">295</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">==</span> <span class="mi">2011</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">dollar_value</span> <span class="o">==</span> <span class="mf">3.33e8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dollar_value</span> <span class="o">==</span> <span class="mf">3.333e9</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">dupe_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="CashFlowsTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CashFlowsTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform class for :ref:`core_ferc1__yearly_cash_flows_sched120` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="CashFlowsTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">CASH_FLOWS</span></div>

<div class="viewcode-block" id="CashFlowsTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;process_instant_xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CashFlowsTableTransformer.process_instant_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.process_instant_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_instant_xbrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pre-processing required to make the instant and duration tables compatible.</span>

<span class="sd">        This table has a rename that needs to take place in an unusual spot -- after the</span>
<span class="sd">        starting / ending balances have been unstacked, but before the instant &amp;</span>
<span class="sd">        duration tables are merged. This method just reversed the order in which these</span>
<span class="sd">        operations happen, compared to the inherited method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unstack_balances_to_report_year_instant_xbrl</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;instant_xbrl&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CashFlowsTableTransformer.transform_main">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.transform_main">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transform_main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add duplicate removal and validation after standard transform_main.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span>
            <span class="o">.</span><span class="n">transform_main</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_drop_duplicates</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">validate_start_end_balance</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CashFlowsTableTransformer.targeted_drop_duplicates">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.targeted_drop_duplicates">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">targeted_drop_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop one duplicate record from 2020, utility_id_ferc1 2037.</span>

<span class="sd">        Note: This step could be avoided if we employed a :meth:`drop_invalid_rows`</span>
<span class="sd">        transform step with ``required_valid_cols = [&quot;amount&quot;]``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dupe_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">utility_id_ferc1</span> <span class="o">==</span> <span class="mi">237</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">==</span> <span class="mi">2020</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">amount_type</span> <span class="o">==</span> <span class="s2">&quot;dividends_on_common_stock&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">amount</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len_dupes</span> <span class="o">:=</span> <span class="n">dupe_mask</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="kc">True</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected to find 1 duplicate record. Found </span><span class="si">{</span><span class="n">len_dupes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">dupe_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="CashFlowsTableTransformer.validate_start_end_balance">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.validate_start_end_balance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_start_end_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate of start balance + net = end balance.</span>

<span class="sd">        Add a quick check to ensure the vast majority of the ending balances are</span>
<span class="sd">        calculable from the net change + the starting balance = the ending balance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># calculate ending balance</span>
        <span class="n">df</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
        <span class="n">end_bal_calc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span>
                <span class="n">df</span><span class="o">.</span><span class="n">amount_type</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;starting_balance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;net_increase_decrease_in_cash_and_cash_equivalents&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">])[[</span><span class="s2">&quot;amount&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_ending_balance&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># grab reported ending balance &amp; squish with the calculated version</span>
        <span class="n">end_bal</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">amount_type</span> <span class="o">==</span> <span class="s2">&quot;ending_balance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">end_bal_calc</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">end_bal</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;amount_ending_balance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_bal_calc</span><span class="o">.</span><span class="n">amount_ending_balance</span>

        <span class="c1"># when both exist, are they close?</span>
        <span class="n">end_bal_off</span> <span class="o">=</span> <span class="n">end_bal</span><span class="p">[</span>
            <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">end_bal</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="n">end_bal</span><span class="o">.</span><span class="n">amount_ending_balance</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="n">end_bal</span><span class="p">[[</span><span class="s2">&quot;amount&quot;</span><span class="p">,</span> <span class="s2">&quot;amount_ending_balance&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">end_bal_off_ratio</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_bal_off</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">end_bal</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.005</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Ahhh!! The ending balance isn&#39;t calculable in </span><span class="si">{</span><span class="n">end_bal_off_ratio</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="s2">&quot; of records. Expected under 0.5%.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="CashFlowsTableTransformer.convert_xbrl_metadata_json_to_df">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.CashFlowsTableTransformer.convert_xbrl_metadata_json_to_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_xbrl_metadata_json_to_df</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">:</span> <span class="n">Self</span><span class="p">,</span>
        <span class="n">xbrl_metadata_json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;instant&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform the metadata to reflect the transformed data.</span>

<span class="sd">        Replace the name of the balance column reported in the XBRL Instant table with</span>
<span class="sd">        starting_balance / ending_balance since we pull those two values into their own</span>
<span class="sd">        separate labeled rows, each of which should get the original metadata for the</span>
<span class="sd">        Instant column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">convert_xbrl_metadata_json_to_df</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="p">)</span>
        <span class="n">ending_balance</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">meta</span><span class="o">.</span><span class="n">xbrl_factoid</span> <span class="o">==</span> <span class="s2">&quot;starting_balance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">xbrl_factoid</span><span class="o">=</span><span class="s2">&quot;ending_balance&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">meta</span><span class="p">,</span> <span class="n">ending_balance</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="SalesByRateSchedulesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SalesByRateSchedulesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SalesByRateSchedulesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform class for :ref:`core_ferc1__yearly_sales_by_rate_schedules_sched304` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SalesByRateSchedulesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SalesByRateSchedulesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">SALES_BY_RATE_SCHEDULES</span></div>

<div class="viewcode-block" id="SalesByRateSchedulesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SalesByRateSchedulesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SalesByRateSchedulesTableTransformer.add_axis_to_total_table_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SalesByRateSchedulesTableTransformer.add_axis_to_total_table_rows">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_axis_to_total_table_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add total to the axis column for rows from the total table.</span>

<span class="sd">        Because we&#39;re adding the</span>
<span class="sd">        sales_of_electricity_by_rate_schedules_account_totals_304 table into the mix,</span>
<span class="sd">        we have a bunch of total values that get mixed in with all the _billed columns</span>
<span class="sd">        from the individual tables. If left alone, these totals aren&#39;t labeled in any</span>
<span class="sd">        way because they don&#39;t have the same _axis columns explaining what each of the</span>
<span class="sd">        values are. In order to distinguish them from the rest of the sub-total data we</span>
<span class="sd">        use this function to create an _axis value for them noting that they are totals.</span>

<span class="sd">        It&#39;s worth noting that there are also some total values in there already.</span>
<span class="sd">        Those would be hard to clean. The idea is that if you want the actual totals,</span>
<span class="sd">        don&#39;t try and sum the sub-components, look at the actual labeled total rows.</span>

<span class="sd">        This function relies on the ``sched_table_name`` column, so it must be called</span>
<span class="sd">        before that gets dropped.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: The sales table with a ``sched_table_name`` column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Labeling total values.&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sched_table_name&quot;</span><span class="p">]</span>
            <span class="o">==</span> <span class="s2">&quot;sales_of_electricity_by_rate_schedules_account_totals_304&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;sales_axis&quot;</span><span class="p">,</span> <span class="s2">&quot;rate_schedule_description&quot;</span><span class="p">],</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;total&quot;</span>
        <span class="k">return</span> <span class="n">df</span></div>


    <span class="nd">@cache_df</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="SalesByRateSchedulesTableTransformer.process_xbrl">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.SalesByRateSchedulesTableTransformer.process_xbrl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_xbrl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">raw_xbrl_instant</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">raw_xbrl_duration</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename columns before running wide_to_tidy.&quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">: Processing XBRL data pre-concatenation.&quot;</span><span class="p">)</span>
        <span class="n">instant_xbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_instant_xbrl</span><span class="p">(</span><span class="n">raw_xbrl_instant</span><span class="p">)</span>
        <span class="n">duration_xbrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_duration_xbrl</span><span class="p">(</span><span class="n">raw_xbrl_duration</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_instant_and_duration_tables_xbrl</span><span class="p">(</span><span class="n">instant_xbrl</span><span class="p">,</span> <span class="n">duration_xbrl</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">,</span> <span class="n">rename_stage</span><span class="o">=</span><span class="s2">&quot;xbrl&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combine_axis_columns_xbrl</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_axis_to_total_table_rows</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wide_to_tidy</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_record_id</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assign_utility_id_ferc1</span><span class="p">,</span> <span class="n">source_ferc1</span><span class="o">=</span><span class="n">SourceFerc1</span><span class="o">.</span><span class="n">XBRL</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OtherRegulatoryLiabilitiesTableTransformer">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OtherRegulatoryLiabilitiesTableTransformer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OtherRegulatoryLiabilitiesTableTransformer</span><span class="p">(</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transformer class for :ref:`core_ferc1__yearly_other_regulatory_liabilities_sched278` table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="OtherRegulatoryLiabilitiesTableTransformer.table_id">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OtherRegulatoryLiabilitiesTableTransformer.table_id">[docs]</a>
    <span class="n">table_id</span><span class="p">:</span> <span class="n">TableIdFerc1</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="o">.</span><span class="n">OTHER_REGULATORY_LIABILITIES</span></div>

<div class="viewcode-block" id="OtherRegulatoryLiabilitiesTableTransformer.has_unique_record_ids">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.OtherRegulatoryLiabilitiesTableTransformer.has_unique_record_ids">[docs]</a>
    <span class="n">has_unique_record_ids</span> <span class="o">=</span> <span class="kc">False</span></div>
</div>



<div class="viewcode-block" id="FERC1_TFR_CLASSES">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.FERC1_TFR_CLASSES">[docs]</a>
<span class="n">FERC1_TFR_CLASSES</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">[</span><span class="n">Ferc1AbstractTableTransformer</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;core_ferc1__yearly_steam_plants_fuel_sched402&quot;</span><span class="p">:</span> <span class="n">SteamPlantsFuelTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_steam_plants_sched402&quot;</span><span class="p">:</span> <span class="n">SteamPlantsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_small_plants_sched410&quot;</span><span class="p">:</span> <span class="n">SmallPlantsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_hydroelectric_plants_sched406&quot;</span><span class="p">:</span> <span class="n">HydroelectricPlantsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_plant_in_service_sched204&quot;</span><span class="p">:</span> <span class="n">PlantInServiceTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_pumped_storage_plants_sched408&quot;</span><span class="p">:</span> <span class="n">PumpedStoragePlantsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_transmission_lines_sched422&quot;</span><span class="p">:</span> <span class="n">TransmissionLinesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_purchased_power_and_exchanges_sched326&quot;</span><span class="p">:</span> <span class="n">PurchasedPowerAndExchangesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_energy_sources_sched401&quot;</span><span class="p">:</span> <span class="n">EnergySourcesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_energy_dispositions_sched401&quot;</span><span class="p">:</span> <span class="n">EnergyDispositionsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_utility_plant_summary_sched200&quot;</span><span class="p">:</span> <span class="n">UtilityPlantSummaryTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_operating_expenses_sched320&quot;</span><span class="p">:</span> <span class="n">OperatingExpensesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_balance_sheet_liabilities_sched110&quot;</span><span class="p">:</span> <span class="n">BalanceSheetLiabilitiesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_depreciation_summary_sched336&quot;</span><span class="p">:</span> <span class="n">DepreciationSummaryTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_balance_sheet_assets_sched110&quot;</span><span class="p">:</span> <span class="n">BalanceSheetAssetsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_income_statements_sched114&quot;</span><span class="p">:</span> <span class="n">IncomeStatementsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_depreciation_changes_sched219&quot;</span><span class="p">:</span> <span class="n">DepreciationChangesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_depreciation_by_function_sched219&quot;</span><span class="p">:</span> <span class="n">DepreciationByFunctionTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_retained_earnings_sched118&quot;</span><span class="p">:</span> <span class="n">RetainedEarningsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_operating_revenues_sched300&quot;</span><span class="p">:</span> <span class="n">OperatingRevenuesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_cash_flows_sched120&quot;</span><span class="p">:</span> <span class="n">CashFlowsTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_sales_by_rate_schedules_sched304&quot;</span><span class="p">:</span> <span class="n">SalesByRateSchedulesTableTransformer</span><span class="p">,</span>
    <span class="s2">&quot;core_ferc1__yearly_other_regulatory_liabilities_sched278&quot;</span><span class="p">:</span> <span class="n">OtherRegulatoryLiabilitiesTableTransformer</span><span class="p">,</span>
<span class="p">}</span></div>



<div class="viewcode-block" id="ferc1_transform_asset_factory">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ferc1_transform_asset_factory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ferc1_transform_asset_factory</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">tfr_class</span><span class="p">:</span> <span class="n">Ferc1AbstractTableTransformer</span><span class="p">,</span>
    <span class="n">io_manager_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pudl_io_manager&quot;</span><span class="p">,</span>
    <span class="n">convert_dtypes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">generic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssetsDefinition</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an asset that pulls in raw ferc Form 1 assets and applies transformations.</span>

<span class="sd">    This is a convenient way to create assets for tables that only depend on raw dbf,</span>
<span class="sd">    raw xbrl instant and duration tables and xbrl metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: The name of the table to create an asset for.</span>
<span class="sd">        tfr_class: A transformer class corresponding to the table_name.</span>
<span class="sd">        io_manager_key: the dagster io_manager key to use. None defaults</span>
<span class="sd">            to the fs_io_manager.</span>
<span class="sd">        convert_dtypes: convert dtypes of transformed dataframes.</span>
<span class="sd">        generic: If using GenericPlantFerc1TableTransformer pass table_id to constructor.</span>

<span class="sd">    Return:</span>
<span class="sd">        An asset for the clean table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ins</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AssetIn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">listify</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>  <span class="c1"># noqa: E731</span>
    <span class="n">dbf_tables</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">TABLE_NAME_MAP_FERC1</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;dbf&quot;</span><span class="p">])</span>
    <span class="n">xbrl_tables</span> <span class="o">=</span> <span class="n">listify</span><span class="p">(</span><span class="n">TABLE_NAME_MAP_FERC1</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;xbrl&quot;</span><span class="p">])</span>

    <span class="n">ins</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;raw_ferc1_dbf__</span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;raw_ferc1_dbf__</span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">dbf_tables</span><span class="p">}</span>
    <span class="n">ins</span> <span class="o">|=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;raw_ferc1_xbrl__</span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">_instant&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;raw_ferc1_xbrl__</span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">_instant&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">xbrl_tables</span>
    <span class="p">}</span>
    <span class="n">ins</span> <span class="o">|=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;raw_ferc1_xbrl__</span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">_duration&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;raw_ferc1_xbrl__</span><span class="si">{</span><span class="n">tn</span><span class="si">}</span><span class="s2">_duration&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">xbrl_tables</span>
    <span class="p">}</span>
    <span class="n">ins</span><span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AssetIn</span><span class="p">(</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">)</span>

    <span class="n">table_id</span> <span class="o">=</span> <span class="n">TableIdFerc1</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">ins</span><span class="o">=</span><span class="n">ins</span><span class="p">,</span> <span class="n">io_manager_key</span><span class="o">=</span><span class="n">io_manager_key</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ferc1_transform_asset</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform a FERC Form 1 table.</span>

<span class="sd">        Args:</span>
<span class="sd">            raw_dbf: raw dbf table.</span>
<span class="sd">            raw_xbrl_instant: raw XBRL instant table.</span>
<span class="sd">            raw_xbrl_duration: raw XBRL duration table.</span>
<span class="sd">            _core_ferc1_xbrl__metadata_json: XBRL metadata json for all tables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            transformed FERC Form 1 table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: split the key by __, then groupby, then concatenate</span>
        <span class="n">_core_ferc1_xbrl__metadata_json</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generic</span><span class="p">:</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">tfr_class</span><span class="p">(</span>
                <span class="n">xbrl_metadata_json</span><span class="o">=</span><span class="n">_core_ferc1_xbrl__metadata_json</span><span class="p">[</span><span class="n">table_name</span><span class="p">],</span>
                <span class="n">table_id</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transformer</span> <span class="o">=</span> <span class="n">tfr_class</span><span class="p">(</span>
                <span class="n">xbrl_metadata_json</span><span class="o">=</span><span class="n">_core_ferc1_xbrl__metadata_json</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">raw_dbf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;raw_ferc1_dbf__&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">raw_xbrls</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">tn</span><span class="p">:</span> <span class="n">filter_for_freshest_data_xbrl</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">get_primary_key_raw_xbrl</span><span class="p">(</span><span class="n">tn</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;raw_ferc1_xbrl__&quot;</span><span class="p">),</span> <span class="s2">&quot;ferc1&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">tn</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;raw_ferc1_xbrl__&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">raw_xbrl_table_name</span> <span class="ow">in</span> <span class="n">listify</span><span class="p">(</span><span class="n">TABLE_NAME_MAP_FERC1</span><span class="p">[</span><span class="n">table_name</span><span class="p">][</span><span class="s2">&quot;xbrl&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">raw_xbrls</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;raw_ferc1_xbrl__</span><span class="si">{</span><span class="n">raw_xbrl_table_name</span><span class="si">}</span><span class="s2">_instant&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span>
                <span class="ow">and</span> <span class="n">raw_xbrls</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;raw_ferc1_xbrl__</span><span class="si">{</span><span class="n">raw_xbrl_table_name</span><span class="si">}</span><span class="s2">_duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">raw_xbrl_table_name</span><span class="si">}</span><span class="s2"> has neither instant nor duration tables. &quot;</span>
                    <span class="s2">&quot;Is it spelled correctly in pudl.extract.ferc1.TABLE_NAME_MAP_FERC1&quot;</span>
                <span class="p">)</span>
        <span class="n">raw_xbrl_instant</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">raw_xbrls</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_instant&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">raw_xbrl_duration</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">df</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">raw_xbrls</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_duration&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">raw_dbf</span><span class="o">=</span><span class="n">raw_dbf</span><span class="p">,</span>
            <span class="n">raw_xbrl_instant</span><span class="o">=</span><span class="n">raw_xbrl_instant</span><span class="p">,</span>
            <span class="n">raw_xbrl_duration</span><span class="o">=</span><span class="n">raw_xbrl_duration</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">convert_dtypes</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">convert_cols_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">data_source</span><span class="o">=</span><span class="s2">&quot;ferc1&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">return</span> <span class="n">ferc1_transform_asset</span></div>



<div class="viewcode-block" id="create_ferc1_transform_assets">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.create_ferc1_transform_assets">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_ferc1_transform_assets</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AssetsDefinition</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a list of transformed FERC Form 1 assets.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of AssetsDefinitions where each asset is a clean ferc form 1 table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">tfr_class</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">assets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ferc1_transform_asset_factory</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">tfr_class</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">assets</span></div>



<div class="viewcode-block" id="ferc1_assets">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.ferc1_assets">[docs]</a>
<span class="n">ferc1_assets</span> <span class="o">=</span> <span class="n">create_ferc1_transform_assets</span><span class="p">()</span></div>


<span class="c1">##########################################</span>
<span class="c1"># Post-core tables/XBLR Calculations Stuff</span>
<span class="c1">##########################################</span>


<div class="viewcode-block" id="other_dimensions">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.other_dimensions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">other_dimensions</span><span class="p">(</span><span class="n">table_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of the other dimension columns across all of the transformers.&quot;&quot;&quot;</span>
    <span class="c1"># grab all of the dimensions columns that we are currently verifying as a part of</span>
    <span class="c1"># reconcile_table_calculations</span>
    <span class="k">return</span> <span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">dedupe_n_flatten_list_of_lists</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">FERC1_TFR_CLASSES</span><span class="p">[</span><span class="n">table_name</span><span class="p">]()</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dimension_columns</span>
            <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">table_names</span>
        <span class="p">]</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="table_to_xbrl_factoid_name">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.table_to_xbrl_factoid_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">table_to_xbrl_factoid_name</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a dictionary of table name (keys) to ``xbrl_factoid`` column name.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="n">transformer</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">xbrl_factoid_name</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">transformer</span><span class="p">)</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="table_to_column_to_check">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.table_to_column_to_check">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">table_to_column_to_check</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a dictionary of table name (keys) to column_to_check from reconcile_table_calculations.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="n">transformer</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">column_to_check</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">transformer</span><span class="p">)</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">transformer</span><span class="p">()</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">reconcile_table_calculations</span><span class="o">.</span><span class="n">column_to_check</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="remove_rare_utility_type_subdimensions_rows">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.remove_rare_utility_type_subdimensions_rows">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_rare_utility_type_subdimensions_rows</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the rare, non-total utility types when all values are duplicated.</span>

<span class="sd">    We remove the records of non-total utility_type&#39;s for xbrl_factoid&#39;s when almost</span>
<span class="sd">    all instances of that xbrl_factoid show up with just a utility_type of &quot;total&quot;. We</span>
<span class="sd">    can only do this confidently because we also check that all of the dollar_value in</span>
<span class="sd">    those records are exactly the same as the corresponding records with utility_type</span>
<span class="sd">    of &quot;total&quot; or the non-total utility_type&#39;s have null dollar_value&#39;s.</span>

<span class="sd">    This data isn&#39;t incorrect, it just interferes with how we process the calculations</span>
<span class="sd">    embedded within these tables. This is why we are applying this within</span>
<span class="sd">    :func:`_core_ferc1__table_dimensions` because that is what we use to build the</span>
<span class="sd">    calculation components table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># made these variables so we could generalize to other tables if we desired that.</span>
    <span class="n">xbrl_factoid</span> <span class="o">=</span> <span class="s2">&quot;xbrl_factoid&quot;</span>
    <span class="n">dimension_col</span> <span class="o">=</span> <span class="s2">&quot;utility_type&quot;</span>
    <span class="n">money_col</span> <span class="o">=</span> <span class="s2">&quot;dollar_value&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">,</span> <span class="n">xbrl_factoid</span><span class="p">]</span>

    <span class="c1"># first we need to find the xbrl_factoid&#39;s where there are mostly only totals</span>
    <span class="c1"># within the dimension_col. Which is to say there are a few rare non-total</span>
    <span class="c1"># utility_type&#39;s.</span>
    <span class="n">tot_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">dimension_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span>
    <span class="c1"># build a dataframe of xbrl_factoid&#39;s with a column for the count of the records</span>
    <span class="c1"># with utility_type total and another column with the count for all the other</span>
    <span class="c1"># utility_type&#39;s</span>
    <span class="n">dimension_value_count</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tot_mask</span><span class="p">,</span> <span class="n">xbrl_factoid</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()),</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">tot_mask</span><span class="p">,</span> <span class="n">xbrl_factoid</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()),</span>
        <span class="n">on</span><span class="o">=</span><span class="n">xbrl_factoid</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_total&quot;</span><span class="p">,</span> <span class="s2">&quot;_other&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># With that little xbrl_factoid count dataframe we can check to see which</span>
    <span class="c1"># xbrl_factoid&#39;s are almost entriely total. In order to id these &quot;rare&quot;</span>
    <span class="c1"># non-totals we use a threshold of 20% here. meaning only 20% of the instances</span>
    <span class="c1"># of the utility_type for a particular xbrl_factoid were non-totals.</span>
    <span class="c1"># that&#39;s a little bit arbitrary... This was tested up to 40% but that seems</span>
    <span class="c1"># too aggressive.</span>
    <span class="n">mostly_total_xbrl_factoids</span> <span class="o">=</span> <span class="n">dimension_value_count</span><span class="p">[</span>
        <span class="n">dimension_value_count</span><span class="o">.</span><span class="n">count_other</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
        <span class="o">&amp;</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">dimension_value_count</span><span class="o">.</span><span class="n">count_other</span>
                <span class="o">/</span> <span class="p">(</span>
                    <span class="n">dimension_value_count</span><span class="o">.</span><span class="n">count_other</span>
                    <span class="o">+</span> <span class="n">dimension_value_count</span><span class="o">.</span><span class="n">count_total</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">&lt;</span> <span class="mf">0.20</span>
        <span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mostly_total_xbrl_factoids</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">xbrl_factoid</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of the &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;xbrl_factoid&#39;s in this table have </span><span class="si">{</span><span class="n">dimension_col</span><span class="si">}</span><span class="s2"> values that are mostly total, &quot;</span>
        <span class="s2">&quot;but have some rare instances of non-total values.&quot;</span>
    <span class="p">)</span>
    <span class="c1"># add a utility type count column. Because we only care about this when there</span>
    <span class="c1"># are more than one util type</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;util_type_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">idx</span><span class="p">)[[</span><span class="n">dimension_col</span><span class="p">]]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">mostly_totals_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">xbrl_factoid</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">[</span><span class="n">fact</span> <span class="k">for</span> <span class="n">fact</span> <span class="ow">in</span> <span class="n">mostly_total_xbrl_factoids</span> <span class="k">if</span> <span class="s2">&quot;correction&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fact</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">util_type_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Now we&#39;ve ID-ed what we probably want to drop. But we have to check to see if there</span>
    <span class="c1"># are records in here that contain unique values in these rare non-total columns.</span>
    <span class="n">mostly_totals_idx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mostly_totals_mask</span><span class="p">,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
    <span class="p">)</span>
    <span class="n">mixed_typed_income</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mostly_totals_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="c1"># first remove the records with null non-total records</span>
    <span class="n">maybe_unique</span> <span class="o">=</span> <span class="n">mixed_typed_income</span><span class="p">[</span>
        <span class="o">~</span><span class="p">(</span>
            <span class="p">(</span><span class="n">mixed_typed_income</span><span class="p">[</span><span class="n">dimension_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">mixed_typed_income</span><span class="p">[</span><span class="n">money_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span>
            <span class="n">actually_unique</span> <span class="o">:=</span> <span class="n">maybe_unique</span><span class="p">[</span>
                <span class="o">~</span><span class="n">maybe_unique</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">idx</span> <span class="o">+</span> <span class="p">[</span><span class="n">money_col</span><span class="p">])</span>
                <span class="c1"># bc we removed some of the null non-totals we&#39;ve gotta leave out the</span>
                <span class="c1"># total&#39;s here</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">maybe_unique</span><span class="p">[</span><span class="n">dimension_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="o">&gt;</span> <span class="mi">4</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Ah we found actually unique values within the records with xbrl_factoid&#39;s &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;that have rare non-total </span><span class="si">{</span><span class="n">dimension_col</span><span class="si">}</span><span class="s2"> when we expected only 4 records&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;:</span><span class="se">\n</span><span class="si">{</span><span class="n">actually_unique</span><span class="si">}</span><span class="se">\n</span><span class="s2">This breaks out logic we use to feel confident about &quot;</span>
            <span class="s2">&quot;removing these records in favor of keeping only the utility_type == total records.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Now that we&#39;ve affirmed that we feel confident dropping these rare non-total</span>
    <span class="c1"># records... drop them!</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">mostly_totals_mask</span><span class="p">],</span>
            <span class="n">mixed_typed_income</span><span class="p">[</span><span class="n">mixed_typed_income</span><span class="p">[</span><span class="n">dimension_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span></div>



<span class="nd">@asset</span><span class="p">(</span>
    <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span>
        <span class="k">if</span> <span class="n">table_name</span> <span class="o">!=</span> <span class="s2">&quot;plants_steam_ferc1&quot;</span>
    <span class="p">}</span>
<span class="p">)</span>
<div class="viewcode-block" id="_core_ferc1__table_dimensions">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._core_ferc1__table_dimensions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_core_ferc1__table_dimensions</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a table of values of dimensions observed in the transformed data tables.</span>

<span class="sd">    Compile a dataframe indicating what distinct values are observed in the data for</span>
<span class="sd">    each dimension column in association with each unique combination of ``table_name``</span>
<span class="sd">    and ``xbrl_factoid``. E.g. for all factoids found in the</span>
<span class="sd">    :ref:`core_ferc1__yearly_depreciation_by_function_sched219` table,</span>
<span class="sd">    the only value observed for ``utility_type`` is ``electric`` and the values observed</span>
<span class="sd">    for ``plant_status`` include: ``future``, ``in_service``, ``leased`` and ``total``.</span>

<span class="sd">    We need to include the ``xbrl_factoid`` column because these dimensions can differ</span>
<span class="sd">    based on the ``xbrl_factoid``. So we first rename all of the columns which</span>
<span class="sd">    contain the ``xbrl_factoid`` using :func:`table_to_xbrl_factoid_name` rename</span>
<span class="sd">    dictionary. Then we concatenate all of the tables together and drop duplicates so</span>
<span class="sd">    we have unique instances of observed ``table_name`` and ``xbrl_factoid`` and the</span>
<span class="sd">    other dimension columns found in :func:`other_dimensions`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table_to_xbrl_factoid_name_dict</span> <span class="o">=</span> <span class="n">table_to_xbrl_factoid_name</span><span class="p">()</span>
    <span class="n">tbls</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">table_to_xbrl_factoid_name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">tbls</span><span class="p">[</span><span class="s2">&quot;core_ferc1__yearly_income_statements_sched114&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">remove_rare_utility_type_subdimensions_rows</span><span class="p">(</span>
            <span class="n">tbls</span><span class="p">[</span><span class="s2">&quot;core_ferc1__yearly_income_statements_sched114&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tbls</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span>
            <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">other_dimensions</span><span class="p">(</span><span class="n">table_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Since we&#39;ve converted the XBRL factoid columns into categoricals in the</span>
    <span class="c1"># transformation of the core tables, we should ensure that the XBRL factoid</span>
    <span class="c1"># column is a string as expected, rather than an object. We do this manually,</span>
    <span class="c1"># as this table doesn&#39;t have a defined schema.</span>
    <span class="k">return</span> <span class="n">dimensions</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span></div>



<span class="nd">@asset</span><span class="p">(</span>
    <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">),</span>
        <span class="s2">&quot;_core_ferc1__table_dimensions&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="s2">&quot;_core_ferc1__table_dimensions&quot;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">io_manager_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Change to sqlite_io_manager...</span>
<span class="p">)</span>
<div class="viewcode-block" id="_core_ferc1_xbrl__metadata">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._core_ferc1_xbrl__metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_core_ferc1_xbrl__metadata</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a table of all of the tables&#39; XBRL metadata.&quot;&quot;&quot;</span>
    <span class="n">_core_ferc1_xbrl__metadata_json</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">]</span>
    <span class="n">_core_ferc1__table_dimensions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1__table_dimensions&quot;</span><span class="p">]</span>
    <span class="n">tbl_metas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">trans</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">tbl_meta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">trans</span><span class="p">(</span><span class="n">xbrl_metadata_json</span><span class="o">=</span><span class="n">_core_ferc1_xbrl__metadata_json</span><span class="p">[</span><span class="n">table_name</span><span class="p">])</span>
            <span class="o">.</span><span class="n">xbrl_metadata</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;xbrl_factoid_original&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tbl_metas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl_meta</span><span class="p">)</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">other_dimensions</span><span class="p">(</span><span class="n">table_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="p">))</span>
    <span class="n">metadata_all</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tbl_metas</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">make_xbrl_factoid_dimensions_explicit</span><span class="p">,</span>
            <span class="n">table_dimensions_ferc1</span><span class="o">=</span><span class="n">_core_ferc1__table_dimensions</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">metadata_all</span></div>



<span class="nd">@asset</span><span class="p">(</span>
    <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">),</span>
        <span class="s2">&quot;_core_ferc1__table_dimensions&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="s2">&quot;_core_ferc1__table_dimensions&quot;</span><span class="p">),</span>
        <span class="s2">&quot;_core_ferc1_xbrl__metadata&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="s2">&quot;_core_ferc1_xbrl__metadata&quot;</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="n">io_manager_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Change to sqlite_io_manager...</span>
<span class="p">)</span>
<div class="viewcode-block" id="_core_ferc1_xbrl__calculation_components">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._core_ferc1_xbrl__calculation_components">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_core_ferc1_xbrl__calculation_components</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create calculation-component table from table-level metadata.&quot;&quot;&quot;</span>
    <span class="n">_core_ferc1_xbrl__metadata_json</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__metadata_json&quot;</span><span class="p">]</span>
    <span class="n">_core_ferc1__table_dimensions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1__table_dimensions&quot;</span><span class="p">]</span>
    <span class="n">_core_ferc1_xbrl__metadata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__metadata&quot;</span><span class="p">]</span>
    <span class="c1"># compile all of the calc comp tables.</span>
    <span class="n">calc_metas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">transformer</span> <span class="ow">in</span> <span class="n">FERC1_TFR_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">calc_meta</span> <span class="o">=</span> <span class="n">transformer</span><span class="p">(</span>
            <span class="n">xbrl_metadata_json</span><span class="o">=</span><span class="n">_core_ferc1_xbrl__metadata_json</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">xbrl_calculations</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span>
        <span class="n">calc_metas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calc_meta</span><span class="p">)</span>
    <span class="c1"># squish all of the calc comp tables then add in the implicit table dimensions</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">other_dimensions</span><span class="p">(</span><span class="n">table_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="p">))</span>
    <span class="n">calc_components</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">calc_metas</span><span class="p">)</span>
        <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">dim</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">()</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">})</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">make_xbrl_factoid_dimensions_explicit</span><span class="p">,</span>
            <span class="n">_core_ferc1__table_dimensions</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">assign_parent_dimensions</span><span class="p">,</span>
            <span class="n">table_dimensions</span><span class="o">=</span><span class="n">_core_ferc1__table_dimensions</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">infer_intra_factoid_totals</span><span class="p">,</span>
            <span class="n">meta_w_dims</span><span class="o">=</span><span class="n">_core_ferc1_xbrl__metadata</span><span class="p">,</span>
            <span class="n">table_dimensions</span><span class="o">=</span><span class="n">_core_ferc1__table_dimensions</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">add_calculation_component_corrections</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">child_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span>
    <span class="n">calc_cols</span> <span class="o">=</span> <span class="n">child_cols</span> <span class="o">+</span> <span class="n">dimensions</span>
    <span class="n">calc_and_parent_cols</span> <span class="o">=</span> <span class="n">calc_cols</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">calc_cols</span><span class="p">]</span>

    <span class="c1"># Defensive testing on this table!</span>
    <span class="k">assert</span> <span class="n">calc_components</span><span class="p">[[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="c1"># Let&#39;s check that all calculated components that show up in our data are</span>
    <span class="c1"># getting calculated.</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_calcs_vs_table</span><span class="p">(</span>
        <span class="n">calcs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">checked_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">idx_calcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">idx_table</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">how</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;not_in&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">calcs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_calcs</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span>
                <span class="n">checked_table</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_table</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;not_in&quot;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">calcs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_calcs</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span>
                <span class="n">checked_table</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_table</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
            <span class="p">)</span>
        <span class="n">calcs_vs_table</span> <span class="o">=</span> <span class="n">calcs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx_calcs</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">calcs_vs_table</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># which calculations are missing from the metadata table?</span>
    <span class="c1"># ignore the corrections bc they are weird</span>
    <span class="n">missing_calcs</span> <span class="o">=</span> <span class="n">check_calcs_vs_table</span><span class="p">(</span>
        <span class="n">calcs</span><span class="o">=</span><span class="n">calc_components</span><span class="p">[</span>
            <span class="n">calc_components</span><span class="o">.</span><span class="n">table_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">calc_components</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_correction&quot;</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="n">checked_table</span><span class="o">=</span><span class="n">_core_ferc1_xbrl__metadata</span><span class="p">,</span>
        <span class="n">idx_calcs</span><span class="o">=</span><span class="n">calc_cols</span><span class="p">,</span>
        <span class="n">idx_table</span><span class="o">=</span><span class="n">calc_cols</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;not_in&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># ensure that none of the calculation components that are missing from the metadata</span>
    <span class="c1"># table are from any of the exploded tables.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_calcs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Calculations found in calculation components table are missing from the &quot;</span>
            <span class="s2">&quot;_core_ferc1_xbrl__metadata table.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># which of these missing calculations actually show up in the transformed tables?</span>
        <span class="c1"># This handles dbf-only calculation components, which are added to the</span>
        <span class="c1"># _core_ferc1_xbrl__metadata table as part of each table&#39;s transformations but aren&#39;t</span>
        <span class="c1"># observed (or therefore present in _core_ferc1__table_dimensions) in the fast ETL or</span>
        <span class="c1"># in all subsets of years. We only want to flag calculation components as</span>
        <span class="c1"># missing when they&#39;re actually observed in the data.</span>
        <span class="n">actually_missing_kids</span> <span class="o">=</span> <span class="n">check_calcs_vs_table</span><span class="p">(</span>
            <span class="n">calcs</span><span class="o">=</span><span class="n">missing_calcs</span><span class="p">,</span>
            <span class="n">checked_table</span><span class="o">=</span><span class="n">_core_ferc1__table_dimensions</span><span class="p">,</span>
            <span class="n">idx_calcs</span><span class="o">=</span><span class="n">child_cols</span><span class="p">,</span>
            <span class="n">idx_table</span><span class="o">=</span><span class="n">child_cols</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">actually_missing_kids</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_calcs</span><span class="p">)</span><span class="si">}</span><span class="s2"> missing calculation components observed in transformed FERC1 data.&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">actually_missing_kids</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found missing calculations from the exploded tables:</span><span class="se">\n</span><span class="si">{</span><span class="n">actually_missing_kids</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">check_for_calc_components_duplicates</span><span class="p">(</span>
        <span class="n">calc_components</span><span class="p">,</span>
        <span class="n">table_names_known_dupes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;core_ferc1__yearly_sales_by_rate_schedules_sched304&quot;</span><span class="p">],</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">calc_and_parent_cols</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># check for parent/child duplicates. again need to remove the</span>
    <span class="c1"># core_ferc1__yearly_sales_by_rate_schedules_sched304 table. Null hack bc comparing pandas</span>
    <span class="c1"># nulls</span>
    <span class="n">self_refs_mask</span> <span class="o">=</span> <span class="n">calc_components</span><span class="p">[</span><span class="n">calc_and_parent_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;NULL HACK&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">calc_cols</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="n">calc_components</span><span class="o">.</span><span class="n">table_name</span>
        <span class="o">!=</span> <span class="s2">&quot;core_ferc1__yearly_sales_by_rate_schedules_sched304&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">parent_child_dupes</span> <span class="o">:=</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">self_refs_mask</span><span class="p">])</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_child_dupes</span><span class="p">)</span><span class="si">}</span><span class="s2"> calculations where the parent and child &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;columns are identical and expected 0.</span><span class="se">\n</span><span class="si">{</span><span class="n">parent_child_dupes</span><span class="si">=}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="n">unexpected_totals</span> <span class="o">:=</span> <span class="n">unexpected_total_components</span><span class="p">(</span>
            <span class="n">calc_components</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">(),</span> <span class="n">dimensions</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found unexpected total records: </span><span class="si">{</span><span class="n">unexpected_totals</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Remove convert_dtypes() once we&#39;re writing to the DB using enforce_schema()</span>
    <span class="k">return</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">convert_dtypes</span><span class="p">()</span></div>



<div class="viewcode-block" id="unexpected_total_components">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.unexpected_total_components">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unexpected_total_components</span><span class="p">(</span>
    <span class="n">calc_comps</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find unexpected components in within-fact total calculations.</span>

<span class="sd">    This doesn&#39;t check anything about the calcs we get from the metadata, we</span>
<span class="sd">    are only looking at within-fact totals which we&#39;ve added ourselves.</span>

<span class="sd">    Finds calculation relationships where:</span>

<span class="sd">    - child components that do not match with parent in non-total dimensions.</span>

<span class="sd">      - For example, if utility_type_parent is not &quot;total&quot;, then utility_type</span>
<span class="sd">        must be the same as utility_type_parent.</span>

<span class="sd">    - child components, that share table_name/xbrl_factoid with their parent,</span>
<span class="sd">      that have &quot;total&quot; for any dimension - these should be represented by</span>
<span class="sd">      *their* child components</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_comps: calculation component join table</span>
<span class="sd">        dimensions: list of dimensions we resolved &quot;total&quot; values for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parent_dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">]</span>
    <span class="n">totals_mask</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">calc_comps</span><span class="p">[</span><span class="n">parent_dimensions</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">calc_comps</span><span class="p">[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">calc_comps</span><span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">])</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">calc_comps</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">calc_comps</span><span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">calcs_with_totals</span> <span class="o">=</span> <span class="n">calc_comps</span><span class="p">[</span><span class="n">totals_mask</span><span class="p">]</span>

    <span class="n">unexpected_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">child_dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
        <span class="n">mismatched_non_total</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">calcs_with_totals</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">child_dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">calcs_with_totals</span><span class="p">[</span><span class="n">child_dim</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">calcs_with_totals</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">child_dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span>
        <span class="n">children_with_totals</span> <span class="o">=</span> <span class="n">calcs_with_totals</span><span class="p">[</span><span class="n">child_dim</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span>
        <span class="n">unexpected_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">calcs_with_totals</span><span class="p">[</span><span class="n">mismatched_non_total</span> <span class="o">|</span> <span class="n">children_with_totals</span><span class="p">][</span>
                <span class="p">[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">parent_dimensions</span>
                <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">dimensions</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">unexpected_links</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_for_calc_components_duplicates">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.check_for_calc_components_duplicates">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_for_calc_components_duplicates</span><span class="p">(</span>
    <span class="n">calc_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">table_names_known_dupes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for duplicates calculation records.</span>

<span class="sd">    We need to remove the core_ferc1__yearly_sales_by_rate_schedules_sched304 bc there are</span>
<span class="sd">    duplicate renamed factoids in that table (originally billed/unbilled).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">calc_components_test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">calc_components</span><span class="p">[</span>
            <span class="o">~</span><span class="n">calc_components</span><span class="o">.</span><span class="n">table_name_parent</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">table_names_known_dupes</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">calc_components_test</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found duplicates based on </span><span class="si">{</span><span class="n">idx</span><span class="si">=}</span><span class="s2"> when expected none.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">calc_components_test</span><span class="p">[</span><span class="n">calc_components_test</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="make_xbrl_factoid_dimensions_explicit">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.make_xbrl_factoid_dimensions_explicit">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_xbrl_factoid_dimensions_explicit</span><span class="p">(</span>
    <span class="n">df_w_xbrl_factoid</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">table_dimensions_ferc1</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">parent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill in null dimensions w/ the values observed in :func:`_core_ferc1__table_dimensions`.</span>

<span class="sd">    In the raw XBRL metadata&#39;s calculations, there is an implicit assumption that</span>
<span class="sd">    calculated values are aggregated within categorical columns called Axes or</span>
<span class="sd">    dimensions, in addition to being grouped by date, utility, table, and fact. The</span>
<span class="sd">    dimensions and their values don&#39;t need to be specified explicitly in the calculation</span>
<span class="sd">    components because the same calculation is assumed to apply in all cases.</span>

<span class="sd">    We have extended this calculation system to allow independent calculations to be</span>
<span class="sd">    specified for different values within a given dimension. For example, the</span>
<span class="sd">    :ref:`core_ferc1__yearly_utility_plant_summary_sched200` table contains records with a variety of</span>
<span class="sd">    different ``utility_type`` values (gas, electric, etc.). For many combinations of</span>
<span class="sd">    fact and ``utility_type``, no more detailed information about the source of the data</span>
<span class="sd">    is available, but for some, and only in the case of electric utilities, much more</span>
<span class="sd">    detail can be found in the :ref:`core_ferc1__yearly_plant_in_service_sched204` table.</span>
<span class="sd">    In order to use this additional information when it is available, we sometimes</span>
<span class="sd">    explicitly specify different calculations for different values of additional</span>
<span class="sd">    dimension columns.</span>

<span class="sd">    This function uses the observed associations between ``table_name``,</span>
<span class="sd">    ``xbrl_factoid`` and the other dimension columns compiled by</span>
<span class="sd">    :func:`_core_ferc1__table_dimensions` to fill in missing (previously implied) dimension</span>
<span class="sd">    values in the calculation components table.</span>

<span class="sd">    This is often a broadcast merge because many tables contain many values within these</span>
<span class="sd">    dimension columns, so it is expected that new calculation component table will have</span>
<span class="sd">    many more records than the input calculation components table.</span>

<span class="sd">    Any dimension that was already specified in the calculation fixes will be left</span>
<span class="sd">    unchanged. If no value of a particular dimension has ever been observed in</span>
<span class="sd">    association with a given combination of ``table_name`` and ``xbrl_factoid`` it will</span>
<span class="sd">    remain null.</span>

<span class="sd">    Args:</span>
<span class="sd">        calculation_components: a table of calculation component records which have had</span>
<span class="sd">            some manual calculation fixes applied.</span>
<span class="sd">        table_dimensions_ferc1: table with all observed values of</span>
<span class="sd">            :func:`other_dimensions` for each ``table_name`` and ``xbrl_factoid``</span>
<span class="sd">        dimensions: list of dimension columns to check.</span>
<span class="sd">        parent: boolean to indicate whether or not the dimensions to be added are</span>
<span class="sd">            the parental dimensions or the child dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="n">dimensions</span><span class="si">=}</span><span class="s2"> into calculation component table.&quot;</span><span class="p">)</span>
    <span class="n">df_w_dims</span> <span class="o">=</span> <span class="n">df_w_xbrl_factoid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">on_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
        <span class="n">table_dimensions_ferc1</span> <span class="o">=</span> <span class="n">table_dimensions_ferc1</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">on_cols</span><span class="p">}</span>
            <span class="o">|</span> <span class="p">{</span><span class="n">dim</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">on_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">on_cols</span><span class="p">]</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">]</span>
    <span class="c1"># for each dimension, use split/apply/combine. when there are no dims explicit in</span>
    <span class="c1"># the calc components, merge in all of the dims.</span>
    <span class="k">for</span> <span class="n">dim_col</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
        <span class="c1"># extract the unique observed instances of this one dimension column &amp; add the</span>
        <span class="c1"># _calc suffix so we can merge onto the calculation components.</span>
        <span class="n">observed_dim</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">table_dimensions_ferc1</span><span class="p">[</span><span class="n">on_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">dim_col</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
            <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">dim_col</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># bc there are dupes after we removed the other dim cols</span>

        <span class="n">null_dim_mask</span> <span class="o">=</span> <span class="n">df_w_dims</span><span class="p">[</span><span class="n">dim_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="n">null_dim</span> <span class="o">=</span> <span class="n">df_w_dims</span><span class="p">[</span><span class="n">null_dim_mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">dim_col</span><span class="p">])</span>
        <span class="n">df_w_implied_dims</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">null_dim</span><span class="p">,</span>
            <span class="n">observed_dim</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="n">on_cols</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df_w_explicit_dims</span> <span class="o">=</span> <span class="n">df_w_dims</span><span class="p">[</span><span class="o">~</span><span class="n">null_dim_mask</span><span class="p">]</span>
        <span class="c1"># astypes dealing w/ future warning regarding all null columns</span>
        <span class="n">df_w_dims</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">df_w_implied_dims</span><span class="p">,</span>
                <span class="n">df_w_explicit_dims</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">df_w_implied_dims</span><span class="o">.</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df_w_dims</span></div>



<div class="viewcode-block" id="assign_parent_dimensions">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.assign_parent_dimensions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assign_parent_dimensions</span><span class="p">(</span>
    <span class="n">calc_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">table_dimensions</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add dimensions to calculation parents.</span>

<span class="sd">    We now add in parent-dimension values for all of the original calculation component</span>
<span class="sd">    records using the observed dimensions.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_components: a table of calculation component records which have had some</span>
<span class="sd">            manual calculation fixes applied.</span>
<span class="sd">        table_dimensions: table with all observed values of :func:`other_dimensions` for</span>
<span class="sd">            each ``table_name`` and ``xbrl_factoid``.</span>
<span class="sd">        dimensions: list of dimension columns to check.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">})</span>
    <span class="c1"># desired: add parental dimension columns</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
        <span class="c1"># split the nulls and non-nulls. If the child dim is null, then we can run the</span>
        <span class="c1"># parent factoid through make_xbrl_factoid_dimensions_explicit to get it&#39;s dims.</span>
        <span class="c1"># if a child fact has dims, we need to merge the dimensions using the dim of the</span>
        <span class="c1"># child and the dim of the parent bc we don&#39;t want to broadcast merge all parent</span>
        <span class="c1"># dims to all child dims. We are assuming here that if a child is has a dim</span>
        <span class="n">null_dim_mask</span> <span class="o">=</span> <span class="n">calc_components</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
        <span class="n">calc_components_null</span> <span class="o">=</span> <span class="n">make_xbrl_factoid_dimensions_explicit</span><span class="p">(</span>
            <span class="n">df_w_xbrl_factoid</span><span class="o">=</span><span class="n">calc_components</span><span class="p">[</span><span class="n">null_dim_mask</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">}</span>
            <span class="p">),</span>
            <span class="n">table_dimensions_ferc1</span><span class="o">=</span><span class="n">table_dimensions</span><span class="p">,</span>
            <span class="n">dimensions</span><span class="o">=</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">parent_dim_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">]</span>
        <span class="n">calc_components_non_null</span> <span class="o">=</span> <span class="n">calc_components</span><span class="p">[</span><span class="o">~</span><span class="n">null_dim_mask</span><span class="p">]</span>
        <span class="n">table_dimensions_non_null</span> <span class="o">=</span> <span class="n">table_dimensions</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table_dimensions</span><span class="p">}</span>
        <span class="p">)[</span><span class="n">parent_dim_idx</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">calc_components_non_null</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">calc_components_non_null</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="n">table_dimensions_non_null</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;table_name_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid_parent&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span>
            <span class="n">right_on</span><span class="o">=</span><span class="n">parent_dim_idx</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># astypes dealing w/ future warning regarding empty or all null dfs</span>
        <span class="n">calc_components</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">calc_components_null</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">calc_components_non_null</span><span class="o">.</span><span class="n">dtypes</span><span class="p">),</span>
                <span class="n">calc_components_non_null</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">calc_components_null</span><span class="o">.</span><span class="n">dtypes</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">calc_components</span></div>



<div class="viewcode-block" id="infer_intra_factoid_totals">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.infer_intra_factoid_totals">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">infer_intra_factoid_totals</span><span class="p">(</span>
    <span class="n">calc_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">meta_w_dims</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">table_dimensions</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">dimensions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define dimension total calculations.</span>

<span class="sd">    Some factoids are marked as a total along some dimension in the metadata,</span>
<span class="sd">    which means that they are the sum of all the non-total factoids along that</span>
<span class="sd">    dimension.</span>

<span class="sd">    We match the parent factoids from the metadata to child factoids from the</span>
<span class="sd">    table_dimensions. We treat &quot;total&quot; as a wildcard value.</span>

<span class="sd">    We exclude child factoids that are themselves totals, because that would</span>
<span class="sd">    result in a double-count.</span>

<span class="sd">    Here are a few examples:</span>

<span class="sd">    Imagine a factoid with the following dimensions &amp; values:</span>

<span class="sd">    - utility types: &quot;total&quot;, &quot;gas&quot;, &quot;electric&quot;;</span>
<span class="sd">    - plant status: &quot;total&quot;, &quot;in_service&quot;, &quot;future&quot;</span>

<span class="sd">    Then the following parents would match/not-match:</span>

<span class="sd">    - parent: &quot;total&quot;, &quot;in_service&quot;</span>

<span class="sd">      - child: &quot;gas&quot;, &quot;in_service&quot; WOULD match.</span>
<span class="sd">      - child: &quot;electric&quot;, &quot;in_service&quot; WOULD match.</span>
<span class="sd">      - child: &quot;electric&quot;, &quot;future&quot; WOULD NOT match.</span>

<span class="sd">    - parent: &quot;total&quot;, &quot;total&quot;</span>

<span class="sd">      - child: &quot;gas&quot;, &quot;in_service&quot; WOULD match.</span>
<span class="sd">      - child: &quot;electric&quot;, &quot;future&quot; WOULD match.</span>

<span class="sd">    See the unit test in ferc1_test.py for more details.</span>

<span class="sd">    To be able to define these within-dimension calculations we also add dimension</span>
<span class="sd">    columns to all of the parent factoids in the table.</span>

<span class="sd">    Args:</span>
<span class="sd">        calc_components: a table of calculation component records which have had some</span>
<span class="sd">            manual calculation fixes applied. Passed through unmodified.</span>
<span class="sd">        meta_w_dims: metadata table with the dimensions.</span>
<span class="sd">        table_dimensions: table with all observed values of :func:`other_dimensions` for</span>
<span class="sd">            each ``table_name`` and ``xbrl_factoid``.</span>
<span class="sd">        dimensions: list of dimension columns to check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An table associating calculation components with the parents they will be</span>
<span class="sd">        aggregated into. The components and the parents are each identified by</span>
<span class="sd">        ``table_name``, ``xbrl_factoid``, and columns defining the additional dimensions</span>
<span class="sd">        (``utility_type``, ``plant_status``, ``plant_function``). The parent columns</span>
<span class="sd">        have a ``_parent`` suffix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># grab all of the non-total and non-correction records</span>
    <span class="n">child_candidates</span> <span class="o">=</span> <span class="n">table_dimensions</span><span class="p">[</span>
        <span class="o">~</span><span class="p">(</span><span class="n">table_dimensions</span><span class="p">[</span><span class="n">dimensions</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">table_dimensions</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_correction&quot;</span><span class="p">))</span>
    <span class="p">]</span>

    <span class="n">total_comps</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># check *every* combination of dimensions that could have any total values</span>
    <span class="n">dim_combos</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
        <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">_total_dims</span> <span class="ow">in</span> <span class="n">dim_combos</span><span class="p">:</span>
        <span class="n">total_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_total_dims</span><span class="p">)</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">meta_w_dims</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">total_dims</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">meta_w_dims</span><span class="p">[</span><span class="n">total_dims</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">parents</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># There&#39;s no wildcard merge in Pandas, so we just ignore whichever</span>
        <span class="c1"># columns have &quot;total&quot;</span>
        <span class="n">non_total_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dimensions</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">total_dims</span>
        <span class="p">]</span>
        <span class="n">total_comps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">left</span><span class="o">=</span><span class="n">parents</span><span class="p">,</span>
                <span class="n">right</span><span class="o">=</span><span class="n">child_candidates</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="n">non_total_cols</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_parent&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">is_within_table_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">table_name_parent</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
                <span class="n">xbrl_factoid_parent</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">child_node_pk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dimensions</span>
    <span class="n">parent_node_pk</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">child_node_pk</span><span class="p">]</span>
    <span class="n">relationship_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;is_within_table_calc&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span>
    <span class="n">all_expected_cols</span> <span class="o">=</span> <span class="n">parent_node_pk</span> <span class="o">+</span> <span class="n">child_node_pk</span> <span class="o">+</span> <span class="n">relationship_cols</span>
    <span class="n">inferred_totals</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">total_comps</span><span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">all_expected_cols</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># merge() will have dropped shared columns, so re-fill with child values:</span>
    <span class="n">child_values</span> <span class="o">=</span> <span class="n">inferred_totals</span><span class="p">[[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dimensions</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">dim</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">_parent&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span>
    <span class="p">)</span>
    <span class="n">inferred_totals</span> <span class="o">=</span> <span class="n">inferred_totals</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">child_values</span><span class="p">)</span>
    <span class="n">calcs_with_totals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">calc_components</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">is_total_to_subdimensions_calc</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">inferred_totals</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">is_total_to_subdimensions_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># verification + deduping below.</span>
    <span class="n">check_for_calc_components_duplicates</span><span class="p">(</span>
        <span class="n">calcs_with_totals</span><span class="p">,</span>
        <span class="n">table_names_known_dupes</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;core_ferc1__yearly_sales_by_rate_schedules_sched304&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">idx</span><span class="o">=</span><span class="n">parent_node_pk</span> <span class="o">+</span> <span class="n">child_node_pk</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># only drop duplicates if the table_name is in known dupes list.</span>
    <span class="n">calcs_with_totals</span> <span class="o">=</span> <span class="n">calcs_with_totals</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
        <span class="n">parent_node_pk</span> <span class="o">+</span> <span class="n">child_node_pk</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">calcs_with_totals</span><span class="p">[</span><span class="n">calcs_with_totals</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">empty</span>
    <span class="k">return</span> <span class="n">calcs_with_totals</span></div>



<div class="viewcode-block" id="add_calculation_component_corrections">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1.add_calculation_component_corrections">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_calculation_component_corrections</span><span class="p">(</span>
    <span class="n">calc_components</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add records into the calculation components table.</span>

<span class="sd">    All calculated records should have correction records. All total-to-subdimension</span>
<span class="sd">    calculations should also have correction records. For the core (non-subdimension)</span>
<span class="sd">    calculations, all calculation parents require a record with a correction child.</span>
<span class="sd">    For the total-to-subdimension calculations, we are assuming we can identify those</span>
<span class="sd">    calculations with the ``is_total_to_subdimensions_calc`` boolean column. All</span>
<span class="sd">    total-to-subdimension</span>

<span class="sd">    All calculaitons will get a correction record in the calculation components table</span>
<span class="sd">    whether or not there is ever a correction record in the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_child_cols</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">is_subdimension_correction</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">table_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">table_name_parent</span><span class="p">,</span>
            <span class="n">xbrl_factoid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">xbrl_factoid_parent</span>
                <span class="o">+</span> <span class="p">(</span>
                    <span class="s2">&quot;_subdimension_correction&quot;</span>
                    <span class="k">if</span> <span class="n">is_subdimension_correction</span>
                    <span class="k">else</span> <span class="s2">&quot;_correction&quot;</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">plant_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">plant_function_parent</span><span class="p">,</span>
            <span class="n">utility_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">utility_type_parent</span><span class="p">,</span>
            <span class="n">plant_status</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">plant_status_parent</span><span class="p">,</span>
            <span class="n">is_total_to_subdimensions_calc</span><span class="o">=</span><span class="n">is_subdimension_correction</span><span class="p">,</span>
            <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">other_dimensions</span><span class="p">(</span><span class="n">table_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="p">))</span>
    <span class="n">parent_idx</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">_parent&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dimensions</span><span class="p">]</span>

    <span class="n">non_corrections</span> <span class="o">=</span> <span class="n">calc_components</span><span class="p">[</span>
        <span class="o">~</span><span class="n">calc_components</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_correction&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">corrections</span> <span class="o">=</span> <span class="n">calc_components</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">parent_idx</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">assign_child_cols</span><span class="p">,</span> <span class="n">is_subdimension_correction</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">subdimension_corrections</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">calc_components</span><span class="p">[</span><span class="n">calc_components</span><span class="o">.</span><span class="n">is_total_to_subdimensions_calc</span><span class="p">]</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">parent_idx</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">assign_child_cols</span><span class="p">,</span> <span class="n">is_subdimension_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">non_corrections</span><span class="p">,</span> <span class="n">corrections</span><span class="p">,</span> <span class="n">subdimension_corrections</span><span class="p">])</span></div>



<span class="nd">@asset</span><span class="p">(</span>
    <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="c1"># list of tables that have reconcile_table_calculations params</span>
        <span class="c1"># minus electric_plant_depreciation_changes_ferc1 bc that table is messy and</span>
        <span class="c1"># not actually in the explosion work</span>
        <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;core_ferc1__yearly_plant_in_service_sched204&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_utility_plant_summary_sched200&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_operating_expenses_sched320&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_balance_sheet_liabilities_sched110&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_depreciation_summary_sched336&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_balance_sheet_assets_sched110&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_income_statements_sched114&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_depreciation_by_function_sched219&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_retained_earnings_sched118&quot;</span><span class="p">,</span>
            <span class="s2">&quot;core_ferc1__yearly_operating_revenues_sched300&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">}</span>
    <span class="o">|</span> <span class="p">{</span>
        <span class="s2">&quot;_core_ferc1_xbrl__calculation_components&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span>
            <span class="s2">&quot;_core_ferc1_xbrl__calculation_components&quot;</span>
        <span class="p">)</span>
    <span class="p">},</span>
<span class="p">)</span>
<div class="viewcode-block" id="_core_ferc1__calculation_metric_checks">
<a class="viewcode-back" href="../../../autoapi/pudl/transform/ferc1/index.html#pudl.transform.ferc1._core_ferc1__calculation_metric_checks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_core_ferc1__calculation_metric_checks</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check calculation metrics for all transformed tables which have reconciled calcs.&quot;&quot;&quot;</span>
    <span class="n">calculation_components</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__calculation_components&quot;</span><span class="p">]</span>
    <span class="n">transformed_ferc1_dfs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">df</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_core_ferc1_xbrl__calculation_components&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="c1"># standardize the two key columns we are going to use into generic names</span>
    <span class="n">xbrl_factoid_name</span> <span class="o">=</span> <span class="n">table_to_xbrl_factoid_name</span><span class="p">()</span>
    <span class="n">columns_to_check</span> <span class="o">=</span> <span class="n">table_to_column_to_check</span><span class="p">()</span>
    <span class="n">tbls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="n">xbrl_factoid_name</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span> <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
                <span class="n">columns_to_check</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span> <span class="s2">&quot;column_to_check&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="n">transformed_ferc1_dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">transformed_ferc1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tbls</span><span class="p">)</span>
    <span class="c1"># restrict the calculation components to only the bits we want</span>
    <span class="n">calculation_components</span> <span class="o">=</span> <span class="n">calculation_components</span><span class="p">[</span>
        <span class="c1"># remove total to subdimensions</span>
        <span class="o">~</span><span class="n">calculation_components</span><span class="o">.</span><span class="n">is_total_to_subdimensions_calc</span>
        <span class="c1"># only the intra table calcs</span>
        <span class="o">&amp;</span> <span class="n">calculation_components</span><span class="o">.</span><span class="n">is_within_table_calc</span>
        <span class="c1"># remove corrections (bc they would clean up the calcs so the errors wouldn&#39;t show up)</span>
        <span class="o">&amp;</span> <span class="o">~</span><span class="n">calculation_components</span><span class="o">.</span><span class="n">xbrl_factoid</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;_correction&quot;</span><span class="p">)</span>
        <span class="c1"># remove all of the tables that aren&#39;t in this check</span>
        <span class="o">&amp;</span> <span class="n">calculation_components</span><span class="o">.</span><span class="n">table_name_parent</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">transformed_ferc1_dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="p">]</span>

    <span class="n">calc_idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span> <span class="s2">&quot;table_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">other_dimensions</span><span class="p">(</span>
        <span class="n">table_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">FERC1_TFR_CLASSES</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">calculated_df</span> <span class="o">=</span> <span class="n">calculate_values_from_components</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">transformed_ferc1</span><span class="p">,</span>
        <span class="n">calculation_components</span><span class="o">=</span><span class="n">calculation_components</span><span class="p">,</span>
        <span class="n">calc_idx</span><span class="o">=</span><span class="n">calc_idx</span><span class="p">,</span>
        <span class="n">value_col</span><span class="o">=</span><span class="s2">&quot;column_to_check&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">calculation_metrics</span> <span class="o">=</span> <span class="n">check_calculation_metrics_by_group</span><span class="p">(</span>
        <span class="n">calculated_df</span><span class="o">=</span><span class="n">calculated_df</span><span class="p">,</span>
        <span class="n">group_metric_checks</span><span class="o">=</span><span class="n">GroupMetricChecks</span><span class="p">(</span>
            <span class="n">groups_to_check</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;ungrouped&quot;</span><span class="p">,</span>
                <span class="s2">&quot;table_name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;xbrl_factoid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_id_ferc1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="n">calculation_metrics</span><span class="p">[</span>
        <span class="n">calculation_metrics</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;is_error&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">42</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2"> from the results of check_calculation_metrics_by_group&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;with default group values when less than 41 was expected.</span><span class="se">\n</span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">calculation_metrics</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2016-2026, Catalyst Cooperative, CC-BY-4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=11fc87b4"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>