<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXWBBTVMWK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EXWBBTVMWK');
    </script>
    <link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">
        <link rel="prefetch" href="../../_static/catalyst_logo-200x200.png" as="image">

    <!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>pudl.helpers - PUDL 2026.2.1.dev10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=b1990d62" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     <b>Take our ~10 minute <a href="https://forms.gle/E9ou5fgMcR7YVRCRA">2026 Energy Data Ecosystem Survey!</b> 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">PUDL 2026.2.1.dev10 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/catalyst_logo-200x200.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PUDL 2026.2.1.dev10 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">About PUDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_access.html">Data Access</a></li>
<li class="toctree-l1"><a class="reference external" href="https://data.catalyst.coop">PUDL Data Viewer</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../data_sources/index.html">Data Sources</a><input aria-label="Toggle navigation of Data Sources" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/censusdp1tract.html">Census DP1 – Profile of General Demographic Characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/censuspep.html">Population Estimates Program's (PEP) Federal Information Processing Series (FIPS) Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eiaapi.html">EIA Bulk API Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eia176.html">EIA Form 176 – Annual Report of Natural and Supplemental Gas Supply and Disposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eia860.html">EIA Form 860 – Annual Electric Generator Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eia861.html">EIA Form 861 – Annual Electric Power Industry Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eia923.html">EIA Form 923 – Power Plant Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eia930.html">EIA Form 930 – Hourly and Daily Balancing Authority Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/eiaaeo.html">EIA Annual Energy Outlook (AEO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/epacamd_eia.html">EPA CAMD to EIA Power Sector Data Crosswalk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/epacems.html">EPA Hourly Continuous Emission Monitoring System (CEMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/ferc1.html">FERC Form 1 – Annual Report of Major Electric Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/ferc714.html">FERC Form 714 – Annual Electric Balancing Authority Area and Planning Area Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/ferceqr.html">FERC Form 920 – Electric Quarterly Report (EQR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/gridpathratoolkit.html">GridPath Resource Adequacy Toolkit Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/nrelatb.html">NREL Annual Technology Baseline (ATB) for Electricity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/phmsagas.html">Pipelines and Hazardous Materials Safety Administration (PHMSA) Annual Natural Gas Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/rus12.html">USDA RUS Form 12 – Financial and Operating Report: Electric Power Supply</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/rus7.html">USDA RUS Form 7 – Financial and Operating Report: Electric Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/sec10k.html">U.S. Securities and Exchange Commission (SEC) Form 10-K</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/vcerare.html">Vibrant Clean Energy Resource Adequacy Renewable Energy (RARE) Power Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/other_data.html">Other Data in PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_sources/future_data.html">High Priority Target Datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../data_dictionaries/index.html">Data Dictionaries</a><input aria-label="Toggle navigation of Data Dictionaries" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../data_dictionaries/pudl_db.html">PUDL Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_dictionaries/ferc1_db.html">Raw FERC Form 1 Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_dictionaries/codes_and_labels.html">PUDL Code Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_dictionaries/usage_warnings.html">PUDL Usage Warnings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../methodology/index.html">Methodology</a><input aria-label="Toggle navigation of Methodology" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../methodology/timeseries_imputation.html">Timeseries Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../methodology/sec10k_modeling.html">SEC 10-K Ownership Data Extraction Modeling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dev/index.html">Development</a><input aria-label="Toggle navigation of Development" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dev/dev_setup.html">Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/run_the_etl.html">Running the ETL Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/dev_dagster.html">Developing with Dagster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/project_management.html">Project Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/testing.html">Testing PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/data_validation_quickstart.html">Data validation quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/data_validation_reference.html">Data validation reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/metadata.html">Metadata editing guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/build_docs.html">Building the Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/datastore.html">Working with the Datastore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/clone_ferc1.html">Converting raw FERC data to SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/existing_data_updates.html">Existing Data Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/run_a_release.html">Run a Versioned Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/pudl_id_mapping.html">PUDL ID Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/naming_conventions.html">Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/data_guidelines.html">Data and ETL Design Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/nightly_data_builds.html">Nightly Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/ferceqr_data_builds.html">FERC EQR Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/infrastructure_as_code.html">Infrastructure as Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dev/managing_external_contributions.html">Managing External Contributions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">Licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../autoapi/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../autoapi/pudl/index.html">pudl</a><input aria-label="Toggle navigation of pudl" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/__main__/index.html">pudl.__main__</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/_version/index.html">pudl._version</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/analysis/index.html">pudl.analysis</a><input aria-label="Toggle navigation of pudl.analysis" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/allocate_gen_fuel/index.html">pudl.analysis.allocate_gen_fuel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/fuel_by_plant/index.html">pudl.analysis.fuel_by_plant</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/mcoe/index.html">pudl.analysis.mcoe</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/analysis/ml_tools/index.html">pudl.analysis.ml_tools</a><input aria-label="Toggle navigation of pudl.analysis.ml_tools" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/ml_tools/experiment_tracking/index.html">pudl.analysis.ml_tools.experiment_tracking</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/ml_tools/models/index.html">pudl.analysis.ml_tools.models</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/plant_parts_eia/index.html">pudl.analysis.plant_parts_eia</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/index.html">pudl.analysis.record_linkage</a><input aria-label="Toggle navigation of pudl.analysis.record_linkage" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/classify_plants_ferc1/index.html">pudl.analysis.record_linkage.classify_plants_ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/eia_ferc1_inputs/index.html">pudl.analysis.record_linkage.eia_ferc1_inputs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/eia_ferc1_model_config/index.html">pudl.analysis.record_linkage.eia_ferc1_model_config</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/eia_ferc1_record_linkage/index.html">pudl.analysis.record_linkage.eia_ferc1_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/eia_ferc1_train/index.html">pudl.analysis.record_linkage.eia_ferc1_train</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/embed_dataframe/index.html">pudl.analysis.record_linkage.embed_dataframe</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/link_cross_year/index.html">pudl.analysis.record_linkage.link_cross_year</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/analysis/record_linkage/name_cleaner/index.html">pudl.analysis.record_linkage.name_cleaner</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/service_territory/index.html">pudl.analysis.service_territory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/spatial/index.html">pudl.analysis.spatial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/state_demand/index.html">pudl.analysis.state_demand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/timeseries_cleaning/index.html">pudl.analysis.timeseries_cleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/analysis/timeseries_evaluation/index.html">pudl.analysis.timeseries_evaluation</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/convert/index.html">pudl.convert</a><input aria-label="Toggle navigation of pudl.convert" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/convert/censusdp1tract_to_sqlite/index.html">pudl.convert.censusdp1tract_to_sqlite</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/convert/metadata_to_rst/index.html">pudl.convert.metadata_to_rst</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/dbt_wrapper/index.html">pudl.dbt_wrapper</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/etl/index.html">pudl.etl</a><input aria-label="Toggle navigation of pudl.etl" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/asset_checks/index.html">pudl.etl.asset_checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/check_foreign_keys/index.html">pudl.etl.check_foreign_keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/cli/index.html">pudl.etl.cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/eia_bulk_elec_assets/index.html">pudl.etl.eia_bulk_elec_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/ferceqr_deployment/index.html">pudl.etl.ferceqr_deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/glue_assets/index.html">pudl.etl.glue_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/etl/static_assets/index.html">pudl.etl.static_assets</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/extract/index.html">pudl.extract</a><input aria-label="Toggle navigation of pudl.extract" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/censuspep/index.html">pudl.extract.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/csv/index.html">pudl.extract.csv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/dbf/index.html">pudl.extract.dbf</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia176/index.html">pudl.extract.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia191/index.html">pudl.extract.eia191</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia757a/index.html">pudl.extract.eia757a</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia860/index.html">pudl.extract.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia860m/index.html">pudl.extract.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia861/index.html">pudl.extract.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia923/index.html">pudl.extract.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eia930/index.html">pudl.extract.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eiaaeo/index.html">pudl.extract.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/eiaapi/index.html">pudl.extract.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/epacems/index.html">pudl.extract.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/excel/index.html">pudl.extract.excel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/extractor/index.html">pudl.extract.extractor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferc/index.html">pudl.extract.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferc1/index.html">pudl.extract.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferc2/index.html">pudl.extract.ferc2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferc6/index.html">pudl.extract.ferc6</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferc60/index.html">pudl.extract.ferc60</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferc714/index.html">pudl.extract.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferccid/index.html">pudl.extract.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/ferceqr/index.html">pudl.extract.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/gridpathratoolkit/index.html">pudl.extract.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/nrelatb/index.html">pudl.extract.nrelatb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/parquet/index.html">pudl.extract.parquet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/phmsagas/index.html">pudl.extract.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/rus12/index.html">pudl.extract.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/rus7/index.html">pudl.extract.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/sec10k/index.html">pudl.extract.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/vcerare/index.html">pudl.extract.vcerare</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/extract/xbrl/index.html">pudl.extract.xbrl</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/ferc_to_sqlite/index.html">pudl.ferc_to_sqlite</a><input aria-label="Toggle navigation of pudl.ferc_to_sqlite" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/ferc_to_sqlite/cli/index.html">pudl.ferc_to_sqlite.cli</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/glue/index.html">pudl.glue</a><input aria-label="Toggle navigation of pudl.glue" class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/glue/ferc1_eia/index.html">pudl.glue.ferc1_eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/glue/ferc714/index.html">pudl.glue.ferc714</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/helpers/index.html">pudl.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/io_managers/index.html">pudl.io_managers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/logging_helpers/index.html">pudl.logging_helpers</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/metadata/index.html">pudl.metadata</a><input aria-label="Toggle navigation of pudl.metadata" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/classes/index.html">pudl.metadata.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/codes/index.html">pudl.metadata.codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/constants/index.html">pudl.metadata.constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/descriptions/index.html">pudl.metadata.descriptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/dfs/index.html">pudl.metadata.dfs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/enums/index.html">pudl.metadata.enums</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/fields/index.html">pudl.metadata.fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/helpers/index.html">pudl.metadata.helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/labels/index.html">pudl.metadata.labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/resource_helpers/index.html">pudl.metadata.resource_helpers</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/index.html">pudl.metadata.resources</a><input aria-label="Toggle navigation of pudl.metadata.resources" class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/allocate_gen_fuel/index.html">pudl.metadata.resources.allocate_gen_fuel</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/censusdp1tract/index.html">pudl.metadata.resources.censusdp1tract</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia/index.html">pudl.metadata.resources.eia</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia176/index.html">pudl.metadata.resources.eia176</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia860/index.html">pudl.metadata.resources.eia860</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia860m/index.html">pudl.metadata.resources.eia860m</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia861/index.html">pudl.metadata.resources.eia861</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia923/index.html">pudl.metadata.resources.eia923</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eia930/index.html">pudl.metadata.resources.eia930</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eiaaeo/index.html">pudl.metadata.resources.eiaaeo</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/eiaapi/index.html">pudl.metadata.resources.eiaapi</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/epacems/index.html">pudl.metadata.resources.epacems</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/ferc1/index.html">pudl.metadata.resources.ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/ferc1_eia_record_linkage/index.html">pudl.metadata.resources.ferc1_eia_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/ferc714/index.html">pudl.metadata.resources.ferc714</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/ferccid/index.html">pudl.metadata.resources.ferccid</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/ferceqr/index.html">pudl.metadata.resources.ferceqr</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/glue/index.html">pudl.metadata.resources.glue</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/gridpathratoolkit/index.html">pudl.metadata.resources.gridpathratoolkit</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/nrelatb/index.html">pudl.metadata.resources.nrelatb</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/phmsagas/index.html">pudl.metadata.resources.phmsagas</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/pudl/index.html">pudl.metadata.resources.pudl</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/rus12/index.html">pudl.metadata.resources.rus12</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/rus7/index.html">pudl.metadata.resources.rus7</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/sec10k/index.html">pudl.metadata.resources.sec10k</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/metadata/resources/vcerare/index.html">pudl.metadata.resources.vcerare</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/sources/index.html">pudl.metadata.sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/metadata/warnings/index.html">pudl.metadata.warnings</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/output/index.html">pudl.output</a><input aria-label="Toggle navigation of pudl.output" class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/censusdp1tract/index.html">pudl.output.censusdp1tract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/eia/index.html">pudl.output.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/eia860/index.html">pudl.output.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/eia923/index.html">pudl.output.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/eia930/index.html">pudl.output.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/eiaapi/index.html">pudl.output.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/ferc1/index.html">pudl.output.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/ferc714/index.html">pudl.output.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/output/sec10k/index.html">pudl.output.sec10k</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/output/sql/index.html">pudl.output.sql</a><input aria-label="Toggle navigation of pudl.output.sql" class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/output/sql/helpers/index.html">pudl.output.sql.helpers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/index.html">pudl.package_data</a><input aria-label="Toggle navigation of pudl.package_data" class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/censuspep/index.html">pudl.package_data.censuspep</a><input aria-label="Toggle navigation of pudl.package_data.censuspep" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/censuspep/column_maps/index.html">pudl.package_data.censuspep.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia176/index.html">pudl.package_data.eia176</a><input aria-label="Toggle navigation of pudl.package_data.eia176" class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia176/column_maps/index.html">pudl.package_data.eia176.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia191/index.html">pudl.package_data.eia191</a><input aria-label="Toggle navigation of pudl.package_data.eia191" class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia191/column_maps/index.html">pudl.package_data.eia191.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia757a/index.html">pudl.package_data.eia757a</a><input aria-label="Toggle navigation of pudl.package_data.eia757a" class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia757a/column_maps/index.html">pudl.package_data.eia757a.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia860/index.html">pudl.package_data.eia860</a><input aria-label="Toggle navigation of pudl.package_data.eia860" class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia860/column_maps/index.html">pudl.package_data.eia860.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia860m/index.html">pudl.package_data.eia860m</a><input aria-label="Toggle navigation of pudl.package_data.eia860m" class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia860m/column_maps/index.html">pudl.package_data.eia860m.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia861/index.html">pudl.package_data.eia861</a><input aria-label="Toggle navigation of pudl.package_data.eia861" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia861/column_maps/index.html">pudl.package_data.eia861.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia923/index.html">pudl.package_data.eia923</a><input aria-label="Toggle navigation of pudl.package_data.eia923" class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia923/column_maps/index.html">pudl.package_data.eia923.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/eia930/index.html">pudl.package_data.eia930</a><input aria-label="Toggle navigation of pudl.package_data.eia930" class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/eia930/column_maps/index.html">pudl.package_data.eia930.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/package_data/epacems/index.html">pudl.package_data.epacems</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/ferc1/index.html">pudl.package_data.ferc1</a><input aria-label="Toggle navigation of pudl.package_data.ferc1" class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/ferc1/row_maps/index.html">pudl.package_data.ferc1.row_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/package_data/glue/index.html">pudl.package_data.glue</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/phmsagas/index.html">pudl.package_data.phmsagas</a><input aria-label="Toggle navigation of pudl.package_data.phmsagas" class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/phmsagas/column_maps/index.html">pudl.package_data.phmsagas.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/rus12/index.html">pudl.package_data.rus12</a><input aria-label="Toggle navigation of pudl.package_data.rus12" class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/rus12/column_maps/index.html">pudl.package_data.rus12.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/package_data/rus7/index.html">pudl.package_data.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/package_data/settings/index.html">pudl.package_data.settings</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/package_data/test/index.html">pudl.package_data.test</a><input aria-label="Toggle navigation of pudl.package_data.test" class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/package_data/test/column_maps/index.html">pudl.package_data.test.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/package_data/vcerare/index.html">pudl.package_data.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/resources/index.html">pudl.resources</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/scripts/index.html">pudl.scripts</a><input aria-label="Toggle navigation of pudl.scripts" class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/scripts/auto_match_utilities/index.html">pudl.scripts.auto_match_utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/scripts/dbt_helper/index.html">pudl.scripts.dbt_helper</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/scripts/generate_pudl_duckdb/index.html">pudl.scripts.generate_pudl_duckdb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/scripts/pudl_null_cols/index.html">pudl.scripts.pudl_null_cols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/scripts/resource_description/index.html">pudl.scripts.resource_description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/scripts/zenodo_data_release/index.html">pudl.scripts.zenodo_data_release</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/settings/index.html">pudl.settings</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/transform/index.html">pudl.transform</a><input aria-label="Toggle navigation of pudl.transform" class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/censuspep/index.html">pudl.transform.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/classes/index.html">pudl.transform.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia/index.html">pudl.transform.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia176/index.html">pudl.transform.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia860/index.html">pudl.transform.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia860m/index.html">pudl.transform.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia861/index.html">pudl.transform.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia923/index.html">pudl.transform.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eia930/index.html">pudl.transform.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eiaaeo/index.html">pudl.transform.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/eiaapi/index.html">pudl.transform.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/epacems/index.html">pudl.transform.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/ferc/index.html">pudl.transform.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/ferc1/index.html">pudl.transform.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/ferc714/index.html">pudl.transform.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/ferccid/index.html">pudl.transform.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/ferceqr/index.html">pudl.transform.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/gridpathratoolkit/index.html">pudl.transform.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/nrelatb/index.html">pudl.transform.nrelatb</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../autoapi/pudl/transform/params/index.html">pudl.transform.params</a><input aria-label="Toggle navigation of pudl.transform.params" class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../autoapi/pudl/transform/params/ferc1/index.html">pudl.transform.params.ferc1</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/phmsagas/index.html">pudl.transform.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/rus/index.html">pudl.transform.rus</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/rus12/index.html">pudl.transform.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/rus7/index.html">pudl.transform.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/sec10k/index.html">pudl.transform.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/transform/vcerare/index.html">pudl.transform.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../autoapi/pudl/validate/index.html">pudl.validate</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../autoapi/pudl/workspace/index.html">pudl.workspace</a><input aria-label="Toggle navigation of pudl.workspace" class="toctree-checkbox" id="toctree-checkbox-36" name="toctree-checkbox-36" role="switch" type="checkbox"/><label for="toctree-checkbox-36"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/workspace/datastore/index.html">pudl.workspace.datastore</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/workspace/resource_cache/index.html">pudl.workspace.resource_cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../autoapi/pudl/workspace/setup/index.html">pudl.workspace.setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bibliography.html">Bibliography</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pudl.helpers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;General utility functions that are used in a variety of contexts.</span>

<span class="sd">The functions in this module are used in various stages of the ETL and post-etl</span>
<span class="sd">processes. They are usually not dataset specific, but not always. If a function is</span>
<span class="sd">designed to be used as a general purpose tool, applicable in multiple scenarios, it</span>
<span class="sd">should probably live here. There are lost of transform type functions in here that help</span>
<span class="sd">with cleaning and restructuring dataframes.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">importlib.resources</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">NamedTuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">duckdb</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dagster</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssetKey</span><span class="p">,</span> <span class="n">AssetsDefinition</span><span class="p">,</span> <span class="n">AssetSelection</span><span class="p">,</span> <span class="n">AssetSpec</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas._libs.missing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NAType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pudl.logging_helpers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">get_pudl_dtypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.workspace.setup</span><span class="w"> </span><span class="kn">import</span> <span class="n">PudlPaths</span>

<div class="viewcode-block" id="sum_na">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.sum_na">[docs]</a>
<span class="n">sum_na</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<span class="sd">&quot;&quot;&quot;A sum function that returns NA if the Series includes any NA values.</span>

<span class="sd">In many of our aggregations we need to override the default behavior of treating NA</span>
<span class="sd">values as if they were zero. E.g. when calculating the heat rates of generation units,</span>
<span class="sd">if there are some months where fuel consumption is reported as NA, but electricity</span>
<span class="sd">generation is reported normally, then the fuel consumption for the year needs to be NA,</span>
<span class="sd">otherwise we&#39;ll get unrealistic heat rates.</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">logging_helpers</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>



<div class="viewcode-block" id="label_map">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.label_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">label_map</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">from_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span>
    <span class="n">to_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
    <span class="n">null_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">NAType</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">NAType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build a mapping dictionary from two columns of a labeling / coding dataframe.</span>

<span class="sd">    These dataframes document the meanings of the codes that show up in much of the</span>
<span class="sd">    originally reported data. They&#39;re defined in :mod:`pudl.metadata.codes`.  This</span>
<span class="sd">    function is mostly used to build maps that can translate the hard to understand</span>
<span class="sd">    short codes into longer human-readable codes.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The coding / labeling dataframe. Must contain columns ``from_col``</span>
<span class="sd">            and ``to_col``.</span>
<span class="sd">        from_col: Label of column containing the existing codes to be replaced.</span>
<span class="sd">        to_col: Label of column containing the new codes to be swapped in.</span>
<span class="sd">        null_value: Default (Null) value to map to when a value which doesn&#39;t</span>
<span class="sd">            appear in ``from_col`` is encountered.</span>


<span class="sd">    Returns:</span>
<span class="sd">        A mapping dictionary suitable for use with :meth:`pandas.Series.map`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">null_value</span><span class="p">,</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">from_col</span><span class="p">,</span> <span class="n">to_col</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">from_col</span><span class="p">])</span>
        <span class="o">.</span><span class="n">to_records</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="find_new_ferc1_strings">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.find_new_ferc1_strings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_new_ferc1_strings</span><span class="p">(</span>
    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">strdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">ferc1_engine</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">Engine</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify as-of-yet uncategorized freeform strings in FERC Form 1.</span>

<span class="sd">    Args:</span>
<span class="sd">        table: Name of the FERC Form 1 DB to search.</span>
<span class="sd">        field: Name of the column in that table to search.</span>
<span class="sd">        strdict: A string cleaning dictionary. See</span>
<span class="sd">            e.g. :py:const:`pudl.transform.ferc1.FUEL_UNIT_STRINGS`</span>
<span class="sd">        ferc1_engine: SQL Alchemy DB connection engine for the FERC Form 1 DB.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Any string found in the searched table + field that was not part of any of</span>
<span class="sd">        categories enumerated in strdict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_strings</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">;&quot;</span><span class="p">,</span> <span class="n">ferc1_engine</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>  <span class="c1"># noqa: S608</span>
            <span class="n">simplify_strings</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="p">)[</span><span class="n">field</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">old_strings</span> <span class="o">=</span> <span class="nb">set</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span> <span class="k">for</span> <span class="n">strings</span> <span class="ow">in</span> <span class="n">strdict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">all_strings</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">old_strings</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_foreign_key_errors">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.find_foreign_key_errors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_foreign_key_errors</span><span class="p">(</span><span class="n">dfs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Report foreign key violations from a dictionary of dataframes.</span>

<span class="sd">    The database schema to check against is generated based on the names of the</span>
<span class="sd">    dataframes (keys of the dictionary) and the PUDL metadata structures.</span>

<span class="sd">    Args:</span>
<span class="sd">        dfs: Keys are table names, and values are dataframes ready for loading</span>
<span class="sd">            into the SQLite database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dictionaries, each one pertains to a single database table</span>
<span class="sd">        in which a foreign key constraint violation was found, and it includes</span>
<span class="sd">        the table name, foreign key definition, and the elements of the</span>
<span class="sd">        dataframe that violated the foreign key constraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pudl.metadata.classes</span>

    <span class="n">package</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">Package</span><span class="o">.</span><span class="n">from_resource_ids</span><span class="p">(</span>
        <span class="n">resource_ids</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">dfs</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">foreign_key</span> <span class="ow">in</span> <span class="n">resource</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">resource</span><span class="p">][</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
            <span class="n">ncols</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)</span>
            <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Faster check for single-field foreign key</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">invalid</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">])</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span> <span class="p">:]</span>
                    <span class="o">|</span> <span class="n">xx</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">invalid</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s2">&quot;foreign_key&quot;</span><span class="p">:</span> <span class="n">foreign_key</span><span class="p">,</span>
                        <span class="s2">&quot;invalid&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">invalid</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">errors</span></div>



<div class="viewcode-block" id="download_zip_url">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.download_zip_url">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_zip_url</span><span class="p">(</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">9.05</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download and save a Zipfile locally.</span>

<span class="sd">    Useful for acquiring and storing non-PUDL data locally.</span>

<span class="sd">    Args:</span>
<span class="sd">        url: The URL from which to download the Zipfile</span>
<span class="sd">        save_path: The location to save the file.</span>
<span class="sd">        chunk_size: Data chunk in bytes to use while downloading.</span>
<span class="sd">        timeout: Time to wait for the server to accept a connection.</span>
<span class="sd">            See https://requests.readthedocs.io/en/latest/user/advanced/#timeouts</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This is a temporary hack to avoid being filtered as a bot:</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US,en;q=0.5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Upgrade-Insecure-Requests&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">save_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_fips_ids">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.add_fips_ids">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_fips_ids</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">geocodes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">state_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span>
    <span class="n">county_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add State and County FIPS IDs to a dataframe.</span>

<span class="sd">    To just add State FIPS IDs, make county_col = None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">add_state_id_fips</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geocodes</span><span class="p">,</span> <span class="n">state_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">county_col</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">add_county_fips_id</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">geocodes</span><span class="p">,</span> <span class="n">county_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="add_state_id_fips">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.add_state_id_fips">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_state_id_fips</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">geocodes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">state_col</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the State FIPS codes.&quot;&quot;&quot;</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">geocodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">geocodes</span><span class="p">[</span><span class="s2">&quot;fips_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;040&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;state_id_fips&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state_col</span><span class="p">})</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Assigned state FIPS codes for &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">state_id_fips</span><span class="o">.</span><span class="n">notnull</span><span class="p">()])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> of records.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="add_county_fips_id">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.add_county_fips_id">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_county_fips_id</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">geocodes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">county_col</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the County FIPS codes to a table with State FIPS codes.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_area_name_col</span><span class="p">(</span><span class="n">area_name_col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">replace_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean a area name column - meant for use in FIPS code adding.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">area_name_col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">replace_dict</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">diacritics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">r</span><span class="s2">&quot;ñ&quot;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;&#39;&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;ó&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;í&quot;</span><span class="p">:</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;á&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;ü&quot;</span><span class="p">:</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;é&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;î&quot;</span><span class="p">:</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;è&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;à&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;ì&quot;</span><span class="p">:</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s2">&quot;å&quot;</span><span class="p">:</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">abbrevs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ft. &quot;</span><span class="p">:</span> <span class="s2">&quot;fort &quot;</span><span class="p">,</span> <span class="s2">&quot;st. &quot;</span><span class="p">:</span> <span class="s2">&quot;saint &quot;</span><span class="p">,</span> <span class="s2">&quot;ste. &quot;</span><span class="p">:</span> <span class="s2">&quot;sainte &quot;</span><span class="p">}</span>

    <span class="n">county_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">r</span><span class="s2">&quot; (county|city|city and borough|borough|census area|municipio|municipality|district|parish|island)$&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>

    <span class="c1"># compile the counties.</span>
    <span class="n">counties</span> <span class="o">=</span> <span class="n">geocodes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">geocodes</span><span class="p">[</span><span class="s2">&quot;fips_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;050&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;area_name&quot;</span><span class="p">,</span> <span class="s2">&quot;state_id_fips&quot;</span><span class="p">,</span> <span class="s2">&quot;county_id_fips&quot;</span><span class="p">],</span>
    <span class="p">]</span>  <span class="c1"># compile all of the many possible ways these county columns could show up.</span>
    <span class="n">counties</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">counties</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">county_tmp</span><span class="o">=</span><span class="n">_clean_area_name_col</span><span class="p">(</span><span class="n">counties</span><span class="p">[</span><span class="s2">&quot;area_name&quot;</span><span class="p">],</span> <span class="n">replace_dict</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">replace_dict</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">{},</span>
                <span class="n">diacritics</span> <span class="o">|</span> <span class="n">abbrevs</span><span class="p">,</span>
                <span class="n">county_types</span><span class="p">,</span>
                <span class="n">diacritics</span> <span class="o">|</span> <span class="n">abbrevs</span> <span class="o">|</span> <span class="n">county_types</span><span class="p">,</span>
                <span class="n">county_types</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;&#39;s&quot;</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">},</span>
            <span class="p">]</span>
        <span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># see assertion note below. we keep the city records because all instances</span>
    <span class="c1"># of the city as county reported we&#39;ve seen always note lone city as county</span>
    <span class="c1"># name instead of lone county. There is one exception which is Bedford.. #3531</span>
    <span class="n">city_county_dupe_mask</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;state_id_fips&quot;</span><span class="p">,</span> <span class="s2">&quot;county_tmp&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">counties</span><span class="o">.</span><span class="n">area_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;county|borough&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="o">~</span><span class="n">counties</span><span class="o">.</span><span class="n">area_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;bedford&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">counties</span><span class="o">.</span><span class="n">area_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bedford city&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">city_county_dupes</span> <span class="o">:=</span> <span class="n">counties</span><span class="p">[</span><span class="n">city_county_dupe_mask</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;We expect there to be 9 county records that have the same name and state &quot;</span>
            <span class="s2">&quot;but have different county fips codes. This is due to pair counties that have &quot;</span>
            <span class="s2">&quot;a city jurisdiction and a corresponding county jurisdiction (ex. Baltimore &quot;</span>
            <span class="s2">&quot;County and Baltimore City which is also a county). We found &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">city_county_dupes</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">city_county_dupes</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;county_tmp&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="p">[</span><span class="o">~</span><span class="n">city_county_dupe_mask</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">county_col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">StringDtype</span><span class="p">()})</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">county_tmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_clean_area_name_col</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">county_col</span><span class="p">],</span> <span class="p">{}))</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">counties</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;state_id_fips&quot;</span><span class="p">,</span> <span class="s2">&quot;county_tmp&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;county_tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;area_name&quot;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Assigned county FIPS codes for &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">county_id_fips</span><span class="o">.</span><span class="n">notnull</span><span class="p">()])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> of records.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="clean_eia_counties">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.clean_eia_counties">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_eia_counties</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">fixes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">state_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span>
    <span class="n">county_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace non-standard county names with county names from US Census.&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="n">county_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">county_col</span><span class="p">]</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Condense multiple whitespace chars.</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^St &quot;</span><span class="p">,</span> <span class="s2">&quot;St. &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Standardize abbreviation.</span>
        <span class="c1"># Standardize abbreviation.</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^Ste &quot;</span><span class="p">,</span> <span class="s2">&quot;Ste. &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Kent &amp; New Castle&quot;</span><span class="p">,</span> <span class="s2">&quot;Kent, New Castle&quot;</span><span class="p">)</span>  <span class="c1"># Two counties</span>
        <span class="c1"># Fix ordering, remove comma</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Borough, Kodiak Island&quot;</span><span class="p">,</span> <span class="s2">&quot;Kodiak Island Borough&quot;</span><span class="p">)</span>
        <span class="c1"># Turn comma-separated counties into lists</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;,$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Create new records for each county in a multi-valued record</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">county_col</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">county_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">county_col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Yellowstone county is in MT, not WY</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">state_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;WY&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">county_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Yellowstone&quot;</span><span class="p">),</span> <span class="n">state_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;MT&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Replace individual bad county names with identified correct names in fixes:</span>
    <span class="k">for</span> <span class="n">fix</span> <span class="ow">in</span> <span class="n">fixes</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">state_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">state_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">fix</span><span class="o">.</span><span class="n">state</span>
        <span class="n">county_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">county_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">fix</span><span class="o">.</span><span class="n">eia_county</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">state_mask</span> <span class="o">&amp;</span> <span class="n">county_mask</span><span class="p">,</span> <span class="n">county_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">fix</span><span class="o">.</span><span class="n">fips_county</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="oob_to_nan">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.oob_to_nan">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">oob_to_nan</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">lb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ub</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set non-numeric values and those outside of a given range to NaN.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe containing values to be altered.</span>
<span class="sd">        cols: Labels of the columns whose values are to be changed.</span>
<span class="sd">        lb: Lower bound, below which values are set to NaN. If None, don&#39;t use a lower</span>
<span class="sd">            bound.</span>
<span class="sd">        ub: Upper bound, below which values are set to NaN. If None, don&#39;t use an upper</span>
<span class="sd">            bound.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The altered DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="c1"># Force column to be numeric if possible, NaN otherwise:</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lb</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">out_df</span></div>



<div class="viewcode-block" id="oob_to_nan_with_dependent_cols">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.oob_to_nan_with_dependent_cols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">oob_to_nan_with_dependent_cols</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">dependent_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">lb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ub</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call :func:`oob_to_nan` and additionally nullify any derived columns.</span>

<span class="sd">    Set values in ``cols`` to NaN if values are non-numeric or outside of a</span>
<span class="sd">    given range. The corresponding values in ``dependent_cols`` are then set</span>
<span class="sd">    to NaN. ``dependent_cols`` should be columns derived from one or multiple</span>
<span class="sd">    of the columns in ``cols``.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe containing values to be altered.</span>
<span class="sd">        cols: Labels of the columns whose values are to be changed.</span>
<span class="sd">        dependent_cols: Labels of the columns whose corresponding values should also be</span>
<span class="sd">            nullified. Columns are derived from one or multiple of the columns in</span>
<span class="sd">            ``cols``.</span>
<span class="sd">        lb: Lower bound, below which values are set to NaN. If None, don&#39;t use a lower</span>
<span class="sd">            bound.</span>
<span class="sd">        ub: Upper bound, below which values are set to NaN. If None, don&#39;t use an upper</span>
<span class="sd">            bound.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The altered DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">oob_to_nan</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">)</span>
    <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">out_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">dependent_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">out_df</span></div>



<div class="viewcode-block" id="prep_dir">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.prep_dir">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prep_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">clobber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create (or delete and recreate) a directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        dir_path: path to the directory that you are trying to clean and prepare.</span>
<span class="sd">        clobber: If True and dir_path exists, it will be removed and replaced with a</span>
<span class="sd">            new, empty directory.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileExistsError: if a file or directory already exists at dir_path.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Path to the created directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dir_path</span><span class="si">}</span><span class="s2"> exists and clobber is </span><span class="si">{</span><span class="n">clobber</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dir_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dir_path</span></div>



<div class="viewcode-block" id="is_doi">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.is_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if a string is a valid digital object identifier (DOI).</span>

<span class="sd">    Function simply checks whether the offered string matches a regular</span>
<span class="sd">    expression -- it doesn&#39;t check whether the DOI is actually registered</span>
<span class="sd">    with the relevant authority.</span>

<span class="sd">    Args:</span>
<span class="sd">        doi: String to validate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if doi matches the regex for valid DOIs, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doi_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;(doi:\s*|(?:https?://)?(?:dx\.)?doi\.org/)?(10\.\d+(.\d+)*/.+)$&quot;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">doi_regex</span><span class="p">,</span> <span class="n">doi</span><span class="p">))</span></div>



<div class="viewcode-block" id="convert_col_to_datetime">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.convert_col_to_datetime">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_col_to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">date_col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a non-datetime column in a dataframe to a datetime64[s].</span>

<span class="sd">    If the column isn&#39;t a datetime, it needs to be converted to a string type</span>
<span class="sd">    first so that integer years are formatted correctly.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Dataframe with column to convert.</span>
<span class="sd">        date_col_name: name of the datetime column to convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dataframe with the converted datetime column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_datetime64_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">date_col_name</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> column. &quot;</span>
            <span class="s2">&quot;Converting to datetime64[ns].&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="full_timeseries_date_merge">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.full_timeseries_date_merge">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">full_timeseries_date_merge</span><span class="p">(</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">on</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">left_date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">right_date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">new_date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">date_on</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
    <span class="n">how</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span>
    <span class="n">report_at_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge dataframes with different date frequencies and expand to a full timeseries.</span>

<span class="sd">    Arguments: see arguments for ``date_merge`` and ``expand_timeseries``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">date_merge</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span>
        <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
        <span class="n">left_date_col</span><span class="o">=</span><span class="n">left_date_col</span><span class="p">,</span>
        <span class="n">right_date_col</span><span class="o">=</span><span class="n">right_date_col</span><span class="p">,</span>
        <span class="n">new_date_col</span><span class="o">=</span><span class="n">new_date_col</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span>
        <span class="n">date_on</span><span class="o">=</span><span class="n">date_on</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span>
        <span class="n">report_at_start</span><span class="o">=</span><span class="n">report_at_start</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">expand_timeseries</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
        <span class="n">date_col</span><span class="o">=</span><span class="n">new_date_col</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
        <span class="n">key_cols</span><span class="o">=</span><span class="n">on</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="_add_suffix_to_date_on">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers._add_suffix_to_date_on">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_add_suffix_to_date_on</span><span class="p">(</span><span class="n">date_on</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check date_on list is valid and add _temp_for_merge suffix.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">date_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date_on</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span>
    <span class="n">date_on_suffix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">date_on</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;quarter&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> is not a valid string in date_on column list.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">date_on_suffix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_temp_for_merge&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">date_on_suffix</span></div>



<div class="viewcode-block" id="date_merge">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.date_merge">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">date_merge</span><span class="p">(</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">on</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">left_date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">right_date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">new_date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">date_on</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;cross&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span>
    <span class="n">report_at_start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge two dataframes that have different report date frequencies.</span>

<span class="sd">    We often need to bring together data that is reported at different</span>
<span class="sd">    temporal granularities e.g. monthly basis versus annual basis. This function</span>
<span class="sd">    acts as a wrapper on a pandas merge to allow merging at different temporal</span>
<span class="sd">    granularities. The date columns of both dataframes are separated into</span>
<span class="sd">    year, quarter, month, and day columns. Then, the dataframes are merged according</span>
<span class="sd">    to ``how`` on the columns specified by the ``on`` and ``date_on`` argument,</span>
<span class="sd">    which list the new temporal columns to merge on as well any additional shared columns.</span>
<span class="sd">    Finally, the datetime column is reconstructed in the output dataframe and</span>
<span class="sd">    named according to the ``new_date_col`` parameter.</span>

<span class="sd">    Args:</span>
<span class="sd">        left: The left dataframe in the merge. Typically monthly in our use</span>
<span class="sd">            cases if doing a left merge E.g. ``core_eia923__monthly_generation``.</span>
<span class="sd">            Must contain columns specified by ``left_date_col`` and</span>
<span class="sd">            ``on`` argument.</span>
<span class="sd">        right: The right dataframe in the merge. Typically annual in our uses</span>
<span class="sd">            cases if doing a left merge E.g. ``core_eia860__scd_generators``.</span>
<span class="sd">            Must contain columns specified by ``right_date_col`` and</span>
<span class="sd">            ``on`` argument.</span>
<span class="sd">        on: The columns to merge on that are shared between both</span>
<span class="sd">            dataframes. Typically ID columns like ``plant_id_eia``, ``generator_id``</span>
<span class="sd">            or ``boiler_id``.</span>
<span class="sd">        left_date_col: Column in ``left`` containing datetime like data. Default is</span>
<span class="sd">            ``report_date``. Must be a Datetime or convertible to a Datetime using</span>
<span class="sd">            :func:`pandas.to_datetime`</span>
<span class="sd">        right_date_col: Column in ``right`` containing datetime like data. Default is</span>
<span class="sd">            ``report_date``. Must be a Datetime or convertible to a Datetime using</span>
<span class="sd">            :func:`pandas.to_datetime`.</span>
<span class="sd">        new_date_col: Name of the reconstructed datetime column in the output dataframe.</span>
<span class="sd">        date_on: The temporal columns to merge on. Values in this list</span>
<span class="sd">            of columns must be [``year``, ``quarter``, ``month``, ``day``].</span>
<span class="sd">            E.g. if a monthly reported dataframe is being merged onto a daily reported</span>
<span class="sd">            dataframe, then the merge would be performed on ``[&quot;year&quot;, &quot;month&quot;]``.</span>
<span class="sd">            If one of these temporal columns already exists in the dataframe it will not</span>
<span class="sd">            be clobbered by the merge, as the suffix &quot;_temp_for_merge&quot; is added when</span>
<span class="sd">            expanding the datetime column into year, quarter, month, and day. By default,</span>
<span class="sd">            ``date_on`` will just include year.</span>
<span class="sd">        how: How the dataframes should be merged. See :func:`pandas.DataFrame.merge`.</span>
<span class="sd">        report_at_start: Whether the data in the dataframe whose report date is not being</span>
<span class="sd">            kept in the merged output (in most cases the less frequently reported dataframe)</span>
<span class="sd">            is reported at the start or end of the time period e.g. January 1st</span>
<span class="sd">            for annual data.</span>
<span class="sd">        kwargs : Additional arguments to pass to :func:`pandas.DataFrame.merge`.</span>


<span class="sd">    Returns:</span>
<span class="sd">        Merged contents of left and right input dataframes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if ``left_date_col`` or ``right_date_col`` columns are missing from their</span>
<span class="sd">            respective input dataframes.</span>
<span class="sd">        ValueError: if any of the labels referenced in ``on`` are missing from either</span>
<span class="sd">            the left or right dataframes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">separate_date_cols</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date_col_name</span><span class="p">,</span> <span class="n">date_on</span><span class="p">):</span>
        <span class="n">out_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">date_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">out_df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;year_temp_for_merge&quot;</span> <span class="ow">in</span> <span class="n">date_on</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;year_temp_for_merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
        <span class="k">if</span> <span class="s2">&quot;quarter_temp_for_merge&quot;</span> <span class="ow">in</span> <span class="n">date_on</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;quarter_temp_for_merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">quarter</span>
        <span class="k">if</span> <span class="s2">&quot;month_temp_for_merge&quot;</span> <span class="ow">in</span> <span class="n">date_on</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;month_temp_for_merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
        <span class="k">if</span> <span class="s2">&quot;day_temp_for_merge&quot;</span> <span class="ow">in</span> <span class="n">date_on</span><span class="p">:</span>
            <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;day_temp_for_merge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_df</span><span class="p">[</span><span class="n">date_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
        <span class="k">return</span> <span class="n">out_df</span>

    <span class="n">right</span> <span class="o">=</span> <span class="n">convert_col_to_datetime</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">right_date_col</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">convert_col_to_datetime</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">left_date_col</span><span class="p">)</span>
    <span class="n">date_on</span> <span class="o">=</span> <span class="n">_add_suffix_to_date_on</span><span class="p">(</span><span class="n">date_on</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">separate_date_cols</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">right_date_col</span><span class="p">,</span> <span class="n">date_on</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">separate_date_cols</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">left_date_col</span><span class="p">,</span> <span class="n">date_on</span><span class="p">)</span>
    <span class="n">merge_cols</span> <span class="o">=</span> <span class="n">date_on</span> <span class="o">+</span> <span class="n">on</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">merge_cols</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">left_date_col</span> <span class="o">==</span> <span class="n">right_date_col</span><span class="p">:</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;suffixes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;_x&quot;</span><span class="p">,</span> <span class="s2">&quot;_y&quot;</span><span class="p">])</span>
    <span class="c1"># reconstruct the new report date column and clean up columns</span>
    <span class="n">left_right_date_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">left_date_col</span> <span class="o">+</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">right_date_col</span> <span class="o">+</span> <span class="n">suffixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">report_at_start</span><span class="p">:</span>
        <span class="c1"># keep the later of the two report dates when determining</span>
        <span class="c1"># the new report date for each row</span>
        <span class="n">reconstructed_date</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">left_right_date_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># keep the earlier of the two report dates</span>
        <span class="n">reconstructed_date</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">left_right_date_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">left_right_date_col</span> <span class="o">+</span> <span class="n">date_on</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">new_date_col</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">reconstructed_date</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>



<div class="viewcode-block" id="expand_timeseries">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.expand_timeseries">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">expand_timeseries</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">key_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">,</span>
    <span class="n">fill_through_freq</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expand a dataframe to a include a full time series at a given frequency.</span>

<span class="sd">    This function adds a full timeseries to the given dataframe for each group</span>
<span class="sd">    of columns specified by ``key_cols``. The data in the timeseries will be filled</span>
<span class="sd">    with the next previous chronological observation for a group of primary key columns</span>
<span class="sd">    specified by ``key_cols``.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe to expand. Must have ``date_col`` in columns.</span>
<span class="sd">        key_cols: Column names of the non-date primary key columns in the dataframe.</span>
<span class="sd">            The resulting dataframe will have a full timeseries expanded for each</span>
<span class="sd">            unique group of these ID columns that are present in the dataframe.</span>
<span class="sd">        date_col: Name of the datetime column being expanded into a full timeseries.</span>
<span class="sd">        freq: The frequency of the time series to expand the data to.</span>
<span class="sd">            See :ref:`here &lt;timeseries.offset_aliases&gt;` for a list of</span>
<span class="sd">            frequency aliases.</span>
<span class="sd">        fill_through_freq: The frequency in which to fill in the data through. For</span>
<span class="sd">            example, if equal to &quot;year&quot; the data will be filled in through the end of</span>
<span class="sd">            the last reported year for each grouping of ``key_cols``. Valid frequencies</span>
<span class="sd">            are only &quot;year&quot;, &quot;month&quot;, or &quot;day&quot;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if ``fill_through_freq`` is not one of &quot;year&quot;, &quot;month&quot; or &quot;day&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">frequencies</span><span class="o">.</span><span class="n">to_offset</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Frequency string </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s2"> is not valid. </span><span class="se">\</span>
<span class="s2">            See Pandas Timeseries Offset Aliases docs for valid strings.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># For each group of ID columns add a dummy record with the date column</span>
    <span class="c1"># equal to one increment higher than the last record in the group for the</span>
    <span class="c1"># desired fill_through_freq.</span>
    <span class="c1"># This allows records to be filled through the end of the last reported period</span>
    <span class="c1"># and then this dummy record is dropped</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">convert_col_to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">date_col</span><span class="p">)</span>
    <span class="n">end_dates</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">key_cols</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">date_col</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">fill_through_freq</span> <span class="o">==</span> <span class="s2">&quot;year&quot;</span><span class="p">:</span>
        <span class="n">end_dates</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">end_dates</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">fill_through_freq</span> <span class="o">==</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span>
        <span class="n">end_dates</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_dates</span><span class="p">[</span>
            <span class="n">date_col</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">end_dates</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">end_dates</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">end_dates</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">fill_through_freq</span> <span class="o">==</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span>
        <span class="n">end_dates</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_dates</span><span class="p">[</span>
            <span class="n">date_col</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">end_dates</span><span class="p">[</span><span class="s2">&quot;drop_row&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">end_dates</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()])</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">date_col</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">key_cols</span><span class="p">)</span>
        <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">key_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">drop_row</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;drop_row&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="organize_cols">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.organize_cols">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">organize_cols</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Organize columns into key ID &amp; name fields &amp; alphabetical data columns.</span>

<span class="sd">    For readability, it&#39;s nice to group a few key columns at the beginning</span>
<span class="sd">    of the dataframe (e.g. report_year or report_date, plant_id...) and then</span>
<span class="sd">    put all the rest of the data columns in alphabetical order.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The DataFrame to be re-organized.</span>
<span class="sd">        cols: The columns to put first, in their desired output ordering.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: A dataframe with the same columns as the input</span>
<span class="sd">        DataFrame df, but with cols first, in the same order as they</span>
<span class="sd">        were passed in, and the remaining columns sorted alphabetically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate a list of all the columns in the dataframe that are not included in cols</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">organized_cols</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">+</span> <span class="n">data_cols</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">organized_cols</span><span class="p">]</span></div>



<div class="viewcode-block" id="simplify_strings">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.simplify_strings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">simplify_strings</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simplify the strings contained in a set of dataframe columns.</span>

<span class="sd">    Performs several operations to simplify strings for comparison and parsing purposes.</span>
<span class="sd">    These include removing Unicode control characters, stripping leading and trailing</span>
<span class="sd">    whitespace, using lowercase characters, and compacting all internal whitespace to a</span>
<span class="sd">    single space.</span>

<span class="sd">    Leaves null values unaltered. Casts other values with astype(str).</span>

<span class="sd">    Running with ``copy=False`` is intended for memory-intensive data frames where no</span>
<span class="sd">    upstream process retains a reference to the data. Use care with this option,</span>
<span class="sd">    and keep an eye out for spooky data changes showing up in unexpected places.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: DataFrame whose columns are being cleaned up.</span>
<span class="sd">        columns: The labels of the string columns to be simplified.</span>
<span class="sd">        copy: (Default True) Return a copy, making no changes to the original data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The whole DataFrame that was passed in, with the string columns cleaned up.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">copy</span> <span class="k">else</span> <span class="n">df</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">out_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">out_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">out_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\x00-\x1f\x7f-\x9f]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">out_df</span></div>



<div class="viewcode-block" id="cleanstrings_series">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.cleanstrings_series">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cleanstrings_series</span><span class="p">(</span>
    <span class="n">col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
    <span class="n">str_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="n">unmapped</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up the strings in a single column/Series.</span>

<span class="sd">    Args:</span>
<span class="sd">        col: A pandas Series, typically a single column of a</span>
<span class="sd">            dataframe, containing the freeform strings that are to be cleaned.</span>
<span class="sd">        str_map: A dictionary of lists of strings, in which the keys are</span>
<span class="sd">            the simplified canonical strings, with which each string found in</span>
<span class="sd">            the corresponding list will be replaced.</span>
<span class="sd">        unmapped: A value with which to replace any string found in col</span>
<span class="sd">            that is not found in one of the lists of strings in map. Typically</span>
<span class="sd">            the null string &#39;&#39;. If None, these strings will not be replaced.</span>
<span class="sd">        simplify: If True, strip and compact whitespace, and lowercase</span>
<span class="sd">            all strings in both the list of values to be replaced, and the</span>
<span class="sd">            values found in col. This can reduce the number of strings that</span>
<span class="sd">            need to be kept track of.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The cleaned up Series / column, suitable for replacing the original messy column</span>
<span class="sd">        in a :class:`pandas.DataFrame`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">simplify</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">str_map</span><span class="p">:</span>
            <span class="n">str_map</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">str_map</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">str_map</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">str_map</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">str_map</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unmapped</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">badstrings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(</span><span class="n">str_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c1"># This call to replace can only work if there are actually some</span>
        <span class="c1"># leftover strings to fix -- otherwise it runs forever because we</span>
        <span class="c1"># are replacing nothing with nothing.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">badstrings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">badstrings</span><span class="p">,</span> <span class="n">unmapped</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">col</span></div>



<div class="viewcode-block" id="cleanstrings">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.cleanstrings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cleanstrings</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">stringmaps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
    <span class="n">unmapped</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">simplify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Consolidate freeform strings in several dataframe columns.</span>

<span class="sd">    This function will consolidate freeform strings found in ``columns`` into simplified</span>
<span class="sd">    categories, as defined by ``stringmaps``. This is useful when a field contains many</span>
<span class="sd">    different strings that are really meant to represent a finite number of categories,</span>
<span class="sd">    e.g. a type of fuel. It can also be used to create simplified categories that apply</span>
<span class="sd">    to similar attributes that are reported in various data sources from different</span>
<span class="sd">    agencies that use their own taxonomies.</span>

<span class="sd">    The function takes and returns a pandas.DataFrame, making it suitable for use with</span>
<span class="sd">    the :func:`pandas.DataFrame.pipe` method in a chain.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: the DataFrame containing the string columns to be cleaned up.</span>
<span class="sd">        columns: a list of string column labels found in the column index of df. These</span>
<span class="sd">            are the columns that will be cleaned.</span>
<span class="sd">        stringmaps: a list of dictionaries. The keys of these dictionaries are strings,</span>
<span class="sd">            and the values are lists of strings. Each dictionary in the list corresponds</span>
<span class="sd">            to a column in columns. The keys of the dictionaries are the values with</span>
<span class="sd">            which every string in the list of values will be replaced.</span>
<span class="sd">        unmapped: the value with which strings not found in the stringmap dictionary</span>
<span class="sd">            will be replaced. Typically the null string &#39;&#39;. If None, then strings found</span>
<span class="sd">            in the columns but not in the stringmap will be left unchanged.</span>
<span class="sd">        simplify: If true, strip whitespace, remove duplicate whitespace, and force</span>
<span class="sd">            lower-case on both the string map and the values found in the columns to be</span>
<span class="sd">            cleaned. This can reduce the overall number of string values that need to be</span>
<span class="sd">            tracked.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The function returns a new DataFrame containing the cleaned strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">str_map</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">stringmaps</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">out_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">cleanstrings_series</span><span class="p">(</span>
            <span class="n">out_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">str_map</span><span class="p">,</span> <span class="n">unmapped</span><span class="o">=</span><span class="n">unmapped</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="n">simplify</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">out_df</span></div>



<div class="viewcode-block" id="fix_int_na">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.fix_int_na">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_int_na</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">float_na</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">int_na</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">str_na</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert NA containing integer columns from float to string.</span>

<span class="sd">    Numpy doesn&#39;t have a real NA value for integers. When pandas stores integer data</span>
<span class="sd">    which has NA values, it thus upcasts integers to floating point values, using np.nan</span>
<span class="sd">    values for NA. However, in order to dump some of our dataframes to CSV files for use</span>
<span class="sd">    in data packages, we need to write out integer formatted numbers, with empty strings</span>
<span class="sd">    as the NA value. This function replaces np.nan values with a sentinel value,</span>
<span class="sd">    converts the column to integers, and then to strings, finally replacing the sentinel</span>
<span class="sd">    value with the desired NA string.</span>

<span class="sd">    This is an interim solution -- now that pandas extension arrays have been</span>
<span class="sd">    implemented, we need to go back through and convert all of these integer columns</span>
<span class="sd">    that contain NA values to Nullable Integer types like Int64.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe to be fixed. This argument allows method chaining with the</span>
<span class="sd">            pipe() method.</span>
<span class="sd">        columns: A list of DataFrame column labels indicating which columns need to be</span>
<span class="sd">            reformatted for output.</span>
<span class="sd">        float_na: The floating point value to be interpreted as NA and replaced in col.</span>
<span class="sd">        int_na: Sentinel value to substitute for float_na prior to conversion of the</span>
<span class="sd">            column to integers.</span>
<span class="sd">        str_na: String value to substitute for int_na after the column has been</span>
<span class="sd">            converted to strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new DataFrame, with the selected columns converted to strings that look like</span>
<span class="sd">        integers, compatible with the postgresql COPY FROM command.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">float_na</span><span class="p">),</span> <span class="n">int_na</span><span class="p">)</span>
        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">int_na</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">},</span> <span class="n">str_na</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="month_year_to_date">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.month_year_to_date">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">month_year_to_date</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert all pairs of year/month fields in a dataframe into Date fields.</span>

<span class="sd">    This function finds all column names within a dataframe that match the</span>
<span class="sd">    regular expression &#39;_month$&#39; and &#39;_year$&#39;, and looks for pairs that have</span>
<span class="sd">    identical prefixes before the underscore. These fields are assumed to</span>
<span class="sd">    describe a date, accurate to the month.  The two fields are used to</span>
<span class="sd">    construct a new _date column (having the same prefix) and the month/year</span>
<span class="sd">    columns are then dropped.</span>

<span class="sd">    Todo:</span>
<span class="sd">        This function needs to be combined with convert_to_date, and improved:</span>
<span class="sd">        * find and use a _day$ column as well</span>
<span class="sd">        * allow specification of default month &amp; day values, if none are found.</span>
<span class="sd">        * allow specification of lists of year, month, and day columns to be</span>
<span class="sd">        combined, rather than automataically finding all the matching ones.</span>
<span class="sd">        * Do the Right Thing when invalid or NA values are encountered.</span>

<span class="sd">    Args:</span>
<span class="sd">        The DataFrame in which to convert year/months fields to Date fields.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A DataFrame in which the year/month fields have been converted into Date fields.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">month_regex</span> <span class="o">=</span> <span class="s2">&quot;_month$&quot;</span>
    <span class="n">year_regex</span> <span class="o">=</span> <span class="s2">&quot;_year$&quot;</span>
    <span class="c1"># Columns that match our month or year patterns.</span>
    <span class="n">month_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">month_regex</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">year_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">year_regex</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="c1"># Base column names that don&#39;t include the month or year pattern</span>
    <span class="n">months_base</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">month_regex</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">month_cols</span><span class="p">]</span>
    <span class="n">years_base</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">year_regex</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">year_cols</span><span class="p">]</span>

    <span class="c1"># We only want to retain columns that have BOTH month and year</span>
    <span class="c1"># matches -- otherwise there&#39;s no point in creating a Date.</span>
    <span class="n">date_base</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">months_base</span> <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">years_base</span><span class="p">]</span>

    <span class="c1"># For each base column that DOES have both a month and year,</span>
    <span class="c1"># We need to grab the real column names corresponding to each,</span>
    <span class="c1"># so we can access the values in the data frame, and use them</span>
    <span class="c1"># to create a corresponding Date column named [BASE]_date</span>
    <span class="n">month_year_date</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">date_base</span><span class="p">:</span>
        <span class="n">base_month_regex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">base</span><span class="si">}{</span><span class="n">month_regex</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">month_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">base_month_regex</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span>
        <span class="n">month_col</span> <span class="o">=</span> <span class="n">month_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">base_year_regex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">base</span><span class="si">}{</span><span class="n">year_regex</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">year_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="n">base_year_regex</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">year_col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span>
        <span class="n">year_col</span> <span class="o">=</span> <span class="n">year_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">date_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">_date&quot;</span>
        <span class="n">month_year_date</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">month_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">date_col</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">month_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">date_col</span> <span class="ow">in</span> <span class="n">month_year_date</span><span class="p">:</span>
        <span class="n">date_mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">year_col</span><span class="p">,</span> <span class="n">month_col</span><span class="p">]]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_mask</span><span class="p">,</span> <span class="n">year_col</span><span class="p">]</span>
        <span class="n">months</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_mask</span><span class="p">,</span> <span class="n">month_col</span><span class="p">]</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_mask</span><span class="p">,</span> <span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">years</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Now that we&#39;ve replaced these fields with a date, we drop them.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">month_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="convert_to_date">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.convert_to_date">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_to_date</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">date_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="n">year_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_year&quot;</span><span class="p">,</span>
    <span class="n">month_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_month&quot;</span><span class="p">,</span>
    <span class="n">day_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report_day&quot;</span><span class="p">,</span>
    <span class="n">month_na_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">day_na_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">copy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert specified year, month or day columns into a datetime object.</span>

<span class="sd">    If the input ``date_col`` already exists in the input dataframe, then no</span>
<span class="sd">    conversion is applied, and the original dataframe is returned unchanged.</span>
<span class="sd">    Otherwise the constructed date is placed in that column, and the columns</span>
<span class="sd">    which were used to create the date are dropped.</span>

<span class="sd">    Running with ``copy=False`` is intended for memory-intensive data frames where no</span>
<span class="sd">    upstream process retains a reference to the data. Use care with this option,</span>
<span class="sd">    and keep an eye out for spooky data changes showing up in unexpected places.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: dataframe to convert</span>
<span class="sd">        date_col: the name of the column you want in the output.</span>
<span class="sd">        year_col: the name of the year column in the original table.</span>
<span class="sd">        month_col: the name of the month column in the original table.</span>
<span class="sd">        day_col: the name of the day column in the original table.</span>
<span class="sd">        month_na_value: generated month if no month exists or if the month</span>
<span class="sd">            value is NA.</span>
<span class="sd">        day_na_value: generated day if no day exists or if the day value is NA.</span>
<span class="sd">        copy: (default True) return a copy, making no changes to the original data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A DataFrame in which the year, month, day columns values have been converted</span>
<span class="sd">        into datetime objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">date_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="n">year</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">year_col</span><span class="p">]</span>

    <span class="n">month</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">month_na_value</span>
        <span class="k">if</span> <span class="n">month_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">else</span> <span class="n">df</span><span class="p">[</span><span class="n">month_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">month_na_value</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">day</span> <span class="o">=</span> <span class="n">day_na_value</span> <span class="k">if</span> <span class="n">day_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">df</span><span class="p">[</span><span class="n">day_col</span><span class="p">]</span>

    <span class="n">df</span><span class="p">[</span><span class="n">date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">({</span><span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">month</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">})</span>
    <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">day_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">month_col</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PD002</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="remove_leading_zeros_from_numeric_strings">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.remove_leading_zeros_from_numeric_strings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_leading_zeros_from_numeric_strings</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove leading zeros frame column values that are numeric strings.</span>

<span class="sd">    Sometimes an ID column (like generator_id or unit_id) will be reported with leading</span>
<span class="sd">    zeros and sometimes it won&#39;t. For example, in the Excel spreadsheets published by</span>
<span class="sd">    EIA, the same generator may show up with the ID &quot;0001&quot; and &quot;1&quot; in different years</span>
<span class="sd">    This function strips the leading zeros from those numeric strings so the data can</span>
<span class="sd">    be mapped across years and datasets more reliably.</span>

<span class="sd">    Alphanumeric generator IDs with leadings zeroes are not affected, as we found no</span>
<span class="sd">    instances in which an alphanumeric ID appeared both with and without leading zeroes.</span>
<span class="sd">    The ID &quot;0A1&quot; will stay &quot;0A1&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A DataFrame containing the column you&#39;d like to remove numeric leading zeros</span>
<span class="sd">            from.</span>
<span class="sd">        col_name: The name of the column you&#39;d like to remove numeric leading zeros</span>
<span class="sd">            from.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A DataFrame without leading zeros for numeric string values in the desired</span>
<span class="sd">        column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">leading_zeros</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^0+\d+$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leading_zeros</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fixing leading zeros in </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2"> column&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">leading_zeros</span><span class="p">,</span> <span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;^0+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found no numeric leading zeros in </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="standardize_na_values">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.standardize_na_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize_na_values</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace common apparently NA values in numerical columns with the floating point np.nan.</span>

<span class="sd">    Currently replaces the empty string, any string entirely composed of whitespace,</span>
<span class="sd">    bare decimal points, and any string entirely composed of hyphens, all of which are</span>
<span class="sd">    common stand-ins for NA in spreadsheets. Note that this function should only be</span>
<span class="sd">    applied to columns whose true type is expected to be numeric.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The DataFrame to clean.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with regularized NA values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define a regex pattern to match ill-posed NA values</span>
    <span class="n">na_patterns</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(^\.$|^\s*$|^-+$)&quot;</span>

    <span class="c1"># Replace matching patterns in all object columns with np.nan</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">na_patterns</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="simplify_columns">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.simplify_columns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">simplify_columns</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simplify column labels for use as snake_case database fields.</span>

<span class="sd">    All column labels will be simplified by:</span>

<span class="sd">    * Replacing all non-alphanumeric characters with spaces.</span>
<span class="sd">    * Forcing all letters to be lower case.</span>
<span class="sd">    * Compacting internal whitespace to a single &quot; &quot;.</span>
<span class="sd">    * Stripping leading and trailing whitespace.</span>
<span class="sd">    * Replacing all remaining whitespace with underscores.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The DataFrame whose column labels to simplify.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dataframe with simplified column names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Do nothing, if empty dataframe (e.g. mocked for tests)</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^0-9a-zA-Z]+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="drop_tables">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.drop_tables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">drop_tables</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">Engine</span><span class="p">,</span> <span class="n">clobber</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drops all tables from a SQLite database.</span>

<span class="sd">    Creates an sa.schema.MetaData object reflecting the structure of the</span>
<span class="sd">    database that the passed in ``engine`` refers to, and uses that schema to</span>
<span class="sd">    drop all existing tables.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine: An SQL Alchemy SQLite database Engine pointing at an existing SQLite</span>
<span class="sd">            database to be deleted.</span>
<span class="sd">        clobber: Whether or not to allow a non-empty DB to be removed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if clobber is False and there are any tables in the database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">MetaData</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">md</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">insp</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">insp</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Attempting to drop database at </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2"> while clobber is </span><span class="si">{</span><span class="n">clobber</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">md</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">exec_driver_sql</span><span class="p">(</span><span class="s2">&quot;VACUUM&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="merge_dicts">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.merge_dicts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_dicts</span><span class="p">(</span><span class="n">lods</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge multiple dictionaries together.</span>

<span class="sd">    Given any number of dicts, shallow copy and merge into a new dict, precedence goes</span>
<span class="sd">    to key value pairs in latter dicts within the input list.</span>

<span class="sd">    Args:</span>
<span class="sd">        lods: a list of dictionaries.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A single merged dictionary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">lods</span><span class="p">:</span>
        <span class="n">merged</span> <span class="o">|=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">merged</span></div>



<div class="viewcode-block" id="convert_cols_dtypes">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.convert_cols_dtypes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_cols_dtypes</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a PUDL dataframe&#39;s columns to the correct data type.</span>

<span class="sd">    Boolean type conversions created a special problem, because null values in</span>
<span class="sd">    boolean columns get converted to True (which is bonkers!)... we generally</span>
<span class="sd">    want to preserve the null values and definitely don&#39;t want them to be True,</span>
<span class="sd">    so we are keeping those columns as objects and preforming a simple mask for</span>
<span class="sd">    the boolean columns.</span>

<span class="sd">    The other exception in here is with the ``utility_id_eia`` column. It is</span>
<span class="sd">    often an object column of strings. All of the strings are numbers, so it</span>
<span class="sd">    should be possible to convert to :func:`pandas.Int32Dtype` directly, but it</span>
<span class="sd">    is requiring us to convert to int first. There will probably be other</span>
<span class="sd">    columns that have this problem... and hopefully pandas just enables this</span>
<span class="sd">    direct conversion.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: dataframe with columns that appear in the PUDL tables.</span>
<span class="sd">        data_source: the name of the datasource (eia, ferc1, etc.)</span>
<span class="sd">        name: name of the table (for logging only!)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Input dataframe, but with column types as specified by</span>
<span class="sd">        :py:const:`pudl.metadata.fields.FIELD_METADATA`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get me all of the columns for the table in the constants dtype dict</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">col</span><span class="p">:</span> <span class="n">dtype</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">get_pudl_dtypes</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="n">data_source</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">}</span>

    <span class="c1"># grab only the boolean columns (we only need their names)</span>
    <span class="n">bool_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dtypes</span> <span class="k">if</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;boolean&quot;</span><span class="p">]</span>
    <span class="c1"># grab all of the non boolean columns</span>
    <span class="n">non_bool_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dtypes</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bool_cols</span><span class="p">}</span>
    <span class="c1"># Grab only the string columns...</span>
    <span class="n">string_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dtypes</span> <span class="k">if</span> <span class="n">dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">bool_cols</span><span class="p">:</span>
        <span class="c1"># Bc the og bool values were sometimes coming across as actual bools or</span>
        <span class="c1"># strings, for some reason we need to map both types (I&#39;m not sure</span>
        <span class="c1"># why!). We use na_action to preserve the og NaN&#39;s. I&#39;ve also added in</span>
        <span class="c1"># the string version of a null value bc I am sure it will exist.</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;nan&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converting the dtypes of: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># unfortunately, the pd.Int32Dtype() doesn&#39;t allow a conversion from object</span>
    <span class="c1"># columns to this nullable int type column. `utility_id_eia` shows up as a</span>
    <span class="c1"># column of strings (!) of numbers so it is an object column, and therefor</span>
    <span class="c1"># needs to be converted beforehand.</span>
    <span class="c1"># we want to be able to use this dtype cleaning at many stages, and</span>
    <span class="c1"># sometimes this column has been converted to a float and therefore</span>
    <span class="c1"># we need to skip this conversion</span>
    <span class="k">if</span> <span class="s2">&quot;utility_id_eia&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">utility_id_eia</span><span class="o">.</span><span class="n">dtypes</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span>
        <span class="s2">&quot;object&quot;</span>
    <span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;float&quot;</span><span class="p">})</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">non_bool_cols</span><span class="p">)</span>
        <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">bool_cols</span><span class="p">,</span> <span class="s2">&quot;boolean&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">string_cols</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="s2">&quot;&lt;NA&gt;&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">string_cols</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Zip codes are highly correlated with datatype. If they datatype gets</span>
    <span class="c1"># converted at any point it may mess up the accuracy of the data. For</span>
    <span class="c1"># example: 08401.0 or 8401 are both incorrect versions of 08401 that a</span>
    <span class="c1"># simple datatype conversion cannot fix. For this reason, we use the</span>
    <span class="c1"># zero_pad_numeric_string function.</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;zip_code&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">zip_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;zip_code&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">zip_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;4&quot;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_pad_numeric_string</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">n_digits</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_pad_numeric_string</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">n_digits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="generate_rolling_avg">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.generate_rolling_avg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_rolling_avg</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">data_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a rolling average.</span>

<span class="sd">    For a given dataframe with a ``report_date`` column, generate a monthly</span>
<span class="sd">    rolling average and use this rolling average to impute missing values.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Original dataframe. Must have group_cols column, a data_col column and a</span>
<span class="sd">            ``report_date`` column.</span>
<span class="sd">        group_cols: a list of columns to groupby.</span>
<span class="sd">        data_col: the name of the data column.</span>
<span class="sd">        window: rolling window argument to pass to :meth:`pandas.Series.rolling`.</span>
<span class="sd">        kwargs: Additional arguments to pass to :meth:`pandas.Series.rolling`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with an additional rolling average column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;report_date&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">})</span>
    <span class="c1"># create a full date range for this df</span>
    <span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">]),</span>
            <span class="n">end</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">]),</span>
            <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tmp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># assigning a temp column to merge on</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">tmp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># assigning a temp column to merge on</span>
    <span class="p">)</span>
    <span class="c1"># merge the date range and the groups together</span>
    <span class="c1"># to get the backbone/complete date range/groups</span>
    <span class="n">bones</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">date_range</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;tmp&quot;</span><span class="p">)</span>  <span class="c1"># drop the temp column</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="c1"># with the aggregated data, get a rolling average</span>
    <span class="n">bones</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_rolling&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bones</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">group_cols</span><span class="p">)[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">bones</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>



<div class="viewcode-block" id="fillna_w_rolling_avg">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.fillna_w_rolling_avg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fillna_w_rolling_avg</span><span class="p">(</span>
    <span class="n">df_og</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">group_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">data_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill NA values with a rolling average.</span>

<span class="sd">    Imputes null values from a dataframe using a rolling monthly average.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_og: Original dataframe. Must have ``group_cols`` columns, a ``data_col``</span>
<span class="sd">            column and a ``report_date`` column.</span>
<span class="sd">        group_cols: a list of columns to groupby.</span>
<span class="sd">        data_col: the name of the data column we&#39;re trying to fill.</span>
<span class="sd">        window: rolling window to pass to :meth:`pandas.Series.rolling`.</span>
<span class="sd">        kwargs: Additional arguments to pass to :meth:`pandas.Series.rolling`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: dataframe with nulls filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_og</span> <span class="o">=</span> <span class="n">df_og</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;report_date&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">})</span>
    <span class="n">df_roll</span> <span class="o">=</span> <span class="n">generate_rolling_avg</span><span class="p">(</span><span class="n">df_og</span><span class="p">,</span> <span class="n">group_cols</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">df_roll</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_roll</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_roll</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_rolling&quot;</span><span class="p">])</span>
    <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_og</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">df_roll</span><span class="p">[</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="n">data_col</span><span class="p">]],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_rollfilled&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">df_new</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_new</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_rollfilled&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df_new</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_rollfilled&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="groupby_agg_label_unique_source_or_mixed">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.groupby_agg_label_unique_source_or_mixed">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">groupby_agg_label_unique_source_or_mixed</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get either the unique source in a group or return mixed.</span>

<span class="sd">    Custom function for groupby.agg. Written specifically for</span>
<span class="sd">    aggregating records with fuel_cost_per_mmbtu_source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;mixed&quot;</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
    <span class="k">return</span> <span class="n">source</span></div>



<div class="viewcode-block" id="count_records">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.count_records">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">count_records</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">new_count_col_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count the number of unique records in group in a dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: dataframe you would like to groupby and count.</span>
<span class="sd">        cols: list of columns to group and count by.</span>
<span class="sd">        new_count_col_name: the name that will be assigned to the column that will</span>
<span class="sd">            contain the count.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame containing only ``cols`` and ``new_count_col_name``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">count_me</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">count_me</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;count_me&quot;</span><span class="p">:</span> <span class="n">new_count_col_name</span><span class="p">})</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="cleanstrings_snake">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.cleanstrings_snake">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">cleanstrings_snake</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the strings in a columns in a dataframe with snake case.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: original dataframe.</span>
<span class="sd">        cols: list of columns in to apply snake case to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="zero_pad_numeric_string">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.zero_pad_numeric_string">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">zero_pad_numeric_string</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">n_digits</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up fixed-width leading zero padded numeric (e.g. ZIP, FIPS) codes.</span>

<span class="sd">    Often values like ZIP and FIPS codes are stored as integers, or get</span>
<span class="sd">    converted to floating point numbers because there are NA values in the</span>
<span class="sd">    column. Sometimes other non-digit strings are included like Canadian</span>
<span class="sd">    postal codes mixed in with ZIP codes, or IMP (imported) instead of a</span>
<span class="sd">    FIPS county code. This function attempts to manage these irregularities</span>
<span class="sd">    and produce either fixed-width leading zero padded strings of digits</span>
<span class="sd">    having a specified length (n_digits) or NA.</span>

<span class="sd">    * Convert the Series to a nullable string.</span>
<span class="sd">    * Remove any decimal point and all digits following it.</span>
<span class="sd">    * Remove any non-digit characters.</span>
<span class="sd">    * Replace any empty strings with NA.</span>
<span class="sd">    * Replace any strings longer than n_digits with NA.</span>
<span class="sd">    * Pad remaining digit-only strings to n_digits length.</span>
<span class="sd">    * Replace (invalid) all-zero codes with NA.</span>

<span class="sd">    Args:</span>
<span class="sd">        col: The Series to clean. May be numeric, string, object, etc.</span>
<span class="sd">        n_digits: the desired length of the output strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A Series of nullable strings, containing only all-numeric strings</span>
<span class="sd">        having length n_digits, padded with leading zeroes if necessary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_col</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">col</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
        <span class="c1"># Remove decimal points and any digits following them.</span>
        <span class="c1"># This turns floating point strings into integer strings</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[\.]+\d*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Remove any whitespace</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Replace anything that&#39;s not entirely digits with NA</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\d]+&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Set any string longer than n_digits to NA</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="se">\\</span><span class="s2">d]</span><span class="se">{{</span><span class="si">{</span><span class="n">n_digits</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">,</span><span class="se">}}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Pad the numeric string with leading zeroes to n_digits length</span>
        <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">n_digits</span><span class="p">)</span>
        <span class="c1"># All-zero ZIP &amp; FIPS codes are invalid.</span>
        <span class="c1"># Also catches empty strings that were zero padded.</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">n_digits</span> <span class="o">*</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">})</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;^[</span><span class="se">\\</span><span class="s2">d]</span><span class="se">{{</span><span class="si">{</span><span class="n">n_digits</span><span class="si">}</span><span class="se">}}</span><span class="s2">$&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to generate zero-padded numeric strings of length </span><span class="si">{</span><span class="n">n_digits</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">out_col</span></div>



<div class="viewcode-block" id="iterate_multivalue_dict">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.iterate_multivalue_dict">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">iterate_multivalue_dict</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make dicts from dict with main dict key and one value of main dict.</span>

<span class="sd">    If kwargs is {&#39;form;: &#39;gas_distribution&#39;, &#39;years&#39;: [2019, 2020]}, it will yield these results:</span>
<span class="sd">        {&#39;form&#39;: &#39;gas_distribution&#39;, &#39;years&#39;: 2019}</span>
<span class="sd">        {&#39;form&#39;: &#39;gas_distribution&#39;, &#39;years&#39;: 2020}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">single_valued</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1"># Transform multi-valued {k: vlist} into {k1: [{k1: v1}, {k1: v2}, ...], k2: [...], ...}</span>
    <span class="n">multi_valued</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">}</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vlist</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">vlist</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">vlist</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">value_assignments</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">multi_valued</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">single_valued</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k_v</span> <span class="ow">in</span> <span class="n">value_assignments</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">k_v</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">result</span></div>



<div class="viewcode-block" id="dedupe_on_category">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.dedupe_on_category">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dedupe_on_category</span><span class="p">(</span>
    <span class="n">dedup_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">base_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">category_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sorter</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deduplicate a df using a sorted category to retain preferred values.</span>

<span class="sd">    Use a sorted category column to retain your preferred values when a</span>
<span class="sd">    dataframe is deduplicated.</span>

<span class="sd">    Args:</span>
<span class="sd">        dedup_df: the dataframe with the records to deduplicate.</span>
<span class="sd">        base_cols: list of columns which must not be duplicated.</span>
<span class="sd">        category_name: name of the categorical column to order values for deduplication.</span>
<span class="sd">        sorter: sorted list of categorical values found in the ``category_name`` column.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The deduplicated dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dedup_df</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dedup_df</span><span class="p">[</span><span class="n">category_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">CategoricalDtype</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="n">sorter</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">dedup_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">base_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="dedupe_and_drop_nas">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.dedupe_and_drop_nas">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dedupe_and_drop_nas</span><span class="p">(</span>
    <span class="n">dedup_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">primary_key_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Deduplicate a df by comparing primary key columns and dropping null rows.</span>

<span class="sd">    When a primary key appears twice in a dataframe, and one record is all null other</span>
<span class="sd">    than the primary keys, drop the null row.</span>

<span class="sd">    Args:</span>
<span class="sd">        dedup_df: the dataframe with the records to deduplicate.</span>
<span class="sd">        primary_key_cols: list of columns which must not be duplicated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The deduplicated dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dupes</span> <span class="o">=</span> <span class="n">dedup_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dedup_df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">primary_key_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="n">dupe_groups</span> <span class="o">=</span> <span class="n">dupes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">primary_key_cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dupe_groups</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># noqa: PD101</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Duplicate records with disagreeing data: </span><span class="si">{</span><span class="n">dupes</span><span class="p">[</span><span class="n">dupes</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">primary_key_cols</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">deduped</span> <span class="o">=</span> <span class="n">dupe_groups</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="c1"># replace the duplicated rows with the deduped versions</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">dedup_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">primary_key_cols</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">deduped</span><span class="p">],</span>
        <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="drop_records_with_null_in_column">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.drop_records_with_null_in_column">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">drop_records_with_null_in_column</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_of_expected_nulls</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop a prescribed number of records with null values in a column.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: table with column to check.</span>
<span class="sd">        column: name of column with potential null values.</span>
<span class="sd">        num_of_expected_nulls: the number of records with null values in the column</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If there are more nulls in the df then the</span>
<span class="sd">            num_of_expected_nulls.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ensure there isn&#39;t more than the expected number of nulls before dropping</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">null_records</span> <span class="o">:=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()])</span> <span class="o">&gt;</span> <span class="n">num_of_expected_nulls</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected </span><span class="si">{</span><span class="n">num_of_expected_nulls</span><span class="si">}</span><span class="s2"> or less records with a null values </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> but found </span><span class="si">{</span><span class="n">null_records</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span></div>



<div class="viewcode-block" id="standardize_percentages_ratio">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.standardize_percentages_ratio">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize_percentages_ratio</span><span class="p">(</span>
    <span class="n">frac_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">mixed_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">years_to_standardize</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardize year-to-year changes in mixed percentage/ratio reporting in a column.</span>

<span class="sd">    When a column uses both 0-1 and 0-100 scales to describe percentages, standardize</span>
<span class="sd">    the years using 0-100 scales to 0-1 ratios/fractions.</span>

<span class="sd">    Args:</span>
<span class="sd">        frac_df: the dataframe with the columns to standardize.</span>
<span class="sd">        mixed_cols: list of columns which should get standardized to the 0-1 scale.</span>
<span class="sd">        years_to_standardize: range of dates over which the standardization should occur.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The standardized dataframe.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standardizing ratios and percentages for </span><span class="si">{</span><span class="n">mixed_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mixed_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">frac_df</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: Standardization method requires numeric dtype.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;report_year&quot;</span> <span class="ow">in</span> <span class="n">frac_df</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">years_to_standardize</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">frac_df</span><span class="o">.</span><span class="n">report_year</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">years_to_standardize</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;report_date&quot;</span> <span class="ow">in</span> <span class="n">frac_df</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_df</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">years_to_standardize</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">frac_df</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">years_to_standardize</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">frac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dates</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="n">frac_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: Values &gt;100pct observed: </span><span class="si">{</span><span class="n">frac_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">frac_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">frac_df</span></div>



<div class="viewcode-block" id="calc_capacity_factor">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.calc_capacity_factor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_capacity_factor</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;YS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">],</span>
    <span class="n">min_cap_fact</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_cap_fact</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate capacity factor.</span>

<span class="sd">    Capacity factor is calculated from the capacity, the net generation over a</span>
<span class="sd">    time period and the hours in that same time period. The dates from that</span>
<span class="sd">    dataframe are pulled out to determine the hours in each period based on</span>
<span class="sd">    the frequency. The number of hours is used in calculating the capacity</span>
<span class="sd">    factor. Then records with capacity factors outside the range specified by</span>
<span class="sd">    ``min_cap_fact`` and ``max_cap_fact`` are dropped.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: table with required inputs for capacity factor (``report_date``,</span>
<span class="sd">            ``net_generation_mwh`` and ``capacity_mw``).</span>
<span class="sd">        freq: String describing time frequency at which to aggregate the reported data,</span>
<span class="sd">            such as ``MS`` (month start) or ``YS`` (annual start).</span>
<span class="sd">        min_cap_fact: Lower bound, below which values are set to NaN. If None, don&#39;t use</span>
<span class="sd">            a lower bound. Default is None.</span>
<span class="sd">        max_cap_fact: Upper bound, below which values are set to NaN.  If None, don&#39;t</span>
<span class="sd">            use an upper bound. Default is None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Modified version of the input DataFrame with an additional ``capacity_factor``</span>
<span class="sd">        column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get a unique set of dates to generate the number of hours</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">dates_to_hours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;report_date&quot;</span><span class="p">:</span> <span class="n">dates</span><span class="p">,</span>
            <span class="s2">&quot;hours&quot;</span><span class="p">:</span> <span class="n">dates</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">/</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># merge in the hours for the calculation</span>
        <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dates_to_hours</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">])</span>
        <span class="c1"># actually calculate capacity factor wooo!</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">capacity_factor</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">hours</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Replace unrealistic capacity factors with NaN</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">oob_to_nan</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;capacity_factor&quot;</span><span class="p">],</span> <span class="n">lb</span><span class="o">=</span><span class="n">min_cap_fact</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">max_cap_fact</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;hours&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="weighted_average">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.weighted_average">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">weighted_average</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">data_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">weight_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a weighted average.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A DataFrame containing, at minimum, the columns specified in the other</span>
<span class="sd">            parameters data_col and weight_col.</span>
<span class="sd">        data_col: column name of data column to average</span>
<span class="sd">        weight_col: column name to weight on</span>
<span class="sd">        by: List of columns to group by when calculating the weighted average value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A table with ``by`` columns as the index and the weighted ``data_col``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_data_times_weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">weight_col</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_weight_where_notnull&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">weight_col</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;_data_times_weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;_weight_where_notnull&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">min_count</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="k">del</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_data_times_weight&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_weight_where_notnull&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">data_col</span><span class="p">)</span>  <span class="c1"># .reset_index()</span></div>



<div class="viewcode-block" id="sum_and_weighted_average_agg">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.sum_and_weighted_average_agg">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">sum_and_weighted_average_agg</span><span class="p">(</span>
    <span class="n">df_in</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">sum_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">wtavg_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate dataframe by summing and using weighted averages.</span>

<span class="sd">    Many times we want to aggregate a data table using the same groupby columns but with</span>
<span class="sd">    different aggregation methods. This function combines two of our most common</span>
<span class="sd">    aggregation methods (summing and applying a weighted average) into one function.</span>
<span class="sd">    Because pandas does not have a built-in weighted average method for groupby we use</span>
<span class="sd">    :func:``weighted_average``.</span>

<span class="sd">    Args:</span>
<span class="sd">        df_in: input table to aggregate. Must have columns in ``id_cols``, ``sum_cols``</span>
<span class="sd">            and keys from ``wtavg_dict``.</span>
<span class="sd">        by: columns to group/aggregate based on. These columns will be passed as an</span>
<span class="sd">            argument into grouby as ``by`` arg.</span>
<span class="sd">        sum_cols: columns to sum.</span>
<span class="sd">        wtavg_dict: dictionary of columns to average (keys) and columns to weight by</span>
<span class="sd">           (values).</span>

<span class="sd">    Returns:</span>
<span class="sd">        table with join of columns from ``by``, ``sum_cols`` and keys of ``wtavg_dict``.</span>
<span class="sd">        Primary key of table will be ``by``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;grouping by </span><span class="si">{</span><span class="n">by</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># we are keeping the index here for easy merging of the weighted cols below</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">sum_cols</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="n">min_count</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">weight_col</span> <span class="ow">in</span> <span class="n">wtavg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df_out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">data_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">weighted_average</span><span class="p">(</span>
            <span class="n">df_in</span><span class="p">,</span> <span class="n">data_col</span><span class="o">=</span><span class="n">data_col</span><span class="p">,</span> <span class="n">weight_col</span><span class="o">=</span><span class="n">weight_col</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="n">by</span>
        <span class="p">)[</span><span class="n">data_col</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_eia_ferc_acct_map">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.get_eia_ferc_acct_map">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_eia_ferc_acct_map</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get map of EIA technology_description/pm codes &lt;&gt; ferc accounts.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: table which maps the combination of EIA&#39;s technology</span>
<span class="sd">            description and prime mover code to FERC Uniform System of Accounts</span>
<span class="sd">            (USOA) accounting names. Read more about USOA</span>
<span class="sd">            `here</span>
<span class="sd">            &lt;https://www.ferc.gov/enforcement-legal/enforcement/accounting-matters&gt;`__</span>
<span class="sd">            The output table has the following columns: ``[&#39;technology_description&#39;,</span>
<span class="sd">            &#39;prime_mover_code&#39;, &#39;ferc_acct_name&#39;]``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eia_ferc_acct_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s2">&quot;pudl.package_data.glue&quot;</span><span class="p">)</span>
        <span class="o">/</span> <span class="s2">&quot;ferc_acct_to_pm_tech_map.csv&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">eia_ferc_acct_map</span></div>



<div class="viewcode-block" id="dedupe_n_flatten_list_of_lists">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.dedupe_n_flatten_list_of_lists">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dedupe_n_flatten_list_of_lists</span><span class="p">(</span><span class="n">mega_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flatten a list of lists and remove duplicates.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">({</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">mega_list</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">})</span></div>



<div class="viewcode-block" id="flatten_list">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.flatten_list">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flatten_list</span><span class="p">(</span><span class="n">xs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flatten an irregular (arbitrarily nested) list of lists (or sets).</span>

<span class="sd">    Inspiration from</span>
<span class="sd">    `here &lt;https://stackoverflow.com/questions/2158395/flatten-an-irregular-arbitrarily-nested-list-of-lists&gt;`__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">yield from</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">x</span></div>



<div class="viewcode-block" id="convert_df_to_excel_file">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.convert_df_to_excel_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_df_to_excel_file</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a :class:`pandas.DataFrame` into a :class:`pandas.ExcelFile`.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The DataFrame to convert.</span>
<span class="sd">        kwargs: Additional arguments to pass into :meth:`pandas.to_excel`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The contents of the input DataFrame, represented as an ExcelFile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bio</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;xlsxwriter&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">bio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelFile</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;calamine&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_asset_keys">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.get_asset_keys">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_asset_keys</span><span class="p">(</span>
    <span class="n">assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AssetsDefinition</span><span class="p">],</span> <span class="n">exclude_asset_specs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="n">AssetKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a set of asset keys from a list of asset definitions.</span>

<span class="sd">    Args:</span>
<span class="sd">        assets: list of asset definitions.</span>
<span class="sd">        exclude_asset_specs: exclude AssetSpecs in the returned list.</span>
<span class="sd">            Some selection operations don&#39;t allow AssetSpec keys.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A set of asset keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asset_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">asset</span><span class="p">,</span> <span class="n">AssetSpec</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude_asset_specs</span><span class="p">:</span>
                <span class="n">asset_keys</span> <span class="o">=</span> <span class="n">asset_keys</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">asset_keys</span> <span class="o">=</span> <span class="n">asset_keys</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">asset_keys</span></div>



<div class="viewcode-block" id="get_asset_group_keys">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.get_asset_group_keys">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_asset_group_keys</span><span class="p">(</span>
    <span class="n">asset_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">all_assets</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AssetsDefinition</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of asset names in a given asset group.</span>

<span class="sd">    Args:</span>
<span class="sd">        asset_group: the name of the asset group.</span>
<span class="sd">        all_assets: the collection of assets to select the group from.</span>

<span class="sd">    Return:</span>
<span class="sd">        A list of asset names in the asset_group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asset_keys</span> <span class="o">=</span> <span class="n">AssetSelection</span><span class="o">.</span><span class="n">groups</span><span class="p">(</span><span class="n">asset_group</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">all_assets</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">asset</span><span class="o">.</span><span class="n">to_python_identifier</span><span class="p">()</span> <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">)]</span></div>



<div class="viewcode-block" id="convert_col_to_bool">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.convert_col_to_bool">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_col_to_bool</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">true_values</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">false_values</span><span class="p">:</span> <span class="nb">list</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turn a column into a boolean while preserving NA values.</span>

<span class="sd">    You don&#39;t have to specify NA as true or false - it will preserve it&#39;s NA-ness unless</span>
<span class="sd">    you add it to one of the input true/false lists.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The dataframe containing the column you want to change.</span>
<span class="sd">        col_name: The name of the column you want to turn into a boolean (must be an</span>
<span class="sd">            existing column, not a new column name).</span>
<span class="sd">        true_values: The list of values in col_name that you want to be marked as True.</span>
<span class="sd">        false_values: The list of values appearing in col_name that you want to be</span>
<span class="sd">            False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: if there are non-NA values in col_name that aren&#39;t specified in</span>
<span class="sd">            true_values or false_values.</span>
<span class="sd">        AssertionError: if there are values that appear in both true_values and</span>
<span class="sd">            false_values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: The original dataframe with col_name as a boolean column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure inputs are valid</span>
    <span class="k">if</span> <span class="n">unspecified_values</span> <span class="o">:=</span> <span class="p">[</span>
        <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">true_values</span> <span class="o">+</span> <span class="n">false_values</span>
    <span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Found values besides NA that are not categorized as True or False: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">unspecified_values</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">true_values</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">false_values</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Duplicate values in true and false! You can only pick one.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Set values as true or value. Astype boolean should preserve NA values.</span>
    <span class="c1"># This is easier than building an input dictionary for pandas map or replace</span>
    <span class="c1"># functions.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">true_values</span><span class="p">),</span> <span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">false_values</span><span class="p">),</span> <span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;boolean&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="fix_boolean_columns">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.fix_boolean_columns">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fix_boolean_columns</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">boolean_columns_to_fix</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fix standard issues with boolean columns.</span>

<span class="sd">    Most boolean columns have either &quot;Y&quot; for True or &quot;N&quot; for False. A subset of the</span>
<span class="sd">    columns have &quot;X&quot; values which represents a False value. A subset of the columns</span>
<span class="sd">    have &quot;U&quot; values, presumably for &quot;Unknown,&quot; which must be set to null in order to</span>
<span class="sd">    convert the columns to datatype Boolean. Other data sources may use a 1/0 system</span>
<span class="sd">    instead, with 1 as True and 0 as False.</span>

<span class="sd">    If running with ``inplace=True``, will run in-place versions of the fill and</span>
<span class="sd">    replace operations instead of returning a copy of the data frame. This mode is</span>
<span class="sd">    useful for memory-intensive data frames, but be aware that upstream processes</span>
<span class="sd">    retaining a reference to the data will see the changes made here.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fillna_cols</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">boolean_columns_to_fix</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
    <span class="n">boolean_replace_cols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">col</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">boolean_columns_to_fix</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fillna_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PD002</span>
        <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">boolean_replace_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PD002</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">fillna_cols</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">boolean_replace_cols</span><span class="p">)</span></div>



<div class="viewcode-block" id="scale_by_ownership">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.scale_by_ownership">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scale_by_ownership</span><span class="p">(</span>
    <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">own_eia860</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">scale_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
    <span class="n">validate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1:m&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate proportional data by ownership %s.</span>

<span class="sd">    Why do we have to do this at all? Sometimes generators are owned by</span>
<span class="sd">    many different utility owners that own slices of that generator. EIA</span>
<span class="sd">    reports which portion of each generator is owned by which utility</span>
<span class="sd">    relatively clearly in their ownership table. On the other hand, in</span>
<span class="sd">    FERC1, sometimes a partial owner reports the full plant-part, sometimes</span>
<span class="sd">    they report only their ownership portion of the plant-part. And of</span>
<span class="sd">    course it is not labeled in FERC1. Because of this, we need to compile</span>
<span class="sd">    all of the possible ownership slices of the EIA generators.</span>

<span class="sd">    In order to accumulate every possible version of how a generator could</span>
<span class="sd">    be reported, this method generates two records for each generator&#39;s</span>
<span class="sd">    reported owners: one of the portion of the plant part they own and one</span>
<span class="sd">    for the plant-part as a whole. The portion records are labeled in the</span>
<span class="sd">    ``ownership_record_type`` column as &quot;owned&quot; and the total records are labeled as</span>
<span class="sd">    &quot;total&quot;.</span>

<span class="sd">    In this function we merge in the ownership table so that generators</span>
<span class="sd">    with multiple owners then have one record per owner with the</span>
<span class="sd">    ownership fraction (in column ``fraction_owned``). Because the ownership</span>
<span class="sd">    table only contains records for generators that have multiple owners,</span>
<span class="sd">    we assume that all other generators are owned 100% by their operator.</span>
<span class="sd">    Then we generate the &quot;total&quot; records by duplicating the &quot;owned&quot; records</span>
<span class="sd">    but assigning the ``fraction_owned`` to be 1 (i.e. 100%).</span>

<span class="sd">    Arguments:</span>
<span class="sd">        gens: table with records at the generator level and generator attributes</span>
<span class="sd">            to be scaled by ownership, must have columns ``plant_id_eia``,</span>
<span class="sd">            ``generator_id``, and ``report_date``</span>
<span class="sd">        own_eia860: the ``core_eia860__scd_ownership`` table</span>
<span class="sd">        scale_cols: a list of columns in the generator table to slice by ownership</span>
<span class="sd">            fraction</span>
<span class="sd">        validate: how to validate merging the ownership table onto the</span>
<span class="sd">            generators table</span>
<span class="sd">    Returns:</span>
<span class="sd">        Table of generator records with ``scale_cols`` sliced by ownership fraction</span>
<span class="sd">        such that there is a &quot;total&quot; and &quot;owned&quot; record for each generator owner.</span>
<span class="sd">        The &quot;owned&quot; records have the generator&#39;s data scaled to the ownership</span>
<span class="sd">        percentage (e.g. if a 200 MW generator has a 75% stake owner and a 25%</span>
<span class="sd">        stake owner, this will result in two &quot;owned&quot; records with 150 MW and 50 MW).</span>
<span class="sd">        The &quot;total&quot; records correspond to the full plant for every owner (e.g. using</span>
<span class="sd">        the same 2-owner 200 MW generator as above, each owner will have a</span>
<span class="sd">        records with 200 MW).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># grab the ownership table, and reduce it to only the columns we need</span>
    <span class="n">own860</span> <span class="o">=</span> <span class="n">own_eia860</span><span class="p">[</span>
        <span class="p">[</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fraction_owned&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">convert_cols_dtypes</span><span class="p">,</span> <span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="c1"># we&#39;re left merging BC we&#39;ve removed the retired gens, which are</span>
    <span class="c1"># reported in the ownership table</span>
    <span class="n">gens</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">own860</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
            <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>  <span class="c1"># assume gens that don&#39;t show up in the own table have one 100% owner</span>
            <span class="n">fraction_owned</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fraction_owned</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="c1"># assign the operator id as the owner if null bc if a gen isn&#39;t</span>
            <span class="c1"># reported in the own_eia860 table we can assume the operator</span>
            <span class="c1"># is the owner</span>
            <span class="n">owner_utility_id_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">owner_utility_id_eia</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">utility_id_eia</span>
            <span class="p">),</span>
            <span class="n">ownership_record_type</span><span class="o">=</span><span class="s2">&quot;owned&quot;</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># swap in the owner as the utility</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="c1"># duplicate all of these &quot;owned&quot; records, assign 1 to all of the</span>
    <span class="c1"># fraction_owned column to indicate 100% ownership, and add these new</span>
    <span class="c1"># &quot;total&quot; records to the &quot;owned&quot;</span>
    <span class="n">gens</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">gens</span><span class="p">,</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fraction_owned</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ownership_record_type</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">gens</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">scale_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">gens</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">scale_cols</span><span class="p">]</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
        <span class="n">gens</span><span class="p">[</span><span class="s2">&quot;fraction_owned&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;index&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gens</span></div>



<div class="viewcode-block" id="get_dagster_execution_config">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.get_dagster_execution_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_dagster_execution_config</span><span class="p">(</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tag_concurrency_limits</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the dagster execution config for a given number of workers.</span>

<span class="sd">    If num_workers is 0, then the dagster execution config will not include</span>
<span class="sd">    any limits. With num_workers set to 1, we will use in-process serial</span>
<span class="sd">    executor, otherwise multi-process executor with maximum of num_workers</span>
<span class="sd">    will be used.</span>

<span class="sd">    Args:</span>
<span class="sd">        num_workers: The number of workers to use for the dagster execution config.</span>
<span class="sd">            If 0, then the dagster execution config will not include a multiprocess</span>
<span class="sd">            executor.</span>
<span class="sd">        tag_concurrency_limits: A set of limits that are applied to steps with</span>
<span class="sd">            particular tags. This is helpful for applying concurrency limits to</span>
<span class="sd">            highly concurrent and memory intensive portions of the ETL like CEMS.</span>

<span class="sd">            Dagster description: If a value is set, the limit is applied to</span>
<span class="sd">            only that key-value pair. If no value is set, the limit is applied</span>
<span class="sd">            across all values of that key. If the value is set to a dict with</span>
<span class="sd">            ``applyLimitPerUniqueValue: true``, the limit will apply to the</span>
<span class="sd">            number of unique values for that key. Note that these limits are</span>
<span class="sd">            per run, not global.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dagster execution config.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">num_workers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;execution&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;in_process&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;execution&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;multiprocess&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;max_concurrent&quot;</span><span class="p">:</span> <span class="n">num_workers</span><span class="p">,</span>
                    <span class="s2">&quot;tag_concurrency_limits&quot;</span><span class="p">:</span> <span class="n">tag_concurrency_limits</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="assert_cols_areclose">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.assert_cols_areclose">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_cols_areclose</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">a_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">b_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">mismatch_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if two column sets of a dataframe are close to each other.</span>

<span class="sd">    Ignores NANs and raises if there are too many mismatches.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># we use df.loc, so if we use a debugger in here we can see the actual data</span>
    <span class="c1"># instead of just whether or not there are matches.</span>
    <span class="n">mismatch</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">a_cols</span><span class="p">]),</span> <span class="n">df</span><span class="p">[</span><span class="n">a_cols</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">b_cols</span><span class="p">]),</span> <span class="n">df</span><span class="p">[</span><span class="n">b_cols</span><span class="p">]),</span>
            <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filled</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">mismatch_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mismatch</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mismatch_ratio</span> <span class="o">&gt;</span> <span class="n">mismatch_threshold</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2"> Mismatch ratio </span><span class="si">{</span><span class="n">mismatch_ratio</span><span class="si">:</span><span class="s2">.01%</span><span class="si">}</span><span class="s2"> &gt; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;threshold </span><span class="si">{</span><span class="n">mismatch_threshold</span><span class="si">:</span><span class="s2">.01%</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="TableDiff">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.TableDiff">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TableDiff</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent a diff between two versions of the same table.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TableDiff.deleted">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.TableDiff.deleted">[docs]</a>
    <span class="n">deleted</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></div>

<div class="viewcode-block" id="TableDiff.added">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.TableDiff.added">[docs]</a>
    <span class="n">added</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></div>

<div class="viewcode-block" id="TableDiff.changed">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.TableDiff.changed">[docs]</a>
    <span class="n">changed</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></div>

<div class="viewcode-block" id="TableDiff.old_df">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.TableDiff.old_df">[docs]</a>
    <span class="n">old_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></div>

<div class="viewcode-block" id="TableDiff.new_df">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.TableDiff.new_df">[docs]</a>
    <span class="n">new_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span></div>
</div>



<div class="viewcode-block" id="diff_wide_tables">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.diff_wide_tables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">diff_wide_tables</span><span class="p">(</span>
    <span class="n">primary_key</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">old</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">new</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableDiff</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Diff values across multiple iterations of the same wide table.</span>

<span class="sd">    We often have tables with many value columns; a straightforward comparison of two</span>
<span class="sd">    versions of the same table will show you that two rows are different, but</span>
<span class="sd">    won&#39;t show which of the many values changed.</span>

<span class="sd">    So we melt the table based on some sort of primary key columns then diff</span>
<span class="sd">    the old and new values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_melted</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
        <span class="n">primary_key</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">new_melted</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">primary_key</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;field&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
        <span class="n">primary_key</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">old_aligned</span><span class="p">,</span> <span class="n">new_aligned</span> <span class="o">=</span> <span class="n">old_melted</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">new_melted</span><span class="p">)</span>
    <span class="n">comparison</span> <span class="o">=</span> <span class="n">old_aligned</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">new_aligned</span><span class="p">,</span> <span class="n">result_names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;old&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">comparison</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TableDiff</span><span class="p">(</span>
            <span class="n">deleted</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
            <span class="n">added</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
            <span class="n">changed</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span>
            <span class="n">old_df</span><span class="o">=</span><span class="n">old</span><span class="p">,</span>
            <span class="n">new_df</span><span class="o">=</span><span class="n">new</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">old_values</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">)]</span>
    <span class="n">new_values</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">)]</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="n">old_values</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">new_values</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
    <span class="n">deleted</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="n">old_values</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">new_values</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="n">comparison</span><span class="p">[</span><span class="n">old_values</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">new_values</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">TableDiff</span><span class="p">(</span>
        <span class="n">deleted</span><span class="o">=</span><span class="n">deleted</span><span class="p">,</span> <span class="n">added</span><span class="o">=</span><span class="n">added</span><span class="p">,</span> <span class="n">changed</span><span class="o">=</span><span class="n">changed</span><span class="p">,</span> <span class="n">old_df</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new_df</span><span class="o">=</span><span class="n">new</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="retry">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.retry">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">retry</span><span class="p">(</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">retry_on</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
    <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">base_delay_sec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retry a function with a short sleep between each try.</span>

<span class="sd">    Sleeps twice as long before each retry as the last one, e.g. 1/2/4/8/16</span>
<span class="sd">    seconds.</span>

<span class="sd">    Args:</span>
<span class="sd">        func: the function to retry</span>
<span class="sd">        retry_on: the errors to catch.</span>
<span class="sd">        base_delay_sec: how much time to sleep for the first retry.</span>
<span class="sd">        kwargs: keyword arguments to pass to the wrapped function. Pass non-kwargs as</span>
<span class="sd">            kwargs too.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">try_count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">try_count</span> <span class="o">*</span> <span class="n">base_delay_sec</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">retry_on</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">: retry in </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2">s. </span><span class="si">{</span><span class="n">try_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> retries used.&quot;</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_parquet_table_polars">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.get_parquet_table_polars">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_parquet_table_polars</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a table from a parquet file and return as a polars LazyFrame.&quot;&quot;&quot;</span>
    <span class="c1"># Import here to avoid circular imports</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata.classes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resource</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">from_id</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">to_polars_dtypes</span><span class="p">()</span>

    <span class="c1"># Get the Parquet file path</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">PudlPaths</span><span class="p">()</span>
    <span class="n">parquet_path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">parquet_path</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_parquet_table">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.get_parquet_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_parquet_table</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a table from Parquet files with optional column selection and filtering.</span>

<span class="sd">    This function provides a general-purpose interface for reading PUDL tables from</span>
<span class="sd">    Parquet files. It supports selective column reading for performance, optional</span>
<span class="sd">    filters for data subsetting, and automatic schema validation.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_name: Name of the table to read.</span>
<span class="sd">        columns: List of columns to read. If None, all columns are read.</span>
<span class="sd">        filters: Optional filters to apply when reading the Parquet file. See the</span>
<span class="sd">            :func:`pyarrow.parquet.read_table` documentation for details on filter</span>
<span class="sd">            syntax. If None, no filters are applied.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame with the requested data, with PUDL schema validation applied.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the Parquet file for the table doesn&#39;t exist.</span>
<span class="sd">        ValueError: If the table_name is not a valid PUDL resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import here to avoid circular imports</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata.classes</span><span class="w"> </span><span class="kn">import</span> <span class="n">Resource</span>

    <span class="n">resource</span> <span class="o">=</span> <span class="n">Resource</span><span class="o">.</span><span class="n">from_id</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">()</span>
    <span class="c1"># Get the schema for validation</span>
    <span class="n">pyarrow_schema</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">to_pyarrow</span><span class="p">()</span>

    <span class="c1"># Get the Parquet file path</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">PudlPaths</span><span class="p">()</span>
    <span class="n">parquet_path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

    <span class="n">is_geospatial</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;geometry&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_geospatial</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">parquet_path</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">pyarrow_schema</span><span class="p">,</span>
            <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">memory_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">parquet_path</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">pyarrow_schema</span><span class="p">,</span>
            <span class="n">use_threads</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">memory_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Only enforce schema if we&#39;re reading all columns</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">get_field_names</span><span class="p">()):</span>
        <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">enforce_schema</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># For specific columns, apply PUDL dtypes for the columns we have</span>
    <span class="k">return</span> <span class="n">apply_pudl_dtypes</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">resource</span><span class="o">.</span><span class="n">field_namespace</span><span class="p">)</span></div>



<div class="viewcode-block" id="standardize_phone_column">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.standardize_phone_column">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize_phone_column</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardize phone numbers in the specified columns of the DataFrame.</span>

<span class="sd">    US numbers: ###-###-####</span>
<span class="sd">    International numbers with the international code at the beginning.</span>
<span class="sd">    Numbers with extensions will be appended with &quot;x#&quot;.</span>
<span class="sd">    Non-numeric entries will be returned as np.nan. Entries with fewer than</span>
<span class="sd">    10 digits will be returned with no hyphens.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: The DataFrame to modify.</span>
<span class="sd">        columns: A list of the names of the columns that need to be standardized.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified DataFrame with standardized phone numbers in the same column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define a regex pattern to identify and separate extensions</span>
    <span class="n">extension_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[xX](\d+)$&quot;</span>

    <span class="c1"># Standardize each specified column</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Convert column to string type for consistent processing</span>
        <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>

        <span class="c1"># Remove &quot;.0&quot; from the end of phone numbers, if present</span>
        <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.0$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Separate phone number from extension, if present</span>
        <span class="n">phone_main</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(.*?)(?:[xX].*)?$&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">extension_pattern</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Remove non-digit characters from the main phone number</span>
        <span class="n">phone_main</span> <span class="o">=</span> <span class="n">phone_main</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\d]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Handle numbers with exactly 10 digits (US format)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone_main</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">phone_main</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">phone_main</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
            <span class="o">+</span> <span class="n">phone_main</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
            <span class="o">+</span> <span class="n">phone_main</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># For numbers with an extension, append it back</span>
        <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">extension</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;x&quot;</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>

        <span class="c1"># Replace invalid or empty phone numbers with NaN</span>
        <span class="n">invalid_mask</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">phone_main</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">phone_main</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;0+&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">phone_main</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">invalid_mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="ParquetData">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.ParquetData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParquetData</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrap table data offloaded as parquet file(s) on disk.</span>

<span class="sd">    Writing data to disk as parquet files enables the use of highly efficient</span>
<span class="sd">    processing/transforms with tools like Polars or duckdb. This class provides</span>
<span class="sd">    helpers for managing paths to parquet data on disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ParquetData.table_name">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.ParquetData.table_name">[docs]</a>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span></div>

<div class="viewcode-block" id="ParquetData.partitions">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.ParquetData.partitions">[docs]</a>
    <span class="n">partitions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="ParquetData.parquet_directory">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.ParquetData.parquet_directory">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parquet_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get path to directory for writing/reading parquet files.&quot;&quot;&quot;</span>
        <span class="n">parquet_path</span> <span class="o">=</span> <span class="n">PudlPaths</span><span class="p">()</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span>
        <span class="n">parquet_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parquet_path</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="ParquetData.parquet_path">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.ParquetData.parquet_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parquet_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get name of an individual parquet file corresponding to a single partition of data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">+</span> <span class="s2">&quot;.parquet&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="si">}</span><span class="s2">.parquet&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parquet_directory</span> <span class="o">/</span> <span class="n">filename</span></div>
</div>



<div class="viewcode-block" id="persist_table_as_parquet">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.persist_table_as_parquet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">persist_table_as_parquet</span><span class="p">(</span>
    <span class="n">table_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span> <span class="o">|</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">partitions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">compression</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;zstd&quot;</span><span class="p">,</span> <span class="s2">&quot;snappy&quot;</span><span class="p">,</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span> <span class="s2">&quot;brotli&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;zstd&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParquetData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write data from DataFrame or LazyFrame to disk as a parquet file.</span>

<span class="sd">    Offloading data to disk allows Polars and duckdb to perform highly efficient</span>
<span class="sd">    transforms.</span>

<span class="sd">    Args:</span>
<span class="sd">        table_data: Data to write to disk as either a Pandas DataFrame, Polars LazyFrame, or duckdb relation.</span>
<span class="sd">        table_name: Table name used to construct path to/name of parquet file.</span>
<span class="sd">        partitions: Partitions which correspond to the table_data. If passed</span>
<span class="sd">            ``{&#39;years&#39;: 1995}`` then this method will produce a parquet file at the path</span>
<span class="sd">            ``PudlPaths().parquet_path() / table_name / &#39;1995.parquet&#39;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create ParquetData class to get path to write parquet file</span>
    <span class="n">parquet_data</span> <span class="o">=</span> <span class="n">ParquetData</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="n">partitions</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">table_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_data</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">):</span>
        <span class="n">table_data</span><span class="o">.</span><span class="n">sink_parquet</span><span class="p">(</span>
            <span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">,</span>
            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;streaming&quot;</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_data</span><span class="p">,</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">):</span>
        <span class="n">table_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">),</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;table_data must be of type pd.DataFrame, pl.LazyFrame or duckdb.DuckDBPyRelation.&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">table_data</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">parquet_data</span></div>



<div class="viewcode-block" id="lf_from_parquet">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.lf_from_parquet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lf_from_parquet</span><span class="p">(</span>
    <span class="n">parquet_data</span><span class="p">:</span> <span class="n">ParquetData</span><span class="p">,</span> <span class="n">use_all_partitions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scan parquet file(s) from disk and return Polars LazyFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        parquet_data: Points to parquet data on disk.</span>
<span class="sd">        use_all_partitions: If true read the entire directory of parquet files.</span>
<span class="sd">            Otherwise only read data from the partition specified in parquet_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_all_partitions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="df_from_parquet">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.df_from_parquet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">df_from_parquet</span><span class="p">(</span>
    <span class="n">parquet_data</span><span class="p">:</span> <span class="n">ParquetData</span><span class="p">,</span> <span class="n">use_all_partitions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read data from a set of parquet files and return a pandas DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        parquet_data: Points to parquet data on disk.</span>
<span class="sd">        use_all_partitions: If true read the entire directory of parquet files.</span>
<span class="sd">            Otherwise only read data from the partition specified in parquet_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_all_partitions</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">)</span></div>



<span class="nd">@contextmanager</span>
<div class="viewcode-block" id="duckdb_relation_from_parquet">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.duckdb_relation_from_parquet">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">duckdb_relation_from_parquet</span><span class="p">(</span>
    <span class="n">parquet_data</span><span class="p">:</span> <span class="n">ParquetData</span><span class="p">,</span> <span class="n">use_all_partitions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyRelation</span><span class="p">,</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">DuckDBPyConnection</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a duckdb relation to read from parquet files.</span>

<span class="sd">    This method is intended to be used as a context manager to keep the duckdb</span>
<span class="sd">    connection open while the relation is in use.</span>

<span class="sd">    Args:</span>
<span class="sd">        parquet_data: Points to parquet data on disk.</span>
<span class="sd">        use_all_partitions: If true read the entire directory of parquet files.</span>
<span class="sd">            Otherwise only read data from the partition specified in parquet_data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_all_partitions</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_directory</span><span class="si">}</span><span class="s2">/*.parquet&quot;</span><span class="p">),</span> <span class="n">conn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parquet_data</span><span class="o">.</span><span class="n">parquet_path</span><span class="p">)),</span> <span class="n">conn</span></div>



<div class="viewcode-block" id="duckdb_extract_zipped_csv">
<a class="viewcode-back" href="../../autoapi/pudl/helpers/index.html#pudl.helpers.duckdb_extract_zipped_csv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">duckdb_extract_zipped_csv</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">partitions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">pages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">datasore</span><span class="p">,</span>
    <span class="n">zip_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ParquetData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract data from zipped CSV page(s) in a data archive.</span>

<span class="sd">    A common pattern for raw PUDL data is a set of zipfiles with one zipfile per</span>
<span class="sd">    partition, and one or more CSV files within each zipfile. This function provides</span>
<span class="sd">    a highly efficient way to extract data from archives that conform to this pattern</span>
<span class="sd">    using duckdb. This function is a generator, which will yield a duckdb relation for</span>
<span class="sd">    each CSV file within a zipfile, allowing the caller to perform transforms using</span>
<span class="sd">    the relation before writing to disk with the ``offload_table`` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset: Name of dataset (required to get archive from datastore).</span>
<span class="sd">        partition: Partitions of resource to extract data from.</span>
<span class="sd">        pages: List of csv files to extract from archive.</span>
<span class="sd">        datastore: Instance of PUDL datastore to get raw data.</span>
<span class="sd">        zip_path: Base path within zipfile that points to where CSV files are stored.</span>
<span class="sd">            If not explicitly set, assume CSV files are at the top level of the zipfile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">,</span>
        <span class="n">datasore</span><span class="o">.</span><span class="n">get_zipfile_resource</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="o">**</span><span class="n">partitions</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">,</span>
        <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">page</span><span class="p">,</span> <span class="n">conn</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp_dir</span> <span class="o">/</span> <span class="n">zip_path</span> <span class="o">/</span> <span class="n">page</span><span class="p">))</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2016-2026, Catalyst Cooperative, CC-BY-4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=11fc87b4"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>