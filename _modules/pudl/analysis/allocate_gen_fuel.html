<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXWBBTVMWK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EXWBBTVMWK');
    </script>
    <link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">
        <link rel="prefetch" href="../../../_static/catalyst_logo-200x200.png" as="image">

    <!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>pudl.analysis.allocate_gen_fuel - PUDL 2026.2.1.dev10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=b1990d62" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     <b>Take our ~10 minute <a href="https://forms.gle/E9ou5fgMcR7YVRCRA">2026 Energy Data Ecosystem Survey!</b> 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">PUDL 2026.2.1.dev10 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/catalyst_logo-200x200.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PUDL 2026.2.1.dev10 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">About PUDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_access.html">Data Access</a></li>
<li class="toctree-l1"><a class="reference external" href="https://data.catalyst.coop">PUDL Data Viewer</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../data_sources/index.html">Data Sources</a><input aria-label="Toggle navigation of Data Sources" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/censusdp1tract.html">Census DP1 – Profile of General Demographic Characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/censuspep.html">Population Estimates Program's (PEP) Federal Information Processing Series (FIPS) Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eiaapi.html">EIA Bulk API Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia176.html">EIA Form 176 – Annual Report of Natural and Supplemental Gas Supply and Disposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia860.html">EIA Form 860 – Annual Electric Generator Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia861.html">EIA Form 861 – Annual Electric Power Industry Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia923.html">EIA Form 923 – Power Plant Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia930.html">EIA Form 930 – Hourly and Daily Balancing Authority Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eiaaeo.html">EIA Annual Energy Outlook (AEO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/epacamd_eia.html">EPA CAMD to EIA Power Sector Data Crosswalk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/epacems.html">EPA Hourly Continuous Emission Monitoring System (CEMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferc1.html">FERC Form 1 – Annual Report of Major Electric Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferc714.html">FERC Form 714 – Annual Electric Balancing Authority Area and Planning Area Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferceqr.html">FERC Form 920 – Electric Quarterly Report (EQR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/gridpathratoolkit.html">GridPath Resource Adequacy Toolkit Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/nrelatb.html">NREL Annual Technology Baseline (ATB) for Electricity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/phmsagas.html">Pipelines and Hazardous Materials Safety Administration (PHMSA) Annual Natural Gas Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/rus12.html">USDA RUS Form 12 – Financial and Operating Report: Electric Power Supply</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/rus7.html">USDA RUS Form 7 – Financial and Operating Report: Electric Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/sec10k.html">U.S. Securities and Exchange Commission (SEC) Form 10-K</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/vcerare.html">Vibrant Clean Energy Resource Adequacy Renewable Energy (RARE) Power Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/other_data.html">Other Data in PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/future_data.html">High Priority Target Datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../data_dictionaries/index.html">Data Dictionaries</a><input aria-label="Toggle navigation of Data Dictionaries" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/pudl_db.html">PUDL Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/ferc1_db.html">Raw FERC Form 1 Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/codes_and_labels.html">PUDL Code Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/usage_warnings.html">PUDL Usage Warnings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../methodology/index.html">Methodology</a><input aria-label="Toggle navigation of Methodology" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../methodology/timeseries_imputation.html">Timeseries Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../methodology/sec10k_modeling.html">SEC 10-K Ownership Data Extraction Modeling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../dev/index.html">Development</a><input aria-label="Toggle navigation of Development" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dev_setup.html">Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/run_the_etl.html">Running the ETL Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dev_dagster.html">Developing with Dagster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/project_management.html">Project Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/testing.html">Testing PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_validation_quickstart.html">Data validation quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_validation_reference.html">Data validation reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/metadata.html">Metadata editing guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/build_docs.html">Building the Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/datastore.html">Working with the Datastore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/clone_ferc1.html">Converting raw FERC data to SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/existing_data_updates.html">Existing Data Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/run_a_release.html">Run a Versioned Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/pudl_id_mapping.html">PUDL ID Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/naming_conventions.html">Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_guidelines.html">Data and ETL Design Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/nightly_data_builds.html">Nightly Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/ferceqr_data_builds.html">FERC EQR Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/infrastructure_as_code.html">Infrastructure as Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/managing_external_contributions.html">Managing External Contributions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../LICENSE.html">Licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../autoapi/pudl/index.html">pudl</a><input aria-label="Toggle navigation of pudl" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/__main__/index.html">pudl.__main__</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/_version/index.html">pudl._version</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/index.html">pudl.analysis</a><input aria-label="Toggle navigation of pudl.analysis" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html">pudl.analysis.allocate_gen_fuel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/fuel_by_plant/index.html">pudl.analysis.fuel_by_plant</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/mcoe/index.html">pudl.analysis.mcoe</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/index.html">pudl.analysis.ml_tools</a><input aria-label="Toggle navigation of pudl.analysis.ml_tools" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/experiment_tracking/index.html">pudl.analysis.ml_tools.experiment_tracking</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/models/index.html">pudl.analysis.ml_tools.models</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/plant_parts_eia/index.html">pudl.analysis.plant_parts_eia</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/index.html">pudl.analysis.record_linkage</a><input aria-label="Toggle navigation of pudl.analysis.record_linkage" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/classify_plants_ferc1/index.html">pudl.analysis.record_linkage.classify_plants_ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_inputs/index.html">pudl.analysis.record_linkage.eia_ferc1_inputs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_model_config/index.html">pudl.analysis.record_linkage.eia_ferc1_model_config</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_record_linkage/index.html">pudl.analysis.record_linkage.eia_ferc1_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_train/index.html">pudl.analysis.record_linkage.eia_ferc1_train</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/embed_dataframe/index.html">pudl.analysis.record_linkage.embed_dataframe</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/link_cross_year/index.html">pudl.analysis.record_linkage.link_cross_year</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/name_cleaner/index.html">pudl.analysis.record_linkage.name_cleaner</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/service_territory/index.html">pudl.analysis.service_territory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/spatial/index.html">pudl.analysis.spatial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/state_demand/index.html">pudl.analysis.state_demand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html">pudl.analysis.timeseries_cleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/timeseries_evaluation/index.html">pudl.analysis.timeseries_evaluation</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/convert/index.html">pudl.convert</a><input aria-label="Toggle navigation of pudl.convert" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/convert/censusdp1tract_to_sqlite/index.html">pudl.convert.censusdp1tract_to_sqlite</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/convert/metadata_to_rst/index.html">pudl.convert.metadata_to_rst</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/dbt_wrapper/index.html">pudl.dbt_wrapper</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/etl/index.html">pudl.etl</a><input aria-label="Toggle navigation of pudl.etl" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/asset_checks/index.html">pudl.etl.asset_checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/check_foreign_keys/index.html">pudl.etl.check_foreign_keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/cli/index.html">pudl.etl.cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/eia_bulk_elec_assets/index.html">pudl.etl.eia_bulk_elec_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/ferceqr_deployment/index.html">pudl.etl.ferceqr_deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/glue_assets/index.html">pudl.etl.glue_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/static_assets/index.html">pudl.etl.static_assets</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/extract/index.html">pudl.extract</a><input aria-label="Toggle navigation of pudl.extract" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/censuspep/index.html">pudl.extract.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/csv/index.html">pudl.extract.csv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/dbf/index.html">pudl.extract.dbf</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia176/index.html">pudl.extract.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia191/index.html">pudl.extract.eia191</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia757a/index.html">pudl.extract.eia757a</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia860/index.html">pudl.extract.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia860m/index.html">pudl.extract.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia861/index.html">pudl.extract.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia923/index.html">pudl.extract.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia930/index.html">pudl.extract.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eiaaeo/index.html">pudl.extract.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eiaapi/index.html">pudl.extract.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/epacems/index.html">pudl.extract.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/excel/index.html">pudl.extract.excel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/extractor/index.html">pudl.extract.extractor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc/index.html">pudl.extract.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc1/index.html">pudl.extract.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc2/index.html">pudl.extract.ferc2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc6/index.html">pudl.extract.ferc6</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc60/index.html">pudl.extract.ferc60</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc714/index.html">pudl.extract.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferccid/index.html">pudl.extract.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferceqr/index.html">pudl.extract.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/gridpathratoolkit/index.html">pudl.extract.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/nrelatb/index.html">pudl.extract.nrelatb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/parquet/index.html">pudl.extract.parquet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/phmsagas/index.html">pudl.extract.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/rus12/index.html">pudl.extract.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/rus7/index.html">pudl.extract.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/sec10k/index.html">pudl.extract.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/vcerare/index.html">pudl.extract.vcerare</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/xbrl/index.html">pudl.extract.xbrl</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/ferc_to_sqlite/index.html">pudl.ferc_to_sqlite</a><input aria-label="Toggle navigation of pudl.ferc_to_sqlite" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/ferc_to_sqlite/cli/index.html">pudl.ferc_to_sqlite.cli</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/glue/index.html">pudl.glue</a><input aria-label="Toggle navigation of pudl.glue" class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/glue/ferc1_eia/index.html">pudl.glue.ferc1_eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/glue/ferc714/index.html">pudl.glue.ferc714</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/helpers/index.html">pudl.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/io_managers/index.html">pudl.io_managers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/logging_helpers/index.html">pudl.logging_helpers</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/metadata/index.html">pudl.metadata</a><input aria-label="Toggle navigation of pudl.metadata" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/classes/index.html">pudl.metadata.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/codes/index.html">pudl.metadata.codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/constants/index.html">pudl.metadata.constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/descriptions/index.html">pudl.metadata.descriptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/dfs/index.html">pudl.metadata.dfs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/enums/index.html">pudl.metadata.enums</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/fields/index.html">pudl.metadata.fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/helpers/index.html">pudl.metadata.helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/labels/index.html">pudl.metadata.labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/resource_helpers/index.html">pudl.metadata.resource_helpers</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/index.html">pudl.metadata.resources</a><input aria-label="Toggle navigation of pudl.metadata.resources" class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/allocate_gen_fuel/index.html">pudl.metadata.resources.allocate_gen_fuel</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/censusdp1tract/index.html">pudl.metadata.resources.censusdp1tract</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia/index.html">pudl.metadata.resources.eia</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia176/index.html">pudl.metadata.resources.eia176</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia860/index.html">pudl.metadata.resources.eia860</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia860m/index.html">pudl.metadata.resources.eia860m</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia861/index.html">pudl.metadata.resources.eia861</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia923/index.html">pudl.metadata.resources.eia923</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia930/index.html">pudl.metadata.resources.eia930</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eiaaeo/index.html">pudl.metadata.resources.eiaaeo</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eiaapi/index.html">pudl.metadata.resources.eiaapi</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/epacems/index.html">pudl.metadata.resources.epacems</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc1/index.html">pudl.metadata.resources.ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc1_eia_record_linkage/index.html">pudl.metadata.resources.ferc1_eia_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc714/index.html">pudl.metadata.resources.ferc714</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferccid/index.html">pudl.metadata.resources.ferccid</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferceqr/index.html">pudl.metadata.resources.ferceqr</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/glue/index.html">pudl.metadata.resources.glue</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/gridpathratoolkit/index.html">pudl.metadata.resources.gridpathratoolkit</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/nrelatb/index.html">pudl.metadata.resources.nrelatb</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/phmsagas/index.html">pudl.metadata.resources.phmsagas</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/pudl/index.html">pudl.metadata.resources.pudl</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/rus12/index.html">pudl.metadata.resources.rus12</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/rus7/index.html">pudl.metadata.resources.rus7</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/sec10k/index.html">pudl.metadata.resources.sec10k</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/vcerare/index.html">pudl.metadata.resources.vcerare</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/sources/index.html">pudl.metadata.sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/warnings/index.html">pudl.metadata.warnings</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/output/index.html">pudl.output</a><input aria-label="Toggle navigation of pudl.output" class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/censusdp1tract/index.html">pudl.output.censusdp1tract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia/index.html">pudl.output.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia860/index.html">pudl.output.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia923/index.html">pudl.output.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia930/index.html">pudl.output.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eiaapi/index.html">pudl.output.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/ferc1/index.html">pudl.output.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/ferc714/index.html">pudl.output.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/sec10k/index.html">pudl.output.sec10k</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/output/sql/index.html">pudl.output.sql</a><input aria-label="Toggle navigation of pudl.output.sql" class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/output/sql/helpers/index.html">pudl.output.sql.helpers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/index.html">pudl.package_data</a><input aria-label="Toggle navigation of pudl.package_data" class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/censuspep/index.html">pudl.package_data.censuspep</a><input aria-label="Toggle navigation of pudl.package_data.censuspep" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/censuspep/column_maps/index.html">pudl.package_data.censuspep.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia176/index.html">pudl.package_data.eia176</a><input aria-label="Toggle navigation of pudl.package_data.eia176" class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia176/column_maps/index.html">pudl.package_data.eia176.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia191/index.html">pudl.package_data.eia191</a><input aria-label="Toggle navigation of pudl.package_data.eia191" class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia191/column_maps/index.html">pudl.package_data.eia191.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia757a/index.html">pudl.package_data.eia757a</a><input aria-label="Toggle navigation of pudl.package_data.eia757a" class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia757a/column_maps/index.html">pudl.package_data.eia757a.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860/index.html">pudl.package_data.eia860</a><input aria-label="Toggle navigation of pudl.package_data.eia860" class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860/column_maps/index.html">pudl.package_data.eia860.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860m/index.html">pudl.package_data.eia860m</a><input aria-label="Toggle navigation of pudl.package_data.eia860m" class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860m/column_maps/index.html">pudl.package_data.eia860m.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia861/index.html">pudl.package_data.eia861</a><input aria-label="Toggle navigation of pudl.package_data.eia861" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia861/column_maps/index.html">pudl.package_data.eia861.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia923/index.html">pudl.package_data.eia923</a><input aria-label="Toggle navigation of pudl.package_data.eia923" class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia923/column_maps/index.html">pudl.package_data.eia923.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia930/index.html">pudl.package_data.eia930</a><input aria-label="Toggle navigation of pudl.package_data.eia930" class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia930/column_maps/index.html">pudl.package_data.eia930.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/epacems/index.html">pudl.package_data.epacems</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/ferc1/index.html">pudl.package_data.ferc1</a><input aria-label="Toggle navigation of pudl.package_data.ferc1" class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/ferc1/row_maps/index.html">pudl.package_data.ferc1.row_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/glue/index.html">pudl.package_data.glue</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/phmsagas/index.html">pudl.package_data.phmsagas</a><input aria-label="Toggle navigation of pudl.package_data.phmsagas" class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/phmsagas/column_maps/index.html">pudl.package_data.phmsagas.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus12/index.html">pudl.package_data.rus12</a><input aria-label="Toggle navigation of pudl.package_data.rus12" class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus12/column_maps/index.html">pudl.package_data.rus12.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus7/index.html">pudl.package_data.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/settings/index.html">pudl.package_data.settings</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/test/index.html">pudl.package_data.test</a><input aria-label="Toggle navigation of pudl.package_data.test" class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/test/column_maps/index.html">pudl.package_data.test.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/vcerare/index.html">pudl.package_data.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/resources/index.html">pudl.resources</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/scripts/index.html">pudl.scripts</a><input aria-label="Toggle navigation of pudl.scripts" class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/auto_match_utilities/index.html">pudl.scripts.auto_match_utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/dbt_helper/index.html">pudl.scripts.dbt_helper</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/generate_pudl_duckdb/index.html">pudl.scripts.generate_pudl_duckdb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/pudl_null_cols/index.html">pudl.scripts.pudl_null_cols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/resource_description/index.html">pudl.scripts.resource_description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/zenodo_data_release/index.html">pudl.scripts.zenodo_data_release</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/settings/index.html">pudl.settings</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/transform/index.html">pudl.transform</a><input aria-label="Toggle navigation of pudl.transform" class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/censuspep/index.html">pudl.transform.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/classes/index.html">pudl.transform.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia/index.html">pudl.transform.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia176/index.html">pudl.transform.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia860/index.html">pudl.transform.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia860m/index.html">pudl.transform.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia861/index.html">pudl.transform.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia923/index.html">pudl.transform.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia930/index.html">pudl.transform.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eiaaeo/index.html">pudl.transform.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eiaapi/index.html">pudl.transform.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/epacems/index.html">pudl.transform.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc/index.html">pudl.transform.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc1/index.html">pudl.transform.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc714/index.html">pudl.transform.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferccid/index.html">pudl.transform.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferceqr/index.html">pudl.transform.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/gridpathratoolkit/index.html">pudl.transform.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/nrelatb/index.html">pudl.transform.nrelatb</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/transform/params/index.html">pudl.transform.params</a><input aria-label="Toggle navigation of pudl.transform.params" class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/transform/params/ferc1/index.html">pudl.transform.params.ferc1</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/phmsagas/index.html">pudl.transform.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus/index.html">pudl.transform.rus</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus12/index.html">pudl.transform.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus7/index.html">pudl.transform.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/sec10k/index.html">pudl.transform.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/vcerare/index.html">pudl.transform.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/validate/index.html">pudl.validate</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/workspace/index.html">pudl.workspace</a><input aria-label="Toggle navigation of pudl.workspace" class="toctree-checkbox" id="toctree-checkbox-36" name="toctree-checkbox-36" role="switch" type="checkbox"/><label for="toctree-checkbox-36"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/datastore/index.html">pudl.workspace.datastore</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/resource_cache/index.html">pudl.workspace.resource_cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/setup/index.html">pudl.workspace.setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../bibliography.html">Bibliography</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pudl.analysis.allocate_gen_fuel</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Allocate data from :ref:`core_eia923__monthly_generation_fuel` table to generator level.</span>

<span class="sd">The algorithm we&#39;re using assumes the following about the reported data:</span>

<span class="sd">* The :ref:`core_eia923__monthly_generation_fuel` table is the authoritative source of</span>
<span class="sd">  information about how much generation and fuel consumption is attributable to an</span>
<span class="sd">  entire plant. This table has the most complete data coverage, but it is not the most</span>
<span class="sd">  granular data reported. It&#39;s primary keys are :py:const:`IDX_PM_ESC`.</span>
<span class="sd">* The :ref:`core_eia923__monthly_generation` table contains the most granular net</span>
<span class="sd">  generation data. It is reported at the generator level with primary keys</span>
<span class="sd">  :py:const:`IDX_GENS`. This table includes only ~39% of the total MWhs reported in the</span>
<span class="sd">  :ref:`core_eia923__monthly_generation_fuel` table.</span>
<span class="sd">* The :ref:`core_eia923__monthly_boiler_fuel` table contains the most granular fuel</span>
<span class="sd">  consumption data.  It is reported at the boiler/prime mover/energy source level with</span>
<span class="sd">  primary keys :py:const:`IDX_B_PM_ESC`. This table includes only ~38% of the total</span>
<span class="sd">  MMBTUs reported in the :ref:`core_eia923__monthly_generation_fuel` table.</span>
<span class="sd">* The :ref:`core_eia860__scd_generators` table provides an exhaustive list of all</span>
<span class="sd">  generators whose generation is being reported in the</span>
<span class="sd">  :ref:`core_eia923__monthly_generation_fuel` table - with primary keys</span>
<span class="sd">  :py:const:`IDX_GENS`.</span>

<span class="sd">This module allocates the total net electricity generation and fuel consumption reported</span>
<span class="sd">in the :ref:`core_eia923__monthly_generation_fuel` table to individual generators, based</span>
<span class="sd">on more granular data reported in the :ref:`core_eia923__monthly_generation` and</span>
<span class="sd">:ref:`core_eia923__monthly_boiler_fuel` tables, as well as capacity (MW) found in the</span>
<span class="sd">:ref:`core_eia860__scd_generators` table. It uses other generator attributes from the</span>
<span class="sd">:ref:`core_eia860__scd_generators` table to associate the data found in the</span>
<span class="sd">:ref:`core_eia923__monthly_generation_fuel` with generators. It also uses as the</span>
<span class="sd">associations between boilers and generators found in the</span>
<span class="sd">:ref:`core_eia860__assn_boiler_generator` table to aggregate data</span>
<span class="sd">:ref:`core_eia923__monthly_boiler_fuel` tables. The main coordinating functions hereare</span>
<span class="sd">:func:`allocate_gen_fuel_by_generator_energy_source` and</span>
<span class="sd">:func:`aggregate_gen_fuel_by_generator`.</span>

<span class="sd">Some definitions:</span>

<span class="sd">* **Data columns** refers to the net generation and fuel consumption - the specific</span>
<span class="sd">  columns are defined in :py:const:`DATA_COLUMNS`.</span>
<span class="sd">* **Granular tables** refers to :ref:`core_eia923__monthly_generation` and</span>
<span class="sd">  :ref:`core_eia923__monthly_boiler_fuel`, which report granular data but do not have</span>
<span class="sd">  complete coverage.</span>

<span class="sd">There are six main stages of the allocation process in this module:</span>

<span class="sd">#. **Read inputs**: Read denormalized net generation and fuel consumption data from the</span>
<span class="sd">   PUDL DB and standardize data reporting frequency. (See :func:`select_input_data`</span>
<span class="sd">   and :func:`standardize_input_frequency`).</span>
<span class="sd">#. **Associate inputs**: Merge data columns from the input tables described above on the</span>
<span class="sd">   basis of their shared primary key columns, producing an output with primary key</span>
<span class="sd">   :py:const:`IDX_GENS_PM_ESC`. This broadcasts many data values across multiple rows</span>
<span class="sd">   for use in the allocation process below (see :func:`associate_generator_tables`).</span>
<span class="sd">#. **Flag associated inputs**: For each record in the associated inputs, add boolean</span>
<span class="sd">   flags that separately indicate whether the generation and fuel consumption in that</span>
<span class="sd">   record are directly reported in the granular tables. This lets us choose an</span>
<span class="sd">   appropriate data allocation method based on how complete the granular data coverage</span>
<span class="sd">   is for a given value of :py:const:`IDX_PM_ESC`, which is the original primary key of</span>
<span class="sd">   the :ref:`core_eia923__monthly_generation_fuel` table. (See</span>
<span class="sd">   :func:`prep_allocation_fraction`).</span>
<span class="sd">#. **Allocate**: Allocate the net generation and fuel consumption reported in the less</span>
<span class="sd">   granular :ref:`core_eia923__monthly_generation_fuel` table to the</span>
<span class="sd">   :py:const:`IDX_GENS_PM_ESC` level. More details on the allocation process are below</span>
<span class="sd">   (see :func:`allocate_gen_fuel_by_gen_esc` and :func:`allocate_fuel_by_gen_esc`).</span>
<span class="sd">#. **Sanity check allocation**: Verify that the total allocated net generation and fuel</span>
<span class="sd">   consumption within each plant is equal to the total of the originally reported values</span>
<span class="sd">   within some tolerance (see :func:`test_original_gf_vs_the_allocated_by_gens_gf`).</span>
<span class="sd">   Warn if assumptions about the data and the outputs aren&#39;t met (see</span>
<span class="sd">   :func:`warn_if_missing_pms`, :func:`_test_frac`, :func:`test_gen_fuel_allocation` and</span>
<span class="sd">   :func:`_test_gen_pm_fuel_output`)</span>
<span class="sd">#. **Aggregate outputs**: Aggregate the allocated net generation and fuel consumption to</span>
<span class="sd">   the generator level, going from having primary keys of :py:const:`IDX_GENS_PM_ESC` to</span>
<span class="sd">   :py:const:`IDX_GENS` (see :func:`aggregate_gen_fuel_by_generator`).</span>

<span class="sd">**High-level description about the allocation step**:</span>

<span class="sd">We allocate the data columns reported in the :ref:`core_eia923__monthly_generation_fuel`</span>
<span class="sd">table on the basis of plant, prime mover, and energy source among the generators in each</span>
<span class="sd">plant that have matching energy sources.</span>

<span class="sd">We group the associated data columns by :py:const:`IDX_PM_ESC` and categorize</span>
<span class="sd">each resulting group of generators based on whether  **ALL**, **SOME**, or **NONE** of</span>
<span class="sd">them reported data in the granular tables. This is done for both the net generation and</span>
<span class="sd">fuel consumption since the same generator may have reported differently in its</span>
<span class="sd">respective granular table. This is done for both the net generation and fuel consumption</span>
<span class="sd">since the same generator may have reported differently in its respective granular table.</span>

<span class="sd">In more detail, within each reporting period, we split the plants into three groups:</span>

<span class="sd">* The **ALL** Coverage Records: where ALL generators report in the granular tables.</span>
<span class="sd">* The **NONE** Coverage Records: where NONE of the generators report in the granular</span>
<span class="sd">  tables.</span>
<span class="sd">* The **SOME** Coverage Records: where only SOME of the generators report in the</span>
<span class="sd">  granular tables.</span>

<span class="sd">In the **ALL** generators case, the data columns reported in the</span>
<span class="sd">:ref:`core_eia923__monthly_generation_fuel` table are allocated in proportion to data</span>
<span class="sd">reported in the granular data tables. We do this instead of directly using the data</span>
<span class="sd">columns from the granular tables because there are discrepancies between the</span>
<span class="sd">core_eia923__monthly_generation_fuel table and the granular tables and we are assuming</span>
<span class="sd">the totals reported in the core_eia923__monthly_generation_fuel table are authoritative.</span>

<span class="sd">In the **NONE** generators case, the data columns reported in the</span>
<span class="sd">:ref:`core_eia923__monthly_generation_fuel` table are allocated in proportion to the</span>
<span class="sd">each generator&#39;s capacity.</span>

<span class="sd">In the **SOME** generators case, we use a combination of the two allocation methods</span>
<span class="sd">described above. First, the data columns reported in the</span>
<span class="sd">:ref:`core_eia923__monthly_generation_fuel` table are allocated between the two</span>
<span class="sd">categories of generators: those that report granular data, and those that don&#39;t. The</span>
<span class="sd">fraction allocated to each of those categories is based on how much of the total is</span>
<span class="sd">reported in the granular tables. If T is the total reported, and X is the quantity</span>
<span class="sd">reported in the granular tables, then the allocation is X/T to the generators reporting</span>
<span class="sd">granular data, and (T-X)/T to the generators not reporting granular data. Within each of</span>
<span class="sd">those categories the allocation then follows the ALL or NONE allocation methods</span>
<span class="sd">described above.</span>

<span class="sd">**Known Drawbacks of this methodology**:</span>

<span class="sd">Note that this methodology does not distinguish between primary and secondary</span>
<span class="sd">energy_sources for generators. It associates portions of net generation to each</span>
<span class="sd">generators in the same plant do not report detailed generation, have the same</span>
<span class="sd">prime_mover_code, and use the same fuels, but have very different capacity factors in</span>
<span class="sd">reality, this methodology will allocate generation such that they end up with very</span>
<span class="sd">similar capacity factors. We imagine this is an uncommon scenario.</span>

<span class="sd">This methodology has several potential flaws and drawbacks. Because there is no</span>
<span class="sd">indicator of what portion of the energy_source_codes, we associate the net generation</span>
<span class="sd">equally among them. In effect, if a plant had multiple generators with the same</span>
<span class="sd">prime_mover_code but opposite primary and secondary fuels (eg. gen 1 has a primary fuel</span>
<span class="sd">of &#39;NG&#39; and secondary fuel of &#39;DFO&#39;, while gen 2 has a primary fuel of &#39;DFO&#39; and a</span>
<span class="sd">secondary fuel of &#39;NG&#39;), the methodology associates the</span>
<span class="sd">core_eia923__monthly_generation_fuel records similarly across these two generators.</span>
<span class="sd">However, the allocated net generation will still be porporational to each generator&#39;s</span>
<span class="sd">net generation (if it&#39;s reported) or capacity (if generation is not reported).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="c1"># Useful high-level external modules.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dagster</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssetIn</span><span class="p">,</span> <span class="n">AssetsDefinition</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">asset</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pudl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">apply_pudl_dtypes</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">logging_helpers</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>


<div class="viewcode-block" id="IDX_GENS">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.IDX_GENS">[docs]</a>
<span class="n">IDX_GENS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Primary key columns for generator records.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IDX_GENS_PM_ESC">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.IDX_GENS_PM_ESC">[docs]</a>
<span class="n">IDX_GENS_PM_ESC</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
    <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
    <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
<span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Primary key columns for plant, generator, prime mover &amp; energy source records.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IDX_PM_ESC">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.IDX_PM_ESC">[docs]</a>
<span class="n">IDX_PM_ESC</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Primary key columns for plant, prime mover &amp; energy source records.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IDX_B_PM_ESC">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.IDX_B_PM_ESC">[docs]</a>
<span class="n">IDX_B_PM_ESC</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
    <span class="s2">&quot;boiler_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
<span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Primary key columns for plant, boiler, prime mover &amp; energy source records.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IDX_ESC">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.IDX_ESC">[docs]</a>
<span class="n">IDX_ESC</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_source_code&quot;</span><span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Primary key columns for plant &amp; energy source records.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="IDX_UNIT_ESC">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.IDX_UNIT_ESC">[docs]</a>
<span class="n">IDX_UNIT_ESC</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span> <span class="s2">&quot;unit_id_pudl&quot;</span><span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Primary key columns for plant, energy source &amp; unit records.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DATA_COLUMNS">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.DATA_COLUMNS">[docs]</a>
<span class="n">DATA_COLUMNS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fuel_consumed_mmbtu&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fuel_consumed_for_electricity_mmbtu&quot;</span><span class="p">,</span>
<span class="p">]</span></div>

<span class="sd">&quot;&quot;&quot;Data columns from :ref:`core_eia923__monthly_generation_fuel` that are being allocated.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MISSING_SENTINEL">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.MISSING_SENTINEL">[docs]</a>
<span class="n">MISSING_SENTINEL</span> <span class="o">=</span> <span class="mf">0.00001</span></div>

<span class="sd">&quot;&quot;&quot;A sentinel value for dealing with null or zero values.</span>

<span class="sd">#. Zeroes in the relevant data columns get filled in with the sentinel value in</span>
<span class="sd">   :func:`associate_generator_tables`. At this stage all of the zeros from the original</span>
<span class="sd">   data that are now associated with generators, prime mover codes and energy source</span>
<span class="sd">   codes.</span>
<span class="sd">#. All of the nulls in the relevant data columns are filled with the sentinel value in</span>
<span class="sd">   :func:`prep_allocation_fraction`. (Could this also be done in</span>
<span class="sd">   :func:`associate_generator_tables`?)</span>
<span class="sd">#. After the allocation of net generation (within :func:`allocate_gen_fuel_by_gen_esc`</span>
<span class="sd">   and :func:`allocate_fuel_by_gen_esc` via :func:`remove_aggregated_sentinel_value`),</span>
<span class="sd">   convert all of the aggregated values that are between 0 and twenty times this</span>
<span class="sd">   sentinel value back to zero&#39;s. This is meant to find all instances of aggregated</span>
<span class="sd">   sentinel values. We avoid any negative values because there are instances of</span>
<span class="sd">   negative original values - especially negative net generation.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="allocate_gen_fuel_asset_factory">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.allocate_gen_fuel_asset_factory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">allocate_gen_fuel_asset_factory</span><span class="p">(</span>
    <span class="n">freq</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;YS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">],</span>
    <span class="n">io_manager_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AssetsDefinition</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build yearly and monthly net generation &amp; fuel consumption allocation assets.&quot;&quot;&quot;</span>
    <span class="n">agg_freqs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;YS&quot;</span><span class="p">:</span> <span class="s2">&quot;yearly&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">:</span> <span class="s2">&quot;monthly&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_freqs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;freq must be one of </span><span class="si">{</span><span class="n">agg_freqs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">, got: </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation_fuel_by_generator_energy_source&quot;</span><span class="p">,</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;gf&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation_fuel_combined&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;bf&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_boiler_fuel&quot;</span><span class="p">),</span>
            <span class="s2">&quot;gen&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bga&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;core_eia860__assn_boiler_generator&quot;</span><span class="p">),</span>
            <span class="s2">&quot;gens&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;_out_eia__yearly_generators&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">io_manager_key</span><span class="o">=</span><span class="n">io_manager_key</span><span class="p">,</span>
        <span class="n">op_tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;memory-use&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">compute_kind</span><span class="o">=</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span>
        <span class="n">config_schema</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="n">Field</span><span class="p">(</span>
                <span class="nb">bool</span><span class="p">,</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;If True, retain interim columns used compile net_generation_mwh. &quot;</span>
                    <span class="s2">&quot;These are mostly &#39;frac&#39; and the originally reported net &quot;</span>
                    <span class="s2">&quot;generation, which are useful for debugging. Note that this only &quot;</span>
                    <span class="s2">&quot;works when using the default filesystem io_manager.&quot;</span>
                <span class="p">),</span>
            <span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_fuel_by_gen_esc</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span>
        <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">bf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">bga</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Allocate net gen from gen_fuel to generator/energy_source_code level.&quot;&quot;&quot;</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">copy_on_write</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">bga</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="n">select_input_data</span><span class="p">(</span>
            <span class="n">gf</span><span class="o">=</span><span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="o">=</span><span class="n">bf</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span> <span class="n">bga</span><span class="o">=</span><span class="n">bga</span><span class="p">,</span> <span class="n">gens</span><span class="o">=</span><span class="n">gens</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">allocate_gen_fuel_by_generator_energy_source</span><span class="p">(</span>
            <span class="n">gf</span><span class="o">=</span><span class="n">gf</span><span class="p">,</span>
            <span class="n">bf</span><span class="o">=</span><span class="n">bf</span><span class="p">,</span>
            <span class="n">gen</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span>
            <span class="n">bga</span><span class="o">=</span><span class="n">bga</span><span class="p">,</span>
            <span class="n">gens</span><span class="o">=</span><span class="n">gens</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation_fuel_by_generator&quot;</span><span class="p">,</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;net_gen_fuel_alloc&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation_fuel_by_generator_energy_source&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;pu&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;_out_eia__plants_utilities&quot;</span><span class="p">),</span>
            <span class="s2">&quot;bga&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;core_eia860__assn_boiler_generator&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">io_manager_key</span><span class="o">=</span><span class="n">io_manager_key</span><span class="p">,</span>
        <span class="n">compute_kind</span><span class="o">=</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_fuel_by_gen</span><span class="p">(</span>
        <span class="n">net_gen_fuel_alloc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pu</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">bga</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate gen fuel data columns to generators.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="c1"># aggregate the gen/pm/fuel records back to generator records</span>
            <span class="n">agg_by_generator</span><span class="p">(</span>
                <span class="n">net_gen_fuel_alloc</span><span class="o">=</span><span class="n">net_gen_fuel_alloc</span><span class="p">,</span>
                <span class="n">sum_cols</span><span class="o">=</span><span class="n">DATA_COLUMNS</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># make the output resemble out_eia923__generation:</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">pudl</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">eia923</span><span class="o">.</span><span class="n">denorm_by_gen</span><span class="p">,</span> <span class="n">pu</span><span class="o">=</span><span class="n">pu</span><span class="p">,</span> <span class="n">bga</span><span class="o">=</span><span class="n">bga</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation_fuel_by_generator_energy_source_owner&quot;</span><span class="p">,</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;net_gen_fuel_alloc&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;out_eia923__</span><span class="si">{</span><span class="n">agg_freqs</span><span class="p">[</span><span class="n">freq</span><span class="p">]</span><span class="si">}</span><span class="s2">_generation_fuel_by_generator_energy_source&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;gens&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;_out_eia__yearly_generators&quot;</span><span class="p">),</span>
            <span class="s2">&quot;own_eia860&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;out_eia860__yearly_ownership&quot;</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">io_manager_key</span><span class="o">=</span><span class="n">io_manager_key</span><span class="p">,</span>
        <span class="n">compute_kind</span><span class="o">=</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_fuel_by_gen_esc_owner</span><span class="p">(</span>
        <span class="n">net_gen_fuel_alloc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">own_eia860</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate gen fuel data columns to generator owners.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">scale_allocated_net_gen_fuel_by_ownership</span><span class="p">(</span>
            <span class="n">net_gen_fuel_alloc</span><span class="o">=</span><span class="n">net_gen_fuel_alloc</span><span class="p">,</span>
            <span class="n">gens</span><span class="o">=</span><span class="n">gens</span><span class="p">,</span>
            <span class="n">own_eia860</span><span class="o">=</span><span class="n">own_eia860</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">assets</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen_fuel_by_gen_esc</span><span class="p">,</span> <span class="n">gen_fuel_by_gen</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;YS&quot;</span><span class="p">:</span>
        <span class="c1"># The monthly version is yuuuuge and we only use the annual data for now.</span>
        <span class="n">assets</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gen_fuel_by_gen_esc_owner</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">assets</span></div>



<div class="viewcode-block" id="allocate_gen_fuel_assets">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.allocate_gen_fuel_assets">[docs]</a>
<span class="n">allocate_gen_fuel_assets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">allocated_net_gen_asset</span>
    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;YS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">allocated_net_gen_asset</span> <span class="ow">in</span> <span class="n">allocate_gen_fuel_asset_factory</span><span class="p">(</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
        <span class="n">io_manager_key</span><span class="o">=</span><span class="s2">&quot;pudl_io_manager&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">]</span></div>



<div class="viewcode-block" id="allocate_gen_fuel_by_generator_energy_source">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.allocate_gen_fuel_by_generator_energy_source">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">allocate_gen_fuel_by_generator_energy_source</span><span class="p">(</span>
    <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">bf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">bga</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;YS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">],</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allocate net gen from gen_fuel table to the generator/energy_source_code level.</span>

<span class="sd">    There are two main steps here:</span>

<span class="sd">    * associate ``core_eia923__monthly_generation_fuel`` table data w/ generators</span>
<span class="sd">    * allocate ``core_eia923__monthly_generation_fuel`` table data proportionally</span>

<span class="sd">    The association process happens via :func:`associate_generator_tables`.</span>

<span class="sd">    The allocation process (via :func:`allocate_gen_fuel_by_gen_esc`) entails</span>
<span class="sd">    generating a fraction for each record within a ``IDX_PM_ESC`` group. We</span>
<span class="sd">    have two data points for generating this ratio: the net generation in the</span>
<span class="sd">    core_eia923__monthly_generation table and the capacity from the core_eia860__scd_generators table.</span>
<span class="sd">    The end result is a ``frac`` column which is unique for each combination of</span>
<span class="sd">    generator, prime_mover, and fuel and is used to allocate the associated</span>
<span class="sd">    net generation from the :ref:`core_eia923__monthly_generation_fuel` table.</span>

<span class="sd">    Args:</span>
<span class="sd">        gf: Temporally aggregated :ref:`out_eia923__generation_fuel_combined` dataframe.</span>
<span class="sd">        bf: Temporally aggregated :ref:`core_eia923__monthly_boiler_fuel` dataframe.</span>
<span class="sd">        gen: Temporally aggregated :ref:`core_eia923__monthly_generation` dataframe.</span>
<span class="sd">        bga: :ref:`core_eia860__assn_boiler_generator` dataframe.</span>
<span class="sd">        gens: :ref:`core_eia860__scd_generators` dataframe.</span>
<span class="sd">        freq: Frequency at which the tables are aggregated temporally.</span>
<span class="sd">        debug: If True, return additional debugging information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bf</span><span class="p">,</span> <span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gen</span> <span class="o">=</span> <span class="n">standardize_input_frequency</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">gens</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
    <span class="c1"># Add any startup energy source codes to the list of energy source codes</span>
    <span class="n">gens_at_freq</span> <span class="o">=</span> <span class="n">adjust_msw_energy_source_codes</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">)</span>
    <span class="n">gens_at_freq</span> <span class="o">=</span> <span class="n">add_missing_energy_source_codes_to_gens</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">)</span>
    <span class="c1"># do the association! --&gt; this step is where a small no. of plants are dropped for</span>
    <span class="c1"># an unknown reason. Investigate in issue #2978.</span>
    <span class="n">gen_assoc</span> <span class="o">=</span> <span class="n">associate_generator_tables</span><span class="p">(</span>
        <span class="n">gens</span><span class="o">=</span><span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gf</span><span class="o">=</span><span class="n">gf</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span> <span class="n">bf</span><span class="o">=</span><span class="n">bf</span><span class="p">,</span> <span class="n">bga</span><span class="o">=</span><span class="n">bga</span>
    <span class="p">)</span>
    <span class="c1"># Generate a fraction to use to allocate net generation and fuel consumption by.</span>
    <span class="c1"># These two methods create a column called `frac`, which will be a fraction</span>
    <span class="c1"># to allocate net generation from the gf table for each `IDX_PM_ESC` group</span>
    <span class="n">gen_pm_fuel</span> <span class="o">=</span> <span class="n">prep_allocation_fraction</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">)</span>
    <span class="c1"># Net gen allocation</span>
    <span class="n">net_gen_alloc</span> <span class="o">=</span> <span class="n">allocate_gen_fuel_by_gen_esc</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
        <span class="n">_test_gen_pm_fuel_output</span><span class="p">,</span> <span class="n">gf</span><span class="o">=</span><span class="n">gf</span><span class="p">,</span> <span class="n">gen</span><span class="o">=</span><span class="n">gen</span>
    <span class="p">)</span>
    <span class="n">test_gen_fuel_allocation</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">net_gen_alloc</span><span class="p">)</span>

    <span class="c1"># fuel allocation</span>
    <span class="n">fuel_alloc</span> <span class="o">=</span> <span class="n">allocate_fuel_by_gen_esc</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">)</span>

    <span class="c1"># ensure that the allocated data has unique merge keys</span>
    <span class="n">net_gen_alloc_agg</span> <span class="o">=</span> <span class="n">group_duplicate_keys</span><span class="p">(</span><span class="n">net_gen_alloc</span><span class="p">)</span>
    <span class="n">fuel_alloc_agg</span> <span class="o">=</span> <span class="n">group_duplicate_keys</span><span class="p">(</span><span class="n">fuel_alloc</span><span class="p">)</span>

    <span class="c1"># squish net gen and fuel allocation together</span>
    <span class="n">net_gen_fuel_alloc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">net_gen_alloc_agg</span><span class="p">,</span>
        <span class="n">fuel_alloc_agg</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">IDX_GENS_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_net_gen_alloc&quot;</span><span class="p">,</span> <span class="s2">&quot;_fuel_alloc&quot;</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">IDX_GENS_PM_ESC</span><span class="p">)</span>
    <span class="c1"># When 2020 and 2022 data are used in the fast ETL (2020 data is necessary for</span>
    <span class="c1"># having ample FERC-EIA training data and 2022 as the new year of data) the ci</span>
    <span class="c1"># tests fail on exit code 143 for memory reasons while all tests pass locally.</span>
    <span class="c1"># This function was identified as a large memory suck, therefore this conditional</span>
    <span class="c1"># prevents the function from running as part of the ci and enables the tests to</span>
    <span class="c1"># pass.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GITHUB_ACTIONS&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">test_original_gf_vs_the_allocated_by_gens_gf</span><span class="p">(</span>
            <span class="n">gf</span><span class="o">=</span><span class="n">gf</span><span class="p">,</span> <span class="n">gf_allocated</span><span class="o">=</span><span class="n">net_gen_fuel_alloc</span>
        <span class="p">)</span>
    <span class="c1"># There are a tiny number of records that have NaNs in the prime mover code</span>
    <span class="c1"># and for which the correct prime mover is unclear. Prime mover code is part</span>
    <span class="c1"># of the primary key for this table, so we have to drop them.</span>
    <span class="n">len_before</span> <span class="o">=</span> <span class="n">net_gen_fuel_alloc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">net_gen_fuel_alloc</span> <span class="o">=</span> <span class="n">net_gen_fuel_alloc</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">])</span>
    <span class="n">len_after</span> <span class="o">=</span> <span class="n">net_gen_fuel_alloc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fraction_dropped</span> <span class="o">=</span> <span class="p">(</span><span class="n">len_before</span> <span class="o">-</span> <span class="n">len_after</span><span class="p">)</span> <span class="o">/</span> <span class="n">len_before</span>
    <span class="n">dropped</span> <span class="o">=</span> <span class="n">len_before</span> <span class="o">-</span> <span class="n">len_after</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FRACTION DROPPED: </span><span class="si">{</span><span class="n">fraction_dropped</span><span class="si">}</span><span class="s2">, NUM RECORDS DROPPED: </span><span class="si">{</span><span class="n">dropped</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fraction_dropped</span> <span class="o">&gt;</span> <span class="mf">5e-5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Too many records were found to have a NULL prime_mover_code and &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;dropped. Expected less than 5e-5, but found </span><span class="si">{</span><span class="n">fraction_dropped</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">net_gen_fuel_alloc</span> <span class="o">=</span> <span class="n">net_gen_fuel_alloc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">:,</span>
            <span class="n">IDX_GENS_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DATA_COLUMNS</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="n">net_gen_fuel_alloc</span></div>



<div class="viewcode-block" id="select_input_data">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.select_input_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_input_data</span><span class="p">(</span>
    <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">bf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">bga</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select only the subset of input data needed for the allocation.</span>

<span class="sd">    This includes both selecting only a subset of columns from most input tables, and</span>
<span class="sd">    restricting the dates to those which are available in all inputs. Otherwise we end</span>
<span class="sd">    up with a bunch of NA values since the generators table has up to a year of more</span>
<span class="sd">    recent data from the EIA-860M.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gf</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">IDX_PM_ESC</span> <span class="o">+</span> <span class="n">DATA_COLUMNS</span><span class="p">]</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">IDX_B_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;fuel_consumed_mmbtu&quot;</span><span class="p">]]</span>
    <span class="c1"># load boiler generator associations</span>
    <span class="n">bga</span> <span class="o">=</span> <span class="n">bga</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">:,</span>
        <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;boiler_id&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
    <span class="p">]</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">gf</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">bf</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">bga</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">gens</span> <span class="o">=</span> <span class="n">gens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">report_date</span> <span class="o">&lt;=</span> <span class="n">end_date</span><span class="p">,</span>
        <span class="n">IDX_GENS</span>
        <span class="o">+</span> <span class="p">[</span>
            <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;unit_id_pudl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuel_type_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operational_status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;generator_retirement_date&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;energy_source_code&quot;</span><span class="p">))</span>
        <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;startup_source_code&quot;</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="n">warn_if_missing_pms</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gen</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">IDX_GENS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">]]</span>
        <span class="c1"># removes 4 records with NaN generator_id as of pudl v0.5</span>
        <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">IDX_GENS</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">granular_fuel_ratio</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">gf</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">granular_net_gen_ratio</span> <span class="o">=</span> <span class="n">gen</span><span class="o">.</span><span class="n">net_generation_mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">gf</span><span class="o">.</span><span class="n">net_generation_mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The granular data tables contain </span><span class="si">{</span><span class="n">granular_fuel_ratio</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of the fuel &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="n">granular_net_gen_ratio</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of net generation in the &quot;</span>
        <span class="s2">&quot;higher-coverage core_eia923__monthly_generation_fuel table.&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">gen</span><span class="p">,</span> <span class="n">bga</span><span class="p">,</span> <span class="n">gens</span></div>



<div class="viewcode-block" id="standardize_input_frequency">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.standardize_input_frequency">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">standardize_input_frequency</span><span class="p">(</span>
    <span class="n">bf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">freq</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;MS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Standardize the frequency of the input tables.</span>

<span class="sd">    Employ :func:`distribute_annually_reported_data_to_months_if_annual` on the boiler</span>
<span class="sd">    fuel and generation table. Employ :func:`pudl.helpers.expand_timeseries` on the</span>
<span class="sd">    generators table. Also use the expanded generators table to ensure the generation</span>
<span class="sd">    table has all of the generators present.</span>

<span class="sd">    Args:</span>
<span class="sd">        bf: :ref:`core_eia923__monthly_boiler_fuel` table</span>
<span class="sd">        gens: :ref:`core_eia860__scd_generators` table</span>
<span class="sd">        gen: :ref:`core_eia923__monthly_generation` table</span>
<span class="sd">        freq: the (time) frequency at which the tables will be aggregated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">distribute_annually_reported_data_to_months_if_annual</span><span class="p">(</span>
        <span class="n">df</span><span class="o">=</span><span class="n">bf</span><span class="p">,</span>
        <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;boiler_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">data_column_name</span><span class="o">=</span><span class="s2">&quot;fuel_consumed_mmbtu&quot;</span><span class="p">,</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># duplicate each entry in the gens table 12 times to create an entry for each month of the year</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;MS&quot;</span><span class="p">:</span>
        <span class="n">gens_at_freq</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">expand_timeseries</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">gens</span><span class="p">,</span> <span class="n">key_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gens_at_freq</span> <span class="o">=</span> <span class="n">gens</span>

    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">distribute_annually_reported_data_to_months_if_annual</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span>
            <span class="n">key_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
            <span class="n">data_column_name</span><span class="o">=</span><span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">,</span>
            <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># the gen table is missing many generator ids. Let&#39;s fill this using the gens table</span>
        <span class="c1"># leaving a missing value for net generation</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">gens_at_freq</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">]],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">bf</span><span class="p">,</span> <span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gen</span></div>



<div class="viewcode-block" id="scale_allocated_net_gen_fuel_by_ownership">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.scale_allocated_net_gen_fuel_by_ownership">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scale_allocated_net_gen_fuel_by_ownership</span><span class="p">(</span>
    <span class="n">net_gen_fuel_alloc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">own_eia860</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scale allocated net gen at the generator/energy_source_code level by ownership.</span>

<span class="sd">    It can be helpful to have a table of net generation and fuel consumption at the</span>
<span class="sd">    generator/fuel-type level (i.e. the result of</span>
<span class="sd">    :func:`allocate_gen_fuel_by_generator_energy_source`) to be associated and scaled</span>
<span class="sd">    with all of the owners of those generators.  This allows the aggregation of fuel use</span>
<span class="sd">    to the utility level.</span>

<span class="sd">    This function uses the allocated net generation at the generator/fuel-type level,</span>
<span class="sd">    merges that with a generators table to ensure all necessary columns are available,</span>
<span class="sd">    and then feeds that table into the helper function :meth:`scale_by_ownership`</span>
<span class="sd">    to scale generators by their owners&#39; ownership fraction.</span>

<span class="sd">    Args:</span>
<span class="sd">        net_gen_fuel_alloc: table of allocated generation and fuel consumption</span>
<span class="sd">            at the generator, prime mover, and energy source.</span>
<span class="sd">            From :func:`allocate_gen_fuel_by_generator_energy_source`</span>
<span class="sd">        gens: ``core_eia860__scd_generators`` table with cols: :const:``IDX_GENS``,</span>
<span class="sd">            ``capacity_mw`` and ``utility_id_eia``</span>
<span class="sd">        own_eia860: ``core_eia860__scd_ownership`` table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">scale_by_ownership</span><span class="p">(</span>
        <span class="n">gens</span><span class="o">=</span><span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">date_merge</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="n">net_gen_fuel_alloc</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="n">gens</span><span class="p">[</span><span class="n">IDX_GENS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;capacity_mw&quot;</span><span class="p">]],</span>
            <span class="n">left_date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
            <span class="n">right_date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
            <span class="n">new_date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
            <span class="n">date_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">report_at_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">own_eia860</span><span class="o">=</span><span class="n">own_eia860</span><span class="p">,</span>
        <span class="n">scale_cols</span><span class="o">=</span><span class="n">DATA_COLUMNS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">],</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:m&quot;</span><span class="p">,</span>  <span class="c1"># m:m because there are multiple generators in gen_pm_fuel</span>
    <span class="p">)</span></div>



<span class="c1"># Internal functions for allocate_gen_fuel_by_generator_energy_source</span>
<div class="viewcode-block" id="agg_by_generator">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.agg_by_generator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">agg_by_generator</span><span class="p">(</span>
    <span class="n">net_gen_fuel_alloc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">by_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">IDX_GENS</span><span class="p">,</span>
    <span class="n">sum_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATA_COLUMNS</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate the allocated gen fuel data to the generator level.</span>

<span class="sd">    Args:</span>
<span class="sd">        net_gen_fuel_alloc: result of :func:`allocate_gen_fuel_by_generator_energy_source()`</span>
<span class="sd">        by_cols: list of columns to use as ``pandas.groupby`` arg ``by``</span>
<span class="sd">        sum_cols: Data columns from that are being aggregated via a</span>
<span class="sd">            ``pandas.groupby.sum()``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">net_gen_fuel_alloc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by_cols</span><span class="p">)[</span><span class="n">sum_cols</span><span class="p">]</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gen</span></div>



<div class="viewcode-block" id="stack_generators">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.stack_generators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stack_generators</span><span class="p">(</span>
    <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">cat_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">,</span>
    <span class="n">stacked_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stack the generator table with a set of columns.</span>

<span class="sd">    Args:</span>
<span class="sd">        gens: core_eia860__scd_generators table with cols: :py:const:`IDX_GENS` and all of the</span>
<span class="sd">            ``energy_source_code`` columns</span>
<span class="sd">        cat_col: name of category column which will end up having the column names of</span>
<span class="sd">            ``cols_to_stack``</span>
<span class="sd">        stacked_col: name of column which will end up with the stacked data from</span>
<span class="sd">            ``cols_to_stack``</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: a dataframe with these columns: idx_stack, cat_col,</span>
<span class="sd">        stacked_col</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get a list of all energy_source_code, planned_energy_source_code, and startup_source_code columns</span>
    <span class="n">esc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;source_code&quot;</span><span class="p">))</span>

    <span class="n">gens_stack_prep</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">IDX_GENS</span><span class="p">)[</span><span class="n">esc</span><span class="p">]</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;level_3&quot;</span><span class="p">:</span> <span class="n">cat_col</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="n">stacked_col</span><span class="p">})</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># arrange energy source codes by number and type (start with energy_source_code, then planned_, then startup_)</span>
    <span class="n">gens_stack_prep</span> <span class="o">=</span> <span class="n">gens_stack_prep</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
        <span class="n">by</span><span class="o">=</span><span class="p">(</span><span class="n">IDX_GENS</span> <span class="o">+</span> <span class="p">[</span><span class="n">cat_col</span><span class="p">]),</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="c1"># drop overlapping energy_source_code&#39;s from startup and planned codes</span>
    <span class="n">gens_stack_prep</span> <span class="o">=</span> <span class="n">gens_stack_prep</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
        <span class="n">subset</span><span class="o">=</span><span class="n">IDX_GENS</span> <span class="o">+</span> <span class="p">[</span><span class="n">stacked_col</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span>
    <span class="p">)</span>
    <span class="c1"># replace the energy_source_code_num. Existing energy source codes should be arranged in ascending order</span>
    <span class="n">gens_stack_prep</span><span class="p">[</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;energy_source_code_&quot;</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">gens_stack_prep</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">IDX_GENS</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># merge the stacked df back onto the gens table</span>
    <span class="c1"># we first drop the cols_to_stack so we don&#39;t duplicate data</span>
    <span class="n">gens_stack</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">esc</span><span class="p">),</span> <span class="n">gens_stack_prep</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">IDX_GENS</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gens_stack</span></div>



<div class="viewcode-block" id="associate_generator_tables">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.associate_generator_tables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">associate_generator_tables</span><span class="p">(</span>
    <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">bf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">bga</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Associate the three tables needed to assign net gen and fuel to generators.</span>

<span class="sd">    The :ref:`core_eia923__monthly_generation_fuel` table&#39;s data is reported at the</span>
<span class="sd">    :py:const:`IDX_PM_ESC` granularity. Each generator in the :ref:`core_eia860__scd_generators`</span>
<span class="sd">    has one ``prime_mover_code``, but potentially several ``energy_source_code``s that</span>
<span class="sd">    are reported in several columns. We need to reshape the generators table such that</span>
<span class="sd">    each generator has a separate record corresponding to each of its reported</span>
<span class="sd">    energy_source_codes, so it can be merged with the :ref:`core_eia923__monthly_generation_fuel`</span>
<span class="sd">    table. We do this using :func:``stack_generators`` employing</span>
<span class="sd">    :func:`pd.DataFrame.stack`.</span>

<span class="sd">    The stacked generators table has a primary key of</span>
<span class="sd">    ``[&quot;plant_id_eia&quot;, &quot;generator_id&quot;, &quot;report_date&quot;, &quot;energy_source_code&quot;]``. The table</span>
<span class="sd">    also includes the ``prime_mover_code`` column to enable merges with other tables,</span>
<span class="sd">    the ``capacity_mw`` column which we use to determine the allocation when there is no</span>
<span class="sd">    data in the granular data tables, and the ``operational_status`` column which we use</span>
<span class="sd">    to remove inactive plants from the association and allocation process.</span>

<span class="sd">    The remaining data tables are all less granular than this stacked generators table</span>
<span class="sd">    and have varying primary keys. We add suffixes to the data columns in these data</span>
<span class="sd">    tables to identify the source table before broadcast merging these data columns into</span>
<span class="sd">    the stacked generators. This broadcasted data will be used later in the allocation</span>
<span class="sd">    process.</span>

<span class="sd">    This function also removes inactive generators so that we don&#39;t associate any net</span>
<span class="sd">    generation or fuel to those generators. See :func:`remove_inactive_generators` for</span>
<span class="sd">    more details.</span>

<span class="sd">    There are some records in the data tables that have either ``prime_mover_code`` s  or</span>
<span class="sd">    ``energy_source_code`` s that do no appear in the :ref:`core_eia860__scd_generators` table.</span>
<span class="sd">    We employ :func:`_allocate_unassociated_bf_records` to make sure those records are</span>
<span class="sd">    associated.</span>

<span class="sd">    Args:</span>
<span class="sd">        gens: :ref:`core_eia860__scd_generators` table with cols: :py:const:`IDX_GENS` and all of</span>
<span class="sd">            the ``energy_source_code`` columns and expanded to the same frequency.</span>
<span class="sd">        gf: :ref:`core_eia923__monthly_generation_fuel` table with columns: :py:const:`IDX_PM_ESC` and</span>
<span class="sd">            ``net_generation_mwh`` and ``fuel_consumed_mmbtu``.</span>
<span class="sd">        gen: :ref:`core_eia923__monthly_generation` table with columns: :py:const:`IDX_GENS` and</span>
<span class="sd">            ``net_generation_mwh``.</span>
<span class="sd">        bf: :ref:`core_eia923__monthly_boiler_fuel` table with columns: :py:const:`IDX_B_PM_ESC` and</span>
<span class="sd">            fuel consumption columns.</span>
<span class="sd">        bga: :ref:`core_eia860__assn_boiler_generator` table.</span>

<span class="sd">    Returns:</span>
<span class="sd">        table of generators with stacked energy sources and broadcasted net generation</span>
<span class="sd">        and fuel data from the :ref:`core_eia923__monthly_generation` and :ref:`core_eia923__monthly_generation_fuel`</span>
<span class="sd">        tables. There are many duplicate values in this output which will later be used</span>
<span class="sd">        in the allocation process in :func:`allocate_gen_fuel_by_gen_esc` and</span>
<span class="sd">        :func:`allocate_fuel_by_gen_esc`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stack_gens</span> <span class="o">=</span> <span class="n">stack_generators</span><span class="p">(</span>
        <span class="n">gens</span><span class="p">,</span> <span class="n">cat_col</span><span class="o">=</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">,</span> <span class="n">stacked_col</span><span class="o">=</span><span class="s2">&quot;energy_source_code&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="c1"># allocate the boiler fuel data to generators</span>
    <span class="n">bf_by_gens</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">allocate_bf_data_to_gens</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">gens</span><span class="p">,</span> <span class="n">bga</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">IDX_GENS_PM_ESC</span><span class="p">)</span>
        <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_bf_tbl&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">gf</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">IDX_PM_ESC</span><span class="p">)[</span><span class="n">DATA_COLUMNS</span><span class="p">]</span>
        <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_gf_tbl&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">gen_assoc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">stack_gens</span><span class="p">,</span>
            <span class="n">gen</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;net_generation_mwh_g_tbl&quot;</span><span class="p">}),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_GENS</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">remove_inactive_generators</span><span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">_allocate_unassociated_pm_records</span><span class="p">,</span>
            <span class="n">idx_cols</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span>
            <span class="n">col_w_unexpected_codes</span><span class="o">=</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
            <span class="n">data_columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_gf_tbl&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">DATA_COLUMNS</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">])</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">bf_by_gens</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">IDX_GENS_PM_ESC</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
            <span class="n">_allocate_unassociated_pm_records</span><span class="p">,</span>
            <span class="n">idx_cols</span><span class="o">=</span><span class="n">IDX_GENS_PM_ESC</span><span class="p">,</span>
            <span class="n">col_w_unexpected_codes</span><span class="o">=</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
            <span class="n">data_columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fuel_consumed_mmbtu_bf_tbl&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># replace zeros with small number to avoid div by zero errors when calculating allocation fraction</span>
    <span class="n">data_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;net_generation_mwh_g_tbl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fuel_consumed_mmbtu_gf_tbl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fuel_consumed_for_electricity_mmbtu_gf_tbl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;net_generation_mwh_gf_tbl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fuel_consumed_mmbtu_bf_tbl&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">gen_assoc</span><span class="p">[</span><span class="n">data_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="p">[</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MISSING_SENTINEL</span><span class="p">)</span>

    <span class="c1"># calculate the total capacity in every fuel group</span>
    <span class="n">gen_assoc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">gen_assoc</span><span class="p">,</span>
        <span class="n">gen_assoc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">IDX_ESC</span><span class="p">)[[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;net_generation_mwh_g_tbl&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_fuel&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
        <span class="n">on</span><span class="o">=</span><span class="n">IDX_ESC</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gen_assoc</span></div>



<div class="viewcode-block" id="remove_inactive_generators">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.remove_inactive_generators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_inactive_generators</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove the retired generators.</span>

<span class="sd">    We don&#39;t want to associate and later allocate net generation or fuel to generators</span>
<span class="sd">    that are retired (or proposed! or any other ``operational_status`` besides</span>
<span class="sd">    ``existing``). However, we do want to keep the generators that report operational</span>
<span class="sd">    statuses other than ``existing`` but which report non-zero data despite being</span>
<span class="sd">    ``retired`` or ``proposed``. This includes several categories of generators/plants:</span>

<span class="sd">        * ``retiring_generators``: generators that retire mid-year</span>
<span class="sd">        * ``retired_plants``: entire plants that supposedly retired prior to</span>
<span class="sd">          the current year but which report data. If a plant has a mix of gens</span>
<span class="sd">          which are existing and retired, they are not included in this category.</span>
<span class="sd">        * ``proposed_generators``: generators that become operational mid-year,</span>
<span class="sd">          or which are marked as ``proposed`` but start reporting non-zero data</span>
<span class="sd">        * ``proposed_plants``: entire plants that have a ``proposed`` status but</span>
<span class="sd">          which start reporting data. If a plant has a mix of gens which are</span>
<span class="sd">          existing and proposed, they are not included in this category.</span>

<span class="sd">    When we do not have generator-specific generation for a proposed/retired</span>
<span class="sd">    generator that is not coming online/retiring mid-year, we can also look</span>
<span class="sd">    at whether there is generation reported for this generator in the gf table.</span>
<span class="sd">    However, if a proposed/retired generator is part of an existing plant, it</span>
<span class="sd">    is possible that the reported generation from the gf table belongs to one</span>
<span class="sd">    of the other existing generators. Thus, we want to only keep proposed/retired</span>
<span class="sd">    generators where the entire plant is proposed/retired (in which case the gf-</span>
<span class="sd">    reported generation could only come from one of the new/retired generators).</span>

<span class="sd">    We also want to keep unassociated plants that have no ``generator_id`` which will</span>
<span class="sd">    be associated via :func:`_allocate_unassociated_records`.</span>

<span class="sd">    Args:</span>
<span class="sd">        gen_assoc: table of generators with stacked energy sources and broadcasted net</span>
<span class="sd">            generation data from the core_eia923__monthly_generation and core_eia923__monthly_generation_fuel</span>
<span class="sd">            tables. Output of :func:`associate_generator_tables`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">existing</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;existing&quot;</span><span class="p">)]</span>

    <span class="n">retiring_generators</span> <span class="o">=</span> <span class="n">identify_retiring_generators</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">)</span>

    <span class="n">retired_plants</span> <span class="o">=</span> <span class="n">identify_retired_plants</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">)</span>

    <span class="n">proposed_generators</span> <span class="o">=</span> <span class="n">identify_generators_coming_online</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">)</span>

    <span class="n">proposed_plants</span> <span class="o">=</span> <span class="n">identify_proposed_plants</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">)</span>

    <span class="n">unassociated_plants</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="p">[</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">generator_id</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>

    <span class="n">gen_assoc_removed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">existing</span><span class="p">,</span>
            <span class="n">retiring_generators</span><span class="p">,</span>
            <span class="n">retired_plants</span><span class="p">,</span>
            <span class="n">proposed_generators</span><span class="p">,</span>
            <span class="n">proposed_plants</span><span class="p">,</span>
            <span class="n">unassociated_plants</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gen_assoc_removed</span></div>



<div class="viewcode-block" id="identify_retiring_generators">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.identify_retiring_generators">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">identify_retiring_generators</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify any generators that retire mid-year.</span>

<span class="sd">    We want to include all of the generator records within any given year that</span>
<span class="sd">    retired mid-year or any generators that reported any fuel use or generation.</span>
<span class="sd">    These are generators with a mid-year retirement date or which report</span>
<span class="sd">    generator-specific generation or fuel use after they are labeled as retired.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gen_assoc</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">report_year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
    <span class="c1"># identify the complete set of generator ids that are retiring mid year</span>
    <span class="c1"># or have fuel or generation use while being labeled as retired.</span>
    <span class="n">retiring_generator_identities</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;retired&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">report_date</span> <span class="o">&lt;=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">generator_retirement_date</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;fuel_consumed&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">],</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># merge these ids into gen_assoc and keep all months of data for these gens</span>
    <span class="n">retiring_generators</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">retiring_generator_identities</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_year&quot;</span><span class="p">],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;report_year&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">retiring_generators</span></div>



<div class="viewcode-block" id="identify_retired_plants">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.identify_retired_plants">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">identify_retired_plants</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify entire plants that have previously retired but are reporting data.&quot;&quot;&quot;</span>
    <span class="c1"># get a subset of the data that represents all plants that have completely retired before the start date</span>
    <span class="c1"># Get a list of all of the plants with at least one retired generator and reports non-zero generation data</span>
    <span class="c1"># after the generator retirement date</span>
    <span class="n">retired_generators_with_reported_gf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;retired&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">report_date</span> <span class="o">&gt;</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">generator_retirement_date</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># create a table for all of these plants that identifies all of the unique operational statuses</span>
    <span class="n">plants_with_any_retired_generators</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">gen_assoc</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">retired_generators_with_reported_gf</span><span class="p">),</span>
        <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;operational_status&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_retirement_date&quot;</span><span class="p">],</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># remove plants that have operational statuses other than retired</span>
    <span class="n">plants_with_both_retired_and_and_existing_generators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">plants_with_any_retired_generators</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">plants_with_any_retired_generators</span><span class="p">[</span><span class="s2">&quot;operational_status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;retired&quot;</span><span class="p">),</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">plants_with_only_retired_generators</span> <span class="o">=</span> <span class="n">plants_with_any_retired_generators</span><span class="p">[</span>
        <span class="o">~</span><span class="n">plants_with_any_retired_generators</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
            <span class="n">plants_with_both_retired_and_and_existing_generators</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># only keep the plants where all retirement dates are before the current year</span>
    <span class="n">plants_retiring_after_start_date</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">plants_with_only_retired_generators</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">plants_with_only_retired_generators</span><span class="p">[</span><span class="s2">&quot;generator_retirement_date&quot;</span><span class="p">]</span>
            <span class="o">&gt;=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">report_date</span><span class="p">),</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">entirely_retired_plants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">plants_with_only_retired_generators</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="o">~</span><span class="n">plants_with_only_retired_generators</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="n">plants_retiring_after_start_date</span>
            <span class="p">),</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">retired_plants</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="p">[</span><span class="n">gen_assoc</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">entirely_retired_plants</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">retired_plants</span></div>



<div class="viewcode-block" id="identify_generators_coming_online">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.identify_generators_coming_online">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">identify_generators_coming_online</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify generators that are coming online mid-year.</span>

<span class="sd">    These are defined as generators that have a proposed status but which report</span>
<span class="sd">    generator-specific generation data in the g table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># sometimes a plant will report generation data before its proposed operating date</span>
    <span class="c1"># we want to keep any data that is reported for proposed generators</span>
    <span class="n">proposed_generators</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;proposed&quot;</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">proposed_generators</span></div>



<div class="viewcode-block" id="identify_proposed_plants">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.identify_proposed_plants">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">identify_proposed_plants</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify entirely new plants that are proposed but are already reporting data.&quot;&quot;&quot;</span>
    <span class="c1"># Get a list of all of the plants that have a proposed generator with non-null and non-zero gf generation</span>
    <span class="n">proposed_generators_with_reported_bf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;proposed&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_assoc</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># create a table for all of these plants that identifies all of the unique operational statuses</span>
    <span class="n">plants_with_any_proposed_generators</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="n">gen_assoc</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">proposed_generators_with_reported_bf</span><span class="p">),</span>
        <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;operational_status&quot;</span><span class="p">],</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="c1"># filter this list to those plant ids where the only operational status is &quot;proposed&quot;</span>
    <span class="c1"># i.e. where the entire plant is new</span>
    <span class="n">entirely_new_plants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">plants_with_any_proposed_generators</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="o">~</span><span class="n">plants_with_any_proposed_generators</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span>
                    <span class="n">subset</span><span class="o">=</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">plants_with_any_proposed_generators</span><span class="p">[</span><span class="s2">&quot;operational_status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;proposed&quot;</span><span class="p">),</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># keep data for these proposed plants in months where there is reported data</span>
    <span class="n">proposed_plants</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="p">[</span>
        <span class="n">gen_assoc</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">entirely_new_plants</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="n">gen_assoc</span><span class="p">[</span><span class="s2">&quot;net_generation_mwh_gf_tbl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">proposed_plants</span></div>



<div class="viewcode-block" id="_allocate_unassociated_pm_records">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel._allocate_unassociated_pm_records">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_allocate_unassociated_pm_records</span><span class="p">(</span>
    <span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">idx_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">col_w_unexpected_codes</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">],</span>
    <span class="n">data_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Associate unassociated :ref:`core_eia923__monthly_boiler_fuel` table records on idx_cols.</span>

<span class="sd">    There are a subset of :ref:`core_eia923__monthly_boiler_fuel` and :ref:`core_eia923__monthly_generation_fuel`</span>
<span class="sd">    records which do not merge onto the stacked generator table on ``IDX_GENS_PM_ESC``</span>
<span class="sd">    or ``ID_PM_ESC`` respectively. These records generally don&#39;t match with the set of</span>
<span class="sd">    prime movers and energy sources in the stacked generator table. In this method, we</span>
<span class="sd">    associate those straggler, unassociated records by merging these records with the</span>
<span class="sd">    stacked generators witouth the un-matching data column.</span>

<span class="sd">    Args:</span>
<span class="sd">        gen_assoc: generators associated with data.</span>
<span class="sd">        idx_cols: ID columns (includes ``col_w_unexpected_codes``)</span>
<span class="sd">        col_w_unexpected_codes: name of the column which has codes in it that were not</span>
<span class="sd">            found in the generators table.</span>
<span class="sd">        data_columns: the data columns to associate and allocate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># we&#39;re going to only associate these unassociated fuel records w/</span>
    <span class="c1"># the primary fuel so we don&#39;t have to deal w/ double counting</span>
    <span class="n">connected_mask</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">_merge</span> <span class="o">!=</span> <span class="s2">&quot;right_only&quot;</span>
    <span class="c1"># if everything is connected, skip this. (this is mostly for unit tests!</span>
    <span class="c1">#  drop_invalid_rows will fail if there are not unassociated records)</span>
    <span class="k">if</span> <span class="n">gen_assoc</span><span class="p">[</span><span class="o">~</span><span class="n">connected_mask</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;No unassociated core_eia923__monthly_boiler_fuel or core_eia923__monthly_generation_fuel records. &quot;</span>
            <span class="s2">&quot;Skipping _allocate_unassociated_bf_records&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">gen_assoc</span>
    <span class="c1"># we&#39;re associating these unassociated records but we only want to associate</span>
    <span class="c1"># them w/ the standard id columns minus the column with the non-matching codes</span>
    <span class="n">idx_minus_one</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">idx_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">col_w_unexpected_codes</span><span class="p">]</span>
    <span class="n">eia_generators_connected</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">connected_mask</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">capacity_mw_minus_one</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">idx_minus_one</span><span class="p">)[</span>
            <span class="s2">&quot;capacity_mw&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="n">frac_cap_minus_one</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_minus_one</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">eia_generators_unassociated</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gen_assoc</span><span class="p">[</span><span class="o">~</span><span class="n">connected_mask</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">idx_minus_one</span><span class="p">)</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Associating and allocating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eia_generators_unassociated</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eia_generators_unassociated</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">)</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">) records with &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;unexpected </span><span class="si">{</span><span class="n">col_w_unexpected_codes</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_allocate_unassociated_data_col</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to allocate an unassociated data column.</span>

<span class="sd">        We want the main and the unassociated data to be added together but sometimes</span>
<span class="sd">        there is no data from the gf table and sometimes there is no unassociated data.</span>
<span class="sd">        The unassociated data column also needs to be allocated across the various</span>
<span class="sd">        gen/PM code combos in the plant that it is being merged with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">|</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_unassociated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="n">col</span>
        <span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_unassociated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">frac_cap_minus_one</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

    <span class="n">eia_generators</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">eia_generators_connected</span><span class="p">,</span>
        <span class="n">eia_generators_unassociated</span><span class="p">[</span><span class="n">idx_minus_one</span> <span class="o">+</span> <span class="n">data_columns</span><span class="p">],</span>
        <span class="n">on</span><span class="o">=</span><span class="n">idx_minus_one</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_unassociated&quot;</span><span class="p">),</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">eia_generators</span> <span class="o">=</span> <span class="n">eia_generators</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="n">col</span><span class="p">:</span> <span class="n">_allocate_unassociated_data_col</span><span class="p">(</span><span class="n">eia_generators</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">eia_generators</span></div>



<div class="viewcode-block" id="prep_allocation_fraction">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.prep_allocation_fraction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prep_allocation_fraction</span><span class="p">(</span><span class="n">gen_assoc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare the associated generators for allocation.</span>

<span class="sd">    Make flags and aggregations to prepare for the :func:`allocate_gen_fuel_by_gen_esc`</span>
<span class="sd">    and :func:`allocate_fuel_by_gen_esc` functions.</span>

<span class="sd">    In :func:`allocate_gen_fuel_by_gen_esc`, we will break the generators out into four</span>
<span class="sd">    types - see :func:`allocate_gen_fuel_by_gen_esc` docs for details. This function adds</span>
<span class="sd">    flags for splitting the generators.</span>

<span class="sd">    Args:</span>
<span class="sd">        gen_assoc: a table of generators that have associated w/ energy sources, prime</span>
<span class="sd">            movers and boilers - result of :func:`associate_generator_tables`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># flag whether the generator exists in the generation table (this will be used</span>
    <span class="c1"># later on) for calculating ratios to use to allocate net generation</span>
    <span class="c1"># if there is more net gen reported to the gen table than the gf table, we assume</span>
    <span class="c1"># this is an &quot;all gen&quot; table (see allocate_gen_fuel_by_gen_esc). If this isn&#39;t done</span>
    <span class="c1"># the records that don&#39;t report in the gen table will end up getting negative net</span>
    <span class="c1"># generation</span>
    <span class="n">gen_assoc</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">more_mwh_in_g_than_gf_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span>
        <span class="p">),</span>
        <span class="n">in_g_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span>  <span class="c1"># | x.more_mwh_in_g_than_gf_tbl,</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">in_bf_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">gens_gb_pm_esc</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">gens_gb_u_esc</span> <span class="o">=</span> <span class="n">gen_assoc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">IDX_UNIT_ESC</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># get the total values for the merge group</span>
    <span class="c1"># we would use on groupby here with agg but it is much slower</span>
    <span class="c1"># so we&#39;re gb-ing twice w/ a merge</span>
    <span class="c1"># gens_gb.agg({&#39;net_generation_mwh_g_tbl&#39;: lambda x: x.sum(min_count=1),</span>
    <span class="c1">#              &#39;capacity_mw&#39;: lambda x: x.sum(min_count=1),</span>
    <span class="c1">#              &#39;in_g_tbl&#39;: &#39;all&#39;},)</span>
    <span class="n">gen_pm_fuel</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gen_assoc</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>  <span class="c1"># flag if all generators exist in the core_eia860__scd_generators tbl</span>
            <span class="n">gens_gb_pm_esc</span><span class="p">[[</span><span class="s2">&quot;in_g_tbl&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_all&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>  <span class="c1"># flag if some generators exist in the core_eia860__scd_generators tbl</span>
            <span class="n">gens_gb_pm_esc</span><span class="p">[[</span><span class="s2">&quot;in_g_tbl&quot;</span><span class="p">,</span> <span class="s2">&quot;more_mwh_in_g_than_gf_tbl&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_any&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>  <span class="c1"># flag if all generators exist in the boiler fuel tbl</span>
            <span class="n">gens_gb_pm_esc</span><span class="p">[[</span><span class="s2">&quot;in_bf_tbl&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_all&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>  <span class="c1"># flag if some generators exist in the boiler fuel tbl</span>
            <span class="n">gens_gb_pm_esc</span><span class="p">[[</span><span class="s2">&quot;in_bf_tbl&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_any&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># Net generation and capacity are both proxies that can be used</span>
        <span class="c1"># to allocate the generation which only shows up in generation_fuel.</span>
        <span class="c1"># fuel consumption from the bf table can be used as a proxy to allocate</span>
        <span class="c1"># fuel consumption that only shows up in generation_fuel</span>
        <span class="c1"># Sum them up across the whole plant-prime-fuel group so we can tell</span>
        <span class="c1"># what fraction of the total capacity each generator is.</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">gens_gb_pm_esc</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;net_generation_mwh_g_tbl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;fuel_consumed_mmbtu_bf_tbl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_pm_fuel&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">gens_gb_u_esc</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;fuel_consumed_mmbtu_bf_tbl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_unit_fuel&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">IDX_UNIT_ESC</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="c1"># fill in the missing generation with small numbers (this will help ensure</span>
            <span class="c1"># the calculations to run the fractions in `allocate_gen_fuel_by_gen_esc`</span>
            <span class="c1"># and `allocate_fuel_by_gen_esc` can be consistent)</span>
            <span class="c1"># do the same with missing fuel consumption</span>
            <span class="n">fuel_consumed_mmbtu_bf_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                <span class="n">MISSING_SENTINEL</span>
            <span class="p">),</span>
            <span class="n">net_generation_mwh_g_tbl_pm_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl_pm_fuel</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">MISSING_SENTINEL</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">fuel_consumed_mmbtu_bf_tbl_pm_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl_pm_fuel</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">MISSING_SENTINEL</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">fuel_consumed_mmbtu_bf_tbl_unit_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl_unit_fuel</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">MISSING_SENTINEL</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Add a column that indicates how much capacity comes from generators that</span>
    <span class="c1"># report in the generation table, and how much comes only from generators</span>
    <span class="c1"># that show up in the generation_fuel table.</span>
    <span class="n">gen_pm_fuel</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">gen_pm_fuel</span><span class="p">,</span>
        <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">IDX_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;in_g_tbl&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_in_g_tbl_group&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
        <span class="n">on</span><span class="o">=</span><span class="n">IDX_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;in_g_tbl&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">gen_pm_fuel</span><span class="p">[</span><span class="s2">&quot;capacity_mw_fuel_in_bf_tbl_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">IDX_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;in_bf_tbl&quot;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)[[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gen_pm_fuel</span></div>



<div class="viewcode-block" id="allocate_gen_fuel_by_gen_esc">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.allocate_gen_fuel_by_gen_esc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">allocate_gen_fuel_by_gen_esc</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allocate net generation to generators/energy_source_code via three methods.</span>

<span class="sd">    There are three main types of generators:</span>
<span class="sd">      * &quot;all gen&quot;: generators of plants which fully report to the ``core_eia923__monthly_generation``</span>
<span class="sd">        table. This includes records that report more MWh to the ``core_eia923__monthly_generation``</span>
<span class="sd">        table than to the ``core_eia923__monthly_generation_fuel`` table (if we did not include these</span>
<span class="sd">        records, the ).</span>
<span class="sd">      * &quot;some gen&quot;: generators of plants which partially report to the</span>
<span class="sd">        ``core_eia923__monthly_generation`` table.</span>
<span class="sd">      * &quot;gf only&quot;: generators of plants which do not report at all to the</span>
<span class="sd">        ``core_eia923__monthly_generation`` table.</span>

<span class="sd">    Each different type of generator needs to be treated slightly differently,</span>
<span class="sd">    but all will end up with a ``frac`` column that can be used to allocate</span>
<span class="sd">    the ``net_generation_mwh_gf_tbl``.</span>

<span class="sd">    Args:</span>
<span class="sd">        gen_pm_fuel: output of :func:``prep_allocation_fraction()``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># break out the table into these four different generator types and assign a category</span>
    <span class="n">all_mask</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_g_tbl_all</span> <span class="o">|</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">more_mwh_in_g_than_gf_tbl_any</span>
    <span class="n">all_gen</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_mask</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">net_gen_alloc_cat</span><span class="o">=</span><span class="s2">&quot;all_gen&quot;</span><span class="p">)</span>
    <span class="n">some_gen</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_g_tbl_any</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">all_mask</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">net_gen_alloc_cat</span><span class="o">=</span><span class="s2">&quot;some_gen&quot;</span>
    <span class="p">)</span>
    <span class="n">gf_only</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_g_tbl_any</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">net_gen_alloc_cat</span><span class="o">=</span><span class="s2">&quot;gf_only&quot;</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Ratio calc types: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;   All gens w/in generation table:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_gen</span><span class="p">)</span><span class="si">}</span><span class="s2">#, </span><span class="si">{</span><span class="n">all_gen</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;   Some gens w/in generation table: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">some_gen</span><span class="p">)</span><span class="si">}</span><span class="s2">#, </span><span class="si">{</span><span class="n">some_gen</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;   No gens w/in generation table:   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gf_only</span><span class="p">)</span><span class="si">}</span><span class="s2">#, </span><span class="si">{</span><span class="n">gf_only</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> MW&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_gen</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_gen</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">gf_only</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Error in splitting the gens between records showing up fully, &quot;</span>
            <span class="s2">&quot;partially, or not at all in the generation table.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># In the case where we have all of the generation from the generation</span>
    <span class="c1"># table, we still allocate, because the generation reported in these two</span>
    <span class="c1"># tables don&#39;t always match perfectly</span>
    <span class="n">all_gen</span> <span class="o">=</span> <span class="n">all_gen</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">frac_net_gen</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl_pm_fuel</span>
        <span class="p">),</span>
        <span class="n">frac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_net_gen</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># _ = _test_frac(all_gen)</span>

    <span class="c1"># a brief explanation of the equations below</span>
    <span class="c1"># input definitions:</span>
    <span class="c1">#   ng == net generation from the generation table (by generator)</span>
    <span class="c1">#   ngf == net generation from the generation fuel table (summed by PM/Fuel)</span>
    <span class="c1">#   ngt == total net generation from the generation table (summed by PM/Fuel)</span>
    <span class="c1">#</span>
    <span class="c1"># y = ngt / ngf (fraction of generation reporting in the generation table)</span>
    <span class="c1"># z = ng * ngt (fraction of generation from generation table by generator)</span>
    <span class="c1"># g = y * z  (fraction of generation reporting in generation table by generator - frac_gen)</span>

    <span class="n">some_gen</span> <span class="o">=</span> <span class="n">some_gen</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="c1"># fraction of the generation that should go to the generators that</span>
        <span class="c1"># report in the generation table</span>
        <span class="n">frac_from_g_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl_pm_fuel</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl_pm_fuel</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># for records within these mix groups that do have net gen in the</span>
        <span class="c1"># generation table..</span>
        <span class="n">frac_net_gen</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl_pm_fuel</span>
        <span class="p">),</span>  <span class="c1"># generator based net gen from gen table</span>
        <span class="n">frac_gen</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_net_gen</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_from_g_tbl</span><span class="p">,</span>
        <span class="c1"># fraction of generation that does not show up in the generation table</span>
        <span class="n">frac_missing_from_g_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_from_g_tbl</span><span class="p">,</span>
        <span class="n">capacity_mw_missing_from_g_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">in_g_tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span><span class="p">),</span>
        <span class="n">frac_cap</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">frac_missing_from_g_tbl</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_missing_from_g_tbl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_in_g_tbl_group</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># the real deal</span>
        <span class="c1"># this could also be `x.frac_gen + x.frac_cap` because the frac_gen</span>
        <span class="c1"># should be 0 for any generator that does not have net gen in the g_tbl</span>
        <span class="c1"># and frac_cap should be 0 for any generator that has net gen in the</span>
        <span class="c1"># g_tbl.</span>
        <span class="n">frac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">in_g_tbl</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_gen</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_cap</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># _ = _test_frac(some_gen)</span>

    <span class="c1"># Calculate what fraction of the total capacity is associated with each of</span>
    <span class="c1"># the generators in the grouping.</span>
    <span class="n">gf_only</span> <span class="o">=</span> <span class="n">gf_only</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">frac_cap</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_pm_fuel</span><span class="p">,</span>
        <span class="n">frac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_cap</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># _ = _test_frac(gf_only)</span>

    <span class="c1"># squish all of these methods back together.</span>
    <span class="n">net_gen_alloc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_gen</span><span class="p">,</span> <span class="n">some_gen</span><span class="p">,</span> <span class="n">gf_only</span><span class="p">])</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">_test_frac</span><span class="p">(</span><span class="n">net_gen_alloc</span><span class="p">)</span>

    <span class="c1"># replace the placeholder missing values with zero before allocating</span>
    <span class="c1"># since some of these may have been aggregated, well, flag any values less than 10</span>
    <span class="c1"># times the sentinel but more than 0 bc there are negative net generation values</span>
    <span class="n">net_gen_alloc</span><span class="p">[</span><span class="s2">&quot;net_generation_mwh_gf_tbl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_aggregated_sentinel_value</span><span class="p">(</span>
        <span class="n">net_gen_alloc</span><span class="p">[</span><span class="s2">&quot;net_generation_mwh_gf_tbl&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># do the allocating-ing!</span>
    <span class="n">net_gen_alloc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">net_gen_alloc</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="c1"># we could x.net_generation_mwh_g_tbl.fillna here if we wanted to</span>
            <span class="c1"># take the net gen</span>
            <span class="n">net_generation_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">net_gen_alloc</span></div>



<div class="viewcode-block" id="allocate_fuel_by_gen_esc">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.allocate_fuel_by_gen_esc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">allocate_fuel_by_gen_esc</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allocate fuel_consumption to generators/energy_source_code via three methods.</span>

<span class="sd">    There are three main types of generators:</span>

<span class="sd">      * &quot;all bf&quot;: generators of plants which fully report to the</span>
<span class="sd">        core_eia923__monthly_boiler_fuel table.</span>
<span class="sd">      * &quot;some bf&quot;: generators of plants which partially report to the</span>
<span class="sd">        core_eia923__monthly_boiler_fuel table.</span>
<span class="sd">      * &quot;gf only&quot;: generators of plants which do not report at all to the</span>
<span class="sd">        core_eia923__monthly_boiler_fuel table.</span>

<span class="sd">    Each different type of generator needs to be treated slightly differently,</span>
<span class="sd">    but all will end up with a ``frac`` column that can be used to allocate</span>
<span class="sd">    the ``fuel_consumed_mmbtu_gf_tbl``.</span>

<span class="sd">    Args:</span>
<span class="sd">        gen_pm_fuel: output of :func:`prep_allocation_fraction`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># break out the table into these four different generator types.</span>
    <span class="n">all_bf</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_bf_tbl_all</span><span class="p">]</span>
    <span class="n">some_bf</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_bf_tbl_any</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_bf_tbl_all</span><span class="p">]</span>
    <span class="n">gf_only</span> <span class="o">=</span> <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">in_bf_tbl_any</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Ratio calc types: </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;   All gens w/in boiler fuel table:  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_bf</span><span class="p">)</span><span class="si">}</span><span class="s2">#, </span><span class="si">{</span><span class="n">all_bf</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;   Some gens w/in boiler fuel table: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">some_bf</span><span class="p">)</span><span class="si">}</span><span class="s2">#, </span><span class="si">{</span><span class="n">some_bf</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> MW</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;   No gens w/in boiler fuel table:   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gf_only</span><span class="p">)</span><span class="si">}</span><span class="s2">#, </span><span class="si">{</span><span class="n">gf_only</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">:</span><span class="s2">.2</span><span class="si">}</span><span class="s2"> MW&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_bf</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_bf</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">gf_only</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
            <span class="s2">&quot;Error in splitting the gens between records showing up fully, &quot;</span>
            <span class="s2">&quot;partially, or not at all in the boiler fuel table.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># In the case where we have all of the fuel from the bf</span>
    <span class="c1"># table, we still allocate, because the fuel reported in these two</span>
    <span class="c1"># tables don&#39;t always match perfectly</span>
    <span class="n">all_bf</span> <span class="o">=</span> <span class="n">all_bf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">frac_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl_pm_fuel</span>
        <span class="p">),</span>
        <span class="n">frac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_fuel</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># _ = _test_frac(all_bf)</span>

    <span class="n">some_bf</span> <span class="o">=</span> <span class="n">some_bf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="c1"># fraction of the fuel consumption that should go to the generators that</span>
        <span class="c1"># report in the boiler fuel table</span>
        <span class="n">frac_from_bf_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl_pm_fuel</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_gf_tbl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl_pm_fuel</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_gf_tbl</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="c1"># for records within these mix groups that do have fuel consumption in the</span>
        <span class="c1"># bf table..</span>
        <span class="n">frac_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_bf_tbl_pm_fuel</span>
        <span class="p">),</span>  <span class="c1"># generator based fuel from bf table</span>
        <span class="n">frac_bf</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_fuel</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_from_bf_tbl</span><span class="p">,</span>
        <span class="c1"># fraction of fuel that does not show up in the bf table</span>
        <span class="c1"># set minimum fraction to zero so we don&#39;t get negative fuel</span>
        <span class="n">frac_missing_from_bf_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">frac_from_bf_tbl</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_from_bf_tbl</span><span class="p">),</span> <span class="mi">0</span>
        <span class="p">),</span>
        <span class="n">capacity_mw_missing_from_bf_tbl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">in_bf_tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span>
        <span class="p">),</span>
        <span class="n">frac_cap</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">frac_missing_from_bf_tbl</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_missing_from_bf_tbl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_fuel_in_bf_tbl_group</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="c1"># the real deal</span>
        <span class="c1"># this could also be `x.frac_bf + x.frac_cap` because the frac_bf</span>
        <span class="c1"># should be 0 for any generator that does not have fuel in the bf_tbl</span>
        <span class="c1"># and frac_cap should be 0 for any generator that has fuel in the</span>
        <span class="c1"># bf_tbl.</span>
        <span class="n">frac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">in_bf_tbl</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_bf</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_cap</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># _ = _test_frac(some_bf)</span>

    <span class="c1"># Calculate what fraction of the total capacity is associated with each of</span>
    <span class="c1"># the generators in the grouping.</span>
    <span class="n">gf_only</span> <span class="o">=</span> <span class="n">gf_only</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">frac_cap</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_pm_fuel</span><span class="p">,</span>
        <span class="n">frac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">frac_cap</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># _ = _test_frac(gf_only)</span>

    <span class="c1"># squish all of these methods back together.</span>
    <span class="n">fuel_alloc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">all_bf</span><span class="p">,</span> <span class="n">some_bf</span><span class="p">,</span> <span class="n">gf_only</span><span class="p">])</span>
    <span class="c1"># _ = _test_frac(fuel_alloc)</span>

    <span class="c1"># replace the placeholder missing values with zero before allocating</span>
    <span class="c1"># since some of these may have been aggregated, well, flag any values less than the</span>
    <span class="c1"># sentinel missing value</span>
    <span class="n">fuel_alloc</span> <span class="o">=</span> <span class="n">fuel_alloc</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">fuel_consumed_mmbtu_gf_tbl</span><span class="o">=</span><span class="n">remove_aggregated_sentinel_value</span><span class="p">(</span>
            <span class="n">fuel_alloc</span><span class="p">[</span><span class="s2">&quot;fuel_consumed_mmbtu_gf_tbl&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">fuel_consumed_for_electricity_mmbtu_gf_tbl</span><span class="o">=</span><span class="n">remove_aggregated_sentinel_value</span><span class="p">(</span>
            <span class="n">fuel_alloc</span><span class="p">[</span><span class="s2">&quot;fuel_consumed_for_electricity_mmbtu_gf_tbl&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># do the allocating-ing!</span>
    <span class="n">fuel_alloc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">fuel_alloc</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="c1"># we could x.fuel_consumed_mmbtu_bf_tbl.fillna here if we wanted to</span>
            <span class="c1"># take the net gen</span>
            <span class="n">fuel_consumed_mmbtu</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_mmbtu_gf_tbl</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span>
            <span class="n">fuel_consumed_for_electricity_mmbtu</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_for_electricity_mmbtu_gf_tbl</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">frac</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fuel_alloc</span></div>



<div class="viewcode-block" id="remove_aggregated_sentinel_value">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.remove_aggregated_sentinel_value">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_aggregated_sentinel_value</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replace the post-aggregation sentinel values in a column with zero.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scalar</span> <span class="o">*</span> <span class="n">MISSING_SENTINEL</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span></div>



<div class="viewcode-block" id="group_duplicate_keys">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.group_duplicate_keys">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">group_duplicate_keys</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Catches duplicate keys in the allocated data and groups them together.</span>

<span class="sd">    Merging ``net_gen_alloc`` and ``fuel_alloc`` together requires unique keys in each</span>
<span class="sd">    df. Sometimes the allocation process creates duplicate keys. This function</span>
<span class="sd">    identifies when this happens, and aggregates the data on these keys to remove the</span>
<span class="sd">    duplicates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># identify any duplicate records</span>
    <span class="n">duplicate_keys</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">(</span><span class="n">IDX_GENS_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">]))</span>
    <span class="p">]</span>
    <span class="c1"># if there are duplicate records, print a warning and fix the issue</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicate_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Duplicate keys exist in the allocated data.&quot;</span>
            <span class="s2">&quot;These will be grouped together, but check the source &quot;</span>
            <span class="s2">&quot;of this issue.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">duplicate_keys</span><span class="p">[</span><span class="n">IDX_GENS_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">]])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">IDX_GENS_PM_ESC</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;energy_source_code_num&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<span class="c1">#####################################################################################</span>
<span class="c1"># Fuel Allocation Functions</span>
<span class="c1">#####################################################################################</span>
<div class="viewcode-block" id="distribute_annually_reported_data_to_months_if_annual">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.distribute_annually_reported_data_to_months_if_annual">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">distribute_annually_reported_data_to_months_if_annual</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">key_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">data_column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;YS&quot;</span><span class="p">,</span> <span class="s2">&quot;MS&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allocates annually-reported data from the gen or bf table to each month.</span>

<span class="sd">    Certain plants only report data to the generator table and boiler fuel table</span>
<span class="sd">    on an annual basis. In these cases, their annual total is reported as a single</span>
<span class="sd">    value in January or December, and the other 11 months are reported as missing</span>
<span class="sd">    values. This function first identifies which plants are annual respondents by</span>
<span class="sd">    identifying plants that have 11 months of missing data, with the one month of</span>
<span class="sd">    existing data being in January or December. This is an assumption based on seeing</span>
<span class="sd">    that over 40% of the plants that have 11 months of missing data report their one</span>
<span class="sd">    month of data in January and December (this ratio of reporting is checked and will</span>
<span class="sd">    raise a warning if it becomes untrue). It then distributes this annually-reported</span>
<span class="sd">    value evenly across all months in the year. Because we know some of the plants are</span>
<span class="sd">    reporting in only one month that is not January or December, the assumption about</span>
<span class="sd">    January and December only reporting is almost certainly resulting in some non-annual</span>
<span class="sd">    data being allocated across all months, but on average the data will be more</span>
<span class="sd">    accurate.</span>

<span class="sd">    Note: We should be able to use the ``reporting_frequency_code`` column for the</span>
<span class="sd">    identification of annually reported data. This currently does not work because we</span>
<span class="sd">    assumed this was a plant-level annual attribute (and is thus stored in the</span>
<span class="sd">    ``core_eia860__scd_plants`` table). See Issue #1933.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: A dataframe of either generation or boiler-fuel data, loaded from</span>
<span class="sd">            :ref:`out_eia923__monthly_generation` or</span>
<span class="sd">            :ref:`out_eia923__yearly_generation` and</span>
<span class="sd">            :ref:`out_eia923__monthly_boiler_fuel` or</span>
<span class="sd">            :ref:`out_eia923__yearly_boiler_fuel` or respectively.</span>
<span class="sd">        key_columns: a list of the primary key column names, either</span>
<span class="sd">            ``[&quot;plant_id_eia&quot;,&quot;boiler_id&quot;,&quot;energy_source_code&quot;]`` or</span>
<span class="sd">            ``[&quot;plant_id_eia&quot;,&quot;generator_id&quot;]``</span>
<span class="sd">        data_column_name: the name of the data column to allocate, either</span>
<span class="sd">            &quot;net_generation_mwh&quot; or &quot;fuel_consumed_mmbtu&quot; depending on the df specified</span>
<span class="sd">        freq: frequency of input df. Must be either ``YS`` or ``MS``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dataframe with the annually reported generation or fuel consumption values</span>
<span class="sd">        allocated to each month.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;MS&quot;</span><span class="p">:</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">assign_plant_year</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">plant_year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">plant_id_eia</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">reporters</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">assign_plant_year</span><span class="p">)</span>
        <span class="c1"># get a count of the number of missing values in a year</span>
        <span class="n">key_columns_annual</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plant_year&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">key_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;report_date&quot;</span>
        <span class="p">]</span>
        <span class="n">reporters</span><span class="p">[</span><span class="s2">&quot;missing_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">reporters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">missing_data</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
                    <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">reporters</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">key_columns_annual</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;missing_data&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># separate annual and monthly reporters</span>
        <span class="n">once_a_year_reporters</span> <span class="o">=</span> <span class="n">reporters</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="n">reporters</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>
                <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">reporters</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">reporters</span><span class="o">.</span><span class="n">missing_data</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">annual_reporters</span> <span class="o">=</span> <span class="n">once_a_year_reporters</span><span class="p">[</span>
            <span class="n">once_a_year_reporters</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">])</span>
        <span class="p">]</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;plant_year&quot;</span><span class="p">])</span>

        <span class="c1"># check if the plurality of the once_a_year_reporters are in Jan or Dec</span>
        <span class="n">perc_of_annual</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">annual_reporters</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">once_a_year_reporters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">perc_of_annual</span> <span class="o">&lt;</span> <span class="mf">0.40</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Less than 40% (</span><span class="si">{</span><span class="n">perc_of_annual</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">) of the once-a-year reporters &quot;</span>
                <span class="s2">&quot;are in January or December. Examine assumption about annual reporters.&quot;</span>
            <span class="p">)</span>

        <span class="n">reporters</span> <span class="o">=</span> <span class="n">reporters</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;plant_year&quot;</span><span class="p">])</span>
        <span class="n">monthly_reporters</span> <span class="o">=</span> <span class="n">reporters</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">reporters</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">annual_reporters</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Distributing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">annual_reporters</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">reporters</span><span class="p">)</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> annually reported&quot;</span>
            <span class="s2">&quot; records to months.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># first convert the december month to january bc expand_timeseries expands from</span>
        <span class="c1"># the start date and we want january on.</span>
        <span class="n">annual_reporters_expanded</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">annual_reporters</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">report_date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">expand_timeseries</span><span class="p">,</span>
                <span class="n">key_cols</span><span class="o">=</span><span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">key_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
                <span class="n">date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
                <span class="n">fill_through_freq</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">data_column_name</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">]</span> <span class="o">/</span> <span class="mi">12</span><span class="p">})</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">assign_plant_year</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">apply_pudl_dtypes</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;plant_year&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># sometimes a plant oscillates btwn annual and monthly reporting. when it does</span>
        <span class="c1"># expand_timeseries will generate monthly records for years that were not</span>
        <span class="c1"># included annual_reporters bc expand_timeseries expands from the most recent</span>
        <span class="c1"># to the last date... so we remove any plant/year combo that didn&#39;t show up</span>
        <span class="c1"># before the expansion</span>
        <span class="n">annual_reporters_expanded</span> <span class="o">=</span> <span class="n">annual_reporters_expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">annual_reporters_expanded</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">annual_reporters</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">df_out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">monthly_reporters</span><span class="p">,</span> <span class="n">annual_reporters_expanded</span><span class="p">])</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;missing_data&quot;</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">freq</span> <span class="o">==</span> <span class="s2">&quot;YS&quot;</span><span class="p">:</span>
        <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Frequency must be either `YS` or `MS`. Got </span><span class="si">{</span><span class="n">freq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_out</span></div>



<div class="viewcode-block" id="manually_fix_energy_source_codes">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.manually_fix_energy_source_codes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">manually_fix_energy_source_codes</span><span class="p">(</span><span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reassign fuel codes that differ between gen-fuel and gens tables.&quot;&quot;&quot;</span>
    <span class="c1"># plant 10204 should be waste heat instead of other</span>
    <span class="n">gf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">gf</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10204</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gf</span><span class="p">[</span><span class="s2">&quot;energy_source_code&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OTH&quot;</span><span class="p">),</span>
        <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WH&quot;</span>

    <span class="k">return</span> <span class="n">gf</span></div>



<div class="viewcode-block" id="adjust_msw_energy_source_codes">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.adjust_msw_energy_source_codes">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">adjust_msw_energy_source_codes</span><span class="p">(</span>
    <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">bf_by_gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adjusts MSW codes.</span>

<span class="sd">    Adjust the MSW codes in gens to match those used in gf and bf.</span>

<span class="sd">    In recent years, EIA-923 started splitting out the ``MSW`` (municipal_solid_waste)</span>
<span class="sd">    into its consitituent components ``MSB`` (municipal_solid_waste_biogenic) and</span>
<span class="sd">    ``MSN`` (municipal_solid_nonbiogenic). However, the EIA-860 Generators table still</span>
<span class="sd">    only uses the ``MSW`` code.</span>

<span class="sd">    This function identifies which MSW codes are used in the gf and bf tables and</span>
<span class="sd">    creates records to match these.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Adjust any energy source codes related to municipal solid waste</span>
    <span class="c1"># get a list of all of the MSW-related codes used in gf and bf</span>
    <span class="n">codes_used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">energy_source_code</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
        <span class="n">bf_by_gens</span><span class="o">.</span><span class="n">energy_source_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="c1"># NOTE 2025-12-11: we sort this reverse-ly to match the indeterminate order that happens to be in nightly builds right now</span>
    <span class="n">msw_codes_used</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;MSN&quot;</span><span class="p">,</span> <span class="s2">&quot;MSB&quot;</span><span class="p">,</span> <span class="s2">&quot;MSW&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">codes_used</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="c1"># join these codes into a string that will be used to replace the MSW code</span>
    <span class="n">replacement_codes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msw_codes_used</span><span class="p">)</span>

    <span class="c1"># if MSN and MSB codes are used, replace the existing MSW value</span>
    <span class="k">if</span> <span class="n">replacement_codes</span> <span class="o">!=</span> <span class="s2">&quot;MSW&quot;</span><span class="p">:</span>
        <span class="c1"># for each type of energy source column, we want to expand any &quot;MSW&quot; values</span>
        <span class="k">for</span> <span class="n">esc_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;energy_&quot;</span><span class="p">,</span> <span class="s2">&quot;planned_energy_&quot;</span><span class="p">,</span> <span class="s2">&quot;startup_&quot;</span><span class="p">]:</span>
            <span class="c1"># create a column of all unique fuels in the order in which they appear (ESC 1-6, startup fuel 1-6)</span>
            <span class="c1"># this column will have each fuel code separated by a comma</span>
            <span class="n">gens</span><span class="p">[</span><span class="s2">&quot;unique_esc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fuel</span> <span class="k">for</span> <span class="n">fuel</span> <span class="ow">in</span> <span class="n">fuels</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">fuel</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">fuels</span> <span class="ow">in</span> <span class="n">gens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">:,</span>
                    <span class="p">[</span>
                        <span class="n">col</span>
                        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gens</span><span class="o">.</span><span class="n">columns</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">esc_type</span><span class="si">}</span><span class="s2">source_code&quot;</span><span class="p">)</span>
                    <span class="p">],</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="p">]</span>

            <span class="c1"># replace any MSW codes with the codes used in bf and gf</span>
            <span class="n">gens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gens</span><span class="p">[</span><span class="s2">&quot;unique_esc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;MSW&quot;</span><span class="p">),</span> <span class="s2">&quot;unique_esc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gens</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">gens</span><span class="p">[</span><span class="s2">&quot;unique_esc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;MSW&quot;</span><span class="p">),</span> <span class="s2">&quot;unique_esc&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;MSW&quot;</span><span class="p">,</span> <span class="n">replacement_codes</span><span class="p">)</span>

            <span class="c1"># we need to create numbered energy source code columns for each fuel</span>
            <span class="c1"># first, we need to identify the maximum number of fuel codes that exist for a single generator</span>
            <span class="n">max_num_esc</span> <span class="o">=</span> <span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">unique_esc</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># create a list of numbered fuel code columns</span>
            <span class="n">esc_columns_to_add</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_num_esc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">esc_columns_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">esc_type</span><span class="si">}</span><span class="s2">source_code_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># drop all of the existing energy source code columns</span>
            <span class="n">gens</span> <span class="o">=</span> <span class="n">gens</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">col</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">gens</span><span class="o">.</span><span class="n">columns</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">esc_type</span><span class="si">}</span><span class="s2">source_code&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># create new numbered energy source code columns by expanding the list of unique fuels</span>
            <span class="n">gens</span><span class="p">[</span><span class="n">esc_columns_to_add</span><span class="p">]</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="s2">&quot;unique_esc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># creating columns from this list sometimes replaces NaN values with &quot;&quot; or None</span>
            <span class="n">gens</span><span class="p">[</span><span class="n">esc_columns_to_add</span><span class="p">]</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="n">esc_columns_to_add</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">gens</span><span class="p">[</span><span class="n">esc_columns_to_add</span><span class="p">]</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="n">esc_columns_to_add</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="c1"># drop the intermediate column</span>
            <span class="n">gens</span> <span class="o">=</span> <span class="n">gens</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;unique_esc&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">gens</span></div>



<div class="viewcode-block" id="add_missing_energy_source_codes_to_gens">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.add_missing_energy_source_codes_to_gens">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_missing_energy_source_codes_to_gens</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add energy_source_codes to gens that were found only in the gf or bf tables.</span>

<span class="sd">    In some cases, non-zero fuel consumption and net generation is reported in the</span>
<span class="sd">    EIA-923 generation and fuel table that is associated with an energy_source_code that</span>
<span class="sd">    is not associated with that plant-prime mover in the gens table, which would cause</span>
<span class="sd">    these data to get dropped when these two tables are merged. To fix this, for each</span>
<span class="sd">    plant-pm, this function identifies such esc, and adds them to the `gens_at_freq`</span>
<span class="sd">    table as new energy_source_code columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing_gf_escs_from_gens</span> <span class="o">=</span> <span class="n">identify_missing_gf_escs_in_gens</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing_gf_escs_from_gens</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gens_at_freq</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">]</span>
    <span class="c1"># pivot these data to become new numbered energy_source_code_n columns starting at 8</span>
    <span class="c1"># the native table ends at 6, but we add one more in adjust_msw_energy_source_codes</span>
    <span class="n">missing_gf_escs_from_gens</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">missing_gf_escs_from_gens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">8</span>
    <span class="p">)</span>
    <span class="n">missing_gf_escs_from_gens</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_gf_escs_from_gens</span><span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">missing_gf_escs_from_gens</span> <span class="o">=</span> <span class="n">missing_gf_escs_from_gens</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;num&quot;</span>
    <span class="p">)[[</span><span class="s2">&quot;energy_source_code&quot;</span><span class="p">]]</span>
    <span class="n">missing_gf_escs_from_gens</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_gf_escs_from_gens</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">missing_gf_escs_from_gens</span> <span class="o">=</span> <span class="n">missing_gf_escs_from_gens</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># merge these missing fuel columns into the gens data</span>
    <span class="n">gens_at_freq</span> <span class="o">=</span> <span class="n">gens_at_freq</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">missing_gf_escs_from_gens</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:m&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">gens_at_freq</span></div>



<div class="viewcode-block" id="identify_missing_gf_escs_in_gens">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.identify_missing_gf_escs_in_gens">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">identify_missing_gf_escs_in_gens</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">bf</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify energy_source_codes that exist in gf or bf but not gens.&quot;&quot;&quot;</span>
    <span class="c1"># create a version of gf that identifies all of the unique energy source codes</span>
    <span class="c1"># create a filtered version of gf and bf data</span>
    <span class="n">escs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">IDX_PM_ESC</span><span class="p">],</span> <span class="n">bf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">IDX_PM_ESC</span><span class="p">]])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="c1"># create a version that identifies all of the unique energy source codes</span>
    <span class="c1"># associated with each plant-pm for gens with non-retired generation</span>
    <span class="n">esc_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;_source_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">gens_escs</span> <span class="o">=</span> <span class="n">gens_at_freq</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="p">(</span><span class="n">gens_at_freq</span><span class="p">[</span><span class="s2">&quot;generator_retirement_date&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">gens_at_freq</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">]),</span>
        <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">esc_columns</span><span class="p">,</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">gens_escs</span> <span class="o">=</span> <span class="n">gens_escs</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">],</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">])</span>
    <span class="n">gens_escs</span> <span class="o">=</span> <span class="n">gens_escs</span><span class="p">[</span><span class="o">~</span><span class="n">gens_escs</span><span class="p">[</span><span class="s2">&quot;energy_source_code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>

    <span class="c1"># create a dataframe that identifies all plant-pm ESCs that only exist in gf</span>
    <span class="n">missing_gf_escs_from_gens</span> <span class="o">=</span> <span class="n">gens_escs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">escs</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
        <span class="n">indicator</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">missing_gf_escs_from_gens</span> <span class="o">=</span> <span class="n">missing_gf_escs_from_gens</span><span class="p">[</span>
        <span class="n">missing_gf_escs_from_gens</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;right_only&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">missing_gf_escs_from_gens</span></div>



<div class="viewcode-block" id="allocate_bf_data_to_gens">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.allocate_bf_data_to_gens">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">allocate_bf_data_to_gens</span><span class="p">(</span>
    <span class="n">bf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">bga</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Allocates boiler fuel data to the generator level.</span>

<span class="sd">    Distributes boiler-level data from core_eia923__monthly_boiler_fuel to the generator level based</span>
<span class="sd">    on the boiler-generator association table and the nameplate capacity of the</span>
<span class="sd">    connected generators.</span>

<span class="sd">    Because fuel consumption in the core_eia923__monthly_boiler_fuel table is reported per boiler_id,</span>
<span class="sd">    we must first map this data to generators using the core_eia860__assn_boiler_generator</span>
<span class="sd">    table. For boilers that have a 1:m or m: m relationship with generators, we allocate</span>
<span class="sd">    the reported fuel to each associated generator based on the nameplate capacity of</span>
<span class="sd">    each generator. So if boiler &quot;1&quot; was associated with generator A (25 MW) and generator</span>
<span class="sd">    B (75 MW), 25% of the fuel consumption would be allocated to generator A and 75% would</span>
<span class="sd">    be allocated to generator B.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># merge generator capacity information into the BGA</span>
    <span class="n">bga_w_gen</span> <span class="o">=</span> <span class="n">bga</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">gens</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">],</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># calculate an allocation fraction based on the capacity of each generator with which</span>
    <span class="c1"># a boiler is connected</span>
    <span class="n">bga_w_gen</span><span class="p">[</span><span class="s2">&quot;cap_frac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bga_w_gen</span><span class="p">[[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">]]</span> <span class="o">/</span> <span class="n">bga_w_gen</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;boiler_id&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">]</span>
    <span class="p">)[[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>

    <span class="c1"># drop records from bf where there is missing fuel data</span>
    <span class="n">bf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;fuel_consumed_mmbtu&quot;</span><span class="p">)</span>
    <span class="c1"># merge in the generator id and the capacity fraction</span>
    <span class="n">bf_assoc_gen</span> <span class="o">=</span> <span class="n">pudl</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">date_merge</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="n">bf</span><span class="p">,</span>
        <span class="n">right</span><span class="o">=</span><span class="n">bga_w_gen</span><span class="p">,</span>
        <span class="n">left_date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
        <span class="n">right_date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
        <span class="n">new_date_col</span><span class="o">=</span><span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;boiler_id&quot;</span><span class="p">,</span> <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">],</span>
        <span class="n">date_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">report_at_start</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># distribute the boiler-level data to each generator based on the capacity fraciton</span>
    <span class="n">bf_assoc_gen</span><span class="p">[</span><span class="s2">&quot;fuel_consumed_mmbtu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bf_assoc_gen</span><span class="p">[</span><span class="s2">&quot;fuel_consumed_mmbtu&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">bf_assoc_gen</span><span class="p">[</span><span class="s2">&quot;cap_frac&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># group the data by generator-PM-fuel, dropping records where there is no boiler-generator association</span>
    <span class="n">bf_by_gen</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">bf_assoc_gen</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;energy_source_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numeric_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># remove intermediate columns</span>
    <span class="n">bf_by_gen</span> <span class="o">=</span> <span class="n">bf_by_gen</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;cap_frac&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">bf_by_gen</span></div>



<span class="c1">########################################################################################</span>
<span class="c1"># Tests of Outputs</span>
<span class="c1">########################################################################################</span>
<div class="viewcode-block" id="warn_if_missing_pms">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.warn_if_missing_pms">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">warn_if_missing_pms</span><span class="p">(</span><span class="n">gens</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log warning if there are too many null ``prime_mover_code`` s.</span>

<span class="sd">    Warn if prime mover codes in gens do not match the codes in the gf table this is</span>
<span class="sd">    something that should probably be fixed in the input data see</span>
<span class="sd">    https://github.com/catalyst-cooperative/pudl/issues/1585 set a threshold and ignore</span>
<span class="sd">    2001 bc most errors are 2001 errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing_pm</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span>
        <span class="n">gens</span><span class="p">[</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="mi">2001</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_pm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_pm</span><span class="p">)</span><span class="si">}</span><span class="s2"> generators are missing prime mover codes in gens_eia860. &quot;</span>
            <span class="s2">&quot;This will result in incorrect allocation.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="n">missing_pm</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;report_date&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;unit_id_pudl&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operational_status&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;energy_source_code_1&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="_test_frac">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel._test_frac">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_test_frac</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if each of the IDX_PM_ESC groups frac&#39;s add up to 1.&quot;&quot;&quot;</span>
    <span class="n">frac_test</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">IDX_PM_ESC</span><span class="p">)[[</span><span class="s2">&quot;frac&quot;</span><span class="p">,</span> <span class="s2">&quot;net_generation_mwh_g_tbl&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">frac_test_bad</span> <span class="o">=</span> <span class="n">frac_test</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">frac_test</span><span class="o">.</span><span class="n">frac</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">frac_test</span><span class="o">.</span><span class="n">frac</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">frac_test_bad</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># raise AssertionError(</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Ooopsies. You got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frac_test_bad</span><span class="p">)</span><span class="si">}</span><span class="s2"> records where the &quot;</span>
            <span class="s2">&quot;&#39;frac&#39; column isn&#39;t adding up to 1 for each &#39;IDX_PM_ESC&#39; &quot;</span>
            <span class="s2">&quot;group. Check &#39;make_allocation_frac()&#39;&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">frac_test_bad</span></div>



<div class="viewcode-block" id="_test_gen_pm_fuel_output">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel._test_gen_pm_fuel_output">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_test_gen_pm_fuel_output</span><span class="p">(</span>
    <span class="n">gen_pm_fuel</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="c1"># this is just for testing/debugging</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_net_gen_diff</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">gen_pm_fuel_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">gen_pm_fuel</span><span class="p">,</span>
            <span class="n">gen_pm_fuel</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">idx</span><span class="p">)[[</span><span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">min_count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s2">&quot;_test&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">on</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">net_generation_mwh_diff</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_gf_tbl</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_test</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">gen_pm_fuel_test</span>

    <span class="c1"># make different totals and calc differences for two different indexes</span>
    <span class="n">gen_pm_fuel_test</span> <span class="o">=</span> <span class="n">calc_net_gen_diff</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">IDX_PM_ESC</span><span class="p">)</span>
    <span class="n">gen_fuel_test</span> <span class="o">=</span> <span class="n">calc_net_gen_diff</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">IDX_ESC</span><span class="p">)</span>

    <span class="n">gen_pm_fuel_test</span> <span class="o">=</span> <span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">net_generation_mwh_test</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_test</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">gen_fuel_test</span><span class="o">.</span><span class="n">net_generation_mwh_test</span>
        <span class="p">),</span>
        <span class="n">net_generation_mwh_diff</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_diff</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="n">gen_fuel_test</span><span class="o">.</span><span class="n">net_generation_mwh_diff</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">bad_diff</span> <span class="o">=</span> <span class="n">gen_pm_fuel_test</span><span class="p">[</span>
        <span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">net_generation_mwh_diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">net_generation_mwh_diff</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bad_diff</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">gen_pm_fuel</span><span class="p">)</span><span class="si">:</span><span class="s2">.03%</span><span class="si">}</span><span class="s2"> of records have are partially &quot;</span>
        <span class="s2">&quot;off from their &#39;IDX_PM_ESC&#39; group&quot;</span>
    <span class="p">)</span>
    <span class="n">no_cap_gen</span> <span class="o">=</span> <span class="n">gen_pm_fuel_test</span><span class="p">[</span>
        <span class="p">(</span><span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">net_generation_mwh_g_tbl</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_cap_gen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">no_cap_gen</span><span class="p">)</span><span class="si">}</span><span class="s2"> records have no capacity or net gen&quot;</span><span class="p">)</span>
    <span class="c1"># remove the junk/corrective plants</span>
    <span class="n">fuel_net_gen</span> <span class="o">=</span> <span class="n">gf</span><span class="p">[</span><span class="n">gf</span><span class="o">.</span><span class="n">plant_id_eia</span> <span class="o">!=</span> <span class="s2">&quot;99999&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">net_generation_mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;gen v fuel table net gen diff:      &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">gen</span><span class="o">.</span><span class="n">net_generation_mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fuel_net_gen</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;new v fuel table net gen diff:      &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">net_generation_mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fuel_net_gen</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">gen_pm_fuel_test</span> <span class="o">=</span> <span class="n">gen_pm_fuel_test</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;net_generation_mwh_test&quot;</span><span class="p">,</span> <span class="s2">&quot;net_generation_mwh_diff&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">gen_pm_fuel_test</span></div>



<div class="viewcode-block" id="test_gen_fuel_allocation">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.test_gen_fuel_allocation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_gen_fuel_allocation</span><span class="p">(</span>
    <span class="n">gen</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">net_gen_alloc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Does the allocated MWh differ from the granular :ref:`core_eia923__monthly_generation`?</span>

<span class="sd">    Args:</span>
<span class="sd">        gen: the ``core_eia923__monthly_generation`` table.</span>
<span class="sd">        net_gen_alloc: the allocated net generation at the :py:const:`IDX_PM_ESC` level</span>
<span class="sd">        ratio: the tolerance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">net_gen_alloc</span><span class="p">[</span><span class="n">net_gen_alloc</span><span class="o">.</span><span class="n">more_mwh_in_g_than_gf_tbl</span><span class="p">]</span>
    <span class="n">gens_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">agg_by_generator</span><span class="p">(</span><span class="n">net_gen_alloc</span><span class="p">,</span> <span class="n">sum_cols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">]),</span>
        <span class="n">gen</span><span class="p">,</span>
        <span class="n">on</span><span class="o">=</span><span class="n">IDX_GENS</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_new&quot;</span><span class="p">,</span> <span class="s2">&quot;_og&quot;</span><span class="p">),</span>
    <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">net_generation_new_v_og</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_new</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh_og</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">os_ratios</span> <span class="o">=</span> <span class="n">gens_test</span><span class="p">[</span>
        <span class="p">(</span><span class="o">~</span><span class="n">gens_test</span><span class="o">.</span><span class="n">net_generation_new_v_og</span><span class="o">.</span><span class="n">between</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ratio</span><span class="p">)))</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">gens_test</span><span class="o">.</span><span class="n">net_generation_new_v_og</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
    <span class="p">]</span>
    <span class="n">os_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">os_ratios</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">gens_test</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os_ratio</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> of generator records are more that </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> off from the net generation table&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">ratio</span> <span class="o">==</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">os_ratio</span> <span class="o">&gt;</span> <span class="mf">0.15</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Many generator records that have allocated net gen more than </span><span class="si">{</span><span class="n">ratio</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="test_original_gf_vs_the_allocated_by_gens_gf">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html#pudl.analysis.allocate_gen_fuel.test_original_gf_vs_the_allocated_by_gens_gf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_original_gf_vs_the_allocated_by_gens_gf</span><span class="p">(</span>
    <span class="n">gf</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">gf_allocated</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">data_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATA_COLUMNS</span><span class="p">,</span>
    <span class="n">by</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">],</span>
    <span class="n">acceptance_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.07</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test whether the allocated data and original data sum up to similar values.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If the number of plant/years that are off by more than 5% is</span>
<span class="sd">            not within acceptable level of tolerance.</span>
<span class="sd">        AssertionError: If the difference between the allocated and original data for</span>
<span class="sd">            any plant/year is off by more than x10 or x-5.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gf_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">)[</span><span class="n">data_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">gf_allocated</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">report_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">)[</span><span class="n">data_columns</span><span class="p">]</span>
        <span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_og&quot;</span><span class="p">,</span> <span class="s2">&quot;_allocated&quot;</span><span class="p">),</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># calculate the difference between the allocated and the original data</span>
    <span class="n">gf_test</span> <span class="o">=</span> <span class="n">gf_test</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="o">**</span><span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_diff&quot;</span><span class="p">:</span> <span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_allocated&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_og&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data_columns</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="c1"># remove the inf diffs for net gen if the allocated value if small. many seem to be</span>
    <span class="c1"># a result of the MISSING_SENTINEL filling in.</span>
    <span class="k">if</span> <span class="n">gf_test</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">gf_test</span><span class="o">.</span><span class="n">net_generation_mwh_diff</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">gf_test</span><span class="o">.</span><span class="n">net_generation_mwh_allocated</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">gf_test</span> <span class="o">=</span> <span class="n">gf_test</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">gf_test</span><span class="o">.</span><span class="n">net_generation_mwh_diff</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">data_col</span> <span class="ow">in</span> <span class="n">data_columns</span><span class="p">:</span>
        <span class="n">col_test</span> <span class="o">=</span> <span class="n">gf_test</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_diff&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.05</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_diff&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="n">off_by_5_perc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_test</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">gf_test</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">off_by_5_perc</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2"> of allocated plant/year&#39;s are off by more&quot;</span>
            <span class="s2">&quot; than 5%&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">off_by_5_perc</span> <span class="o">&gt;</span> <span class="n">acceptance_threshold</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">col_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">gf_test</span><span class="p">)</span><span class="si">}</span><span class="s2"> plants&#39; (</span><span class="si">{</span><span class="n">off_by_5_perc</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">) allocated </span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2"> are off&quot;</span>
                <span class="s2">&quot; the original data by more than 5%. Expected &lt; </span><span class="si">{acceptance_threshold:.1%}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">max_diff</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">min_diff</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">gf_test</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2">: Min and max difference are x</span><span class="si">{</span><span class="n">min_diff</span><span class="si">}</span><span class="s2"> and x</span><span class="si">{</span><span class="n">max_diff</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">max_diff</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="n">min_diff</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;ahhhHHhh. </span><span class="si">{</span><span class="n">data_col</span><span class="si">}</span><span class="s2"> has some plant-year aggregations that that &quot;</span>
                <span class="s2">&quot;allocated data that is off from the original core_eia923__monthly_generation_fuel &quot;</span>
                <span class="s2">&quot;data by more than an accepted range of tolerance. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  Min difference: </span><span class="si">{</span><span class="n">min_diff</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;  Max difference: </span><span class="si">{</span><span class="n">max_diff</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">gf_test</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2016-2026, Catalyst Cooperative, CC-BY-4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=11fc87b4"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>