<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EXWBBTVMWK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-EXWBBTVMWK');
    </script>
    <link rel="index" title="Index" href="../../../genindex.html"><link rel="search" title="Search" href="../../../search.html">
        <link rel="prefetch" href="../../../_static/catalyst_logo-200x200.png" as="image">

    <!-- Generated with Sphinx 9.1.0 and Furo 2025.12.19 -->
        <title>pudl.analysis.timeseries_cleaning - PUDL 2026.2.1.dev10 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=7bdb33bb" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=b1990d62" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-announcement-background: yellow;
  --color-announcement-text: red;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     <b>Take our ~10 minute <a href="https://forms.gle/E9ou5fgMcR7YVRCRA">2026 Energy Data Ecosystem Survey!</b> 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">PUDL 2026.2.1.dev10 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../../_static/catalyst_logo-200x200.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">PUDL 2026.2.1.dev10 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">About PUDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_access.html">Data Access</a></li>
<li class="toctree-l1"><a class="reference external" href="https://data.catalyst.coop">PUDL Data Viewer</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../data_sources/index.html">Data Sources</a><input aria-label="Toggle navigation of Data Sources" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/censusdp1tract.html">Census DP1 – Profile of General Demographic Characteristics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/censuspep.html">Population Estimates Program's (PEP) Federal Information Processing Series (FIPS) Codes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eiaapi.html">EIA Bulk API Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia176.html">EIA Form 176 – Annual Report of Natural and Supplemental Gas Supply and Disposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia860.html">EIA Form 860 – Annual Electric Generator Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia861.html">EIA Form 861 – Annual Electric Power Industry Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia923.html">EIA Form 923 – Power Plant Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eia930.html">EIA Form 930 – Hourly and Daily Balancing Authority Operations Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/eiaaeo.html">EIA Annual Energy Outlook (AEO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/epacamd_eia.html">EPA CAMD to EIA Power Sector Data Crosswalk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/epacems.html">EPA Hourly Continuous Emission Monitoring System (CEMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferc1.html">FERC Form 1 – Annual Report of Major Electric Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferc714.html">FERC Form 714 – Annual Electric Balancing Authority Area and Planning Area Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/ferceqr.html">FERC Form 920 – Electric Quarterly Report (EQR)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/gridpathratoolkit.html">GridPath Resource Adequacy Toolkit Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/nrelatb.html">NREL Annual Technology Baseline (ATB) for Electricity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/phmsagas.html">Pipelines and Hazardous Materials Safety Administration (PHMSA) Annual Natural Gas Report</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/rus12.html">USDA RUS Form 12 – Financial and Operating Report: Electric Power Supply</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/rus7.html">USDA RUS Form 7 – Financial and Operating Report: Electric Distribution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/sec10k.html">U.S. Securities and Exchange Commission (SEC) Form 10-K</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/vcerare.html">Vibrant Clean Energy Resource Adequacy Renewable Energy (RARE) Power Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/other_data.html">Other Data in PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_sources/future_data.html">High Priority Target Datasets</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../data_dictionaries/index.html">Data Dictionaries</a><input aria-label="Toggle navigation of Data Dictionaries" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/pudl_db.html">PUDL Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/ferc1_db.html">Raw FERC Form 1 Data Dictionary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/codes_and_labels.html">PUDL Code Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../data_dictionaries/usage_warnings.html">PUDL Usage Warnings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../methodology/index.html">Methodology</a><input aria-label="Toggle navigation of Methodology" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../methodology/timeseries_imputation.html">Timeseries Imputation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../methodology/sec10k_modeling.html">SEC 10-K Ownership Data Extraction Modeling</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../dev/index.html">Development</a><input aria-label="Toggle navigation of Development" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dev_setup.html">Development Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/run_the_etl.html">Running the ETL Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/dev_dagster.html">Developing with Dagster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/project_management.html">Project Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/testing.html">Testing PUDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_validation_quickstart.html">Data validation quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_validation_reference.html">Data validation reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/metadata.html">Metadata editing guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/build_docs.html">Building the Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/datastore.html">Working with the Datastore</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/clone_ferc1.html">Converting raw FERC data to SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/existing_data_updates.html">Existing Data Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/run_a_release.html">Run a Versioned Release</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/pudl_id_mapping.html">PUDL ID Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/naming_conventions.html">Naming Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/data_guidelines.html">Data and ETL Design Guidelines</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/nightly_data_builds.html">Nightly Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/ferceqr_data_builds.html">FERC EQR Data Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/infrastructure_as_code.html">Infrastructure as Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../dev/managing_external_contributions.html">Managing External Contributions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../LICENSE.html">Licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../autoapi/pudl/index.html">pudl</a><input aria-label="Toggle navigation of pudl" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/__main__/index.html">pudl.__main__</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/_version/index.html">pudl._version</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/index.html">pudl.analysis</a><input aria-label="Toggle navigation of pudl.analysis" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/allocate_gen_fuel/index.html">pudl.analysis.allocate_gen_fuel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/fuel_by_plant/index.html">pudl.analysis.fuel_by_plant</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/mcoe/index.html">pudl.analysis.mcoe</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/index.html">pudl.analysis.ml_tools</a><input aria-label="Toggle navigation of pudl.analysis.ml_tools" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/experiment_tracking/index.html">pudl.analysis.ml_tools.experiment_tracking</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/ml_tools/models/index.html">pudl.analysis.ml_tools.models</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/plant_parts_eia/index.html">pudl.analysis.plant_parts_eia</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/index.html">pudl.analysis.record_linkage</a><input aria-label="Toggle navigation of pudl.analysis.record_linkage" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/classify_plants_ferc1/index.html">pudl.analysis.record_linkage.classify_plants_ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_inputs/index.html">pudl.analysis.record_linkage.eia_ferc1_inputs</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_model_config/index.html">pudl.analysis.record_linkage.eia_ferc1_model_config</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_record_linkage/index.html">pudl.analysis.record_linkage.eia_ferc1_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/eia_ferc1_train/index.html">pudl.analysis.record_linkage.eia_ferc1_train</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/embed_dataframe/index.html">pudl.analysis.record_linkage.embed_dataframe</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/link_cross_year/index.html">pudl.analysis.record_linkage.link_cross_year</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/analysis/record_linkage/name_cleaner/index.html">pudl.analysis.record_linkage.name_cleaner</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/service_territory/index.html">pudl.analysis.service_territory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/spatial/index.html">pudl.analysis.spatial</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/state_demand/index.html">pudl.analysis.state_demand</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html">pudl.analysis.timeseries_cleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/analysis/timeseries_evaluation/index.html">pudl.analysis.timeseries_evaluation</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/convert/index.html">pudl.convert</a><input aria-label="Toggle navigation of pudl.convert" class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/convert/censusdp1tract_to_sqlite/index.html">pudl.convert.censusdp1tract_to_sqlite</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/convert/metadata_to_rst/index.html">pudl.convert.metadata_to_rst</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/dbt_wrapper/index.html">pudl.dbt_wrapper</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/etl/index.html">pudl.etl</a><input aria-label="Toggle navigation of pudl.etl" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/asset_checks/index.html">pudl.etl.asset_checks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/check_foreign_keys/index.html">pudl.etl.check_foreign_keys</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/cli/index.html">pudl.etl.cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/eia_bulk_elec_assets/index.html">pudl.etl.eia_bulk_elec_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/ferceqr_deployment/index.html">pudl.etl.ferceqr_deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/glue_assets/index.html">pudl.etl.glue_assets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/etl/static_assets/index.html">pudl.etl.static_assets</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/extract/index.html">pudl.extract</a><input aria-label="Toggle navigation of pudl.extract" class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/censuspep/index.html">pudl.extract.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/csv/index.html">pudl.extract.csv</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/dbf/index.html">pudl.extract.dbf</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia176/index.html">pudl.extract.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia191/index.html">pudl.extract.eia191</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia757a/index.html">pudl.extract.eia757a</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia860/index.html">pudl.extract.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia860m/index.html">pudl.extract.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia861/index.html">pudl.extract.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia923/index.html">pudl.extract.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eia930/index.html">pudl.extract.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eiaaeo/index.html">pudl.extract.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/eiaapi/index.html">pudl.extract.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/epacems/index.html">pudl.extract.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/excel/index.html">pudl.extract.excel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/extractor/index.html">pudl.extract.extractor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc/index.html">pudl.extract.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc1/index.html">pudl.extract.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc2/index.html">pudl.extract.ferc2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc6/index.html">pudl.extract.ferc6</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc60/index.html">pudl.extract.ferc60</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferc714/index.html">pudl.extract.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferccid/index.html">pudl.extract.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/ferceqr/index.html">pudl.extract.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/gridpathratoolkit/index.html">pudl.extract.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/nrelatb/index.html">pudl.extract.nrelatb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/parquet/index.html">pudl.extract.parquet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/phmsagas/index.html">pudl.extract.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/rus12/index.html">pudl.extract.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/rus7/index.html">pudl.extract.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/sec10k/index.html">pudl.extract.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/vcerare/index.html">pudl.extract.vcerare</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/extract/xbrl/index.html">pudl.extract.xbrl</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/ferc_to_sqlite/index.html">pudl.ferc_to_sqlite</a><input aria-label="Toggle navigation of pudl.ferc_to_sqlite" class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/ferc_to_sqlite/cli/index.html">pudl.ferc_to_sqlite.cli</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/glue/index.html">pudl.glue</a><input aria-label="Toggle navigation of pudl.glue" class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/glue/ferc1_eia/index.html">pudl.glue.ferc1_eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/glue/ferc714/index.html">pudl.glue.ferc714</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/helpers/index.html">pudl.helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/io_managers/index.html">pudl.io_managers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/logging_helpers/index.html">pudl.logging_helpers</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/metadata/index.html">pudl.metadata</a><input aria-label="Toggle navigation of pudl.metadata" class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/classes/index.html">pudl.metadata.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/codes/index.html">pudl.metadata.codes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/constants/index.html">pudl.metadata.constants</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/descriptions/index.html">pudl.metadata.descriptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/dfs/index.html">pudl.metadata.dfs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/enums/index.html">pudl.metadata.enums</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/fields/index.html">pudl.metadata.fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/helpers/index.html">pudl.metadata.helpers</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/labels/index.html">pudl.metadata.labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/resource_helpers/index.html">pudl.metadata.resource_helpers</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/index.html">pudl.metadata.resources</a><input aria-label="Toggle navigation of pudl.metadata.resources" class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/allocate_gen_fuel/index.html">pudl.metadata.resources.allocate_gen_fuel</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/censusdp1tract/index.html">pudl.metadata.resources.censusdp1tract</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia/index.html">pudl.metadata.resources.eia</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia176/index.html">pudl.metadata.resources.eia176</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia860/index.html">pudl.metadata.resources.eia860</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia860m/index.html">pudl.metadata.resources.eia860m</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia861/index.html">pudl.metadata.resources.eia861</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia923/index.html">pudl.metadata.resources.eia923</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eia930/index.html">pudl.metadata.resources.eia930</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eiaaeo/index.html">pudl.metadata.resources.eiaaeo</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/eiaapi/index.html">pudl.metadata.resources.eiaapi</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/epacems/index.html">pudl.metadata.resources.epacems</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc1/index.html">pudl.metadata.resources.ferc1</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc1_eia_record_linkage/index.html">pudl.metadata.resources.ferc1_eia_record_linkage</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferc714/index.html">pudl.metadata.resources.ferc714</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferccid/index.html">pudl.metadata.resources.ferccid</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/ferceqr/index.html">pudl.metadata.resources.ferceqr</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/glue/index.html">pudl.metadata.resources.glue</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/gridpathratoolkit/index.html">pudl.metadata.resources.gridpathratoolkit</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/nrelatb/index.html">pudl.metadata.resources.nrelatb</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/phmsagas/index.html">pudl.metadata.resources.phmsagas</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/pudl/index.html">pudl.metadata.resources.pudl</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/rus12/index.html">pudl.metadata.resources.rus12</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/rus7/index.html">pudl.metadata.resources.rus7</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/sec10k/index.html">pudl.metadata.resources.sec10k</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/metadata/resources/vcerare/index.html">pudl.metadata.resources.vcerare</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/sources/index.html">pudl.metadata.sources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/metadata/warnings/index.html">pudl.metadata.warnings</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/output/index.html">pudl.output</a><input aria-label="Toggle navigation of pudl.output" class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/censusdp1tract/index.html">pudl.output.censusdp1tract</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia/index.html">pudl.output.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia860/index.html">pudl.output.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia923/index.html">pudl.output.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eia930/index.html">pudl.output.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/eiaapi/index.html">pudl.output.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/ferc1/index.html">pudl.output.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/ferc714/index.html">pudl.output.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/output/sec10k/index.html">pudl.output.sec10k</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/output/sql/index.html">pudl.output.sql</a><input aria-label="Toggle navigation of pudl.output.sql" class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/output/sql/helpers/index.html">pudl.output.sql.helpers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/index.html">pudl.package_data</a><input aria-label="Toggle navigation of pudl.package_data" class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/censuspep/index.html">pudl.package_data.censuspep</a><input aria-label="Toggle navigation of pudl.package_data.censuspep" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/censuspep/column_maps/index.html">pudl.package_data.censuspep.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia176/index.html">pudl.package_data.eia176</a><input aria-label="Toggle navigation of pudl.package_data.eia176" class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia176/column_maps/index.html">pudl.package_data.eia176.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia191/index.html">pudl.package_data.eia191</a><input aria-label="Toggle navigation of pudl.package_data.eia191" class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia191/column_maps/index.html">pudl.package_data.eia191.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia757a/index.html">pudl.package_data.eia757a</a><input aria-label="Toggle navigation of pudl.package_data.eia757a" class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia757a/column_maps/index.html">pudl.package_data.eia757a.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860/index.html">pudl.package_data.eia860</a><input aria-label="Toggle navigation of pudl.package_data.eia860" class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" role="switch" type="checkbox"/><label for="toctree-checkbox-24"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860/column_maps/index.html">pudl.package_data.eia860.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860m/index.html">pudl.package_data.eia860m</a><input aria-label="Toggle navigation of pudl.package_data.eia860m" class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" role="switch" type="checkbox"/><label for="toctree-checkbox-25"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia860m/column_maps/index.html">pudl.package_data.eia860m.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia861/index.html">pudl.package_data.eia861</a><input aria-label="Toggle navigation of pudl.package_data.eia861" class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" role="switch" type="checkbox"/><label for="toctree-checkbox-26"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia861/column_maps/index.html">pudl.package_data.eia861.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia923/index.html">pudl.package_data.eia923</a><input aria-label="Toggle navigation of pudl.package_data.eia923" class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" role="switch" type="checkbox"/><label for="toctree-checkbox-27"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia923/column_maps/index.html">pudl.package_data.eia923.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia930/index.html">pudl.package_data.eia930</a><input aria-label="Toggle navigation of pudl.package_data.eia930" class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" role="switch" type="checkbox"/><label for="toctree-checkbox-28"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/eia930/column_maps/index.html">pudl.package_data.eia930.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/epacems/index.html">pudl.package_data.epacems</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/ferc1/index.html">pudl.package_data.ferc1</a><input aria-label="Toggle navigation of pudl.package_data.ferc1" class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" role="switch" type="checkbox"/><label for="toctree-checkbox-29"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/ferc1/row_maps/index.html">pudl.package_data.ferc1.row_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/glue/index.html">pudl.package_data.glue</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/phmsagas/index.html">pudl.package_data.phmsagas</a><input aria-label="Toggle navigation of pudl.package_data.phmsagas" class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" role="switch" type="checkbox"/><label for="toctree-checkbox-30"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/phmsagas/column_maps/index.html">pudl.package_data.phmsagas.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus12/index.html">pudl.package_data.rus12</a><input aria-label="Toggle navigation of pudl.package_data.rus12" class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" role="switch" type="checkbox"/><label for="toctree-checkbox-31"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus12/column_maps/index.html">pudl.package_data.rus12.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/rus7/index.html">pudl.package_data.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/settings/index.html">pudl.package_data.settings</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/package_data/test/index.html">pudl.package_data.test</a><input aria-label="Toggle navigation of pudl.package_data.test" class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" role="switch" type="checkbox"/><label for="toctree-checkbox-32"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/package_data/test/column_maps/index.html">pudl.package_data.test.column_maps</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/package_data/vcerare/index.html">pudl.package_data.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/resources/index.html">pudl.resources</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/scripts/index.html">pudl.scripts</a><input aria-label="Toggle navigation of pudl.scripts" class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" role="switch" type="checkbox"/><label for="toctree-checkbox-33"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/auto_match_utilities/index.html">pudl.scripts.auto_match_utilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/dbt_helper/index.html">pudl.scripts.dbt_helper</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/generate_pudl_duckdb/index.html">pudl.scripts.generate_pudl_duckdb</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/pudl_null_cols/index.html">pudl.scripts.pudl_null_cols</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/resource_description/index.html">pudl.scripts.resource_description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/scripts/zenodo_data_release/index.html">pudl.scripts.zenodo_data_release</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/settings/index.html">pudl.settings</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/transform/index.html">pudl.transform</a><input aria-label="Toggle navigation of pudl.transform" class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" role="switch" type="checkbox"/><label for="toctree-checkbox-34"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/censuspep/index.html">pudl.transform.censuspep</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/classes/index.html">pudl.transform.classes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia/index.html">pudl.transform.eia</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia176/index.html">pudl.transform.eia176</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia860/index.html">pudl.transform.eia860</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia860m/index.html">pudl.transform.eia860m</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia861/index.html">pudl.transform.eia861</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia923/index.html">pudl.transform.eia923</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eia930/index.html">pudl.transform.eia930</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eiaaeo/index.html">pudl.transform.eiaaeo</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/eiaapi/index.html">pudl.transform.eiaapi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/epacems/index.html">pudl.transform.epacems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc/index.html">pudl.transform.ferc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc1/index.html">pudl.transform.ferc1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferc714/index.html">pudl.transform.ferc714</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferccid/index.html">pudl.transform.ferccid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/ferceqr/index.html">pudl.transform.ferceqr</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/gridpathratoolkit/index.html">pudl.transform.gridpathratoolkit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/nrelatb/index.html">pudl.transform.nrelatb</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../autoapi/pudl/transform/params/index.html">pudl.transform.params</a><input aria-label="Toggle navigation of pudl.transform.params" class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" role="switch" type="checkbox"/><label for="toctree-checkbox-35"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../autoapi/pudl/transform/params/ferc1/index.html">pudl.transform.params.ferc1</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/phmsagas/index.html">pudl.transform.phmsagas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus/index.html">pudl.transform.rus</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus12/index.html">pudl.transform.rus12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/rus7/index.html">pudl.transform.rus7</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/sec10k/index.html">pudl.transform.sec10k</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/transform/vcerare/index.html">pudl.transform.vcerare</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/pudl/validate/index.html">pudl.validate</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/pudl/workspace/index.html">pudl.workspace</a><input aria-label="Toggle navigation of pudl.workspace" class="toctree-checkbox" id="toctree-checkbox-36" name="toctree-checkbox-36" role="switch" type="checkbox"/><label for="toctree-checkbox-36"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/datastore/index.html">pudl.workspace.datastore</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/resource_cache/index.html">pudl.workspace.resource_cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/pudl/workspace/setup/index.html">pudl.workspace.setup</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../bibliography.html">Bibliography</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for pudl.analysis.timeseries_cleaning</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Screen timeseries for anomalies and impute missing and anomalous values.</span>

<span class="sd">For a narrative discussion of these methods aimed at data users, see</span>
<span class="sd">:doc:`/methodology/timeseries_imputation`.</span>

<span class="sd">The screening methods were originally designed to identify unrealistic data in the</span>
<span class="sd">electricity demand timeseries reported in :doc:`/data_sources/eia930`, and we have also</span>
<span class="sd">applied them to demand data from :doc:`/data_sources/ferc714`.</span>

<span class="sd">Screening methods are adapted from code written and maintained by:</span>

<span class="sd">* `Tyler Ruggles &lt;https://github.com/truggles&gt;`__</span>
<span class="sd">* `Alicia Wongel &lt;https://github.com/awongel&gt;`__</span>
<span class="sd">* `Greg Schivley &lt;https://github.com/gschivley&gt;`__</span>
<span class="sd">* `David Farnham &lt;https://github.com/d-farnham&gt;`__</span>

<span class="sd">And described at:</span>

<span class="sd">* https://doi.org/10.1038/s41597-020-0483-x</span>
<span class="sd">* https://zenodo.org/record/3737085</span>
<span class="sd">* https://github.com/truggles/EIA_Cleaned_Hourly_Electricity_Demand_Code</span>

<span class="sd">The imputation methods were designed for multivariate time series forecasting. They are</span>
<span class="sd">adapted from code published by `Xinyu Chen &lt;https://xinychen.github.io/&gt;`__ and</span>
<span class="sd">described at:</span>

<span class="sd">* https://arxiv.org/abs/2006.10436</span>
<span class="sd">* https://arxiv.org/abs/2008.03194</span>
<span class="sd">* https://github.com/xinychen/tensor-learning</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">bottleneck</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandera.pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pa</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dagster</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AssetCheckResult</span><span class="p">,</span>
    <span class="n">AssetIn</span><span class="p">,</span>
    <span class="n">AssetOut</span><span class="p">,</span>
    <span class="n">Output</span><span class="p">,</span>
    <span class="n">asset</span><span class="p">,</span>
    <span class="n">asset_check</span><span class="p">,</span>
    <span class="n">multi_asset</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandera.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Index</span><span class="p">,</span> <span class="n">Series</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_absolute_percentage_error</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.logging_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pudl.metadata.dfs</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImputationReasonCodes</span>

<div class="viewcode-block" id="logger">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.logger">[docs]</a>
<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>


<span class="c1"># --- Constants --- #</span>

<div class="viewcode-block" id="STANDARD_UTC_OFFSETS">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.STANDARD_UTC_OFFSETS">[docs]</a>
<span class="n">STANDARD_UTC_OFFSETS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Pacific/Honolulu&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;America/Anchorage&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span>
    <span class="s2">&quot;America/Los_Angeles&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;America/Denver&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;America/Phoenix&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;America/Chicago&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span>
    <span class="s2">&quot;America/New_York&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;America/Halifax&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span>
<span class="p">}</span></div>

<span class="sd">&quot;&quot;&quot;Hour offset from Coordinated Universal Time (UTC) by time zone.</span>

<span class="sd">Time zones are canonical names (e.g. &#39;America/Denver&#39;) from tzdata (</span>
<span class="sd">https://www.iana.org/time-zones)</span>
<span class="sd">mapped to their standard-time UTC offset.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># --- Data structures --- #</span>


<div class="viewcode-block" id="UTCTimeseriesDataFrame">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.UTCTimeseriesDataFrame">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">UTCTimeseriesDataFrame</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrameModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define schema of input tables for timeseries cleaning.</span>

<span class="sd">    This model defines the expected structure of an input dataframe to the timeseries</span>
<span class="sd">    imputation process. It will be be immediately converted to a</span>
<span class="sd">    :class:`AlignedTimeseriesDataFrame`, then pivoted to a :class:`TimeseriesMatrix`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="UTCTimeseriesDataFrame.id_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.UTCTimeseriesDataFrame.id_col">[docs]</a>
    <span class="n">id_col</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entity ID column(s). Used to group timeseries by entity.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="UTCTimeseriesDataFrame.datetime_utc">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.UTCTimeseriesDataFrame.datetime_utc">[docs]</a>
    <span class="n">datetime_utc</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Datetimes in UTC timezone.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="UTCTimeseriesDataFrame.timezone">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.UTCTimeseriesDataFrame.timezone">[docs]</a>
    <span class="n">timezone</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Local timezone of entity.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="UTCTimeseriesDataFrame.value_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.UTCTimeseriesDataFrame.value_col">[docs]</a>
    <span class="n">value_col</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Float64Dtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Column containing actual values to impute.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="AlignedTimeseriesDataFrame">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.AlignedTimeseriesDataFrame">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AlignedTimeseriesDataFrame</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrameModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define schema of input tables for timeseries cleaning.</span>

<span class="sd">    This model is nearly identical to a ``UTCTimeseriesDataFrame``, but the</span>
<span class="sd">    ``datetime_utc`` values are aligned to &quot;local&quot; ``datetime``&#39;s using a fixed UTC</span>
<span class="sd">    offset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AlignedTimeseriesDataFrame.id_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.AlignedTimeseriesDataFrame.id_col">[docs]</a>
    <span class="n">id_col</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entity ID column(s). Used to group timeseries by entity.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="AlignedTimeseriesDataFrame.datetime">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.AlignedTimeseriesDataFrame.datetime">[docs]</a>
    <span class="n">datetime</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Datetimes shifted by UTC offset to align all timeseries&#39;.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="AlignedTimeseriesDataFrame.value_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.AlignedTimeseriesDataFrame.value_col">[docs]</a>
    <span class="n">value_col</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Float64Dtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Column containing actual values to impute.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="AlignedTimeseriesDataFrame.flags">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.AlignedTimeseriesDataFrame.flags">[docs]</a>
    <span class="n">flags</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Column indicating why value was flagged for imputation.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="TimeseriesMatrix">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.TimeseriesMatrix">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TimeseriesMatrix</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrameModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define schema for timeseries matrix used during imputation.</span>

<span class="sd">    TimeseriesMatrix is the main type used during imputation. It is a dataframe with a</span>
<span class="sd">    `datetime` row index (e.g. &#39;2006-01-01 00:00:00&#39;, ..., &#39;2019-12-31 23:00:00&#39;) in</span>
<span class="sd">    local time ignoring daylight-savings, and a `id_col` column index (e.g. 101, ...,</span>
<span class="sd">    329). Since the columns are dynamically generated by pivoting a</span>
<span class="sd">    ``AlignedTimeseriesDataFrame``, this model only explicitly defines the ``datetime``</span>
<span class="sd">    index. The primary purpose of this type is to annotate methods in this module, so</span>
<span class="sd">    the expected inputs and outputs are immediately clear.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TimeseriesMatrix.datetime">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.TimeseriesMatrix.datetime">[docs]</a>
    <span class="n">datetime</span><span class="p">:</span> <span class="n">Index</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Index timeseries matrix by datetime.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="_shift_utc">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._shift_utc">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_shift_utc</span><span class="p">(</span><span class="n">utc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">utc_offset</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shift ``utc`` by UTC offset.</span>

<span class="sd">    Args:</span>
<span class="sd">        utc: UTC times (tz-naive ``datetime64[ns]`` or ``datetime64[ns, UTC]``).</span>
<span class="sd">        utc_offset: For each datetime in ``utc`` a corresponding offset in hours.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Shifted datetimes (tz-naive ``datetime64[ns]``).</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; s = pd.Series([pd.Timestamp(2020, 1, 1), pd.Timestamp(2020, 1, 1)])</span>
<span class="sd">        &gt;&gt;&gt; _shift_utc(s, [-7, -6])</span>
<span class="sd">        0   2019-12-31 17:00:00</span>
<span class="sd">        1   2019-12-31 18:00:00</span>
<span class="sd">        dtype: datetime64[ns]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">utc</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">utc_offset</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;hours&quot;</span><span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="utc_dataframe_to_aligned">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.utc_dataframe_to_aligned">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">utc_dataframe_to_aligned</span><span class="p">(</span>
    <span class="n">input_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">UTCTimeseriesDataFrame</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return DataFrame with ``datetime_utc`` shifted by offset to align timeseries&#39;.&quot;&quot;&quot;</span>
    <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;utc_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;timezone&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">STANDARD_UTC_OFFSETS</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_shift_utc</span><span class="p">(</span>
        <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;datetime_utc&quot;</span><span class="p">],</span>
        <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;utc_offset&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># List timezone by year for each respondent by the datetime</span>
    <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="k">return</span> <span class="n">input_df</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="pivot_aligned_timeseries_dataframe">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.pivot_aligned_timeseries_dataframe">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">pivot_aligned_timeseries_dataframe</span><span class="p">(</span>
    <span class="n">aligned_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">],</span>
    <span class="n">value_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;value_col&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pivot aligned timeseries dataframe into timeseries matrix and pad if needed.</span>

<span class="sd">    Padding finds the complete list of hours from the start of the first day</span>
<span class="sd">    present in the timeseries to the end of the last, and then fills any missing hours</span>
<span class="sd">    with NULLs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">aligned_df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;id_col&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">value_col</span><span class="p">)</span>

    <span class="c1"># Get the full set of hours from the start of the first day in the series to the end of the last</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span>
    <span class="n">all_hours</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span>

    <span class="c1"># Reindex matrix with all hours. This will fill in any missing hours with NULLS</span>
    <span class="k">return</span> <span class="n">matrix</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">all_hours</span><span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="melt_imputed_timeseries_matrix">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.melt_imputed_timeseries_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">melt_imputed_timeseries_matrix</span><span class="p">(</span>
    <span class="n">imputed_matrix</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">flag_matrix</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Melt imputed timeseries matrix and flag matrix to time-aligned dataframe.&quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">imputed_matrix</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;value_col&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">flag_matrix</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;flags&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<span class="nd">@dataclass</span>
<div class="viewcode-block" id="FlaggedTimeseries">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container class used to flag values in a timeseries matrix for imputation.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FlaggedTimeseries.x">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.x">[docs]</a>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span></div>

<div class="viewcode-block" id="FlaggedTimeseries.columns">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.columns">[docs]</a>
    <span class="n">columns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span></div>

<div class="viewcode-block" id="FlaggedTimeseries.index">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.index">[docs]</a>
    <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span></div>

<div class="viewcode-block" id="FlaggedTimeseries.flags">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.flags">[docs]</a>
    <span class="n">flags</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span></div>

<div class="viewcode-block" id="FlaggedTimeseries.uuid">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.uuid">[docs]</a>
    <span class="n">uuid</span><span class="p">:</span> <span class="nb">str</span></div>


<div class="viewcode-block" id="FlaggedTimeseries.__hash__">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.__hash__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Implement hash for lru_cache.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="FlaggedTimeseries.from_timeseries_matrix">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.from_timeseries_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_timeseries_matrix</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FlaggedTimeseries&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a timeseries object from a dataframe.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span> <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">flags</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
            <span class="n">uuid</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">(),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FlaggedTimeseries.to_dataframes">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.to_dataframes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_dataframes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert back to a dataframe.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="FlaggedTimeseries.flag">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.FlaggedTimeseries.flag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">flag</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="n">ImputationReasonCodes</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;FlaggedTimeseries&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flag values.</span>

<span class="sd">        Flags values (if not already flagged) and nulls flagged values.</span>

<span class="sd">        Args:</span>
<span class="sd">            mask: Boolean mask of the values to flag.</span>
<span class="sd">            flag: Flag name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Only flag unflagged values</span>
        <span class="k">if</span> <span class="n">flag</span> <span class="o">!=</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">MISSING_VALUE</span><span class="p">:</span>
            <span class="c1"># This would assume missing values were flagged for a different</span>
            <span class="c1"># reason, so don&#39;t do this check for `MISSING_VALUE` flag</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Null flagged values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>
</div>



<span class="c1"># ---- Helpers ---- #</span>


<div class="viewcode-block" id="slice_axis">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.slice_axis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">slice_axis</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">slice</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an index that slices an array along an axis.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Array to slice.</span>
<span class="sd">        start: Start index of slice.</span>
<span class="sd">        end: End index of slice.</span>
<span class="sd">        step: Step size of slice.</span>
<span class="sd">        axis: Axis along which to slice.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of :class:`slice` that slices array `x` along axis `axis`</span>
<span class="sd">        (`x[..., start:stop:step]`).</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; x = np.random.random((3, 4, 5))</span>
<span class="sd">        &gt;&gt;&gt; np.all(x[1:] == x[slice_axis(x, start=1, axis=0)])</span>
<span class="sd">        np.True_</span>
<span class="sd">        &gt;&gt;&gt; np.all(x[:, 1:] == x[slice_axis(x, start=1, axis=1)])</span>
<span class="sd">        np.True_</span>
<span class="sd">        &gt;&gt;&gt; np.all(x[:, :, 1:] == x[slice_axis(x, start=1, axis=2)])</span>
<span class="sd">        np.True_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>



<div class="viewcode-block" id="array_diff">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.array_diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">array_diff</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fill</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First discrete difference of array elements.</span>

<span class="sd">    This is a fast numpy implementation of :meth:`pd.DataFrame.diff`.</span>

<span class="sd">    Args:</span>
<span class="sd">        periods: Periods to shift for calculating difference, accepts negative values.</span>
<span class="sd">        axis: Array axis along which to calculate the difference.</span>
<span class="sd">        fill: Value to use at the margins where a difference cannot be calculated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Array of same shape and type as `x` with discrete element differences.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; x = np.random.random((4, 2))</span>
<span class="sd">        &gt;&gt;&gt; np.all(array_diff(x, 1)[1:] == pd.DataFrame(x).diff(1).to_numpy()[1:])</span>
<span class="sd">        np.True_</span>
<span class="sd">        &gt;&gt;&gt; np.all(array_diff(x, 2)[2:] == pd.DataFrame(x).diff(2).to_numpy()[2:])</span>
<span class="sd">        np.True_</span>
<span class="sd">        &gt;&gt;&gt; np.all(array_diff(x, -1)[:-1] == pd.DataFrame(x).diff(-1).to_numpy()[:-1])</span>
<span class="sd">        np.True_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">periods</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">prepend</span> <span class="o">=</span> <span class="n">slice_axis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">append</span> <span class="o">=</span> <span class="n">slice_axis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">periods</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">prepend</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">append</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">append</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=-</span><span class="n">periods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">prepend</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">prepend</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">slice_axis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="o">=-</span><span class="n">periods</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)]</span>
        <span class="n">dx</span><span class="p">[</span><span class="n">append</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
    <span class="k">return</span> <span class="n">dx</span></div>



<div class="viewcode-block" id="encode_run_length">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.encode_run_length">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">encode_run_length</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encode vector with run-length encoding.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Vector to encode.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Values and their run lengths.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; x = np.array([0, 1, 1, 0, 1])</span>
<span class="sd">        &gt;&gt;&gt; encode_run_length(x)</span>
<span class="sd">        (array([0, 1, 0, 1]), array([1, 2, 1, 1]))</span>
<span class="sd">        &gt;&gt;&gt; encode_run_length(x.astype(&#39;bool&#39;))</span>
<span class="sd">        (array([False,  True, False,  True]), array([1, 2, 1, 1]))</span>
<span class="sd">        &gt;&gt;&gt; encode_run_length(x.astype(&#39;&lt;U1&#39;))</span>
<span class="sd">        (array([&#39;0&#39;, &#39;1&#39;, &#39;0&#39;, &#39;1&#39;], dtype=&#39;&lt;U1&#39;), array([1, 2, 1, 1]))</span>
<span class="sd">        &gt;&gt;&gt; encode_run_length(np.where(x == 0, np.nan, x))</span>
<span class="sd">        (array([nan,  1., nan,  1.]), array([1, 2, 1, 1]))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Inspired by https://stackoverflow.com/a/32681075</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># Pairwise unequal (string safe)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Must include last element position</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="c1"># starts = np.cumsum(np.append(0, lengths))[:-1]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lengths</span></div>



<div class="viewcode-block" id="insert_run_length">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.insert_run_length">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">insert_run_length</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">values</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">intersect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Insert run-length encoded values into a vector.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Vector to insert values into.</span>
<span class="sd">        values: Values to insert.</span>
<span class="sd">        lengths: Length of run to insert for each value in `values`.</span>
<span class="sd">        mask: Boolean mask, of the same length as `x`, where values can be inserted.</span>
<span class="sd">            By default, values can be inserted anywhere in `x`.</span>
<span class="sd">        padding: Minimum space between inserted runs and,</span>
<span class="sd">            if `mask` is provided, the edges of masked-out areas.</span>
<span class="sd">        intersect: Whether to allow inserted runs to intersect each other.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Padding must zero or greater.</span>
<span class="sd">        ValueError: Run length must be greater than zero.</span>
<span class="sd">        ValueError: Could not find space for run of length {length}.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Copy of array `x` with values inserted.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; x = [0, 0, 0, 0]</span>
<span class="sd">        &gt;&gt;&gt; mask = [True, False, True, True]</span>
<span class="sd">        &gt;&gt;&gt; insert_run_length(x, values=[1, 2], lengths=[1, 2], mask=mask)</span>
<span class="sd">        array([1, 0, 2, 2])</span>

<span class="sd">        If we use unique values for the background and each inserted run,</span>
<span class="sd">        the run length encoding of the result (ignoring the background)</span>
<span class="sd">        is the same as the inserted run, albeit in a different order.</span>

<span class="sd">        &gt;&gt;&gt; x = np.zeros(10, dtype=int)</span>
<span class="sd">        &gt;&gt;&gt; values = [1, 2, 3]</span>
<span class="sd">        &gt;&gt;&gt; lengths = [1, 2, 3]</span>
<span class="sd">        &gt;&gt;&gt; x = insert_run_length(x, values=values, lengths=lengths)</span>
<span class="sd">        &gt;&gt;&gt; rvalues, rlengths = encode_run_length(x[x != 0])</span>
<span class="sd">        &gt;&gt;&gt; order = np.argsort(rvalues)</span>
<span class="sd">        &gt;&gt;&gt; all(rvalues[order] == values) and all(rlengths[order] == lengths)</span>
<span class="sd">        True</span>

<span class="sd">        Null values can be inserted into a vector such that the new null runs</span>
<span class="sd">        match the run length encoding of the existing null runs.</span>

<span class="sd">        &gt;&gt;&gt; x = [1, 2, np.nan, np.nan, 5, 6, 7, 8, np.nan]</span>
<span class="sd">        &gt;&gt;&gt; is_nan = np.isnan(x)</span>
<span class="sd">        &gt;&gt;&gt; rvalues, rlengths = encode_run_length(is_nan)</span>
<span class="sd">        &gt;&gt;&gt; xi = insert_run_length(</span>
<span class="sd">        ...     x,</span>
<span class="sd">        ...     values=[np.nan] * rvalues.sum(),</span>
<span class="sd">        ...     lengths=rlengths[rvalues],</span>
<span class="sd">        ...     mask=~is_nan</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; np.isnan(xi).sum() == 2 * is_nan.sum()</span>
<span class="sd">        np.True_</span>

<span class="sd">        The same as above, with non-zero `padding`, yields a unique solution:</span>

<span class="sd">        &gt;&gt;&gt; insert_run_length(</span>
<span class="sd">        ...     x,</span>
<span class="sd">        ...     values=[np.nan] * rvalues.sum(),</span>
<span class="sd">        ...     lengths=rlengths[rvalues],</span>
<span class="sd">        ...     mask=~is_nan,</span>
<span class="sd">        ...     padding=1</span>
<span class="sd">        ... )</span>
<span class="sd">        array([nan,  2., nan, nan,  5., nan, nan,  8., nan])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">padding</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Padding must zero or greater&quot;</span><span class="p">)</span>
    <span class="c1"># Make a new array to modify in place</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># Compute runs available for insertions</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_values</span><span class="p">,</span> <span class="n">mask_lengths</span> <span class="o">=</span> <span class="n">encode_run_length</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">run_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mask_lengths</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">mask_values</span><span class="p">]</span>
        <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">mask_lengths</span><span class="p">[</span><span class="n">mask_values</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">padding</span><span class="p">:</span>
        <span class="c1"># Constrict runs</span>
        <span class="n">run_ends</span> <span class="o">=</span> <span class="n">run_starts</span> <span class="o">+</span> <span class="n">run_lengths</span>
        <span class="c1"># Move run starts forward, unless endpoint</span>
        <span class="n">moved</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">run_starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">run_starts</span><span class="p">[</span><span class="n">moved</span><span class="p">]</span> <span class="o">+=</span> <span class="n">padding</span>
        <span class="c1"># Move run ends backward, unless endpoint</span>
        <span class="n">moved</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">run_ends</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">run_ends</span><span class="p">[</span><span class="n">moved</span><span class="p">]</span> <span class="o">-=</span> <span class="n">padding</span>
        <span class="c1"># Recalculate run lengths and keep runs with positive length</span>
        <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">run_ends</span> <span class="o">-</span> <span class="n">run_starts</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">run_lengths</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">run_starts</span> <span class="o">=</span> <span class="n">run_starts</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
        <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">run_lengths</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    <span class="c1"># Grow runs by maximum number of insertions (for speed)</span>
    <span class="n">n_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">run_starts</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">intersect</span><span class="p">:</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">run_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">run_starts</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
        <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">run_lengths</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span>
    <span class="c1"># Initialize random number generator</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="c1"># Sort insertions from longest to shortest</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lengths</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="p">)[</span><span class="n">order</span><span class="p">]</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lengths</span><span class="p">)[</span><span class="n">order</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">lengths</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run length must be greater than zero&quot;</span><span class="p">)</span>
        <span class="c1"># Choose runs of adequate length</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">run_lengths</span><span class="p">[:</span><span class="n">n_runs</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">length</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">choices</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find space for run of length </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
        <span class="c1"># Choose adequate start position in run</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">run_lengths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">length</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">run_starts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="c1"># Insert value</span>
        <span class="n">x</span><span class="p">[</span><span class="n">start</span> <span class="p">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">intersect</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Update runs</span>
        <span class="n">padded_length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">padding</span>
        <span class="k">if</span> <span class="n">offset</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">run_lengths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">padded_length</span>
            <span class="k">if</span> <span class="n">tail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Insert run</span>
                <span class="n">run_starts</span><span class="p">[</span><span class="n">n_runs</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">padded_length</span>
                <span class="n">run_lengths</span><span class="p">[</span><span class="n">n_runs</span><span class="p">]</span> <span class="o">=</span> <span class="n">tail</span>
                <span class="n">n_runs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Shorten run</span>
            <span class="n">run_lengths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">padding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Shift and shorten run</span>
            <span class="n">run_starts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">padded_length</span>
            <span class="n">run_lengths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">padded_length</span>
    <span class="k">return</span> <span class="n">x</span></div>



<div class="viewcode-block" id="_mat2ten">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._mat2ten">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_mat2ten</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fold matrix into a tensor.&quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="n">mode</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_ten2mat">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._ten2mat">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_ten2mat</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unfold tensor into a matrix.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="_svt_tnn">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._svt_tnn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_svt_tnn</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Singular value thresholding (SVT) truncated nuclear norm (TNN) minimization.&quot;&quot;&quot;</span>
    <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">matrix</span> <span class="o">@</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">mid</span><span class="p">[:</span><span class="n">theta</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mid</span><span class="p">[</span><span class="n">theta</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">theta</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">tau</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">[</span><span class="n">theta</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span> <span class="o">@</span> <span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">matrix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_svt_tnn</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vec</span><span class="p">[</span><span class="n">theta</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">theta</span><span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">tau</span>
    <span class="k">return</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="n">idx</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">@</span> <span class="n">v</span><span class="p">[:</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span></div>



<div class="viewcode-block" id="impute_latc_tnn">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.impute_latc_tnn">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">impute_latc_tnn</span><span class="p">(</span>
    <span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">lags</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">],</span>
    <span class="n">rho0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span>
    <span class="n">lambda0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2e-7</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span>
    <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Impute tensor values with LATC-TNN method by Chen and Sun (2020).</span>

<span class="sd">    Uses low-rank autoregressive tensor completion (LATC) with</span>
<span class="sd">    truncated nuclear norm (TNN) minimization.</span>

<span class="sd">    * description: https://arxiv.org/abs/2006.10436</span>
<span class="sd">    * code: https://github.com/xinychen/tensor-learning/blob/master/mats</span>

<span class="sd">    Args:</span>
<span class="sd">        tensor: Observational series in the form (series, groups, periods).</span>
<span class="sd">            Null values are replaced with zeros, so any zeros will be treated as null.</span>
<span class="sd">        lags:</span>
<span class="sd">        alpha:</span>
<span class="sd">        rho0:</span>
<span class="sd">        lambda0:</span>
<span class="sd">        theta:</span>
<span class="sd">        epsilon: Convergence criterion. A smaller number will result in more iterations.</span>
<span class="sd">        maxiter: Maximum number of iterations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor with missing values in `tensor` replaced by imputed values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tensor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dim_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>
    <span class="n">max_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pos_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)))</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">mat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">])</span>
    <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">max_lag</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_lag</span> <span class="o">-</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">last_mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">snorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s2">&quot;fro&quot;</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mat2ten</span><span class="p">(</span>
                <span class="n">_svt_tnn</span><span class="p">(</span>
                    <span class="n">_ten2mat</span><span class="p">(</span><span class="n">_mat2ten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">k</span><span class="p">),</span>
                    <span class="n">tau</span><span class="o">=</span><span class="n">alpha</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">shape</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">tensor_hat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;k, kmnt -&gt; mnt&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">mat_hat</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">tensor_hat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mat0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">max_lag</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">lambda0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">qm</span> <span class="o">=</span> <span class="n">mat_hat</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">qm</span><span class="p">)</span> <span class="o">@</span> <span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">max_lag</span><span class="p">:]</span>
                <span class="n">mat0</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qm</span> <span class="o">@</span> <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">z</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">mat1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_lag</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span><span class="p">),</span>
                <span class="p">(</span><span class="n">mat1</span><span class="p">[:,</span> <span class="n">max_lag</span><span class="p">:]</span> <span class="o">+</span> <span class="n">lambda0</span> <span class="o">*</span> <span class="n">mat0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">+</span> <span class="n">lambda0</span><span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)[</span><span class="n">pos_missing</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ten2mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">t</span> <span class="o">/</span> <span class="n">rho</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">))[</span><span class="n">pos_missing</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">_mat2ten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dim</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">mat_hat</span> <span class="o">-</span> <span class="n">last_mat</span><span class="p">),</span> <span class="s2">&quot;fro&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">snorm</span>
        <span class="n">last_mat</span> <span class="o">=</span> <span class="n">mat_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tol</span> <span class="o">&lt;</span> <span class="n">epsilon</span> <span class="ow">or</span> <span class="n">it</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tensor_hat</span></div>



<div class="viewcode-block" id="_tsvt">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._tsvt">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_tsvt</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">phi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tensor singular value thresholding (TSVT).&quot;&quot;&quot;</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;kt, ijk -&gt; ijt&quot;</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">tensor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">],</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">tau</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">r</span><span class="p">]</span>
            <span class="n">s</span><span class="p">[:</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">r</span><span class="p">]</span> <span class="o">-</span> <span class="n">tau</span>
            <span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="n">r</span><span class="p">]</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">@</span> <span class="n">v</span><span class="p">[:</span><span class="n">r</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;kt, ijt -&gt; ijk&quot;</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></div>



<div class="viewcode-block" id="impute_latc_tubal">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.impute_latc_tubal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">impute_latc_tubal</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
    <span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">lags</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">rho0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span>
    <span class="n">lambda0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2e-7</span><span class="p">,</span>
    <span class="n">epsilon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-7</span><span class="p">,</span>
    <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Impute tensor values with LATC-Tubal method by Chen, Chen and Sun (2020).</span>

<span class="sd">    Uses low-tubal-rank autoregressive tensor completion (LATC-Tubal).</span>
<span class="sd">    It is much faster than :func:`impute_latc_tnn` for very large datasets,</span>
<span class="sd">    with comparable accuracy.</span>

<span class="sd">    * description: https://arxiv.org/abs/2008.03194</span>
<span class="sd">    * code: https://github.com/xinychen/tensor-learning/blob/master/mats</span>

<span class="sd">    Args:</span>
<span class="sd">        tensor: Observational series in the form (series, groups, periods).</span>
<span class="sd">            Null values are replaced with zeros, so any zeros will be treated as null.</span>
<span class="sd">        lags:</span>
<span class="sd">        rho0:</span>
<span class="sd">        lambda0:</span>
<span class="sd">        epsilon: Convergence criterion. A smaller number will result in more iterations.</span>
<span class="sd">        maxiter: Maximum number of iterations.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor with missing values in `tensor` replaced by imputed values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tensor</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tensor</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># [2025-08 kmm] Not sure how an empty tensor makes it this far,</span>
    <span class="c1"># but one found a way</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensor</span>
    <span class="n">dim_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="o">/</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>
    <span class="n">max_lag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lags</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">pos_missing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">z</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="n">mat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">])</span>
    <span class="n">it</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">max_lag</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_lag</span> <span class="o">-</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">lags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">last_mat</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">snorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s2">&quot;fro&quot;</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho0</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">_mat2ten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">temp1</span> <span class="o">@</span> <span class="n">temp1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">temp1</span>
    <span class="k">if</span> <span class="n">dim_time</span> <span class="o">&gt;</span> <span class="mf">5e3</span> <span class="ow">and</span> <span class="n">dim_time</span> <span class="o">&lt;=</span> <span class="mf">1e4</span><span class="p">:</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="k">elif</span> <span class="n">dim_time</span> <span class="o">&gt;</span> <span class="mf">1e4</span><span class="p">:</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_tsvt</span><span class="p">(</span><span class="n">_mat2ten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span> <span class="o">/</span> <span class="n">rho</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rho</span><span class="p">)</span>
        <span class="n">mat_hat</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mat0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">max_lag</span><span class="p">))</span>
        <span class="n">temp2</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">rho</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lambda0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dim_time</span> <span class="o">&lt;=</span> <span class="mf">5e3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">qm</span> <span class="o">=</span> <span class="n">mat_hat</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">qm</span><span class="p">)</span> <span class="o">@</span> <span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">max_lag</span><span class="p">:]</span>
                    <span class="n">mat0</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qm</span> <span class="o">@</span> <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="n">dim_time</span> <span class="o">&gt;</span> <span class="mf">5e3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_time</span> <span class="o">-</span> <span class="n">max_lag</span><span class="p">)</span>
                    <span class="n">rng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">dim_time</span> <span class="o">-</span> <span class="n">max_lag</span><span class="p">))]</span>
                    <span class="n">qm</span> <span class="o">=</span> <span class="n">mat_hat</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">qm</span><span class="p">[</span><span class="n">idx</span><span class="p">[:],</span> <span class="p">:])</span> <span class="o">@</span> <span class="n">z</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">max_lag</span><span class="p">:][</span><span class="n">idx</span><span class="p">[:]]</span>
                    <span class="n">mat0</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">qm</span> <span class="o">@</span> <span class="n">a</span><span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">z</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">temp2</span><span class="p">[:,</span> <span class="p">:</span><span class="n">max_lag</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span><span class="p">),</span>
                <span class="p">(</span><span class="n">temp2</span><span class="p">[:,</span> <span class="n">max_lag</span><span class="p">:]</span> <span class="o">+</span> <span class="n">lambda0</span> <span class="o">*</span> <span class="n">mat0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">rho</span> <span class="o">+</span> <span class="n">lambda0</span><span class="p">),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)[</span><span class="n">pos_missing</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp2</span><span class="p">[</span><span class="n">pos_missing</span><span class="p">]</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">_mat2ten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">tol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">((</span><span class="n">mat_hat</span> <span class="o">-</span> <span class="n">last_mat</span><span class="p">),</span> <span class="s2">&quot;fro&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">snorm</span>
        <span class="n">last_mat</span> <span class="o">=</span> <span class="n">mat_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">it</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">temp1</span> <span class="o">=</span> <span class="n">_ten2mat</span><span class="p">(</span><span class="n">_mat2ten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span> <span class="o">/</span> <span class="n">rho</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">temp1</span> <span class="o">@</span> <span class="n">temp1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">temp1</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tol</span> <span class="o">&lt;</span> <span class="n">epsilon</span> <span class="ow">or</span> <span class="n">it</span> <span class="o">&gt;=</span> <span class="n">maxiter</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">it</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>



<span class="c1"># ---- Anomaly detection ---- #</span>
<div class="viewcode-block" id="flag_null">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_null">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_null</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag null values (MISSING_VALUE).&quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">MISSING_VALUE</span><span class="p">)</span></div>



<div class="viewcode-block" id="flag_negative_or_zero">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_negative_or_zero">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_negative_or_zero</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag negative or zero values (NEGATIVE_OR_ZERO).&quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">NEGATIVE_OR_ZERO</span><span class="p">)</span></div>



<div class="viewcode-block" id="flag_identical_run">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_identical_run">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_identical_run</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag the last values in identical runs (IDENTICAL_RUN).</span>

<span class="sd">    Args:</span>
<span class="sd">        length: Run length to flag.</span>
<span class="sd">            If `3`, the third (and subsequent) identical values are flagged.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Run length must be 2 or greater.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Run length must be 2 or greater&quot;</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">&amp;=</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">IDENTICAL_RUN</span><span class="p">)</span></div>



<div class="viewcode-block" id="flag_global_outlier">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_global_outlier">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_global_outlier</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">medians</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag values greater or less than n times the global median (GLOBAL_OUTLIER).</span>

<span class="sd">    Args:</span>
<span class="sd">        medians: Number of times the median the value must exceed the median.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">median</span> <span class="o">*</span> <span class="n">medians</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">GLOBAL_OUTLIER</span><span class="p">)</span></div>



<div class="viewcode-block" id="flag_global_outlier_neighbor">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_global_outlier_neighbor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_global_outlier_neighbor</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag values neighboring global outliers (GLOBAL_OUTLIER_NEIGHBOR).</span>

<span class="sd">    Args:</span>
<span class="sd">        neighbors: Number of neighbors to flag on either side of each outlier.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Global outliers must be flagged first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">flags</span> <span class="o">==</span> <span class="s2">&quot;GLOBAL_OUTLIER&quot;</span>
    <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">neighbors</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Neighbors before</span>
        <span class="n">mask</span><span class="p">[:</span><span class="o">-</span><span class="n">shift</span><span class="p">][</span><span class="n">outliers</span><span class="p">[</span><span class="n">shift</span><span class="p">:]]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Neighbors after</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">shift</span><span class="p">:][</span><span class="n">outliers</span><span class="p">[:</span><span class="o">-</span><span class="n">shift</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">GLOBAL_OUTLIER_NEIGHBOR</span><span class="p">)</span></div>



<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># noqa: B019</span>
<div class="viewcode-block" id="rolling_median">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.rolling_median">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rolling_median</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rolling median of values.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: rollingDem, rollingDemLong (window=480)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>



<div class="viewcode-block" id="rolling_median_offset">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.rolling_median_offset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rolling_median_offset</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Values minus the rolling median.</span>

<span class="sd">    Estimates the local cycle in cyclical data by removing longterm trends.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: dem_minus_rolling</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">rolling_median</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span></div>



<div class="viewcode-block" id="median_of_rolling_median_offset">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.median_of_rolling_median_offset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">median_of_rolling_median_offset</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
    <span class="n">shifts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Median of the offset from the rolling median.</span>

<span class="sd">    Calculated by shifting the rolling median offset (:meth:`rolling_median_offset`)</span>
<span class="sd">    by different numbers of values, then taking the median at each position.</span>
<span class="sd">    Estimates the typical local cycle in cyclical data.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window for the rolling median.</span>
<span class="sd">        shifts: Number of values to shift the rolling median offset by.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: vals_dem_minus_rolling</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">rolling_median_offset</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="c1"># Fast numpy implementation of pd.DataFrame.shift</span>
    <span class="n">shifted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="o">*</span><span class="n">offset</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shifts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shifted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">shift</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">shifted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">shift</span><span class="p">:]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[:</span><span class="o">-</span><span class="n">shift</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shifted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">shift</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">shifted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">shift</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[</span><span class="o">-</span><span class="n">shift</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shifted</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">offset</span>
    <span class="c1"># Ignore warning for rows with all null values</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
            <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;All-NaN slice encountered&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">bn</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">shifted</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="rolling_iqr_of_rolling_median_offset">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.rolling_iqr_of_rolling_median_offset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rolling_iqr_of_rolling_median_offset</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="n">iqr_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">240</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rolling interquartile range (IQR) of rolling median offset.</span>

<span class="sd">    Estimates the spread of the local cycles in cyclical data.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window for the rolling median.</span>
<span class="sd">        iqr_window: Number of values in the moving window for the rolling IQR.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: dem_minus_rolling_IQR</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">rolling_median_offset</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rolling</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">iqr_window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rolling</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>



<div class="viewcode-block" id="median_prediction">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.median_prediction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">median_prediction</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
    <span class="n">shifts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
    <span class="n">long_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Values predicted from local and regional rolling medians.</span>

<span class="sd">    Calculated as `{ local median } +</span>
<span class="sd">    { median of local median offset } * { local median } / { regional median }`.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window for the local rolling median.</span>
<span class="sd">        shifts: Positions to shift the local rolling median offset by,</span>
<span class="sd">            for computing its median.</span>
<span class="sd">        long_window: Number of values in the moving window</span>
<span class="sd">            for the regional (long) rolling median.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: hourly_median_dem_dev (multiplied by rollingDem)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">rolling_median</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span>
        <span class="mi">1</span>
        <span class="o">+</span> <span class="n">median_of_rolling_median_offset</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">)</span>
        <span class="o">/</span> <span class="n">rolling_median</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">long_window</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="flag_local_outlier">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_local_outlier">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_local_outlier</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
    <span class="n">shifts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
    <span class="n">long_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
    <span class="n">iqr_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag local outliers (LOCAL_OUTLIER_HIGH, LOCAL_OUTLIER_LOW).</span>

<span class="sd">    Flags values which are above or below the :meth:`median_prediction` by more than</span>
<span class="sd">    a `multiplier` times the :meth:`rolling_iqr_of_rolling_median_offset`.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window for the local rolling median.</span>
<span class="sd">        shifts: Positions to shift the local rolling median offset by,</span>
<span class="sd">            for computing its median.</span>
<span class="sd">        long_window: Number of values in the moving window</span>
<span class="sd">            for the regional (long) rolling median.</span>
<span class="sd">        iqr_window: Number of values in the moving window</span>
<span class="sd">            for the rolling interquartile range (IQR).</span>
<span class="sd">        multiplier: Number of times the :meth:`rolling_iqr_of_rolling_median_offset`</span>
<span class="sd">            the value must be above (HIGH) and below (LOW)</span>
<span class="sd">            the :meth:`median_prediction` to be flagged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute constants</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">median_prediction</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span> <span class="n">long_window</span><span class="o">=</span><span class="n">long_window</span>
    <span class="p">)</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">rolling_iqr_of_rolling_median_offset</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">iqr_window</span><span class="o">=</span><span class="n">iqr_window</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">prediction</span> <span class="o">+</span> <span class="n">multiplier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">iqr</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">LOCAL_OUTLIER_HIGH</span><span class="p">)</span>
    <span class="c1"># As in original code, do not recompute constants with new nulls</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">prediction</span> <span class="o">-</span> <span class="n">multiplier</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">iqr</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">LOCAL_OUTLIER_LOW</span><span class="p">)</span></div>



<div class="viewcode-block" id="diff">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Values minus the value of their neighbor.</span>

<span class="sd">    Args:</span>
<span class="sd">        shift: Positions to shift for calculating the difference.</span>
<span class="sd">            Positive values select a preceding (left) neighbor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: delta_pre (shift=1), delta_post (shift=-1)</span>
    <span class="k">return</span> <span class="n">array_diff</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span></div>



<div class="viewcode-block" id="rolling_iqr_of_diff">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.rolling_iqr_of_diff">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rolling_iqr_of_diff</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">240</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rolling interquartile range (IQR) of difference between neighboring values.</span>

<span class="sd">    Args:</span>
<span class="sd">        shift: Positions to shift for calculating the difference.</span>
<span class="sd">        window: Number of values in the moving window for the rolling IQR.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: delta_rolling_iqr</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">rolling</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rolling</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span> <span class="o">-</span> <span class="n">rolling</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span></div>



<div class="viewcode-block" id="flag_double_delta">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_double_delta">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_double_delta</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">iqr_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag values very different from neighbors on either side (DOUBLE_DELTA).</span>

<span class="sd">    Flags values whose differences to both neighbors on either side exceeds a</span>
<span class="sd">    `multiplier` times the rolling interquartile range (IQR) of neighbor difference.</span>

<span class="sd">    Args:</span>
<span class="sd">        iqr_window: Number of values in the moving window for the rolling IQR</span>
<span class="sd">            of neighbor difference.</span>
<span class="sd">        multiplier: Number of times the rolling IQR of neighbor difference</span>
<span class="sd">            the value&#39;s difference to its neighbors must exceed</span>
<span class="sd">            for the value to be flagged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">before</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">after</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">rolling_iqr_of_diff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">iqr_window</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iqr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">iqr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">DOUBLE_DELTA</span><span class="p">)</span></div>



<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># noqa: B019</span>
<div class="viewcode-block" id="relative_median_prediction">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.relative_median_prediction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">relative_median_prediction</span><span class="p">(</span><span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Values divided by their value predicted from medians.</span>

<span class="sd">    Args:</span>
<span class="sd">        kwargs: Arguments to :meth:`median_prediction`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: dem_rel_diff_wrt_hourly, dem_rel_diff_wrt_hourly_long (window=480)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">median_prediction</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="iqr_of_diff_of_relative_median_prediction">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.iqr_of_diff_of_relative_median_prediction">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">iqr_of_diff_of_relative_median_prediction</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">shift</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interquartile range of running difference of relative median prediction.</span>

<span class="sd">    Args:</span>
<span class="sd">        shift: Positions to shift for calculating the difference.</span>
<span class="sd">            Positive values select a preceding (left) neighbor.</span>
<span class="sd">        kwargs: Arguments to :meth:`relative_median_prediction`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># RUGGLES: iqr_relative_deltas</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">array_diff</span><span class="p">(</span><span class="n">relative_median_prediction</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">shift</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">iqr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>



<div class="viewcode-block" id="_find_single_delta">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._find_single_delta">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_find_single_delta</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span>
    <span class="n">relative_median_prediction</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">relative_median_prediction_long</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">rolling_iqr_of_diff</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">iqr_of_diff_of_relative_median_prediction</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">reverse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">not_nan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">not_nan</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])[::</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">previous</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">):</span>
            <span class="c1"># Evaluate value pairs</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">previous</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>
            <span class="n">diff_relative_median_prediction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">relative_median_prediction</span><span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">relative_median_prediction</span><span class="p">[</span><span class="n">previous</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Compare max deviation across short and long rolling median</span>
            <span class="c1"># to catch when outliers pull short median towards themselves.</span>
            <span class="n">previous_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relative_median_prediction</span><span class="p">[</span><span class="n">previous</span><span class="p">,</span> <span class="n">col</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relative_median_prediction_long</span><span class="p">[</span><span class="n">previous</span><span class="p">,</span> <span class="n">col</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">current_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relative_median_prediction</span><span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="n">col</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">relative_median_prediction_long</span><span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="n">col</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">flagged</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="n">rolling_iqr_of_diff</span><span class="p">[</span><span class="n">current</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">diff_relative_median_prediction</span>
                    <span class="o">&gt;</span> <span class="n">iqr_of_diff_of_relative_median_prediction</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">current_max</span> <span class="o">&gt;</span> <span class="n">previous_max</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">flagged_indices</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="n">flagged</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flagged_indices</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># Find position of flagged indices in index</span>
            <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
                <span class="n">indices_idx</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">flagged_indices</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indices_idx</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">flagged_indices</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="c1"># Only flag first of consecutive flagged indices</span>
            <span class="c1"># TODO: May not be necessary after first iteration</span>
            <span class="n">unflagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="kc">False</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">indices_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">flagged_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">flagged_indices</span><span class="p">,</span> <span class="n">unflagged</span><span class="p">)</span>
            <span class="n">indices_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">indices_idx</span><span class="p">,</span> <span class="n">unflagged</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">flagged_indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">flagged</span><span class="p">[</span><span class="n">flagged</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">unflagged</span>
            <span class="c1"># Bump current index of flagged pairs to next unflagged index</span>
            <span class="c1"># Next index always unflagged because flagged runs are not permitted</span>
            <span class="n">next_indices_idx</span> <span class="o">=</span> <span class="n">indices_idx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">next_indices_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                <span class="c1"># Drop last index if out of range</span>
                <span class="n">next_indices_idx</span> <span class="o">=</span> <span class="n">next_indices_idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">next_indices_idx</span><span class="p">]</span>
            <span class="c1"># Trim previous values to length of current values</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="p">[</span><span class="n">flagged</span><span class="p">][:</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)]</span>
            <span class="c1"># Delete flagged indices</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">indices_idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span></div>



<div class="viewcode-block" id="flag_single_delta">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_single_delta">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_single_delta</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
    <span class="n">shifts</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>
    <span class="n">long_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
    <span class="n">iqr_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
    <span class="n">multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">rel_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag values very different from the nearest unflagged value (SINGLE_DELTA).</span>

<span class="sd">    Flags values whose difference to the nearest unflagged value,</span>
<span class="sd">    with respect to value and relative median prediction,</span>
<span class="sd">    differ by less than a multiplier times the rolling interquartile range (IQR)</span>
<span class="sd">    of the difference -</span>
<span class="sd">    `multiplier` times :meth:`rolling_iqr_of_diff` and</span>
<span class="sd">    `rel_multiplier` times :meth:`iqr_of_diff_of_relative_mean_prediction`,</span>
<span class="sd">    respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Number of values in the moving window for the rolling median</span>
<span class="sd">            (for the relative median prediction).</span>
<span class="sd">        shifts: Positions to shift the local rolling median offset by,</span>
<span class="sd">            for computing its median (for the relative median prediction).</span>
<span class="sd">        long_window: Number of values in the moving window for the long rolling</span>
<span class="sd">            median (for the relative median prediction).</span>
<span class="sd">        iqr_window: Number of values in the moving window for the rolling IQR</span>
<span class="sd">            of neighbor difference.</span>
<span class="sd">        multiplier: Number of times the rolling IQR of neighbor difference</span>
<span class="sd">            the value&#39;s difference to its neighbor must exceed</span>
<span class="sd">            for the value to be flagged.</span>
<span class="sd">        rel_multiplier: Number of times the rolling IQR of relative median</span>
<span class="sd">            prediction the value&#39;s prediction difference to its neighbor must exceed</span>
<span class="sd">            for the value to be flagged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute constants used in both forward and reverse pass</span>
    <span class="n">relative_median_pred</span> <span class="o">=</span> <span class="n">relative_median_prediction</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span> <span class="n">long_window</span><span class="o">=</span><span class="n">long_window</span>
    <span class="p">)</span>
    <span class="n">relative_median_pred_long</span> <span class="o">=</span> <span class="n">relative_median_prediction</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">long_window</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span> <span class="n">long_window</span><span class="o">=</span><span class="n">long_window</span>
    <span class="p">)</span>
    <span class="n">rolling_iqr_of_d</span> <span class="o">=</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">rolling_iqr_of_diff</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">iqr_window</span><span class="p">)</span>
    <span class="n">iqr_of_diff_of_relative_median_pred</span> <span class="o">=</span> <span class="n">rel_multiplier</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">iqr_of_diff_of_relative_median_prediction</span><span class="p">(</span>
            <span class="n">ts</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span> <span class="n">long_window</span><span class="o">=</span><span class="n">long_window</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Set values flagged in forward pass to null before reverse pass</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">_find_single_delta</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span>
        <span class="n">relative_median_pred</span><span class="p">,</span>
        <span class="n">relative_median_pred_long</span><span class="p">,</span>
        <span class="n">rolling_iqr_of_d</span><span class="p">,</span>
        <span class="n">iqr_of_diff_of_relative_median_pred</span><span class="p">,</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">SINGLE_DELTA</span><span class="p">)</span>
    <span class="c1"># Repeat in reverse to get all options.</span>
    <span class="c1"># As in original code, do not recompute constants with new nulls</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">_find_single_delta</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span>
        <span class="n">relative_median_pred</span><span class="p">,</span>
        <span class="n">relative_median_pred_long</span><span class="p">,</span>
        <span class="n">rolling_iqr_of_d</span><span class="p">,</span>
        <span class="n">iqr_of_diff_of_relative_median_pred</span><span class="p">,</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">SINGLE_DELTA</span><span class="p">)</span></div>



<div class="viewcode-block" id="flag_anomalous_region">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_anomalous_region">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_anomalous_region</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag values surrounded by flagged values (ANOMALOUS_REGION).</span>

<span class="sd">    Original null values are not considered flagged values.</span>

<span class="sd">    Args:</span>
<span class="sd">        window: Width of regions.</span>
<span class="sd">        threshold: Fraction of flagged values required for a region to be flagged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check whether unflagged</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Check whether after or before half-width region with 1+ flagged values</span>
    <span class="n">half_window</span> <span class="o">=</span> <span class="n">window</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">is_after</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">half_window</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">is_before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">is_after</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">half_window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Check whether not part of a run of unflagged values longer than a half-width</span>
    <span class="n">is_not_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">rvalues</span><span class="p">,</span> <span class="n">rlengths</span> <span class="o">=</span> <span class="n">encode_run_length</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span>
        <span class="n">is_short_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rvalues</span><span class="p">,</span> <span class="n">rlengths</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">half_window</span>
        <span class="n">is_not_run</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">is_short_run</span><span class="p">,</span> <span class="n">rlengths</span><span class="p">)</span>
    <span class="c1"># Check whether within full-width region with too many flagged values</span>
    <span class="n">is_region</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="c1"># Flag if all conditions are met</span>
    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">is_after</span> <span class="o">&amp;</span> <span class="n">is_before</span> <span class="o">&amp;</span> <span class="n">is_not_run</span> <span class="o">&amp;</span> <span class="n">is_region</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">ANOMALOUS_REGION</span><span class="p">)</span></div>



<div class="viewcode-block" id="flag_bad_years">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_bad_years">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_bad_years</span><span class="p">(</span>
    <span class="n">ts</span><span class="p">:</span> <span class="n">FlaggedTimeseries</span><span class="p">,</span>
    <span class="n">min_data</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">min_data_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FlaggedTimeseries</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag entire years, which are missing a large portion of values (BAD_YEAR).</span>

<span class="sd">    This method checks two separate thresholds to determine whether a year is &quot;bad&quot;.</span>
<span class="sd">    First, it finds the range from the first non-null hour to the last non-null hour</span>
<span class="sd">    for each respondent-year. If that total range is less than ``min_data``, then the</span>
<span class="sd">    year is dropped. Next, it checks if the ratio of values within that range which are</span>
<span class="sd">    non-null is greater than ``min_data_fraction``. If not, then the year will also be</span>
<span class="sd">    dropped. This ensures that if there is a section of the year that is mostly complete,</span>
<span class="sd">    even if the rest of the year is NULL, then it will still be included for imputation.</span>

<span class="sd">    Args:</span>
<span class="sd">        ts: Timeseries matrix as described in :class:`FlaggedTimeseries`.</span>
<span class="sd">        min_data: Minimum number of non-null hours in a year.</span>
<span class="sd">        min_data_fraction: Minimum fraction of non-null hours between the first and last</span>
<span class="sd">          non-null hour in a year.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Identify respondent-years where data coverage is below thresholds</span>
    <span class="n">df</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_dataframes</span><span class="p">()</span>
    <span class="n">has_data</span> <span class="o">=</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># Last timestamp with demand in year</span>
        <span class="n">has_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
        <span class="o">-</span>
        <span class="c1"># First timestamp with demand in year</span>
        <span class="n">has_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">fraction</span> <span class="o">=</span> <span class="n">has_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">coverage</span>
    <span class="n">has_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">!=</span> <span class="s2">&quot;missing_value&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="c1"># Get mask of respondent-years for which there are fewer than min_data non-null hours</span>
    <span class="n">short</span> <span class="o">=</span> <span class="n">coverage</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">min_data</span><span class="p">)</span>

    <span class="c1"># Get mask of respondent-years for which the ratio of non-null values is below min_data_fraction</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="n">fraction</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">min_data_fraction</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">has_flags</span>

    <span class="c1"># Report bad respondent-years</span>
    <span class="k">for</span> <span class="n">bad_year_idx</span><span class="p">,</span> <span class="n">bad_id_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">bad</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">fraction</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())[</span><span class="n">bad_year_idx</span><span class="p">,</span><span class="w"> </span><span class="n">bad_id_idx</span><span class="p">])</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% of values are NULL&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; for respondent-year </span><span class="si">{</span><span class="n">bad</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">bad_id_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bad</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">bad_year_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">. Flagging as BAD_YEAR.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Report short respondent-years</span>
    <span class="k">for</span> <span class="n">short_year_idx</span><span class="p">,</span> <span class="n">short_id_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">short</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(),</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Respondent-year </span><span class="si">{</span><span class="n">short</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">short_id_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">short</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">short_year_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; only has data for </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">coverage</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">short_year_idx</span><span class="p">,</span><span class="w"> </span><span class="n">short_id_idx</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot; hours of the year. Flagging as BAD_YEAR&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Set all values in short or bad respondent-years to null</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">short</span> <span class="o">|</span> <span class="n">bad</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">BAD_YEAR</span><span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="flag_ruggles">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.flag_ruggles">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">flag_ruggles</span><span class="p">(</span>
    <span class="n">timeseries_matrix</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">min_data</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">min_data_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Flag values following the method of Ruggles and others (2020).</span>

<span class="sd">    Assumes values are hourly electricity demand.</span>

<span class="sd">    * description: https://doi.org/10.1038/s41597-020-0483-x</span>
<span class="sd">    * code: https://github.com/truggles/EIA_Cleaned_Hourly_Electricity_Demand_Code</span>

<span class="sd">    Args:</span>
<span class="sd">        ts: Aligned timeseries matrix for imputation.</span>
<span class="sd">        min_data: Minimum number of non-null hours in a year.</span>
<span class="sd">        min_data_fraction: Minimum fraction of non-null hours between the first and last</span>

<span class="sd">    Returns:</span>
<span class="sd">        Two ``TimeseriesMatrix`` dataframes with the same shape. The first contains</span>
<span class="sd">        the input timeseries with flagged values Nulled out in preparation for</span>
<span class="sd">        imputation. The second contains the actual flags for reference.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">FlaggedTimeseries</span><span class="o">.</span><span class="n">from_timeseries_matrix</span><span class="p">(</span><span class="n">timeseries_matrix</span><span class="p">)</span>

    <span class="c1"># Step 1</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_null</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_negative_or_zero</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_identical_run</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_global_outlier</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">medians</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_global_outlier_neighbor</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Step 2</span>
    <span class="c1"># NOTE: In original code, statistics used for the flags below are precomputed</span>
    <span class="c1"># here, rather than computed for each flag with nulls added by previous flags.</span>
    <span class="n">window</span> <span class="o">=</span> <span class="mi">48</span>
    <span class="n">long_window</span> <span class="o">=</span> <span class="mi">480</span>
    <span class="n">iqr_window</span> <span class="o">=</span> <span class="mi">240</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_local_outlier</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
        <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span>
        <span class="n">long_window</span><span class="o">=</span><span class="n">long_window</span><span class="p">,</span>
        <span class="n">iqr_window</span><span class="o">=</span><span class="n">iqr_window</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_double_delta</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">iqr_window</span><span class="o">=</span><span class="n">iqr_window</span><span class="p">,</span> <span class="n">multiplier</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_single_delta</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">,</span>
        <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
        <span class="n">shifts</span><span class="o">=</span><span class="n">shifts</span><span class="p">,</span>
        <span class="n">long_window</span><span class="o">=</span><span class="n">long_window</span><span class="p">,</span>
        <span class="n">iqr_window</span><span class="o">=</span><span class="n">iqr_window</span><span class="p">,</span>
        <span class="n">multiplier</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">rel_multiplier</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_anomalous_region</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">flag_bad_years</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">min_data</span><span class="p">,</span> <span class="n">min_data_fraction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_dataframes</span><span class="p">()</span></div>



<div class="viewcode-block" id="summarize_flags">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.summarize_flags">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">summarize_flags</span><span class="p">(</span>
    <span class="n">imputed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">id_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flag_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summarize flagged values by flag, count and median.</span>

<span class="sd">    Args:</span>
<span class="sd">        imputed_df: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">imputed_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">id_col</span><span class="p">,</span> <span class="n">flag_col</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">grouped</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">grouped</span><span class="p">[</span><span class="n">value_col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()}</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="simulate_nulls">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.simulate_nulls">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">simulate_nulls</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">lengths</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">intersect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">overlap</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find non-null values to null to match a run-length distribution.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Timeseries matrix as described in :func:`_prepare_timeseries_matrix`</span>
<span class="sd">            defined within :func:`impute_timeseries_asset_factory`.</span>
<span class="sd">        length: Length of null runs to simulate for each series.</span>
<span class="sd">            By default, uses the run lengths of null values in each series.</span>
<span class="sd">        padding: Minimum number of non-null values between simulated null runs</span>
<span class="sd">            and between simulated and existing null runs.</span>
<span class="sd">        intersect: Whether simulated null runs can intersect each other.</span>
<span class="sd">        overlap: Whether simulated null runs can overlap existing null runs. If</span>
<span class="sd">            ``True``, ``padding`` is ignored.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Boolean mask of current non-null values to set to null.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Could not find space for run of length {length}.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; x = np.column_stack([[1, 2, np.nan, 4, 5, 6, 7, np.nan, np.nan]])</span>
<span class="sd">        &gt;&gt;&gt; simulate_nulls(x).ravel()</span>
<span class="sd">        array([ True, False, False, False, True, True, False, False, False])</span>
<span class="sd">        &gt;&gt;&gt; simulate_nulls(x, lengths=[4], padding=0).ravel()</span>
<span class="sd">        array([False, False, False, True, True, True, True, False, False])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_nulls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">is_null</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="n">col</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lengths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_values</span><span class="p">,</span> <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">encode_run_length</span><span class="p">(</span><span class="n">is_null</span><span class="p">)</span>
            <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">run_lengths</span><span class="p">[</span><span class="n">run_values</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_lengths</span> <span class="o">=</span> <span class="n">lengths</span>
        <span class="n">is_new_null</span> <span class="o">=</span> <span class="n">insert_run_length</span><span class="p">(</span>
            <span class="n">new_nulls</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span>
            <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">run_lengths</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
            <span class="n">lengths</span><span class="o">=</span><span class="n">run_lengths</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">overlap</span> <span class="k">else</span> <span class="o">~</span><span class="n">is_null</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="n">overlap</span> <span class="k">else</span> <span class="n">padding</span><span class="p">,</span>
            <span class="n">intersect</span><span class="o">=</span><span class="n">intersect</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">overlap</span><span class="p">:</span>
            <span class="n">is_new_null</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">is_null</span>
        <span class="n">new_nulls</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_new_null</span>
    <span class="k">return</span> <span class="n">new_nulls</span></div>



<div class="viewcode-block" id="fold_tensor">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.fold_tensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fold_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fold into a 3-dimensional tensor representation.</span>

<span class="sd">    Folds the series `x` (number of observations, number of series)</span>
<span class="sd">    into a 3-d tensor (number of series, number of groups, number of periods),</span>
<span class="sd">    splitting observations into groups of length `periods`.</span>
<span class="sd">    For example, each group may represent a day and each period the hour of the day.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Series array to fold. Uses :attr:`x` by default.</span>
<span class="sd">        periods: Number of consecutive values in each series to fold into a group.</span>

<span class="sd">    Returns:</span>
<span class="sd">        &gt;&gt;&gt; x = np.column_stack([[1, 2, 3, 4, 5, 6], [10, 20, 30, 40, 50, 60]])</span>
<span class="sd">        &gt;&gt;&gt; tensor = fold_tensor(x, periods=3)</span>
<span class="sd">        &gt;&gt;&gt; tensor[0]</span>
<span class="sd">        array([[1, 2, 3],</span>
<span class="sd">               [4, 5, 6]])</span>
<span class="sd">        &gt;&gt;&gt; np.all(x == unfold_tensor(tensor, x.shape))</span>
<span class="sd">        np.True_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tensor_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">periods</span><span class="p">,</span> <span class="n">periods</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tensor_shape</span><span class="p">)</span></div>



<div class="viewcode-block" id="unfold_tensor">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.unfold_tensor">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">unfold_tensor</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unfold a 3-dimensional tensor representation.</span>

<span class="sd">    Performs the reverse of :meth:`fold_tensor`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">tensor</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="impute">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.impute">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">impute</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tubal&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Impute null values.</span>

<span class="sd">    .. note::</span>
<span class="sd">       The imputation method requires that nulls be replaced by zeros,</span>
<span class="sd">       so the series cannot already contain zeros.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask: Boolean mask of values to impute in addition to</span>
<span class="sd">            any null values in :attr:`x`.</span>
<span class="sd">        periods: Number of consecutive values in each series to fold into a group.</span>
<span class="sd">            See :meth:`fold_tensor`. Default of 24 is meant for hourly data with a</span>
<span class="sd">            diurnal periodicity.</span>
<span class="sd">        blocks: Number of blocks into which to split the series for imputation.</span>
<span class="sd">            This has been found to reduce processing time for `method=&#39;tnn&#39;`.</span>
<span class="sd">        method: Imputation method to use</span>
<span class="sd">            (&#39;tubal&#39;: :func:`impute_latc_tubal`, &#39;tnn&#39;: :func:`impute_latc_tnn`).</span>
<span class="sd">        kwargs: Optional arguments to `method`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Array of same shape as :attr:`x` with all null values</span>
<span class="sd">        (and those selected by `mask`) replaced with imputed values.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: Zero values present. Replace with very small value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imputer</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tubal&quot;</span><span class="p">:</span> <span class="n">impute_latc_tubal</span><span class="p">,</span> <span class="s2">&quot;tnn&quot;</span><span class="p">:</span> <span class="n">impute_latc_tnn</span><span class="p">}[</span><span class="n">method</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Zero values present. Replace with very small value.&quot;</span><span class="p">)</span>
    <span class="n">tensor</span> <span class="o">=</span> <span class="n">fold_tensor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="n">blocks</span><span class="p">))),</span> <span class="n">n</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">blocks</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">blocks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="n">ends</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ends</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">tensor</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">imputer</span><span class="p">(</span><span class="n">tensor</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">unfold_tensor</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="summarize_imputed">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.summarize_imputed">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">summarize_imputed</span><span class="p">(</span>
    <span class="n">matrix</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">imputed_matrix</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summarize the fit of imputed values to actual values.</span>

<span class="sd">    Summarizes the agreement between actual and imputed values with the</span>
<span class="sd">    following statistics:</span>

<span class="sd">    * `mpe`: Mean percent error, `(actual - imputed) / actual`.</span>
<span class="sd">    * `mape`: Mean absolute percent error, `abs(mpe)`.</span>

<span class="sd">    Args:</span>
<span class="sd">        imputed: Series of same shape as :attr:`x` with imputed values.</span>
<span class="sd">            See :meth:`impute`.</span>
<span class="sd">        mask: Boolean mask of imputed values that were not null in :attr:`x`.</span>
<span class="sd">            See :meth:`simulate_nulls`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Table of imputed value statistics for each series.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">imputed</span> <span class="o">=</span> <span class="n">imputed_matrix</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">flagged_vals</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flagged_vals</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="p">(</span><span class="n">flagged_vals</span> <span class="o">-</span> <span class="n">imputed</span><span class="p">[</span><span class="n">mask</span><span class="p">[:,</span> <span class="n">col</span><span class="p">],</span> <span class="n">col</span><span class="p">])</span> <span class="o">/</span> <span class="n">flagged_vals</span>
        <span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pe</span><span class="p">)]</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;column&quot;</span><span class="p">:</span> <span class="n">matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">flagged_vals</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="s2">&quot;mpe&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pe</span><span class="p">),</span>
                <span class="s2">&quot;mape&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pe</span><span class="p">)),</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="impute_flagged_values">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.impute_flagged_values">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">impute_flagged_values</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">years</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tubal&quot;</span><span class="p">,</span> <span class="s2">&quot;tnn&quot;</span><span class="p">]],</span>
    <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Impute null values in input timeseries matrix.</span>

<span class="sd">    Imputation is performed separately for each year, with only the respondents</span>
<span class="sd">    reporting data in that year.</span>

<span class="sd">    .. note::</span>
<span class="sd">       The imputation is parallelized internally, and by default will use all available</span>
<span class="sd">       CPU cores. If you want to limit the number of cores used, you can set the</span>
<span class="sd">       ``OMP_NUM_THREADS`` environment variable to the desired number of threads.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Timeseries matrix as described in :func:`_prepare_timeseries_matrix`</span>
<span class="sd">            defined within :func:`impute_timeseries_asset_factory`.</span>
<span class="sd">        years: list of years to input</span>
<span class="sd">        periods: Number of consecutive values in each series to fold into a group. See</span>
<span class="sd">            :meth:`fold_tensor`.</span>
<span class="sd">        blocks: Number of blocks into which to split the series for imputation.</span>
<span class="sd">            This has been found to reduce processing time for the tnn method.</span>
<span class="sd">        method: Maps each year to the appropriate imputation method. &quot;tubal&quot; uses</span>
<span class="sd">            :func:`impute_latc_tubal` and  &quot;tnn&quot; uses :func:`impute_latc_tnn`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Copy of ``df`` with imputed values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># sort here and then don&#39;t sort in the groupby so we can process</span>
    <span class="c1"># the newer years of data first. This is so we can see early if</span>
    <span class="c1"># new data causes any failures.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># remove the records o/s of the working years because some</span>
        <span class="c1"># respondents report one record of midnight of January first</span>
        <span class="c1"># of the next year (report_date.dt.year + 1). and</span>
        <span class="c1"># timeseries matrix chunks over years at a time</span>
        <span class="c1"># and having only one record</span>
        <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Imputing year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Drop completely empty columns and impute</span>
            <span class="n">blank</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">gdf</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">impute</span><span class="p">(</span>
                <span class="n">gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">blank</span><span class="p">),</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">[</span><span class="n">year</span><span class="p">],</span>
                <span class="n">periods</span><span class="o">=</span><span class="n">periods</span><span class="p">,</span>
                <span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Add empty columns back and save result</span>
            <span class="n">result</span><span class="p">[</span><span class="n">blank</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>



<span class="nd">@dataclass</span>
<div class="viewcode-block" id="SimulateFlagsSettings">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulateFlagsSettings">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimulateFlagsSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define settings used to simulate flagged values for scoring imputation.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimulateFlagsSettings.num_months">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulateFlagsSettings.num_months">[docs]</a>
    <span class="n">num_months</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;The number of months of data to simulate.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SimulateFlagsSettings.min_flag_rate">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulateFlagsSettings.min_flag_rate">[docs]</a>
    <span class="n">min_flag_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Min ratio of bad points in a section of data to be used for reference.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SimulateFlagsSettings.max_flag_rate">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulateFlagsSettings.max_flag_rate">[docs]</a>
    <span class="n">max_flag_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Max ratio of bad points in a section of data to be used for reference.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SimulateFlagsSettings.output_io_manager_key">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulateFlagsSettings.output_io_manager_key">[docs]</a>
    <span class="n">output_io_manager_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;io_manager&quot;</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specify io-manager for final simulated asset.</span>

<span class="sd">    In some cases we use the parquet IO-manager so we can build notebooks/visualizations</span>
<span class="sd">    on simulated data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SimulateFlagsSettings.mape_threshold">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulateFlagsSettings.mape_threshold">[docs]</a>
    <span class="n">mape_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maximum allowable mean absolute percent error computed on simulated values. Will be checked in an asset check.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="SimulationDataFrame">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulationDataFrame">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SimulationDataFrame</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">DataFrameModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collection of months of data which will be used to simulate flagged values.</span>

<span class="sd">    Each row in this dataframe identifies a pairing of two entity IDs and two months</span>
<span class="sd">    that can be used to evaluate the performance of the imputation. The &quot;reference&quot;</span>
<span class="sd">    is a month in which a high proportion of reported values were flagged for</span>
<span class="sd">    imputation, and the &quot;simulation&quot; is a month in which there were no values flagged</span>
<span class="sd">    for imputation. The pattern of flagged (null) values in the reference month will be</span>
<span class="sd">    used to mask the reported values found in the simulation month so they can be</span>
<span class="sd">    imputed, and then the imputed values will be compared to the originally reported</span>
<span class="sd">    data to evaluate the imputation&#39;s performance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimulationDataFrame.reference_id_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulationDataFrame.reference_id_col">[docs]</a>
    <span class="n">reference_id_col</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span></div>

<div class="viewcode-block" id="SimulationDataFrame.reference_month">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulationDataFrame.reference_month">[docs]</a>
    <span class="n">reference_month</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span></div>

<div class="viewcode-block" id="SimulationDataFrame.simulation_id_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulationDataFrame.simulation_id_col">[docs]</a>
    <span class="n">simulation_id_col</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span></div>

<div class="viewcode-block" id="SimulationDataFrame.simulation_month">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.SimulationDataFrame.simulation_month">[docs]</a>
    <span class="n">simulation_month</span><span class="p">:</span> <span class="n">Series</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span></div>
</div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="_merge_imputed">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._merge_imputed">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_merge_imputed</span><span class="p">(</span>
    <span class="n">aligned_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">],</span>
    <span class="n">matrix</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
    <span class="n">flags</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to melt imputed timeseries matrix and merge back on input asset.&quot;&quot;&quot;</span>
    <span class="c1"># Melt imputed matrix/flag matrix to long format</span>
    <span class="n">imputed_df</span> <span class="o">=</span> <span class="n">melt_imputed_timeseries_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="c1"># Merge back on core table</span>
    <span class="k">return</span> <span class="n">aligned_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">imputed_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;value_col&quot;</span><span class="p">:</span> <span class="s2">&quot;imputed_value_col&quot;</span><span class="p">}),</span>
        <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="_add_simulated_flag_col">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning._add_simulated_flag_col">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">_add_simulated_flag_col</span><span class="p">(</span>
    <span class="n">imputed_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">],</span>
    <span class="n">simulation_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">SimulationDataFrame</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a modified ``imputed_df`` with a column indicating which rows should be flagged for simulation.</span>

<span class="sd">    This will find all flagged values from a reference month and apply the flag</span>
<span class="sd">    pattern to a simulation month. The flag pattern is determined by calculating the</span>
<span class="sd">    hour of the month for each flagged (how many hours is this after the start of the</span>
<span class="sd">    month), and flagging the corresponding hour in the simulation month. Reference</span>
<span class="sd">    months are chosen by finding months with a relatively high rate of imputation,</span>
<span class="sd">    while simulation months have no values which were flagged for imputation.</span>

<span class="sd">    Args:</span>
<span class="sd">        imputed_df: Production DataFrame with imputed values, which is used to find</span>
<span class="sd">            sections with high rates of imputation.</span>
<span class="sd">        simulation_df: DataFrame with reference and simulation months.</span>

<span class="sd">    Returns:</span>
<span class="sd">        DataFrame which contains all ID/datetime pairs that should be flagged for</span>
<span class="sd">        simulated imputation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add a column to both dataframes, which contains the start date of the month</span>
    <span class="c1"># In the ``datetime`` column.</span>
    <span class="n">simulation_df</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">simulation_df</span><span class="p">[</span><span class="s2">&quot;reference_month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
    <span class="n">imputed_df</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imputed_df</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>

    <span class="c1"># Merge on month and ID to get a DataFrame with all hours in the reference months</span>
    <span class="n">simulation_df</span> <span class="o">=</span> <span class="n">imputed_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">simulation_df</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">],</span>
        <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reference_id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;period&quot;</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;many_to_one&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Filter to hours where values were flagged (NULL) in reference month</span>
    <span class="n">flagged</span> <span class="o">=</span> <span class="n">simulation_df</span><span class="p">[</span><span class="n">simulation_df</span><span class="p">[</span><span class="s2">&quot;flags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>

    <span class="c1"># For each flagged value in a reference month, get the number of hours after midnight</span>
    <span class="c1"># of the first day of the month for this value. Then, use this timedelta to find</span>
    <span class="c1"># the corresponding hour in the simulation month. These hours will then be flagged</span>
    <span class="c1"># for imputation during the simulated imputation.</span>
    <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;simulation_datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;reference_month&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;simulation_month&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Drop hours that crossed over into the next month</span>
    <span class="n">flagged</span> <span class="o">=</span> <span class="n">flagged</span><span class="p">[</span>
        <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;simulation_datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
        <span class="o">==</span> <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;simulation_month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">to_period</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Append column with simulated flags to imputed dataframe</span>
    <span class="n">imputed_df</span><span class="p">[</span><span class="s2">&quot;simulated_flags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">imputed_df</span> <span class="o">=</span> <span class="n">imputed_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;id_col&quot;</span><span class="p">])</span>
    <span class="n">imputed_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="p">(</span><span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;simulation_datetime&quot;</span><span class="p">],</span> <span class="n">flagged</span><span class="p">[</span><span class="s2">&quot;simulation_id_col&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;simulated_flags&quot;</span><span class="p">,</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">imputed_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span></div>



<span class="nd">@pa</span><span class="o">.</span><span class="n">check_types</span>
<div class="viewcode-block" id="get_simulated_flag_mask">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.get_simulated_flag_mask">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_simulated_flag_mask</span><span class="p">(</span>
    <span class="n">settings</span><span class="p">:</span> <span class="n">SimulateFlagsSettings</span><span class="p">,</span>
    <span class="n">imputed_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">[</span><span class="n">AlignedTimeseriesDataFrame</span><span class="p">],</span>
    <span class="n">simulation_group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataFrame</span><span class="p">[</span><span class="n">TimeseriesMatrix</span><span class="p">],</span> <span class="nb">set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a flag mask to flag values for simulated imputation.</span>

<span class="sd">    Find months of data with high rate of flagged values, and use these sections as a</span>
<span class="sd">    reference to flag values in otherwise good sections of data. This allows us to</span>
<span class="sd">    impute data in a realistic scenario where we have good reported data, which we can</span>
<span class="sd">    compare to in order to compute quantitative metrics to validate the quality of our</span>
<span class="sd">    imputation.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings: Settings object, which contains all configurable settings for</span>
<span class="sd">            simulation.</span>
<span class="sd">        imputed_df: Production DataFrame with imputed values, which is used to find</span>
<span class="sd">            sections with high rates of imputation.</span>
<span class="sd">        simulation_group: Allows testing imputation performance on different groups of</span>
<span class="sd">            data like BA/subregion demand, which can be combined into a single</span>
<span class="sd">            imputation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of ``timeseries_matrix``, and ``flag_matrix`` modified with simulation</span>
<span class="sd">        data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get rows in specified simulation_group, and filter any cases where an ID/month</span>
    <span class="c1"># Combo have very few values. This is important because we are going to compute</span>
    <span class="c1"># the rate of values imputed per month, and should make sure we&#39;re using complete months</span>
    <span class="n">imputation_group_df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">imputed_df</span><span class="p">[</span><span class="n">imputed_df</span><span class="p">[</span><span class="s2">&quot;simulation_group&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">simulation_group</span><span class="p">]</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;id_col&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">group</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the rate of imputation per month/ID</span>
    <span class="n">monthly_imputation_rate</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">imputation_group_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;id_col&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)[</span><span class="s2">&quot;flags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="s2">&quot;imputation_rate&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="c1"># Find a set of months with a high level of imputation to use as reference to simulate flagged data</span>
    <span class="n">bad_months</span> <span class="o">=</span> <span class="n">monthly_imputation_rate</span><span class="p">[</span>
        <span class="p">(</span><span class="n">monthly_imputation_rate</span><span class="o">.</span><span class="n">imputation_rate</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">min_flag_rate</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="p">(</span><span class="n">monthly_imputation_rate</span><span class="o">.</span><span class="n">imputation_rate</span> <span class="o">&lt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">max_flag_rate</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="c1"># Find months which didn&#39;t have any values flagged to drop data from</span>
    <span class="n">good_months</span> <span class="o">=</span> <span class="n">monthly_imputation_rate</span><span class="p">[</span>
        <span class="n">monthly_imputation_rate</span><span class="o">.</span><span class="n">imputation_rate</span> <span class="o">==</span> <span class="mf">0.0</span>
    <span class="p">]</span>

    <span class="c1"># Select num_months for simulation if there are enough months to choose from</span>
    <span class="n">num_months</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bad_months</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">good_months</span><span class="p">),</span> <span class="n">settings</span><span class="o">.</span><span class="n">num_months</span><span class="p">)</span>

    <span class="c1"># Take good months and bad months, and combine into a single dataframe</span>
    <span class="c1"># It doesn&#39;t matter which months in particular get matched up</span>
    <span class="n">simulation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">bad_months</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_months</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;id_col&quot;</span><span class="p">:</span> <span class="s2">&quot;reference_id_col&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="s2">&quot;reference_month&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)[[</span><span class="s2">&quot;reference_id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;reference_month&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
            <span class="n">good_months</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_months</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;id_col&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation_id_col&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="s2">&quot;simulation_month&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)[[</span><span class="s2">&quot;simulation_id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;simulation_month&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Use reference month to get hours which should be flagged in simulation month</span>
    <span class="n">imputed_df</span> <span class="o">=</span> <span class="n">_add_simulated_flag_col</span><span class="p">(</span>
        <span class="n">imputed_df</span><span class="p">,</span>
        <span class="n">simulation_df</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Pivot simulated flag column to get mask which can be used to flag a timeseries matrix</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">pivot_aligned_timeseries_dataframe</span><span class="p">(</span><span class="n">imputed_df</span><span class="p">,</span> <span class="n">value_col</span><span class="o">=</span><span class="s2">&quot;simulated_flags&quot;</span><span class="p">)</span>
    <span class="n">flags</span><span class="p">[</span><span class="n">flags</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">simulation_df</span><span class="p">[</span><span class="s2">&quot;simulation_month&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span></div>



<span class="nd">@dataclass</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImputeTimeseriesSettings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Define settings used for timeseries imputation.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ImputeTimeseriesSettings.min_data_fraction">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.min_data_fraction">[docs]</a>
    <span class="n">min_data_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fraction of values in a year which must be non-null to do imputation on year.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings.min_data">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.min_data">[docs]</a>
    <span class="n">min_data</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimum number of values which must be non-null to do imputation on year.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings.periods">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.periods">[docs]</a>
    <span class="n">periods</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Number of consecutive values in each series to fold into a group.</span>

<span class="sd">    See :meth:`fold_tensor`. The default of 24 is meant for hourly data with a diurnal</span>
<span class="sd">    periodicity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings.blocks">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.blocks">[docs]</a>
    <span class="n">blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Split timeseries matrix into equal sized blocks before running imputation.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings.method">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.method">[docs]</a>
    <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tubal&quot;</span><span class="p">,</span> <span class="s2">&quot;tnn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;tubal&quot;</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Imputation method to use.</span>

<span class="sd">    * tubal indicates :func:`impute_latc_tubal`</span>
<span class="sd">    * tnn indicates :func:`impute_latc_tnn`</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings.method_overrides">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.method_overrides">[docs]</a>
    <span class="n">method_overrides</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;tubal&quot;</span><span class="p">,</span> <span class="s2">&quot;tnn&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override stated imputation method for specific years.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ImputeTimeseriesSettings.simulate_flags_settings">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.ImputeTimeseriesSettings.simulate_flags_settings">[docs]</a>
    <span class="n">simulate_flags_settings</span><span class="p">:</span> <span class="n">SimulateFlagsSettings</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Settings to simulate flagged values and score imputation.</span>

<span class="sd">    Defaults to None which will not do any simulation/scoring.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="impute_timeseries_asset_factory">
<a class="viewcode-back" href="../../../autoapi/pudl/analysis/timeseries_cleaning/index.html#pudl.analysis.timeseries_cleaning.impute_timeseries_asset_factory">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">impute_timeseries_asset_factory</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
    <span class="n">input_asset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_asset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">years_from_context</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">id_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">value_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;demand_mwh&quot;</span><span class="p">,</span>
    <span class="n">imputed_value_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;demand_imputed_mwh&quot;</span><span class="p">,</span>
    <span class="n">reported_value_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;demand_reported_mwh&quot;</span><span class="p">,</span>
    <span class="n">simulation_group_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_io_manager_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;parquet_io_manager&quot;</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="n">ImputeTimeseriesSettings</span> <span class="o">=</span> <span class="n">ImputeTimeseriesSettings</span><span class="p">(),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Produces assets to impute values for a given timeseries table/column.</span>

<span class="sd">    This factory function produces a set of assets which perform timeseries imputation</span>
<span class="sd">    on one column in a specified table. This process is split into a series of assets</span>
<span class="sd">    to reduce peak memory usage by offloading intermediate products onto disk. The</span>
<span class="sd">    assets also correspond with the three steps that make up the the timeseries</span>
<span class="sd">    imputation process:</span>

<span class="sd">    1. Convert datetime UTC to local datetimes and pivot dataframe to timeseries matrix</span>
<span class="sd">    2. Flag anomalous and missing values in timeseries</span>
<span class="sd">    3. Perform imputation and melt back to expected output table structure</span>

<span class="sd">    This factory also has the ability to produce a set of simulation assets. These</span>
<span class="sd">    assets mirror the production assets, but they will impute a selection of values</span>
<span class="sd">    which were not actually flagged for imputation. This means we can impute data</span>
<span class="sd">    where the reported data is actually deemed &quot;good&quot;, allowing us to compare the</span>
<span class="sd">    imputed values to the reported. We then compute Mean Absolute Percentage Error</span>
<span class="sd">    to score the imputation. We can produce these simulated assets during our nightly</span>
<span class="sd">    builds for ongoing monitoring of the imputation, or just as one off way to validate</span>
<span class="sd">    or compare imputation methods.</span>

<span class="sd">    Args:</span>
<span class="sd">        input_asset_name: Name of upstream asset to perform imputation on.</span>
<span class="sd">        output_asset_name: Name of final output asset with imputed column.</span>
<span class="sd">        years_from_context: Function to generate the list of years on which to perform</span>
<span class="sd">            imputation on.</span>
<span class="sd">        id_col: Name of column identifying entities to group timeseries by.</span>
<span class="sd">        value_col: Column imputation will be performed on.</span>
<span class="sd">        imputed_value_col: Name of column in output asset with imputed values.</span>
<span class="sd">        reported_value_col: Name of column in output asset with original reported</span>
<span class="sd">            values.</span>
<span class="sd">        output_io_manager_key: IO-manager to use for final output asset.</span>
<span class="sd">        simulation_group_col: In cases where we are combining multiple datasets into</span>
<span class="sd">            a single imputation run (like BA/subregion demand), this column is used</span>
<span class="sd">            to compute simulation results for each set independently. This should</span>
<span class="sd">            point to a categorical column which defines which group a row belongs to.</span>
<span class="sd">        settings: Configurable options for imputation</span>
<span class="sd">            (see :class:`ImputeTimeseriesSettings`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create an asset prefix from `output_asset_name` so we can create unique asset</span>
    <span class="c1"># Names for all intermediate assets in the imputation.</span>
    <span class="c1"># Uses regex substitution so prefix starts with exactly one underscore even</span>
    <span class="c1"># if `output_asset_name` starts with an underscore</span>
    <span class="n">asset_prefix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^__&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">output_asset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Asset names</span>
    <span class="n">timeseries_matrix_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_timeseries_matrix&quot;</span>
    <span class="n">aligned_input_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_aligned&quot;</span>
    <span class="n">cleaned_timeseries_matrix_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_cleaned_timeseries_matrix&quot;</span>
    <span class="n">flags_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_timeseries_matrix_flags&quot;</span>
    <span class="n">imputed_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_imputed&quot;</span>
    <span class="n">simulated_timeseries_matrix_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_simulated_timeseries_matrix&quot;</span>
    <span class="n">simulated_flags_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_timeseries_matrix_simulated_flags&quot;</span>
    <span class="n">imputed_simulated_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_imputed_simulated_matrix&quot;</span>
    <span class="n">imputation_score_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_score&quot;</span>
    <span class="n">simulated_output_asset</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_simulated&quot;</span>

    <span class="nd">@multi_asset</span><span class="p">(</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;input_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">input_asset_name</span><span class="p">)},</span>
        <span class="n">outs</span><span class="o">=</span><span class="p">{</span>
            <span class="n">timeseries_matrix_asset</span><span class="p">:</span> <span class="n">AssetOut</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">timeseries_matrix_asset</span><span class="p">),</span>
            <span class="n">aligned_input_asset</span><span class="p">:</span> <span class="n">AssetOut</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">aligned_input_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_prepare_timeseries_matrix&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_timeseries_matrix</span><span class="p">(</span>
        <span class="n">input_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Take input timeseries table and convert to timeseries matrix for imputation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Input table as a matrix with a ``datetime`` row index</span>
<span class="sd">            (e.g. &#39;2006-01-01 00:00:00&#39;, ..., &#39;2019-12-31 23:00:00&#39;)</span>
<span class="sd">            in local time ignoring daylight-savings,</span>
<span class="sd">            and a ``id_col`` column index (e.g. 101, ..., 329).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert from datetime_utc to local datetime</span>
        <span class="n">aligned_df</span> <span class="o">=</span> <span class="n">utc_dataframe_to_aligned</span><span class="p">(</span>
            <span class="n">input_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">value_col</span><span class="p">:</span> <span class="s2">&quot;value_col&quot;</span><span class="p">,</span>
                    <span class="n">id_col</span><span class="p">:</span> <span class="s2">&quot;id_col&quot;</span><span class="p">,</span>
                    <span class="n">simulation_group_col</span><span class="p">:</span> <span class="s2">&quot;simulation_group&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If no simulation group column is specified, create one with a monolithic group</span>
        <span class="k">if</span> <span class="n">simulation_group_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aligned_df</span><span class="p">[</span><span class="s2">&quot;simulation_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;monolithic&quot;</span>

        <span class="c1"># Pivot to timeseries matrix</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">pivot_aligned_timeseries_dataframe</span><span class="p">(</span><span class="n">aligned_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">timeseries_matrix_asset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Output</span><span class="p">(</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">aligned_input_asset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">aligned_df</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@multi_asset</span><span class="p">(</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;matrix&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">timeseries_matrix_asset</span><span class="p">)},</span>
        <span class="n">outs</span><span class="o">=</span><span class="p">{</span>
            <span class="n">cleaned_timeseries_matrix_asset</span><span class="p">:</span> <span class="n">AssetOut</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">cleaned_timeseries_matrix_asset</span>
            <span class="p">),</span>
            <span class="n">flags_asset</span><span class="p">:</span> <span class="n">AssetOut</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">flags_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">op_tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;memory-use&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_flag_timeseries_matrix&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_flag_timeseries_matrix</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flag/Null anomalous and missing values.&quot;&quot;&quot;</span>
        <span class="n">matrix</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">flag_ruggles</span><span class="p">(</span>
            <span class="n">matrix</span><span class="p">,</span>
            <span class="n">min_data</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">min_data</span><span class="p">,</span>
            <span class="n">min_data_fraction</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">min_data_fraction</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">cleaned_timeseries_matrix_asset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">matrix</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">Output</span><span class="p">(</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">flags_asset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">flags</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">required_resource_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset_settings&quot;</span><span class="p">},</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;matrix&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">cleaned_timeseries_matrix_asset</span><span class="p">),</span>
            <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">flags_asset</span><span class="p">),</span>
            <span class="s2">&quot;aligned_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">aligned_input_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="n">imputed_asset</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_impute_timeseries</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span>
        <span class="n">aligned_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform imputation and return TimeseriesMatrix with imputed values.&quot;&quot;&quot;</span>
        <span class="c1"># Impute flagged/missing values</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">years_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> <span class="o">|</span> <span class="n">settings</span><span class="o">.</span><span class="n">method_overrides</span>
        <span class="n">imputed_matrix</span> <span class="o">=</span> <span class="n">impute_flagged_values</span><span class="p">(</span>
            <span class="n">matrix</span><span class="p">,</span>
            <span class="n">years</span><span class="o">=</span><span class="n">years</span><span class="p">,</span>
            <span class="n">periods</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">periods</span><span class="p">,</span>
            <span class="n">blocks</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">_merge_imputed</span><span class="p">(</span><span class="n">aligned_df</span><span class="p">,</span> <span class="n">imputed_matrix</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;imputed_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">imputed_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="n">output_asset_name</span><span class="p">,</span>
        <span class="n">io_manager_key</span><span class="o">=</span><span class="n">output_io_manager_key</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_output_asset</span><span class="p">(</span>
        <span class="n">imputed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename columns back to original names and output to desired IO-manager.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">imputed_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;id_col&quot;</span><span class="p">:</span> <span class="n">id_col</span><span class="p">,</span>
                <span class="s2">&quot;imputed_value_col&quot;</span><span class="p">:</span> <span class="n">imputed_value_col</span><span class="p">,</span>
                <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">imputed_value_col</span><span class="si">}</span><span class="s2">_imputation_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value_col&quot;</span><span class="p">:</span> <span class="n">reported_value_col</span><span class="p">,</span>
                <span class="s2">&quot;simulation_group&quot;</span><span class="p">:</span> <span class="n">simulation_group_col</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@multi_asset</span><span class="p">(</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;imputed_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">imputed_asset</span><span class="p">),</span>
            <span class="s2">&quot;matrix&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">cleaned_timeseries_matrix_asset</span><span class="p">),</span>
            <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">flags_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">outs</span><span class="o">=</span><span class="p">{</span>
            <span class="n">simulated_timeseries_matrix_asset</span><span class="p">:</span> <span class="n">AssetOut</span><span class="p">(</span>
                <span class="n">key</span><span class="o">=</span><span class="n">simulated_timeseries_matrix_asset</span>
            <span class="p">),</span>
            <span class="n">simulated_flags_asset</span><span class="p">:</span> <span class="n">AssetOut</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">simulated_flags_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">asset_prefix</span><span class="si">}</span><span class="s2">_simulate_flag_timeseries_matrix&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_simulate_flags</span><span class="p">(</span>
        <span class="n">imputed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flag values to impute for simulation purposes.</span>

<span class="sd">        This method will flag a set of otherwise &#39;good&#39; reported values, so they</span>
<span class="sd">        can be imputed and compared back to the &#39;good&#39; values for scoring/validation</span>
<span class="sd">        of the imputation performance. After creating the simulation data, only return</span>
<span class="sd">        years that contain simulated flags, as we do imputation 1 year at a time, so</span>
<span class="sd">        including years without simulated data would have no impact on the results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">simulated_years</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">FlaggedTimeseries</span><span class="o">.</span><span class="n">from_timeseries_matrix</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">simulation_group</span> <span class="ow">in</span> <span class="n">imputed_df</span><span class="p">[</span><span class="s2">&quot;simulation_group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># Get simulated flag mask for simulation group and set of years with simulated flags</span>
            <span class="n">mask</span><span class="p">,</span> <span class="n">years</span> <span class="o">=</span> <span class="n">get_simulated_flag_mask</span><span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">simulate_flags_settings</span><span class="p">,</span> <span class="n">imputed_df</span><span class="p">,</span> <span class="n">simulation_group</span>
            <span class="p">)</span>
            <span class="n">simulated_years</span> <span class="o">|=</span> <span class="n">years</span>

            <span class="c1"># Drop columns that were filtered out by ``filter_missing_values`` in original imputation</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">mask</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

            <span class="c1"># Flag simulated values</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">flag</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span> <span class="n">ImputationReasonCodes</span><span class="o">.</span><span class="n">SIMULATED</span><span class="p">)</span>

        <span class="c1"># Get flag/timeseries matrices and filter to only years with simulated data</span>
        <span class="c1"># Given that we only impute 1 year at a time, removing years without any simulated</span>
        <span class="c1"># flags will not impact results</span>
        <span class="n">matrix</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_dataframes</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Output</span><span class="p">(</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">simulated_timeseries_matrix_asset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">matrix</span><span class="p">[</span><span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">simulated_years</span><span class="p">)],</span>
            <span class="p">),</span>
            <span class="n">Output</span><span class="p">(</span>
                <span class="n">output_name</span><span class="o">=</span><span class="n">simulated_flags_asset</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">flags</span><span class="p">[</span><span class="n">flags</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">simulated_years</span><span class="p">)],</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">required_resource_keys</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dataset_settings&quot;</span><span class="p">},</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;aligned_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">aligned_input_asset</span><span class="p">),</span>
            <span class="s2">&quot;matrix&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">simulated_timeseries_matrix_asset</span><span class="p">),</span>
            <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">simulated_flags_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="n">imputed_simulated_asset</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_impute_simulated_timeseries</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span>
        <span class="n">aligned_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">flags</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform imputation on asset with simulated flags and return :class:TimeseriesMatrix with imputed values.&quot;&quot;&quot;</span>
        <span class="c1"># Impute flagged/missing values</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">years_from_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">method</span><span class="p">)</span> <span class="o">|</span> <span class="n">settings</span><span class="o">.</span><span class="n">method_overrides</span>
        <span class="n">imputed_matrix</span> <span class="o">=</span> <span class="n">impute_flagged_values</span><span class="p">(</span>
            <span class="n">matrix</span><span class="p">,</span>
            <span class="n">years</span><span class="o">=</span><span class="n">years</span><span class="p">,</span>
            <span class="n">periods</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">periods</span><span class="p">,</span>
            <span class="n">blocks</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">blocks</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_merge_imputed</span><span class="p">(</span><span class="n">aligned_df</span><span class="p">,</span> <span class="n">imputed_matrix</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;imputed_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">imputed_simulated_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="n">simulated_output_asset</span><span class="p">,</span>
        <span class="n">io_manager_key</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">simulate_flags_settings</span><span class="o">.</span><span class="n">output_io_manager_key</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">simulate_flags_settings</span>
        <span class="k">else</span> <span class="s2">&quot;io_manager&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_simulated_output_asset</span><span class="p">(</span>
        <span class="n">imputed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename columns back to original names and output to desired IO-manager.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">imputed_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;id_col&quot;</span><span class="p">:</span> <span class="n">id_col</span><span class="p">,</span>
                <span class="s2">&quot;imputed_value_col&quot;</span><span class="p">:</span> <span class="n">imputed_value_col</span><span class="p">,</span>
                <span class="s2">&quot;flags&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">imputed_value_col</span><span class="si">}</span><span class="s2">_imputation_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;value_col&quot;</span><span class="p">:</span> <span class="n">reported_value_col</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@asset</span><span class="p">(</span>
        <span class="n">ins</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;imputed_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">imputed_asset</span><span class="p">),</span>
            <span class="s2">&quot;simulated_df&quot;</span><span class="p">:</span> <span class="n">AssetIn</span><span class="p">(</span><span class="n">imputed_simulated_asset</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">name</span><span class="o">=</span><span class="n">imputation_score_asset</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_score_imputation</span><span class="p">(</span>
        <span class="n">imputed_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">simulated_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute a performance metric on imputed simulated data.</span>

<span class="sd">        This takes the real output asset and the simulated output asset, and will</span>
<span class="sd">        compute a metric comparing the imputed simulated data to the real data. The</span>
<span class="sd">        metric used is ``mean_absolute_percentage_error`` as percent error is more</span>
<span class="sd">        robust to magnitude changes in the underlying data than total error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mape_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">gdf</span> <span class="ow">in</span> <span class="n">simulated_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;simulation_group&quot;</span><span class="p">):</span>
            <span class="c1"># Get just rows where we simultated NULLS</span>
            <span class="n">simulated_gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;flags&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;simulated&quot;</span><span class="p">]</span>

            <span class="c1"># Combine with real data</span>
            <span class="n">combined_df</span> <span class="o">=</span> <span class="n">simulated_gdf</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">imputed_df</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;datetime_utc&quot;</span><span class="p">,</span> <span class="s2">&quot;id_col&quot;</span><span class="p">],</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;one_to_one&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Compute metric</span>
            <span class="n">mape_dict</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_absolute_percentage_error</span><span class="p">(</span>
                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;imputed_value_col_x&quot;</span><span class="p">],</span>
                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;imputed_value_col_y&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Imputed simulated NULLS for group </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> with mean percent error: </span><span class="si">{</span><span class="n">mape_dict</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">mape_dict</span>

    <span class="nd">@asset_check</span><span class="p">(</span>
        <span class="n">asset</span><span class="o">=</span><span class="n">imputation_score_asset</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">imputation_score_asset</span><span class="si">}</span><span class="s2">_asset_check&quot;</span><span class="p">,</span>
        <span class="n">blocking</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_score</span><span class="p">(</span><span class="n">mape_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">AssetCheckResult</span><span class="p">(</span>
            <span class="n">passed</span><span class="o">=</span><span class="nb">all</span><span class="p">(</span>
                <span class="n">mape</span> <span class="o">&lt;</span> <span class="n">settings</span><span class="o">.</span><span class="n">simulate_flags_settings</span><span class="o">.</span><span class="n">mape_threshold</span>
                <span class="k">for</span> <span class="n">mape</span> <span class="ow">in</span> <span class="n">mape_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">mape_dict</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Checks mean absolute percent error computed on simulated imputed data, and compared to a configurable threshold.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">production_assets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_prepare_timeseries_matrix</span><span class="p">,</span>
        <span class="n">_flag_timeseries_matrix</span><span class="p">,</span>
        <span class="n">_impute_timeseries</span><span class="p">,</span>
        <span class="n">_create_output_asset</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">simulation_assets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_simulate_flags</span><span class="p">,</span>
        <span class="n">_impute_simulated_timeseries</span><span class="p">,</span>
        <span class="n">_score_imputation</span><span class="p">,</span>
        <span class="n">_create_simulated_output_asset</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Only return simulation assets if passed simulation settings</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">simulate_flags_settings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">production_assets</span> <span class="o">+</span> <span class="n">simulation_assets</span><span class="p">,</span> <span class="n">_check_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">production_assets</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2016-2026, Catalyst Cooperative, CC-BY-4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=11fc87b4"></script>
    <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>